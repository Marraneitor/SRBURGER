<!DOCTYPE html>
<html lang="es" class="sr-dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="robots" content="noindex, nofollow" />
  <title>Productos (recetas y costos) - SR &amp; SRA BURGER</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
  <link rel="stylesheet" href="styles/sr-ui.css" />
  <script src="js/sr-shell.js" defer></script>
</head>
<body class="min-h-screen bg-gradient-to-br from-slate-900 via-slate-950 to-slate-900 text-slate-50">
  <header class="sticky top-0 z-30 bg-slate-900/90 backdrop-blur border-b border-slate-800">
    <div class="max-w-6xl mx-auto px-4 py-4 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 rounded-2xl bg-amber-500 text-slate-900 grid place-items-center">
          <i class="fas fa-burger"></i>
        </div>
        <div>
          <div class="text-xs font-bold text-amber-300 tracking-wide">SR &amp; SRA BURGER</div>
          <h1 class="text-lg sm:text-xl font-extrabold">Productos y costos de producción</h1>
          <p class="text-xs text-slate-400 hidden sm:block">Vista rápida de todos tus productos con su costo interno.</p>
        </div>
      </div>
      <div class="flex items-center gap-2">
        <a href="admin.html" class="inline-flex items-center gap-2 px-3 py-2 rounded-xl bg-slate-800 hover:bg-slate-700 text-xs font-semibold text-slate-100 border border-slate-700">
          <i class="fas fa-arrow-left"></i>
          Volver al admin
        </a>
      </div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 py-6 space-y-4">
    <div id="status" class="text-sm text-slate-300"></div>

    <section class="rounded-2xl bg-slate-900/70 border border-slate-800 p-4">
      <div class="flex flex-wrap items-center gap-3">
        <div class="flex items-center gap-2 px-3 py-2 rounded-xl bg-slate-800/70 border border-slate-700">
          <i class="fas fa-filter text-amber-300 text-xs"></i>
          <div class="flex flex-col">
            <span class="text-[11px] font-semibold text-slate-300 leading-tight">Filtrar por sección</span>
            <select id="category-filter" class="mt-1 text-xs bg-transparent border-0 text-slate-100 focus:ring-0 p-0">
              <option value="all">Todas las secciones</option>
              <option value="with_recipe">Solo con receta</option>
              <option value="missing_recipe">Sin receta</option>
            </select>
          </div>
        </div>

        <div class="flex-1 min-w-[220px]">
          <div class="relative">
            <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-slate-500 text-xs"></i>
            <input id="search" type="text" placeholder="Buscar producto..." class="w-full pl-9 pr-3 py-2 rounded-xl bg-slate-950/50 border border-slate-700 text-sm text-slate-100 focus:outline-none focus:ring-2 focus:ring-amber-400" />
          </div>
        </div>

        <input id="import-file" type="file" accept="application/json" class="hidden" />
        <button id="import-btn" type="button" class="px-4 py-2 rounded-xl bg-amber-500 hover:bg-amber-400 text-sm font-extrabold text-slate-950 inline-flex items-center gap-2">
          <i class="fas fa-file-import"></i>
          Importar recetas JSON
        </button>
        <button id="export-btn" type="button" class="px-4 py-2 rounded-xl bg-slate-800 hover:bg-slate-700 border border-slate-700 text-sm font-semibold text-slate-100 inline-flex items-center gap-2">
          <i class="fas fa-file-export"></i>
          Exportar recetas JSON
        </button>
      </div>
      <div class="mt-2 text-xs text-slate-400">
        Esta página usa los productos reales del admin. En importación, si un producto no coincide por nombre, se ignora.
      </div>
    </section>

    <div id="productos-container" class="space-y-6"></div>
  </main>

  <!-- Firebase base (trae FirebaseAdminManager como window.firebaseManager) -->
  <script type="module" src="js/firebase-config.js"></script>

  <script>
    (function() {
      const menuData = {
        "Hamburguesas": [
          { id: 1, name: "Cl\u00e1sica PREMIUM", price: 100, description: "Pan XL, carne 80/20 arrachera, queso Gouda, queso americano, cebolla caramelizada, lechuga, tomate y tocino.", image: "", customizable: true },
          { id: 2, name: "BBQ BEACON CRUNCH", price: 110, description: "Pan XL, carne 80/20 arrachera, queso americano, cebolla caramelizada, aros de cebolla, tocino y BBQ.", image: "", customizable: true },
          { id: 11, name: "Alohawai Burger", price: 120, description: "Pan XL, carne 80/20 arrachera, queso Gouda, queso americano, cebolla caramelizada, lechuga, tomate, tocino y pi\u00f1a.", image: "", customizable: true },
          { id: 12, name: "Chistorraburger", price: 120, description: "Pan XL, carne 80/20 arrachera, queso Gouda, cebolla caramelizada, chistorra y tocino.", image: "", customizable: true },
          { id: 13, name: "Choriargentina Burger", price: 120, description: "Pan XL, carne 80/20 arrachera, queso Gouda, cebolla caramelizada, chorizo argentino y tocino.", image: "", customizable: true },
          { id: 30, name: "Salchiburger", price: 120, description: "Pan XL, carne 80/20 arrachera, queso Gouda, queso americano, cebolla caramelizada, lechuga, tomate, tocino y salchicha.", image: "", customizable: true }
        ],
        "Hot Dogs": [
          { id: 5, name: "Hotdog Jumbo", price: 60, description: "Salchicha jumbo jugosa en pan artesanal tostado, tocino crujiente, tomate fresco, cebolla y aderezos especiales.", image: "", customizable: true },
          { id: 27, name: "Jalape\u00f1o Dog", price: 60, description: "Salchicha roja premium con queso manchego derretido, tocino crujiente, cebolla caramelizada y jalape\u00f1os frescos.", image: "", customizable: true }
        ],
        "Combos": [
          { id: 26, name: "DOBLES DOBLES", price: 220, originalPrice: 300, description: "2 hamburguesas a tu elecci\u00f3n a precio especial.", image: "", isCombo: true },
          { id: 6, name: "Combo Pareja", price: 250, originalPrice: 305, description: "2 hamburguesas a elecci\u00f3n, papas medianas y aros.", image: "", isCombo: true },
          { id: 15, name: "Combo D\u00fao", price: 180, originalPrice: 220, description: "1 hamburguesa, 1 hotdog y papas medianas.", image: "", isCombo: true },
          { id: 7, name: "Combo Amigos", price: 360, originalPrice: 400, description: "3 hamburguesas y papas medianas.", image: "", isCombo: true },
          { id: 14, name: "Combo Familiar", price: 650, originalPrice: 730, description: "5 hamburguesas, papas XL, aros y refresco 3L.", image: "", isCombo: true }
        ],
        "Extras": [
          { id: 8, name: "Papas Gajo Medianas", price: 60, description: "Papas gajo doradas y crujientes.", image: "" },
          { id: 28, name: "Papas Francesas Medianas", price: 60, description: "Papas francesas cl\u00e1sicas y crujientes.", image: "" },
          { id: 17, name: "Salchipapas Medianas", price: 80, description: "Papas doradas con trozos de salchicha premium.", image: "" },
          { id: 19, name: "Aros de Cebolla (8 pz)", price: 45, description: "Aros de cebolla empanizados y fritos.", image: "" }
        ],
        "Bebidas": [
          { id: 21, name: "Coca-Cola 600ml", price: 30, description: "Coca-Cola helada y refrescante.", image: "" },
          { id: 22, name: "Coca-Cola 1.75L", price: 40, description: "Coca-Cola familiar para compartir.", image: "" },
          { id: 23, name: "Coca-Cola 3L", price: 60, description: "Coca-Cola grande para toda la familia.", image: "" },
          { id: 24, name: "Agua Natural 600ml", price: 20, description: "Agua natural pura y refrescante.", image: "" }
        ]
      };

      const FIREBASE_ING_KEY = 'ingredientsCatalog';
      const FIREBASE_RECIPES_KEY = 'productsRecipes';

      let firebaseSettings = null;
      let productionCosts = {};
      let ingredientsCatalog = [];
      let productsRecipes = {};

      let saveTimer = null;

      function setStatus(msg, type) {
        const el = document.getElementById('status');
        if (!el) return;
        const base = 'text-sm';
        const color = type === 'error' ? 'text-rose-300' : type === 'success' ? 'text-emerald-300' : 'text-slate-300';
        el.className = base + ' ' + color;
        el.textContent = msg || '';
      }

      function safeText(v) {
        return v == null ? '' : String(v);
      }

      function normText(s) {
        return safeText(s)
          .toLowerCase()
          .normalize('NFD')
          .replace(/[\u0300-\u036f]/g, '')
          .replace(/[^a-z0-9]+/g, ' ')
          .replace(/\s+/g, ' ')
          .trim();
      }

      function toNumber(v) {
        const n = Number(v);
        return Number.isFinite(n) ? n : null;
      }

      function formatMoney(n) {
        const v = Number(n || 0);
        if (!Number.isFinite(v)) return '$0';
        return '$' + v.toFixed(2);
      }

      function debounceSave(fn) {
        if (saveTimer) clearTimeout(saveTimer);
        saveTimer = setTimeout(fn, 600);
      }

      function computeIngredientUnitCost(ing) {
        const p = Number(ing?.pricePerPack ?? 0);
        const u = Number(ing?.unitsPerPack ?? 0);
        if (!Number.isFinite(p) || !Number.isFinite(u) || u <= 0) return 0;
        return p / u;
      }

      function getIngredientIndex(catalog) {
        const byId = new Map();
        const byName = new Map();
        (Array.isArray(catalog) ? catalog : []).forEach((ing) => {
          if (!ing) return;
          const id = safeText(ing.id).trim();
          const name = safeText(ing.name).trim();
          if (id) byId.set(id, ing);
          if (name) byName.set(normText(name), ing);
        });
        return { byId, byName };
      }

      function computeRecipeCost(recipe, catalogIndex) {
        const lines = Array.isArray(recipe?.ingredients) ? recipe.ingredients : [];
        let total = 0;
        const details = [];

        lines.forEach((ln) => {
          if (!ln) return;
          const qty = Number(ln.qty ?? ln.quantity ?? 0);
          if (!Number.isFinite(qty) || qty <= 0) return;

          const ing = (ln.ingredientId && catalogIndex.byId.get(String(ln.ingredientId)))
            || (ln.name && catalogIndex.byName.get(normText(ln.name)))
            || null;

          const unitCost = ing ? computeIngredientUnitCost(ing) : 0;
          const lineCost = unitCost * qty;
          total += lineCost;

          details.push({
            name: safeText(ln.name || ing?.name || 'Ingrediente'),
            qty,
            unit: safeText(ln.unit || ing?.unit || ''),
            unitCost,
            lineCost,
            missing: !ing
          });
        });

        return { total, details };
      }

      function buildProductsList(filterCategory) {
        const all = [];
        const settings = firebaseSettings || {};
        const customProducts = settings.customProducts || {};
        const priceOverrides = settings.priceOverrides || {};
        const infoOverrides = settings.productInfoOverrides || {};

        const categories = new Set([
          ...Object.keys(menuData || {}),
          ...Object.keys(customProducts || {})
        ]);

        Array.from(categories).forEach((cat) => {
          if (!cat) return;
          if (filterCategory && filterCategory !== 'all' && filterCategory !== cat) return;
          const base = Array.isArray(menuData[cat]) ? menuData[cat] : [];
          const extras = Array.isArray(customProducts[cat]) ? customProducts[cat] : [];
          const merged = [...base, ...extras];

          merged.forEach((p) => {
            const id = Number(p.id);
            if (!Number.isFinite(id)) return;

            const infoOvr = infoOverrides[id] || {};
            const priceOvr = priceOverrides[id] || {};
            const effectiveName = (infoOvr.name || p.name || '').toString();
            const effectiveDesc = (infoOvr.description || p.description || '').toString();
            const effectivePrice = Number((priceOvr.price != null ? priceOvr.price : p.price) || 0);
            const cost = Number(productionCosts[id] != null ? productionCosts[id] : NaN);

            all.push({
              category: cat,
              id,
              name: effectiveName,
              description: effectiveDesc,
              price: effectivePrice,
              cost: Number.isFinite(cost) ? cost : null
            });
          });
        });

        // Order by category then name
        all.sort((a, b) => {
          if (a.category === b.category) return a.name.localeCompare(b.name, 'es');
          return a.category.localeCompare(b.category, 'es');
        });

        return all;
      }

      function getValidProductsByName(allProducts) {
        const map = new Map();
        (allProducts || []).forEach((p) => {
          const key = normText(p.name);
          if (key) map.set(key, p);
        });
        return map;
      }

      function parseImportedRecipesPayload(parsed) {
        const list = Array.isArray(parsed)
          ? parsed
          : (Array.isArray(parsed?.productos) ? parsed.productos
            : (Array.isArray(parsed?.products) ? parsed.products
              : (Array.isArray(parsed?.data) ? parsed.data
                : null)));
        if (!Array.isArray(list)) return [];
        return list;
      }

      function normalizeRecipeLine(line) {
        if (!line || typeof line !== 'object') return null;
        const qty = toNumber(line.cantidad ?? line.qty ?? line.quantity ?? line.amount);
        if (qty == null || qty <= 0) return null;

        const ingredientId = safeText(line.ingredienteId ?? line.ingredientId ?? line.id ?? '').trim() || null;
        const name = safeText(line.nombre ?? line.name ?? line.ingrediente ?? '').trim() || null;
        const unit = safeText(line.unidad ?? line.unit ?? '').trim() || null;

        if (!ingredientId && !name) return null;
        return { ingredientId, name, unit, qty };
      }

      function normalizeImportedProductRecipe(raw, validByName, catalogIndex) {
        if (!raw || typeof raw !== 'object') return null;
        const name = safeText(raw.nombre ?? raw.name ?? raw.producto ?? raw.productName ?? raw.titulo ?? raw.title ?? '').trim();
        if (!name) return null;

        const match = validByName.get(normText(name));
        if (!match) return { ignored: true, name };

        const section = safeText(raw.seccion ?? raw.section ?? raw.categoria ?? raw.category ?? raw.clasificacion ?? '').trim();

        const rawLines = Array.isArray(raw.ingredientes)
          ? raw.ingredientes
          : (Array.isArray(raw.receta) ? raw.receta
            : (Array.isArray(raw.ingredients) ? raw.ingredients : []));

        const ingredients = rawLines.map(normalizeRecipeLine).filter(Boolean).map((ln) => {
          // Resolver a ingrediente real (por id o nombre)
          const ing = (ln.ingredientId && catalogIndex.byId.get(String(ln.ingredientId)))
            || (ln.name && catalogIndex.byName.get(normText(ln.name)))
            || null;

          return {
            ingredientId: ing?.id || ln.ingredientId || null,
            name: ing?.name || ln.name || 'Ingrediente',
            unit: ing?.unit || ln.unit || '',
            qty: ln.qty
          };
        });

        return {
          ignored: false,
          productId: match.id,
          productName: match.name,
          section: section || match.category,
          ingredients
        };
      }

      function openEditModal(product, recipe) {
        const catalogIndex = getIngredientIndex(ingredientsCatalog);
        const current = recipe || { section: product.category, ingredients: [] };
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 z-50 bg-black/60 flex items-center justify-center p-4';

        const options = (ingredientsCatalog || [])
          .slice()
          .sort((a, b) => safeText(a.name).localeCompare(safeText(b.name), 'es'))
          .map((i) => `<option value="${String(i.id)}">${escapeHtml(i.name)} (${escapeHtml(i.unit || '')})</option>`)
          .join('');

        function lineRow(idx, line) {
          const idVal = safeText(line?.ingredientId || '').trim();
          const qtyVal = (line?.qty != null ? String(line.qty) : '');
          return `
            <div class="grid grid-cols-1 sm:grid-cols-12 gap-2 items-center" data-line="${idx}">
              <div class="sm:col-span-7">
                <select class="w-full rounded-xl bg-slate-950/60 border border-slate-700 px-3 py-2 text-sm text-slate-100 focus:outline-none focus:ring-2 focus:ring-amber-400" data-field="ing">
                  <option value="">Selecciona ingrediente</option>
                  ${options}
                </select>
              </div>
              <div class="sm:col-span-3">
                <input type="number" min="0" step="0.0001" class="w-full rounded-xl bg-slate-950/60 border border-slate-700 px-3 py-2 text-sm text-slate-100 focus:outline-none focus:ring-2 focus:ring-amber-400" placeholder="Cantidad" data-field="qty" value="${escapeHtmlAttr(qtyVal)}" />
              </div>
              <div class="sm:col-span-2 flex justify-end">
                <button type="button" class="px-3 py-2 rounded-xl bg-rose-500/15 hover:bg-rose-500/25 border border-rose-500/40 text-rose-200 text-xs font-semibold" data-action="remove">Quitar</button>
              </div>
            </div>
          `;
        }

        modal.innerHTML = `
          <div class="w-full max-w-2xl rounded-2xl bg-slate-900 border border-slate-800 shadow-2xl overflow-hidden">
            <div class="px-4 py-3 flex items-center justify-between bg-slate-950/60 border-b border-slate-800">
              <div>
                <div class="text-xs text-slate-400">Editar receta</div>
                <div class="text-sm font-extrabold text-slate-100">${escapeHtml(product.name)}</div>
                <div class="text-[11px] text-slate-500">ID: ${product.id} · Sección: ${escapeHtml(current.section || product.category)}</div>
              </div>
              <button type="button" class="w-10 h-10 rounded-xl bg-slate-800 hover:bg-slate-700 border border-slate-700" data-action="close">
                <i class="fas fa-times text-slate-200"></i>
              </button>
            </div>

            <div class="p-4 space-y-3">
              <div>
                <label class="text-xs font-semibold text-slate-200">Sección</label>
                <input type="text" class="mt-1 w-full rounded-xl bg-slate-950/60 border border-slate-700 px-3 py-2 text-sm text-slate-100 focus:outline-none focus:ring-2 focus:ring-amber-400" data-field="section" value="${escapeHtmlAttr(current.section || product.category)}" />
              </div>

              <div>
                <div class="flex items-center justify-between">
                  <label class="text-xs font-semibold text-slate-200">Ingredientes</label>
                  <button type="button" class="px-3 py-2 rounded-xl bg-slate-800 hover:bg-slate-700 border border-slate-700 text-xs font-semibold" data-action="add">
                    <i class="fas fa-plus mr-1"></i>Agregar
                  </button>
                </div>
                <div class="mt-2 space-y-2" id="lines">
                  ${current.ingredients.length ? current.ingredients.map((ln, idx) => lineRow(idx, ln)).join('') : '<div class="text-xs text-slate-400">Sin ingredientes. Agrega al menos uno.</div>'}
                </div>
              </div>

              <div class="flex flex-wrap items-center gap-2 pt-2">
                <button type="button" class="px-4 py-2 rounded-xl bg-emerald-500 hover:bg-emerald-400 text-sm font-extrabold text-slate-950" data-action="save">Guardar receta</button>
                <button type="button" class="px-4 py-2 rounded-xl bg-amber-500 hover:bg-amber-400 text-sm font-extrabold text-slate-950" data-action="apply">Guardar y aplicar costo</button>
                <div class="flex-1"></div>
                <button type="button" class="px-4 py-2 rounded-xl bg-transparent hover:bg-slate-800 text-sm font-semibold text-rose-300" data-action="clear">Borrar receta</button>
              </div>
              <div class="text-xs text-slate-400">Las cantidades deben estar en la misma unidad del ingrediente (g, pz, unidad, etc.).</div>
            </div>
          </div>
        `;

        document.body.appendChild(modal);

        // Preseleccionar selects
        const setSelectValues = () => {
          const rows = modal.querySelectorAll('[data-line]');
          rows.forEach((row, idx) => {
            const select = row.querySelector('select[data-field="ing"]');
            const idVal = safeText(current.ingredients[idx]?.ingredientId || '').trim();
            if (select && idVal) select.value = idVal;
          });
        };
        setSelectValues();

        function collectRecipeFromModal() {
          const section = safeText(modal.querySelector('[data-field="section"]')?.value).trim() || product.category;
          const linesWrap = modal.querySelector('#lines');
          const rows = linesWrap ? Array.from(linesWrap.querySelectorAll('[data-line]')) : [];
          const lines = [];
          rows.forEach((row) => {
            const ingId = safeText(row.querySelector('[data-field="ing"]')?.value).trim();
            const qty = toNumber(row.querySelector('[data-field="qty"]')?.value);
            if (!ingId || qty == null || qty <= 0) return;
            const ing = catalogIndex.byId.get(ingId);
            if (!ing) return;
            lines.push({ ingredientId: ing.id, name: ing.name, unit: ing.unit, qty });
          });
          return { section, ingredients: lines };
        }

        async function saveRecipe(nextRecipe, applyCost) {
          try {
            const settings = firebaseSettings || (await window.firebaseManager.getSettings());
            const next = { ...(settings || {}) };
            const all = { ...(next[FIREBASE_RECIPES_KEY] || {}) };

            if (!nextRecipe || !Array.isArray(nextRecipe.ingredients) || !nextRecipe.ingredients.length) {
              delete all[String(product.id)];
            } else {
              all[String(product.id)] = {
                section: nextRecipe.section || product.category,
                ingredients: nextRecipe.ingredients,
                updatedAt: new Date().toISOString()
              };
            }

            next[FIREBASE_RECIPES_KEY] = all;

            if (applyCost) {
              const idx = getIngredientIndex(ingredientsCatalog);
              const { total } = computeRecipeCost(all[String(product.id)], idx);
              const prodCosts = { ...(next.productionCosts || {}) };
              prodCosts[String(product.id)] = Number(total.toFixed(2));
              next.productionCosts = prodCosts;
            }

            await window.firebaseManager.saveSettings(next);
            firebaseSettings = next;
            productsRecipes = next[FIREBASE_RECIPES_KEY] || {};
            productionCosts = next.productionCosts || {};
            setStatus('Receta guardada.', 'success');
          } catch (e) {
            console.error(e);
            setStatus('No se pudo guardar la receta en Firebase.', 'error');
          }
        }

        modal.addEventListener('click', async (e) => {
          const btn = e.target.closest('[data-action]');
          if (!btn) return;
          const action = btn.getAttribute('data-action');
          if (action === 'close') {
            modal.remove();
            return;
          }
          if (action === 'add') {
            const lines = modal.querySelector('#lines');
            const rowCount = lines ? lines.querySelectorAll('[data-line]').length : 0;
            if (lines) {
              if (lines.textContent.includes('Sin ingredientes')) lines.innerHTML = '';
              lines.insertAdjacentHTML('beforeend', lineRow(rowCount, {}));
            }
            return;
          }
          if (action === 'remove') {
            const row = btn.closest('[data-line]');
            if (row) row.remove();
            return;
          }
          if (action === 'clear') {
            const ok = confirm('¿Borrar la receta de este producto?');
            if (!ok) return;
            await saveRecipe(null, false);
            modal.remove();
            render(document.getElementById('category-filter')?.value || 'all');
            return;
          }
          if (action === 'save') {
            const r = collectRecipeFromModal();
            await saveRecipe(r, false);
            modal.remove();
            render(document.getElementById('category-filter')?.value || 'all');
            return;
          }
          if (action === 'apply') {
            const r = collectRecipeFromModal();
            await saveRecipe(r, true);
            modal.remove();
            render(document.getElementById('category-filter')?.value || 'all');
            return;
          }
        });
      }

      function escapeHtml(s) {
        return safeText(s)
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/"/g, '&quot;')
          .replace(/'/g, '&#39;');
      }

      function escapeHtmlAttr(s) {
        return escapeHtml(s).replace(/`/g, '&#96;');
      }

      function render(filterCategory) {
        const container = document.getElementById('productos-container');
        const select = document.getElementById('category-filter');
        if (!container || !select) return;

        const query = normText(document.getElementById('search')?.value || '');

        const baseAll = buildProductsList('all');
        const catalogIndex = getIngredientIndex(ingredientsCatalog);
        const recipes = productsRecipes || {};

        const all = baseAll
          .map((p) => {
            const recipe = recipes[String(p.id)] || null;
            const calc = recipe ? computeRecipeCost(recipe, catalogIndex) : { total: null, details: [] };
            return {
              ...p,
              recipe,
              recipeSection: safeText(recipe?.section || p.category).trim() || p.category,
              calcCost: (calc && calc.total != null) ? calc.total : null,
              calcDetails: calc.details || []
            };
          })
          .filter((p) => {
            if (query && !normText(p.name).includes(query)) return false;

            if (filterCategory === 'with_recipe') return Boolean(p.recipe && Array.isArray(p.recipe.ingredients) && p.recipe.ingredients.length);
            if (filterCategory === 'missing_recipe') return !(p.recipe && Array.isArray(p.recipe.ingredients) && p.recipe.ingredients.length);
            if (filterCategory && filterCategory !== 'all') return p.recipeSection === filterCategory;
            return true;
          })
          .sort((a, b) => {
            if (a.recipeSection === b.recipeSection) return a.name.localeCompare(b.name, 'es');
            return a.recipeSection.localeCompare(b.recipeSection, 'es');
          });

        if (!all.length) {
          container.innerHTML = '<div class="text-center py-12 text-slate-400">No se encontraron productos. Revisa tu panel de admin.</div>';
          return;
        }

        // Rellenar opciones de filtro una sola vez
        if (select.options.length <= 1) {
          const cats = Array.from(new Set(baseAll.map(p => safeText((productsRecipes[String(p.id)]?.section) || p.category).trim() || p.category)));
          cats.sort((a, b) => a.localeCompare(b, 'es'));
          cats.forEach((cat) => {
            const opt = document.createElement('option');
            opt.value = cat;
            opt.textContent = cat;
            select.appendChild(opt);
          });
        }

        // Agrupar por categoría
        const byCat = new Map();
        all.forEach((p) => {
          const sec = p.recipeSection || p.category;
          if (!byCat.has(sec)) byCat.set(sec, []);
          byCat.get(sec).push(p);
        });

        const sections = [];
        byCat.forEach((items, cat) => {
          const rows = items.map((p) => {
            const price = Number.isFinite(p.price) ? p.price : 0;
            const storedCost = (() => {
              const v = p.cost;
              if (v == null) return null;
              const n = Number(v);
              return Number.isFinite(n) ? n : null;
            })();

            const calcCost = p.calcCost;
            const hasRecipe = Boolean(p.recipe && Array.isArray(p.recipe.ingredients) && p.recipe.ingredients.length);

            const margin = (calcCost != null) ? (price - calcCost) : (storedCost != null ? (price - storedCost) : null);
            const marginText = margin != null ? '$' + Math.max(0, margin).toFixed(0) : '—';

            const missingCount = (p.calcDetails || []).filter(d => d.missing).length;
            const missingBadge = missingCount
              ? `<span class="ml-2 inline-flex items-center px-2 py-0.5 rounded-full text-[11px] font-semibold bg-rose-500/15 border border-rose-500/40 text-rose-200">${missingCount} faltan</span>`
              : '';

            const costBadge = hasRecipe
              ? `<span class="inline-flex items-center px-2 py-0.5 rounded-full text-[11px] font-semibold bg-amber-500/15 border border-amber-500/30 text-amber-200">Calc: ${formatMoney(calcCost)}</span>`
              : `<span class="inline-flex items-center px-2 py-0.5 rounded-full text-[11px] font-semibold bg-slate-800 border border-slate-700 text-slate-300">Sin receta</span>`;

            const storedBadge = storedCost != null
              ? `<span class="inline-flex items-center px-2 py-0.5 rounded-full text-[11px] font-semibold bg-emerald-500/10 border border-emerald-500/30 text-emerald-200">Guardado: ${formatMoney(storedCost)}</span>`
              : `<span class="inline-flex items-center px-2 py-0.5 rounded-full text-[11px] font-semibold bg-slate-800 border border-slate-700 text-slate-400">Guardado: —</span>`;

            const details = hasRecipe
              ? `
                <div class="mt-2 rounded-xl border border-slate-800 bg-slate-950/40 p-3">
                  <div class="text-[11px] font-semibold text-slate-300 mb-2">Ingredientes (${p.recipe.ingredients.length})</div>
                  <div class="space-y-1">
                    ${(p.calcDetails || []).map((d) => {
                      const warn = d.missing ? 'text-rose-200' : 'text-slate-200';
                      const tag = d.missing ? '<span class="ml-2 text-[10px] px-2 py-0.5 rounded-full bg-rose-500/15 border border-rose-500/40 text-rose-200">No existe</span>' : '';
                      return `<div class="flex items-center justify-between gap-2 text-xs ${warn}"><div class="min-w-0 truncate">${escapeHtml(d.name)}${tag}</div><div class="text-right whitespace-nowrap">${d.qty} ${escapeHtml(d.unit || '')} · ${formatMoney(d.lineCost)}</div></div>`;
                    }).join('')}
                  </div>
                </div>
              `
              : '';

            return `
              <tr class="border-b border-slate-800/60">
                <td class="px-3 py-2 align-top">
                  <div class="text-sm font-semibold text-slate-100">${p.name}</div>
                  <div class="text-[11px] text-slate-400">ID: ${p.id}</div>
                  <div class="text-[11px] text-slate-500 mt-0.5 line-clamp-2">${p.description || ''}</div>
                  <div class="mt-1 flex flex-wrap items-center gap-2">${costBadge}${storedBadge}${missingBadge}</div>
                  ${details}
                </td>
                <td class="px-3 py-2 align-top text-sm text-amber-300 font-semibold whitespace-nowrap">$${price.toFixed(0)}</td>
                <td class="px-3 py-2 align-top">
                  <div class="flex flex-wrap items-center gap-2">
                    <div class="flex items-center gap-2">
                      <span class="text-slate-400 text-xs">$</span>
                      <input type="number" min="0" step="0.01" value="${storedCost != null ? String(storedCost) : ''}" data-product-id="${p.id}" class="cost-input w-24 bg-slate-900/60 border border-slate-700 rounded-lg px-2 py-1 text-xs text-slate-100 focus:ring-amber-400 focus:border-amber-400" placeholder="0" />
                      <button type="button" data-action="save-cost" data-product-id="${p.id}" class="inline-flex items-center gap-1 px-2.5 py-1 rounded-lg bg-emerald-500 hover:bg-emerald-600 text-[11px] font-semibold text-slate-950">
                        <i class="fas fa-save"></i>
                        Guardar
                      </button>
                    </div>
                    <button type="button" data-action="edit-recipe" data-product-id="${p.id}" class="inline-flex items-center gap-1 px-2.5 py-1 rounded-lg bg-slate-800 hover:bg-slate-700 border border-slate-700 text-[11px] font-semibold text-slate-100">
                      <i class="fas fa-pen"></i>
                      Receta
                    </button>
                    <button type="button" data-action="apply-cost" data-product-id="${p.id}" ${hasRecipe ? '' : 'disabled'} class="inline-flex items-center gap-1 px-2.5 py-1 rounded-lg bg-amber-500 hover:bg-amber-400 disabled:opacity-40 disabled:hover:bg-amber-500 text-[11px] font-extrabold text-slate-950">
                      <i class="fas fa-calculator"></i>
                      Aplicar costo
                    </button>
                  </div>
                </td>
                <td class="px-3 py-2 align-top text-xs text-emerald-300 font-semibold whitespace-nowrap">${marginText}</td>
              </tr>
            `;
          }).join('');

          sections.push(`
            <section class="bg-slate-900/80 border border-slate-800 rounded-2xl overflow-hidden shadow-lg">
              <div class="px-4 py-3 flex items-center justify-between bg-slate-900/90 border-b border-slate-800">
                <div class="flex items-center gap-2">
                  <span class="inline-flex items-center justify-center w-7 h-7 rounded-full bg-amber-500/10 text-amber-300">
                    <i class="fas fa-layer-group text-xs"></i>
                  </span>
                  <h2 class="text-sm font-extrabold tracking-wide text-slate-100 uppercase">${cat}</h2>
                </div>
                <span class="text-[11px] text-slate-400">${items.length} productos</span>
              </div>
              <div class="overflow-x-auto">
                <table class="min-w-full text-xs">
                  <thead class="bg-slate-900/90 text-slate-400">
                    <tr>
                      <th class="px-3 py-2 text-left font-semibold">Producto</th>
                      <th class="px-3 py-2 text-left font-semibold">Precio venta</th>
                      <th class="px-3 py-2 text-left font-semibold">Receta</th>
                      <th class="px-3 py-2 text-left font-semibold">Utilidad aprox.</th>
                    </tr>
                  </thead>
                  <tbody class="divide-y divide-slate-800/60">
                    ${rows}
                  </tbody>
                </table>
              </div>
            </section>
          `);
        });

        container.innerHTML = sections.join('');

        container.onclick = async (ev) => {
          const btn = ev.target.closest('[data-action]');
          if (!btn) return;
          const action = btn.getAttribute('data-action');
          const pid = Number(btn.getAttribute('data-product-id'));
          if (!Number.isFinite(pid)) return;
          const product = baseAll.find(p => Number(p.id) === pid);
          if (!product) return;

          if (action === 'save-cost') {
            const input = container.querySelector(`input.cost-input[data-product-id="${pid}"]`);
            if (!input) return;
            const raw = (input.value || '').trim();
            if (!raw) {
              // limpiar
              try {
                const settings = firebaseSettings || (await window.firebaseManager.getSettings());
                const next = { ...(settings || {}) };
                const prodCosts = { ...(next.productionCosts || {}) };
                delete prodCosts[String(pid)];
                next.productionCosts = prodCosts;
                await window.firebaseManager.saveSettings(next);
                firebaseSettings = next;
                productionCosts = prodCosts;
                setStatus('Costo eliminado y guardado.', 'success');
                render(document.getElementById('category-filter')?.value || 'all');
              } catch (e) {
                console.error(e);
                setStatus('No se pudo guardar el cambio de costo.', 'error');
              }
              return;
            }

            const val = Number(raw);
            if (!Number.isFinite(val) || val < 0) {
              alert('Escribe un costo válido mayor o igual a 0.');
              return;
            }

            try {
              const settings = firebaseSettings || (await window.firebaseManager.getSettings());
              const next = { ...(settings || {}) };
              const prodCosts = { ...(next.productionCosts || {}) };
              prodCosts[String(pid)] = Number(val.toFixed(2));
              next.productionCosts = prodCosts;
              await window.firebaseManager.saveSettings(next);
              firebaseSettings = next;
              productionCosts = prodCosts;
              setStatus('Costo guardado en Firebase.', 'success');
              render(document.getElementById('category-filter')?.value || 'all');
            } catch (e) {
              console.error(e);
              setStatus('No se pudo guardar el costo.', 'error');
            }
            return;
          }

          if (action === 'edit-recipe') {
            const recipe = productsRecipes[String(pid)] || null;
            openEditModal(product, recipe);
            return;
          }

          if (action === 'apply-cost') {
            const recipe = productsRecipes[String(pid)] || null;
            if (!recipe) return;
            const idx = getIngredientIndex(ingredientsCatalog);
            const { total } = computeRecipeCost(recipe, idx);
            const nextVal = Number(total.toFixed(2));

            try {
              const settings = firebaseSettings || (await window.firebaseManager.getSettings());
              const next = { ...(settings || {}) };
              const prodCosts = { ...(next.productionCosts || {}) };
              prodCosts[String(pid)] = nextVal;
              next.productionCosts = prodCosts;
              await window.firebaseManager.saveSettings(next);
              firebaseSettings = next;
              productionCosts = prodCosts;
              setStatus('Costo aplicado y guardado en Firebase.', 'success');
              render(document.getElementById('category-filter')?.value || 'all');
            } catch (e) {
              console.error(e);
              setStatus('No se pudo aplicar el costo.', 'error');
            }
          }
        };
      }

      function waitForFirebaseAndInit() {
        if (!window.firebaseManager) {
          setTimeout(waitForFirebaseAndInit, 80);
          return;
        }
        init();
      }

      async function init() {
        try {
          setStatus('Cargando productos, ingredientes y recetas...', 'info');
          if (!window.firebaseManager || typeof window.firebaseManager.getSettings !== 'function') {
            setStatus('Firebase no está disponible. No se pueden leer los productos del admin.', 'error');
            return;
          }
          const settings = await window.firebaseManager.getSettings();
          firebaseSettings = settings || {};
          productionCosts = (firebaseSettings && firebaseSettings.productionCosts) || {};
          ingredientsCatalog = Array.isArray(firebaseSettings[FIREBASE_ING_KEY]) ? firebaseSettings[FIREBASE_ING_KEY] : [];
          // fallback a localStorage usado por ingredientes.html
          if (!ingredientsCatalog.length) {
            try {
              const raw = localStorage.getItem('sr_ingredients_v1');
              const parsed = raw ? JSON.parse(raw) : [];
              ingredientsCatalog = Array.isArray(parsed) ? parsed : [];
            } catch (_) {
              ingredientsCatalog = [];
            }
          }
          productsRecipes = (firebaseSettings && firebaseSettings[FIREBASE_RECIPES_KEY]) || {};

          setStatus('Listo. Puedes importar recetas o editar por producto.', 'success');
          render('all');

          const select = document.getElementById('category-filter');
          if (select) {
            select.addEventListener('change', () => {
              const value = select.value || 'all';
              render(value);
            });
          }

          const search = document.getElementById('search');
          if (search) {
            search.addEventListener('input', () => {
              debounceSave(() => render(document.getElementById('category-filter')?.value || 'all'));
            });
          }

          const importBtn = document.getElementById('import-btn');
          const importFile = document.getElementById('import-file');
          const exportBtn = document.getElementById('export-btn');

          if (importBtn && importFile) {
            importBtn.addEventListener('click', () => {
              importFile.value = '';
              importFile.click();
            });

            importFile.addEventListener('change', async () => {
              const file = importFile.files && importFile.files[0];
              if (!file) return;
              try {
                const text = await file.text();
                const parsed = JSON.parse(text);
                const list = parseImportedRecipesPayload(parsed);
                const baseAll = buildProductsList('all');
                const validByName = getValidProductsByName(baseAll);
                const catalogIndex = getIngredientIndex(ingredientsCatalog);

                let imported = 0;
                let ignored = 0;
                const nextRecipes = { ...(productsRecipes || {}) };

                list.forEach((raw) => {
                  const normalized = normalizeImportedProductRecipe(raw, validByName, catalogIndex);
                  if (!normalized) return;
                  if (normalized.ignored) {
                    ignored += 1;
                    return;
                  }
                  nextRecipes[String(normalized.productId)] = {
                    section: normalized.section,
                    ingredients: normalized.ingredients,
                    importedAt: new Date().toISOString()
                  };
                  imported += 1;
                });

                const settings = firebaseSettings || (await window.firebaseManager.getSettings());
                const next = { ...(settings || {}) };
                next[FIREBASE_RECIPES_KEY] = nextRecipes;
                await window.firebaseManager.saveSettings(next);
                firebaseSettings = next;
                productsRecipes = nextRecipes;

                setStatus(`Importación lista. Recetas importadas: ${imported} · Ignoradas por nombre: ${ignored}`, 'success');
                render(document.getElementById('category-filter')?.value || 'all');
              } catch (e) {
                console.error(e);
                setStatus('No se pudo importar (JSON inválido o estructura no soportada).', 'error');
              }
            });
          }

          if (exportBtn) {
            exportBtn.addEventListener('click', () => {
              const baseAll = buildProductsList('all');
              const out = baseAll.map((p) => {
                const r = productsRecipes[String(p.id)] || null;
                if (!r) return null;
                return {
                  nombre: p.name,
                  seccion: r.section || p.category,
                  receta: (r.ingredients || []).map((ln) => ({
                    ingredienteId: ln.ingredientId || null,
                    nombre: ln.name,
                    unidad: ln.unit,
                    cantidad: ln.qty
                  }))
                };
              }).filter(Boolean);

              const blob = new Blob([JSON.stringify({ version: '1.0', exportDate: new Date().toISOString(), productos: out }, null, 2)], { type: 'application/json' });
              const url = URL.createObjectURL(blob);
              const a = document.createElement('a');
              a.href = url;
              a.download = 'productos_recetas.json';
              document.body.appendChild(a);
              a.click();
              a.remove();
              URL.revokeObjectURL(url);
              setStatus('Exportado productos_recetas.json', 'success');
            });
          }

          // Listener realtime
          if (window.firebaseManager && typeof window.firebaseManager.listenToSettings === 'function') {
            window.firebaseManager.listenToSettings((s) => {
              try {
                firebaseSettings = s || {};
                productionCosts = firebaseSettings.productionCosts || {};
                ingredientsCatalog = Array.isArray(firebaseSettings[FIREBASE_ING_KEY]) ? firebaseSettings[FIREBASE_ING_KEY] : ingredientsCatalog;
                productsRecipes = firebaseSettings[FIREBASE_RECIPES_KEY] || productsRecipes;
                render(document.getElementById('category-filter')?.value || 'all');
              } catch (_) {}
            });
          }
        } catch (e) {
          console.error('Error inicializando Productos:', e);
          setStatus('Ocurrió un error al cargar los productos.', 'error');
        }
      }

      document.addEventListener('DOMContentLoaded', waitForFirebaseAndInit);
    })();
  </script>
</body>
</html>
