<!DOCTYPE html>
<html lang="es" class="scroll-smooth sr-dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex, nofollow">
    <title>Control de Env√≠os - SR & SRA BURGER</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Poppins:wght@700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&family=Poppins:wght@600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles/sr-ui.css">
    
    <style>
    /* Base font scaling for readability */
    html { font-size: 16px; }
    html.kitchen-mode { font-size: 22px; } /* Mayor legibilidad por defecto */

        :root {
            --primary-gold: #16A34A; /* remap UI accent to SR green */
            --primary-gold-dark: #15803D;
            --primary-red: #0B1220;
            --text-primary: #0F172A;
            --text-secondary: #64748B;
            --bg-light: #FFFFFF;
            --bg-section: #F8F9FA;
            --border-light: #E2E8F0;
            --shadow-soft: 0 10px 30px rgba(15, 23, 42, 0.08);
            --shadow-hover: 0 18px 45px rgba(15, 23, 42, 0.14);
            --border-radius: 24px;
            --transition: all 220ms cubic-bezier(0.2, 0.8, 0.2, 1);
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #F8F9FA 0%, #FFFFFF 100%);
            color: var(--text-primary);
            line-height: 1.6;
        }

        .font-poppins {
            font-family: 'Poppins', sans-serif;
        }

        .card-modern {
            background: var(--bg-light);
            border-radius: var(--border-radius);
            padding: 24px;
            box-shadow: var(--shadow-soft);
            border: 1px solid var(--border-light);
            transition: var(--transition);
        }

        .card-modern:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-hover);
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-gold) 0%, var(--primary-gold-dark) 100%);
            color: var(--text-primary);
            border: none;
            padding: 12px 24px;
            border-radius: 12px;
            font-weight: 600;
            font-size: 14px;
            transition: var(--transition);
            box-shadow: var(--shadow-soft);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-hover);
        }

        .btn-success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 12px;
            font-weight: 600;
            font-size: 14px;
            transition: var(--transition);
            box-shadow: var(--shadow-soft);
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(16, 185, 129, 0.3);
        }

        .btn-info {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 12px;
            font-weight: 600;
            font-size: 14px;
            transition: var(--transition);
            box-shadow: var(--shadow-soft);
        }

        .btn-info:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.3);
        }

        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-pending {
            background: #fef3c7;
            color: #92400e;
        }

        .status-preparing {
            background: #dbeafe;
            color: #1e40af;
        }

        .status-ready {
            background: #d1fae5;
            color: #065f46;
        }

        .status-delivering {
            background: #e0e7ff;
            color: #3730a3;
        }

        .status-delivered {
            background: #f3f4f6;
            color: #374151;
        }

        .order-card {
            border-left: 4px solid var(--primary-gold);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .order-card:hover {
            border-left-color: var(--primary-red);
        }

        .order-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 0;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 199, 44, 0.1));
            transition: width 0.3s ease;
            pointer-events: none; /* No bloquear clics en botones */
        }

        .order-card:hover::before {
            width: 100%;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 16px 24px;
            border-radius: 12px;
            color: white;
            font-weight: 600;
            z-index: 1000;
            transform: translateX(400px);
            transition: transform 0.3s ease;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success {
            background: linear-gradient(135deg, #10b981, #059669);
        }

        .notification.error {
            background: linear-gradient(135deg, #ef4444, #dc2626);
        }

        .floating-stats {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: white;
            padding: 16px;
            border-radius: 16px;
            box-shadow: var(--shadow-hover);
            border: 1px solid var(--border-light);
            min-width: 200px;
        }

        @keyframes pulse-ring {
            0% {
                transform: scale(0.33);
            }
            80%, 100% {
                opacity: 0;
            }
        }

        .pulse-ring {
            animation: pulse-ring 1.25s cubic-bezier(0.215, 0.61, 0.355, 1) infinite;
        }

        .order-item {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 8px;
        }

        .order-item.checked {
            background: #d1fae5;
            border-color: #10b981;
            opacity: 0.8;
            text-decoration: line-through;
        }

        .order-item .checkmark {
            display: none;
            color: #10b981;
            margin-left: 8px;
        }

        .order-item.checked .checkmark {
            display: inline;
        }

        .breakdown-item {
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            transition: background-color 0.2s;
            user-select: none;
        }

        .breakdown-item:hover {
            background-color: #f3f4f6;
        }

        .breakdown-item.checked {
            background-color: #d1fae5;
            text-decoration: line-through;
            opacity: 0.8;
        }

        .breakdown-item.checked::after {
            content: ' ‚úì';
            color: #10b981;
            font-weight: bold;
        }

    /* Kitchen mode: bigger, clearer UI */
    html.kitchen-mode body { line-height: 1.7; }
    html.kitchen-mode .card-modern { padding: 28px; }
    html.kitchen-mode .status-badge { font-size: 0.9rem; padding: 8px 14px; }
    html.kitchen-mode .btn-primary,
    html.kitchen-mode .btn-success,
    html.kitchen-mode .btn-info { font-size: 1rem; padding: 14px 28px; }
    html.kitchen-mode .order-item { padding: 20px; }
    html.kitchen-mode header .h-16 { height: 4.5rem; }
    html.kitchen-mode .floating-stats { font-size: 1rem; }
    html.kitchen-mode .customer-info { font-size: 1.1rem; }
    html.kitchen-mode h3 { font-size: 1.5rem; }
    html.kitchen-mode h4 { font-size: 1.25rem; }
    html.kitchen-mode .text-sm { font-size: 0.95rem; }
    html.kitchen-mode .text-xs { font-size: 0.9rem; }
    html.kitchen-mode .order-card { border-left-width: 6px; }

        .customer-info {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border-radius: 12px;
            padding: 16px;
            border: 1px solid #f59e0b;
            pointer-events: none; /* Evita bloquear clics; su contenido no es interactivo */
            font-size: 1.02rem;
        }

    /* Productos m√°s grandes y legibles */
    .order-products .item-title { font-size: 1.25rem; font-weight: 800; color: #111827; }
    .order-products .item-price { font-size: 1.25rem; font-weight: 800; color: #111827; }
    .order-products .breakdown { font-size: 1.12rem; }
        .order-products .breakdown .text-sm,
    .order-products .breakdown .text-xs { font-size: 1.12rem; }
        .order-products .breakdown .text-xs span,
        .order-products .breakdown .text-sm span { padding: 4px 10px; border-radius: 9999px; display: inline-block; }

    html.kitchen-mode .order-products .item-title { font-size: 1.9rem; }
    html.kitchen-mode .order-products .item-price { font-size: 1.9rem; }
    html.kitchen-mode .order-products .breakdown { font-size: 1.35rem; }
        html.kitchen-mode .order-products .breakdown .text-sm,
    html.kitchen-mode .order-products .breakdown .text-xs { font-size: 1.35rem; }
    html.kitchen-mode .order-total .amount { font-size: 2.2rem; }

        @media (max-width: 768px) {
            .card-modern {
                padding: 16px;
                margin-bottom: 16px;
            }

            .floating-stats {
                position: relative;
                bottom: auto;
                left: auto;
                margin: 20px 0;
                width: 100%;
            }

            .btn-primary, .btn-success, .btn-info {
                width: 100%;
                margin-bottom: 8px;
            }
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary-gold);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Estilos adicionales para botones de confirmaci√≥n */
        .btn-confirmed {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            opacity: 0.8;
            cursor: default;
        }

        .btn-confirmed:hover {
            transform: none;
            box-shadow: var(--shadow-soft);
        }

        /* Modal overlay */
        .modal-overlay {
            backdrop-filter: blur(4px);
            animation: fadeIn 0.3s ease-out;
        }

        .modal-content {
            animation: slideUp 0.3s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideUp {
            from { 
                opacity: 0;
                transform: translateY(20px);
            }
            to { 
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Efectos de hover mejorados para botones de acci√≥n */
        .action-button {
            position: relative;
            overflow: hidden;
        }

        .action-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }

        .action-button:hover::before {
            left: 100%;
        }
        /* Asegurar clics en zona de acciones */
        .order-card .btn-primary,
        .order-card .btn-success,
        .order-card .btn-info,
        .order-card button {
            pointer-events: auto;
        }
    </style>
    </head>
    <body class="bg-gray-50 min-h-screen">
    <header class="bg-white shadow-sm">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center space-x-4">
                    <div class="w-12 h-12 bg-gradient-to-br from-yellow-400 to-yellow-600 rounded-xl flex items-center justify-center shadow-md">
                        <i class="fas fa-hamburger text-white text-xl"></i>
                    </div>
                    <div>
                        <div class="font-poppins text-lg font-bold">SR &amp; SRA BURGER</div>
                        <div class="text-xs text-gray-500">Modo Cocina</div>
                    </div>
                </div>
                <div class="flex items-center gap-2">
                    <button onclick="toggleKitchenMode()" class="btn-primary">Modo Cocina</button>
                    <button onclick="toggleFullscreen()" class="btn-info">Pantalla Completa</button>
                    <button onclick="zoomOut()" class="btn-primary" title="Reducir tama√±o">A-</button>
                    <button onclick="zoomIn()" class="btn-primary" title="Aumentar tama√±o">A+</button>
                    <button onclick="refreshOrders()" class="btn-primary">
                        <i class="fas fa-sync-alt mr-1"></i>Actualizar
                    </button>
                    <a href="repartidor.html" class="btn-success">
                        <i class="fas fa-motorcycle mr-1"></i>Repartidor
                    </a>
                    <a href="paginaburger.html" class="btn-info">
                        <i class="fas fa-arrow-left mr-1"></i>Volver al Men√∫
                    </a>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Stats Cards -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="card-modern text-center">
                <div class="w-12 h-12 bg-yellow-100 rounded-xl flex items-center justify-center mx-auto mb-3">
                    <i class="fas fa-clock text-yellow-600 text-xl"></i>
                </div>
                <h3 class="text-2xl font-bold text-gray-900" id="pending-count">0</h3>
                <p class="text-gray-600 font-medium">Pendientes</p>
            </div>
            <div class="card-modern text-center">
                <div class="w-12 h-12 bg-blue-100 rounded-xl flex items-center justify-center mx-auto mb-3">
                    <i class="fas fa-utensils text-blue-600 text-xl"></i>
                </div>
                <h3 class="text-2xl font-bold text-gray-900" id="preparing-count">0</h3>
                <p class="text-gray-600 font-medium">Preparando</p>
            </div>
            <div class="card-modern text-center">
                <div class="w-12 h-12 bg-green-100 rounded-xl flex items-center justify-center mx-auto mb-3">
                    <i class="fas fa-truck text-green-600 text-xl"></i>
                </div>
                <h3 class="text-2xl font-bold text-gray-900" id="delivering-count">0</h3>
                <p class="text-gray-600 font-medium">En Camino</p>
            </div>
            <div class="card-modern text-center">
                <div class="w-12 h-12 bg-gray-100 rounded-xl flex items-center justify-center mx-auto mb-3">
                    <i class="fas fa-check-circle text-gray-600 text-xl"></i>
                </div>
                <h3 class="text-2xl font-bold text-gray-900" id="completed-count">0</h3>
                <p class="text-gray-600 font-medium">Completados</p>
            </div>
        </div>

        <!-- Filter Buttons -->
        <div class="mb-8">
            <div class="flex flex-wrap gap-3">
                <button onclick="filterOrders('all')" class="filter-btn btn-primary active" data-filter="all">
                    <i class="fas fa-list mr-2"></i>Todos
                </button>
                <button onclick="filterOrders('pending')" class="filter-btn btn-info" data-filter="pending">
                    <i class="fas fa-clock mr-2"></i>Pendientes
                </button>
                <button onclick="filterOrders('preparing')" class="filter-btn btn-info" data-filter="preparing">
                    <i class="fas fa-utensils mr-2"></i>Preparando
                </button>
                <button onclick="filterOrders('delivering')" class="filter-btn btn-info" data-filter="delivering">
                    <i class="fas fa-truck mr-2"></i>En Camino
                </button>
                <a href="Historialdepedidos.html" class="filter-btn btn-info inline-flex items-center" data-filter="history">
                    <i class="fas fa-clock-rotate-left mr-2"></i>Historial
                </a>
            </div>
        </div>

        <!-- Orders Container -->
        <div id="orders-container" class="space-y-6">
            <!-- Las √≥rdenes se cargar√°n aqu√≠ din√°micamente -->
        </div>

        <!-- Empty State -->
        <div id="empty-state" class="text-center py-16 hidden">
            <div class="w-24 h-24 bg-gray-100 rounded-xl flex items-center justify-center mx-auto mb-6">
                <i class="fas fa-inbox text-gray-400 text-3xl"></i>
            </div>
            <h3 class="text-xl font-bold text-gray-600 mb-2">No hay pedidos</h3>
            <p class="text-gray-500">Los nuevos pedidos aparecer√°n aqu√≠ autom√°ticamente.</p>
        </div>
    </main>

    <!-- Floating Stats (Mobile) -->
    <div class="floating-stats md:hidden">
        <div class="flex justify-between items-center">
            <div class="text-center">
                <div class="text-lg font-bold text-yellow-600" id="mobile-pending">0</div>
                <div class="text-xs text-gray-600">Pendientes</div>
            </div>
            <div class="text-center">
                <div class="text-lg font-bold text-blue-600" id="mobile-preparing">0</div>
                <div class="text-xs text-gray-600">Preparando</div>
            </div>
            <div class="text-center">
                <div class="text-lg font-bold text-green-600" id="mobile-delivering">0</div>
                <div class="text-xs text-gray-600">En Camino</div>
            </div>
        </div>
    </div>

    <!-- Notification Toast -->
    <div id="notification" class="notification"></div>

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay hidden">
        <div class="loading-spinner"></div>
    </div>

    <!-- Firebase Configuration -->
    <script type="module" src="js/firebase-config.js"></script>
    
    <script>
        // Variables globales
        let orders = [];
        let currentFilter = 'all';
        let unsubscribeOrders = null;
        let baseFontPx = parseInt(localStorage.getItem('kitchenBaseFontPx') || '22', 10); // default 22px
        let comboConfigurations = {}; // Configuraciones de combos
        let localAutoRefreshId = null;

        // === Notificaci√≥n de nuevo pedido (sonido + voz, repetitivo hasta confirmar) ===
        let _knownOrderIds = new Set();
        let _orderNotifierInitialized = false;
        let _newOrderAlertIntervalId = null;
        let _notifAudioCtx = null;
        let _audioUnlocked = false;

        function ensureAudioUnlocked() {
            if (_audioUnlocked) return;
            _audioUnlocked = true;
            try {
                const Ctx = window.AudioContext || window.webkitAudioContext;
                if (Ctx && !_notifAudioCtx) _notifAudioCtx = new Ctx();
                if (_notifAudioCtx && _notifAudioCtx.state === 'suspended') {
                    _notifAudioCtx.resume().catch(() => {});
                }
            } catch (_) {}
        }

        // Muchos navegadores requieren una interacci√≥n del usuario para audio.
        document.addEventListener('pointerdown', ensureAudioUnlocked, { once: true });

        function shouldAlertForOrder(order) {
            if (!order) return false;
            if (isOrderCanceled(order)) return false;
            const status = String(order.status || '').toLowerCase();
            const confirmed = !!order.confirmed;
            return status === 'pending' && !confirmed;
        }

        function hasAnyUnconfirmedPending(list) {
            const arr = Array.isArray(list) ? list : [];
            return arr.some(shouldAlertForOrder);
        }

        function isRecentOrder(order, withinMs = 120000) {
            try {
                const t = Date.parse(order && order.timestamp ? String(order.timestamp) : '');
                if (!Number.isFinite(t)) return false;
                return (Date.now() - t) >= 0 && (Date.now() - t) <= withinMs;
            } catch (_) {
                return false;
            }
        }

        function speakNewOrder() {
            try {
                if (!('speechSynthesis' in window)) return;
                // Intentar desbloquear audio primero
                ensureAudioUnlocked();

                const phrase = 'Ha llegado un nuevo pedido';
                const u = new SpeechSynthesisUtterance(phrase);
                u.lang = 'es-MX';
                u.rate = 1;
                u.pitch = 1;
                u.volume = 1;

                const voices = window.speechSynthesis.getVoices ? window.speechSynthesis.getVoices() : [];
                const esVoice = (voices || []).find(v => String(v.lang || '').toLowerCase().startsWith('es'));
                if (esVoice) u.voice = esVoice;

                // Cancelar cualquier cosa en cola y hablar
                try { window.speechSynthesis.cancel(); } catch (_) {}
                window.speechSynthesis.speak(u);
            } catch (e) {
                // No bloquear la UI si falla
                console.warn('No se pudo reproducir voz:', e);
            }
        }

        function startNewOrderAlert() {
            if (_newOrderAlertIntervalId) return;

            // Si a√∫n no hay interacci√≥n, avisar una sola vez
            if (!_audioUnlocked) {
                showNotification('Nuevo pedido. Toca la pantalla para activar sonido.', 'success');
            }

            const tick = () => {
                // Si ya no hay pendientes sin confirmar, parar
                if (!hasAnyUnconfirmedPending(orders)) {
                    stopNewOrderAlert();
                    return;
                }
                playNotificationSound();
                speakNewOrder();
            };

            // Ejecutar inmediato y luego repetir
            tick();
            _newOrderAlertIntervalId = setInterval(tick, 8000);
        }

        function stopNewOrderAlert() {
            if (_newOrderAlertIntervalId) {
                try { clearInterval(_newOrderAlertIntervalId); } catch (_) {}
                _newOrderAlertIntervalId = null;
            }
            try {
                if ('speechSynthesis' in window) window.speechSynthesis.cancel();
            } catch (_) {}
        }

        function syncNewOrderNotifier(incomingOrders) {
            const arr = Array.isArray(incomingOrders) ? incomingOrders : [];
            const incomingIds = new Set(arr.map(o => String(o.id || '')));

            if (!_orderNotifierInitialized) {
                _orderNotifierInitialized = true;
                _knownOrderIds = incomingIds;

                // Si al abrir la p√°gina hay un pedido MUY reciente pendiente sin confirmar, alertar.
                const hasRecent = arr.some(o => shouldAlertForOrder(o) && isRecentOrder(o, 120000));
                if (hasRecent) startNewOrderAlert();
                return;
            }

            const newPending = arr.filter(o => {
                const id = String(o.id || '');
                return id && !_knownOrderIds.has(id) && shouldAlertForOrder(o);
            });

            _knownOrderIds = incomingIds;

            if (newPending.length) {
                showNotification('¬°Ha llegado un nuevo pedido!', 'success');
                startNewOrderAlert();
            } else {
                // Sin nuevos, pero tal vez ya se confirmaron todos
                if (!hasAnyUnconfirmedPending(arr)) stopNewOrderAlert();
            }
        }

        // Inicializar Modo Cocina por defecto para facilitar lectura
        document.addEventListener('DOMContentLoaded', () => {
            const enabled = localStorage.getItem('kitchenMode') !== '0'; // por defecto ON
            if (enabled) document.documentElement.classList.add('kitchen-mode');
            // Aplicar tama√±o base guardado
            applyFontSize(baseFontPx);
        });

        function applyFontSize(px) {
            baseFontPx = Math.max(16, Math.min(24, px)); // limitar entre 16 y 24 px
            if (document.documentElement.classList.contains('kitchen-mode')) {
                document.documentElement.style.fontSize = baseFontPx + 'px';
            } else {
                document.documentElement.style.fontSize = '16px';
            }
            localStorage.setItem('kitchenBaseFontPx', String(baseFontPx));
        }

        function toggleKitchenMode() {
            const root = document.documentElement;
            const willEnable = !root.classList.contains('kitchen-mode');
            root.classList.toggle('kitchen-mode', willEnable);
            localStorage.setItem('kitchenMode', willEnable ? '1' : '0');
            // Reaplicar tama√±o
            applyFontSize(willEnable ? baseFontPx : 16);
        }

        function zoomIn() { applyFontSize(baseFontPx + 2); }
        function zoomOut() { applyFontSize(baseFontPx - 2); }

        async function toggleFullscreen() {
            try {
                if (!document.fullscreenElement) {
                    await document.documentElement.requestFullscreen();
                } else {
                    await document.exitFullscreen();
                }
            } catch (_) {}
        }

        // Cargar configuraciones de combos
        function loadComboConfigurations() {
            const savedCombos = localStorage.getItem('burgerCombos');
            if (savedCombos) {
                const combos = JSON.parse(savedCombos);
                comboConfigurations = {};
                combos.forEach(combo => {
                    comboConfigurations[combo.name.toLowerCase().replace(/\s+/g, '')] = combo;
                });
                console.log('üìã Configuraciones de combos cargadas:', comboConfigurations);
            } else {
                // Configuraciones por defecto con todos los combos
                comboConfigurations = {
                    'combofamiliar': {
                        name: 'Combo Familiar',
                        type: 'familiar',
                        color: 'amber',
                        items: [
                            { type: 'fries', name: 'Papas Grandes', quantity: 1, icon: 'üçü' },
                            { type: 'onion-rings', name: 'Aros Medianos', quantity: 1, icon: 'üßÖ' },
                            { type: 'drink', name: 'Coca-Cola 3L', quantity: 1, icon: 'ü•§' }
                        ]
                    },
                    'comboduo': {
                        name: 'Combo D√∫o',
                        type: 'duo',
                        color: 'purple',
                        items: [
                            { type: 'burger', name: 'Hamburguesa', quantity: 1, icon: 'üçî' },
                            { type: 'hotdog', name: 'Hot Dog Jumbo', quantity: 1, icon: 'üå≠' },
                            { type: 'fries', name: 'Papas Medianas', quantity: 1, icon: 'üçü' }
                        ]
                    },
                    'combopareja': {
                        name: 'Combo Pareja',
                        type: 'pareja',
                        color: 'pink',
                        items: [
                            { type: 'burger', name: 'Hamburguesa', quantity: 2, icon: 'üçî' },
                            { type: 'fries', name: 'Papas Medianas', quantity: 1, icon: 'üçü' },
                            { type: 'onion-rings', name: 'Aros de Cebolla', quantity: 1, icon: 'üßÖ' }
                        ]
                    },
                    'comboamigos': {
                        name: 'Combo Amigos',
                        type: 'amigos',
                        color: 'green',
                        items: [
                            { type: 'burger', name: 'Hamburguesa', quantity: 3, icon: 'üçî' },
                            { type: 'fries', name: 'Papas Medianas', quantity: 1, icon: 'üçü' }
                        ]
                    },
                    'combodoblesdobles': {
                        name: 'DOBLES DOBLES',
                        type: 'dobles',
                        color: 'red',
                        items: [
                            { type: 'burger', name: 'Hamburguesa Doble', quantity: 2, icon: 'üçî' }
                        ]
                    },
                    'combodoblesdoblesbbq': {
                        name: 'DOBLES DOBLES BBQ',
                        type: 'bbq',
                        color: 'orange',
                        items: [
                            { type: 'burger', name: 'Hamburguesa BBQ', quantity: 2, icon: 'üçî' }
                        ]
                    }
                };
                console.log('üìã Usando configuraciones por defecto con todos los combos:', comboConfigurations);
            }
        }

        // Funci√≥n para detectar si un item es un combo y obtener su configuraci√≥n
        function getComboConfig(itemName) {
            if (!comboConfigurations) return null;
            
            // Normalizar el nombre del item para comparaci√≥n
            const normalizedName = itemName.toLowerCase().trim();
            
            // Buscar en las configuraciones de combos
            for (const [key, config] of Object.entries(comboConfigurations)) {
                if (normalizedName.includes(key) || 
                    normalizedName.includes(config.name.toLowerCase())) {
                    return { ...config, key };
                }
            }
            
            return null;
        }

        function splitComboChoices(text) {
            return String(text || '').split(/\s*\|\s*/).filter(Boolean);
        }
        function parseChoiceText(choiceText) {
            const res = { name: '', qty: 1, toppings: [], fries: null, sauce: null, onionRings: false, extras: [], includeLine: false, drinks: [] };
            let t = String(choiceText || '').trim();
            const qtyMatch = t.match(/^(\d+)\s*x\s*/i);
            if (qtyMatch) { res.qty = parseInt(qtyMatch[1], 10) || 1; t = t.slice(qtyMatch[0].length).trim(); }
            const nameMatch = t.match(/^[^,(]+/);
            res.name = nameMatch ? nameMatch[0].trim() : t;
            if (/^Incluye\s*:/i.test(String(choiceText || ''))) {
                res.includeLine = true;
            }
            const topMatch = t.match(/\(\+\s*([^\)]+)\)/);
            if (topMatch && topMatch[1]) res.toppings = topMatch[1].split(/\s*,\s*/).filter(Boolean);
            const friesMatch = t.match(/Papas\s*(?::|\s)\s*([^,]+)/i);
            if (friesMatch) res.fries = friesMatch[1].trim();
            const sauceMatch = t.match(/Salsas?\s*:\s*([^,|\)]+)/i);
            if (sauceMatch) res.sauce = sauceMatch[1].trim();
            if (/Aros\s+de\s+Cebolla/i.test(t)) res.onionRings = true;
            
            // Mejorar detecci√≥n de Coca-Cola
            const cocaMatch = t.match(/Coca(?:-Cola)?\s*([\d.,]+)\s*[Ll]/i);
            if (cocaMatch) {
                res.drinks.push(`Coca-Cola ${cocaMatch[1]}L`);
            } else if (/Coca(?:-Cola)?\s*3\s*[Ll]/i.test(t)) {
                res.drinks.push('Coca-Cola 3L');
            } else if (/Coca(?:-Cola)/i.test(t)) {
                res.drinks.push('Coca-Cola');
            }
            
            const extraItems = t.match(/\b(\d+)x\s+([^,|]+)/g);
            if (extraItems) {
                extraItems.forEach(e => { const m = e.match(/(\d+)x\s+(.+)/); if (m) res.extras.push({ quantity: parseInt(m[1], 10), name: m[2].trim() }); });
            }
            return res;
        }

        // Escapar texto para evitar inyectar HTML en nombres de productos/toppings
        function escapeHtml(text) {
            const str = String(text == null ? '' : text);
            return str
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
        }

        function parseSingleDetails(text) {
            const res = { toppings: [], fries: null, sauce: null, onionRings: false, extras: [], hotdog: false };
            const parts = String(text || '').split(/\s*,\s*/).map(s => s.trim()).filter(Boolean);
            parts.forEach(p => {
                if (/^\+\s*/.test(p)) {
                    const tops = p.replace(/^\+\s*/, '').split(/\s*,\s*/).filter(Boolean);
                    res.toppings.push(...tops);
                } else if (/^Papas\s*(?::|\s)/i.test(p)) {
                    res.fries = p.replace(/^Papas\s*(?::|\s)\s*/i, '').trim();
                } else if (/^Salsas?\s*:/i.test(p)) {
                    res.sauce = p.replace(/^Salsas?\s*:\s*/i, '').trim();
                } else if (/^Salsa\s*:/i.test(p)) {
                    res.sauce = p.replace(/^Salsa\s*:\s*/i, '').trim();
                } else if (/Aros\s+de\s+Cebolla/i.test(p)) {
                    res.onionRings = true;
                } else if (/Hot\s*dog/i.test(p) || /Perro\s+caliente/i.test(p)) {
                    res.hotdog = true;
                } else if (/^\d+x\s+/i.test(p)) {
                    const m = p.match(/(\d+)x\s+(.+)/); 
                    if (m) {
                        const extraName = m[2].trim();
                        // Detectar Coca-Cola espec√≠ficamente
                        if (/Coca(?:-Cola)?/i.test(extraName)) {
                            res.extras.push({ quantity: parseInt(m[1], 10), name: 'Coca-Cola 3L' });
                        } else {
                            res.extras.push({ quantity: parseInt(m[1], 10), name: extraName });
                        }
                    }
                } else if (/Coca(?:-Cola)?/i.test(p)) {
                    // Detectar Coca-Cola en cualquier parte del texto
                    res.extras.push({ quantity: 1, name: 'Coca-Cola 3L' });
                }
            });
            return res;
        }
        function renderBadges(list, color, orderId, itemIndex, subKey) {
            if (!list || !list.length) return '';
            const cls = color === 'green' ? 'bg-green-100 text-green-800 border-green-200' : 
                       color === 'blue' ? 'bg-blue-100 text-blue-800 border-blue-200' : 
                       color === 'amber' ? 'bg-amber-100 text-amber-800 border-amber-200' :
                       color === 'red' ? 'bg-red-100 text-red-800 border-red-200' :
                       color === 'orange' ? 'bg-orange-100 text-orange-800 border-orange-200' :
                       color === 'purple' ? 'bg-purple-100 text-purple-800 border-purple-200' :
                       color === 'pink' ? 'bg-pink-100 text-pink-800 border-pink-200' :
                       'bg-gray-100 text-gray-800 border-gray-200';
            return `<div class="mt-1 flex flex-wrap gap-1">${list.map((v, idx) => {
                const key = subKey ? `${subKey}_${idx}` : `badge_${idx}`;
                const isChecked = isItemChecked(orderId, itemIndex, key);
                return `<span class="text-xs px-2 py-0.5 rounded-full border breakdown-item ${cls} ${isChecked ? 'checked' : ''}" onclick="event.stopPropagation(); toggleItemChecked('${orderId}', ${itemIndex}, '${key}')">${escapeHtml(v)}</span>`;
            }).join('')}</div>`;
        }
        function renderItemBreakdown(item, orderId, itemIndex) {
            const c = String(item.customizations || '').trim();
            if (!c) return '';

            // Detectar si es un combo configurado
            const comboConfig = getComboConfig(item.name);

            // Si es combo: mantener checklist visual + tambi√©n mostrar detalles (papas/salsas/etc.)
            const comboChecklistHtml = comboConfig ? (() => {
                return `
                    <div class="mt-2 p-3 rounded-lg border-2 border-${comboConfig.color}-200 bg-${comboConfig.color}-50">
                        <div class="text-sm text-gray-700 font-semibold mb-2 flex items-center">
                            <i class="fas fa-${comboConfig.type === 'duo' ? 'users' : 'box'} text-${comboConfig.color}-600 mr-2"></i>
                            Elementos del ${comboConfig.name}:
                        </div>
                        <div class="space-y-2">
                            ${comboConfig.items.map((comboItem, idx) => {
                                const itemKey = `${comboConfig.key}_${comboItem.type}_${idx}`;
                                const isChecked = isItemChecked(orderId, itemIndex, itemKey);
                                const colorMap = {
                                    'amber': 'yellow',
                                    'purple': 'purple',
                                    'blue': 'blue',
                                    'green': 'green',
                                    'red': 'red',
                                    'orange': 'orange',
                                    'pink': 'pink'
                                };
                                const badgeColor = colorMap[comboConfig.color] || 'gray';
                                return `
                                    <div class="flex items-center space-x-2">
                                        <span class="text-xs text-gray-600 font-medium">${comboItem.icon} ${comboItem.name}:</span>
                                        <span class="text-xs px-2 py-0.5 rounded-full border bg-${badgeColor}-100 text-${badgeColor}-800 border-${badgeColor}-200 breakdown-item ${isChecked ? 'checked' : ''}" onclick="event.stopPropagation(); toggleItemChecked('${orderId}', ${itemIndex}, '${itemKey}')">Listo</span>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            })() : '';
            
            let detailsHtml = '';

            if (c.includes(' | ')) {
                const choices = splitComboChoices(c).map(parseChoiceText);
                const includePieces = choices.filter(ch => ch.includeLine || /^Incluye/i.test(ch.name));
                const normalChoices = choices.filter(ch => !(ch.includeLine || /^Incluye/i.test(ch.name)));

                // Aggregate included details
                const friesBadges = [];
                const sauceBadges = [];
                const drinkBadges = [];
                let hasOnion = false;
                includePieces.forEach(ch => {
                    if (ch.fries) friesBadges.push(`Tipo ${ch.fries}`);
                    if (ch.sauce) sauceBadges.push(ch.sauce);
                    if (ch.drinks && ch.drinks.length) drinkBadges.push(...ch.drinks);
                    if (ch.onionRings) hasOnion = true;
                });

                return `
                    <div class="mt-2 space-y-2">
                        ${normalChoices.map((ch, chIdx) => `
                            <div class="p-2 rounded-lg border border-gray-200 bg-white">
                                <div class="text-sm font-semibold text-gray-800">${ch.qty}x ${escapeHtml(ch.name)}</div>
                                ${ch.toppings && ch.toppings.length ? `<div class=\"text-xs text-gray-600 mt-1\"><span class=\"font-semibold\">Toppings:</span>${renderBadges(ch.toppings, 'amber', orderId, itemIndex, 'toppings_' + chIdx)}</div>` : ''}
                                ${ch.fries ? `<div class=\"text-xs text-gray-600 mt-1\"><span class=\"font-semibold\">Papas:</span>${renderBadges([`Tipo ${ch.fries}`], 'blue', orderId, itemIndex, 'fries_' + chIdx)}</div>` : ''}
                                ${ch.sauce ? `<div class=\"text-xs text-gray-600 mt-1\"><span class=\"font-semibold\">Salsa:</span>${renderBadges([ch.sauce], 'pink', orderId, itemIndex, 'sauce_' + chIdx)}</div>` : ''}
                                ${ch.onionRings ? `<div class=\"text-xs text-gray-600 mt-1\"><span class=\"font-semibold\">Acompa√±amientos:</span>${renderBadges(['Aros de Cebolla'], 'green', orderId, itemIndex, 'onion_' + chIdx)}</div>` : ''}
                                ${ch.extras && ch.extras.length ? `<div class=\"text-xs text-gray-600 mt-1\"><span class=\"font-semibold\">Extras:</span>${renderBadges(ch.extras.map(e => `${e.quantity}x ${e.name}`), 'amber', orderId, itemIndex, 'extras_' + chIdx)}</div>` : ''}
                            </div>
                        `).join('')}
                        ${includePieces.length ? `
                            <div class=\"p-3 rounded-lg border-2 border-amber-200 bg-amber-50\">
                                <div class=\"text-sm text-gray-700 font-semibold mb-2 flex items-center\">
                                    <i class=\"fas fa-box text-amber-600 mr-2\"></i>
                                    ${comboConfig ? `Elementos del ${comboConfig.name}:` : 'Incluye:'}
                                </div>
                                <div class=\"space-y-2\">
                                    ${friesBadges.length ? `<div class=\"flex items-center space-x-2\"><span class=\"text-xs text-gray-600 font-medium\">üçü Papas:</span>${renderBadges(friesBadges, 'blue', orderId, itemIndex, 'include_fries')}</div>` : ''}
                                    ${sauceBadges.length ? `<div class=\"flex items-center space-x-2\"><span class=\"text-xs text-gray-600 font-medium\">ü•´ Salsa:</span>${renderBadges([sauceBadges[0]], 'pink', orderId, itemIndex, 'include_sauce')}</div>` : ''}
                                    ${hasOnion ? `<div class=\"flex items-center space-x-2\"><span class=\"text-xs text-gray-600 font-medium\">üßÖ Aros de Cebolla Medianos:</span>${renderBadges(['Listo'], 'green', orderId, itemIndex, 'include_onion')}</div>` : ''}
                                    ${drinkBadges.length ? `<div class=\"flex items-center space-x-2\"><span class=\"text-xs text-gray-600 font-medium\">ü•§ Coca-Cola 3L:</span>${renderBadges(['Listo'], 'green', orderId, itemIndex, 'include_drinks')}</div>` : ''}
                                </div>
                            </div>
                        ` : ''}
                    </div>
                `;
            }
            
            // Para items individuales o combos simples
            const d = parseSingleDetails(c);
            
            return `
                <div class="mt-1">
                    ${d.toppings && d.toppings.length ? `<div class=\"text-xs text-gray-600 mt-1\"><span class=\"font-semibold\">Toppings:</span>${renderBadges(d.toppings, 'amber', orderId, itemIndex, 'toppings')}</div>` : ''}
                    ${d.fries ? `<div class=\"text-xs text-gray-600 mt-1\"><span class=\"font-semibold\">Papas:</span>${renderBadges([`Tipo ${d.fries}`], 'blue', orderId, itemIndex, 'fries')}</div>` : ''}
                    ${d.sauce ? `<div class=\"text-xs text-gray-600 mt-1\"><span class=\"font-semibold\">Salsa:</span>${renderBadges([d.sauce], 'pink', orderId, itemIndex, 'sauce')}</div>` : ''}
                    ${d.onionRings ? `<div class=\"text-xs text-gray-600 mt-1\"><span class=\"font-semibold\">Acompa√±amientos:</span>${renderBadges(['Aros de Cebolla'], 'green', orderId, itemIndex, 'onion')}</div>` : ''}
                    ${d.extras && d.extras.length ? `<div class=\"text-xs text-gray-600 mt-1\"><span class=\"font-semibold\">Extras:</span>${renderBadges(d.extras.map(e => `${e.quantity}x ${e.name}`), 'amber', orderId, itemIndex, 'extras')}</div>` : ''}
                </div>
            `;
        }

        // === Checklist Functions ===
        function getCheckedItems(orderId) {
            const key = `checkedItems_${orderId}`;
            const stored = localStorage.getItem(key);
            return stored ? JSON.parse(stored) : {};
        }

        function saveCheckedItems(orderId, checkedItems) {
            const key = `checkedItems_${orderId}`;
            localStorage.setItem(key, JSON.stringify(checkedItems));
        }

        function toggleItemChecked(orderId, itemIndex, subItemKey = null) {
            const checkedItems = getCheckedItems(orderId);
            const key = subItemKey ? `${itemIndex}_${subItemKey}` : itemIndex.toString();
            checkedItems[key] = !checkedItems[key];
            saveCheckedItems(orderId, checkedItems);
            displayOrders(); // Refresh display
        }

        function isItemChecked(orderId, itemIndex, subItemKey = null) {
            const checkedItems = getCheckedItems(orderId);
            const key = subItemKey ? `${itemIndex}_${subItemKey}` : itemIndex.toString();
            return !!checkedItems[key];
        }

        // Inicializar la p√°gina
        document.addEventListener('DOMContentLoaded', function() {
            // Cargar combos (no depende de Firebase)
            loadComboConfigurations();

            // Esperar a que Firebase (m√≥dulo) exponga window.firebaseOrderManager
            waitForFirebaseAndInit();
        });

        function waitForFirebaseAndInit(attempt = 0) {
            // Ya conectado
            if (unsubscribeOrders) return;

            if (window.firebaseOrderManager && typeof window.firebaseOrderManager.onOrdersChange === 'function') {
                initializeFirebase();
                return;
            }

            // Intentar por ~15s (60 * 250ms)
            if (attempt === 0) {
                console.log('‚è≥ Esperando Firebase...');
                showNotification('Conectando con Firebase...', 'success');
            }

            if (attempt < 60) {
                setTimeout(() => waitForFirebaseAndInit(attempt + 1), 250);
                return;
            }

            // Si no apareci√≥ Firebase, usar modo local
            console.warn('‚ö†Ô∏è Firebase no disponible tras esperar. Usando modo local.');
            showNotification('Firebase no disponible. Usando modo local.', 'error');
            loadOrdersFromLocalStorage();
            setupAutoRefresh();
        }

        // Inicializar Firebase
        function initializeFirebase() {
            if (unsubscribeOrders) return;

            if (window.firebaseOrderManager) {
                console.log('üî• Conectando con Firebase...');

                // Si ven√≠amos de modo local, apagar auto-refresh
                if (localAutoRefreshId) {
                    try { clearInterval(localAutoRefreshId); } catch (_) {}
                    localAutoRefreshId = null;
                }
                
                // Configurar listener en tiempo real
                unsubscribeOrders = window.firebaseOrderManager.onOrdersChange((firebaseOrders) => {
                    console.log('üì• Pedidos recibidos de Firebase:', firebaseOrders.length);
                    orders = firebaseOrders;
                    // Detectar llegada de nuevos pedidos y disparar alerta
                    syncNewOrderNotifier(orders);
                    displayOrders();
                    updateStats();
                });
                
                showNotification('Conectado a Firebase - Datos en tiempo real', 'success');
            } else {
                console.warn('‚ö†Ô∏è Firebase no disponible, usando datos locales');
                loadOrdersFromLocalStorage();
                setupAutoRefresh();
            }
        }

        // Cargar √≥rdenes desde localStorage (fallback)
        function loadOrdersFromLocalStorage() {
            const savedOrders = localStorage.getItem('orders');
            if (savedOrders) {
                orders = JSON.parse(savedOrders);
            } else {
                // Crear √≥rdenes de ejemplo si no hay datos
                createSampleOrders();
            }
            displayOrders();
            updateStats();
        }

        // Guardar √≥rdenes en localStorage (fallback)
        function saveOrdersToLocalStorage() {
            localStorage.setItem('orders', JSON.stringify(orders));
        }

        // Agregar nueva orden (llamada desde paginaburger.html - mantener compatibilidad)
        function addOrder(orderData) {
            if (window.firebaseOrderManager) {
                // Usar Firebase
                window.firebaseOrderManager.addOrder(orderData)
                    .then((orderId) => {
                        console.log('‚úÖ Pedido agregado a Firebase:', orderId);
                        showNotification('Nuevo pedido recibido!', 'success');
                        playNotificationSound();
                        startNewOrderAlert();
                    })
                    .catch((error) => {
                        console.error('‚ùå Error al agregar pedido a Firebase:', error);
                        showNotification('Error al procesar pedido', 'error');
                    });
            } else {
                // Fallback a localStorage
                const newOrder = {
                    id: Date.now().toString(),
                    timestamp: new Date().toISOString(),
                    status: 'pending',
                    customer: orderData.customer,
                    items: orderData.items,
                    total: orderData.total,
                    notes: orderData.notes || '',
                    estimatedTime: calculateEstimatedTime(orderData.items),
                    confirmed: false,
                    onWaySent: false,
                    arrivedSent: false,
                    paid: false,
                    paidAt: null
                };
                
                orders.unshift(newOrder);
                saveOrdersToLocalStorage();
                displayOrders();
                updateStats();
                showNotification('Nuevo pedido recibido!', 'success');
                playNotificationSound();
                startNewOrderAlert();
            }
        }

        // Determinar si una orden est√° cancelada (por status o bandera)
        function isOrderCanceled(order) {
            if (!order) return false;
            if (order.canceled || order.cancelled) return true;
            const s = String(order.status || '').toLowerCase();
            return s.includes('cancel'); // 'canceled', 'cancelled', 'cancelado'
        }

        // Mostrar √≥rdenes
        function displayOrders() {
            const container = document.getElementById('orders-container');
            const emptyState = document.getElementById('empty-state');
            
            // Ocultar siempre las √≥rdenes canceladas
            let filteredOrders = orders.filter(o => !isOrderCanceled(o) && String(o.status || '').toLowerCase() !== 'delivered');
            if (currentFilter !== 'all') {
                filteredOrders = filteredOrders.filter(order => order.status === currentFilter);
            }

            if (filteredOrders.length === 0) {
                container.innerHTML = '';
                emptyState.classList.remove('hidden');
                return;
            }

            emptyState.classList.add('hidden');
            container.innerHTML = filteredOrders.map(order => createOrderCard(order)).join('');
        }

        // Crear tarjeta de orden
        function createOrderCard(order) {
            const statusInfo = getStatusInfo(order.status);
            const timeAgo = getTimeAgo(order.timestamp);
            const customer = order && order.customer ? order.customer : {};
            const items = Array.isArray(order.items) ? order.items : [];

            return `
                <div class="order-card card-modern" data-order-id="${order.id}" data-status="${order.status}">
                    <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
                        <!-- Order Info -->
                        <div class="flex-1">
                            <div class="flex items-center justify-between mb-3">
                                <div class="flex items-center space-x-3">
                                    <h3 class="text-lg font-bold text-gray-900">Pedido #${String(order.id || '').slice(-6)}</h3>
                                    <span class="status-badge ${statusInfo.class}">${statusInfo.text}</span>
                                </div>
                                <div class="text-sm text-gray-500">${timeAgo}</div>
                            </div>

                            <!-- Customer Info -->
                            <div class="customer-info mb-4">
                                <div class="flex items-center space-x-3 mb-2">
                                    <i class="fas fa-user text-yellow-600"></i>
                                    <span class="font-semibold text-gray-900">${escapeHtml(customer.name || '')}</span>
                                </div>
                                <div class="flex items-center space-x-3 mb-2">
                                    <i class="fas fa-phone text-yellow-600"></i>
                                    <span class="text-gray-700">${escapeHtml(customer.phone || '')}</span>
                                </div>
                                <div class="flex items-center space-x-3">
                                    <i class="fas fa-map-marker-alt text-yellow-600"></i>
                                    <span class="text-gray-700">${escapeHtml(customer.address || '')}</span>
                                </div>
                            </div>

                            <!-- Order Items -->
                            <div class="mb-4 order-products">
                                <h4 class="font-semibold text-gray-900 mb-2">
                                    <i class="fas fa-shopping-bag text-gray-600 mr-2"></i>
                                    Productos (${items.length} items)
                                </h4>
                                <div class="space-y-2">
                                    ${items.map((item, itemIndex) => `
                                        <div class="order-item ${isItemChecked(order.id, itemIndex) ? 'checked' : ''}" onclick="toggleItemChecked('${order.id}', ${itemIndex})">
                                            <div class="flex justify-between items-start gap-3">
                                                <div class="min-w-0 flex-1">
                                                    <div class="item-title">${Number(item.quantity || 1)}x ${escapeHtml(item.name || '')}</div>
                                                    <div class="checkmark"><i class="fas fa-check"></i></div>
                                                    <div class="breakdown" onclick="event.stopPropagation()">${item.customizations ? renderItemBreakdown(item, order.id, itemIndex) : ''}</div>
                                                    ${item.specifications ? `<div class=\"mt-1 text-xs text-red-700 font-semibold flex items-start gap-1\"><span>üìù</span><span>Especificaciones: ${escapeHtml(item.specifications)}</span></div>` : ''}
                                                </div>
                                                <div class="text-right whitespace-nowrap">
                                                    <span class="item-price">$${Number(item.price || 0)}</span>
                                                </div>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                                <div class="mt-3 pt-3 border-t border-gray-200">
                                    <div class="flex justify-between items-center">
                                        <span class="text-lg font-bold text-gray-900">Total:</span>
                                        <span class="text-xl font-bold text-yellow-600 amount">$${Number(order.total || 0)}</span>
                                    </div>
                                </div>
                            </div>

                            ${order.notes ? `
                                <div class="mb-4 p-3 bg-blue-50 border border-blue-200 rounded-lg">
                                    <h5 class="font-semibold text-blue-900 mb-1">
                                        <i class="fas fa-sticky-note text-blue-600 mr-2"></i>
                                        Notas especiales:
                                    </h5>
                                    <p class="text-blue-800">${escapeHtml(order.notes)}</p>
                                </div>
                            ` : ''}
                        </div>

                        <!-- Action Buttons -->
                        <div class="lg:w-64 flex flex-col space-y-3">
                            ${getActionButtons(order)}

                            <!-- Time Info -->
                            <div class="text-center p-3 bg-gray-50 rounded-lg">
                                <div class="text-sm text-gray-600">Tiempo estimado</div>
                                <div class="font-bold text-gray-900">${order.estimatedTime} min</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Obtener informaci√≥n del estado
    function getStatusInfo(status) {
            const statusMap = {
                'pending': { text: 'Pendiente', class: 'status-pending' },
                'preparing': { text: 'Preparando', class: 'status-preparing' },
                'ready': { text: 'Listo', class: 'status-ready' },
                'delivering': { text: 'En Camino', class: 'status-delivering' },
        'delivered': { text: 'Entregado', class: 'status-delivered' },
        'canceled': { text: 'Cancelado', class: 'status-delivered' },
        'cancelled': { text: 'Cancelado', class: 'status-delivered' },
        'cancelado': { text: 'Cancelado', class: 'status-delivered' }
            };
            return statusMap[status] || statusMap['pending'];
        }

        // Obtener botones de acci√≥n seg√∫n el estado
        function getActionButtons(order) {
            const locationButton = `
                <button onclick="viewLocation('${order.id}')" class="btn-primary w-full action-button">
                    <i class="fas fa-location-dot mr-2"></i>
                    Ver ubicaci√≥n
                </button>
            `;

            const paidButton = isOrderCanceled(order) ? '' : `
                <button onclick="markOrderPaid('${order.id}')" class="btn-success w-full ${order.paid ? 'opacity-75 pointer-events-none' : ''}">
                    ${order.paid ? '<i class="fas fa-check mr-2"></i>Pagado ‚úì' : '<i class="fas fa-dollar-sign mr-2"></i>PAGADO'}
                </button>
            `;
            switch (order.status) {
                case 'pending':
                    return `
                        ${locationButton}
                        <button onclick="contactCustomer('${order.id}')" class="btn-info w-full action-button">
                            <i class="fab fa-whatsapp mr-2"></i>
                            Contactar cliente
                        </button>
                        ${paidButton}
                        <button onclick="confirmOrder('${order.id}')" class="btn-success w-full ${order.confirmed ? 'opacity-75 pointer-events-none' : ''}">
                            ${order.confirmed ? '<i class="fas fa-check mr-2"></i>Pedido Confirmado ‚úì' : '<i class="fas fa-clipboard-check mr-2"></i>Confirmar Pedido'}
                        </button>
                        <button onclick="updateOrderStatus('${order.id}', 'preparing')" class="btn-info w-full">
                            <i class="fas fa-utensils mr-2"></i>
                            Empezar a Preparar
                        </button>
                        <button onclick="deleteOrder('${order.id}')" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300 w-full">
                            <i class="fas fa-trash mr-2"></i>
                            Eliminar Pedido
                        </button>
                    `;
                case 'preparing':
                    return `
                        ${locationButton}
                        <button onclick="contactCustomer('${order.id}')" class="btn-info w-full action-button">
                            <i class="fab fa-whatsapp mr-2"></i>
                            Contactar cliente
                        </button>
                        ${paidButton}
                        <button onclick="updateOrderStatus('${order.id}', 'ready')" class="btn-success w-full">
                            <i class="fas fa-check mr-2"></i>
                            Marcar como Listo
                        </button>
                        <button onclick="deleteOrder('${order.id}')" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300 w-full">
                            <i class="fas fa-trash mr-2"></i>
                            Eliminar Pedido
                        </button>
                    `;
                case 'ready':
                    return `
                        ${locationButton}
                        <button onclick="contactCustomer('${order.id}')" class="btn-info w-full action-button">
                            <i class="fab fa-whatsapp mr-2"></i>
                            Contactar cliente
                        </button>
                        ${paidButton}
                        <button onclick="sendOnWayMessage('${order.id}')" class="btn-info w-full ${order.onWaySent ? 'opacity-75' : ''}">
                            ${order.onWaySent ? '<i class="fas fa-check mr-2"></i>En Camino Enviado ‚úì' : '<i class="fas fa-truck mr-2"></i>Vamos en Camino'}
                        </button>
                        <button onclick="updateOrderStatus('${order.id}', 'delivering')" class="btn-success w-full">
                            <i class="fas fa-motorcycle mr-2"></i>
                            Marcar "Saliendo"
                        </button>
                        <button onclick="deleteOrder('${order.id}')" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300 w-full">
                            <i class="fas fa-trash mr-2"></i>
                            Eliminar Pedido
                        </button>
                    `;
                case 'delivering':
                    return `
                        ${locationButton}
                        <button onclick="contactCustomer('${order.id}')" class="btn-info w-full action-button">
                            <i class="fab fa-whatsapp mr-2"></i>
                            Contactar cliente
                        </button>
                        ${paidButton}
                        <button onclick="sendArrivedMessage('${order.id}')" class="btn-success w-full ${order.arrivedSent ? 'opacity-75' : ''}">
                            ${order.arrivedSent ? '<i class="fas fa-check mr-2"></i>Llegada Notificada ‚úì' : '<i class="fas fa-home mr-2"></i>Notificar Llegada'}
                        </button>
                        <button onclick="updateOrderStatus('${order.id}', 'delivered')" class="btn-info w-full">
                            <i class="fas fa-check-circle mr-2"></i>
                            Marcar como Entregado
                        </button>
                        <button onclick="deleteOrder('${order.id}')" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300 w-full">
                            <i class="fas fa-trash mr-2"></i>
                            Eliminar Pedido
                        </button>
                    `;
                case 'delivered':
                    return `
                        ${locationButton}
                        <button onclick="contactCustomer('${order.id}')" class="btn-info w-full action-button mb-2">
                            <i class="fab fa-whatsapp mr-2"></i>
                            Contactar cliente
                        </button>
                        ${paidButton}
                        <div class="text-center p-3 bg-green-50 border border-green-200 rounded-lg mb-3">
                            <i class="fas fa-check-circle text-green-600 text-xl mb-2"></i>
                            <div class="text-green-800 font-semibold">Pedido Completado</div>
                        </div>
                        <button onclick="deleteOrder('${order.id}')" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300 w-full">
                            <i class="fas fa-trash mr-2"></i>
                            Eliminar Pedido
                        </button>
                    `;
                default:
                    return '';
            }
        }

        // Abrir ubicaci√≥n del cliente en Google Maps
        function viewLocation(orderId) {
            const order = orders.find(o => o.id === orderId);
            if (!order || !order.customer) return;

            const coords = order.customer.coordinates;
            let url = '';

            if (coords && typeof coords.lat === 'number' && typeof coords.lng === 'number') {
                const q = `${coords.lat},${coords.lng}`;
                url = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(q)}`;
            } else if (order.customer.address) {
                url = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(order.customer.address)}`;
            } else {
                showNotification('Este pedido no tiene direcci√≥n para mostrar en el mapa', 'error');
                return;
            }

            window.open(url, '_blank');
            showNotification('Abriendo ubicaci√≥n en Google Maps', 'success');
        }

        // Contactar cliente por WhatsApp
        function contactCustomer(orderId) {
            const order = orders.find(o => o.id === orderId);
            if (!order) return;
            
            const message = encodeURIComponent('Hola, Te atiende el SrBurger, empezaremos a preparar tu pedido y te avisar√© cuando est√© listo');
            const whatsappUrl = `https://wa.me/${order.customer.phone.replace(/\D/g, '')}?text=${message}`;
            
            window.open(whatsappUrl, '_blank');
            showNotification('Abriendo conversaci√≥n con el cliente', 'success');
        }

        // Confirmar pedido (nuevo)
    function confirmOrder(orderId) {
            const order = orders.find(o => o.id === orderId);
            if (!order) return;

            if (order.confirmed) {
                showNotification('Este pedido ya estaba confirmado', 'success');
                return;
            }

            // Armar mensaje + link de rastreo
            const customerName = order.customer && order.customer.name ? String(order.customer.name) : '';
            const orderNumber = order.orderNumber ? String(order.orderNumber) : '';
            let trackingBase = '';
            try {
                if (window.location && window.location.origin) {
                    const origin = String(window.location.origin);
                    trackingBase = (origin && origin !== 'null') ? origin.replace(/\/$/, '') : '';
                }
            } catch (_) {
                trackingBase = '';
            }
            const trackingUrl = orderNumber
                ? (trackingBase ? `${trackingBase}/tuenvio.html?order=${encodeURIComponent(orderNumber)}` : `tuenvio.html?order=${encodeURIComponent(orderNumber)}`)
                : '';

            const msgLines = [];
            msgLines.push(`Hola${customerName ? ' ' + customerName : ''} ‚úÖ`);
            msgLines.push('Recibimos tu pedido. En unos momentos lo empezaremos a preparar. üçîüî•');
            if (orderNumber) msgLines.push(`\n*N√∫mero de orden:* ${orderNumber}`);
            if (trackingUrl) {
                msgLines.push('\nüì¶ *Rastrea tu pedido:*');
                msgLines.push(trackingUrl);
            }
            const message = encodeURIComponent(msgLines.join('\n'));
            const phone = (order.customer && order.customer.phone ? String(order.customer.phone) : '').replace(/\D/g, '');
            if (phone) {
                const whatsappUrl = `https://wa.me/${phone}?text=${message}`;
                window.open(whatsappUrl, '_blank');
            }
            
            // Actualizar en Firebase o localStorage
            if (window.firebaseOrderManager) {
                window.firebaseOrderManager.updateOrder(orderId, { confirmed: true, confirmedAt: new Date().toISOString(), confirmedSent: true })
                    .then(() => {
            showNotification('Pedido confirmado', 'success');
                        // Si ya no quedan pendientes sin confirmar, detener alerta
                        setTimeout(() => {
                            try { if (!hasAnyUnconfirmedPending(orders)) stopNewOrderAlert(); } catch (_) {}
                        }, 250);
                    })
                    .catch((error) => {
                        console.error('Error al confirmar pedido:', error);
                        showNotification('Error al confirmar pedido', 'error');
                    });
            } else {
                // Fallback localStorage
                const orderIndex = orders.findIndex(o => o.id === orderId);
                if (orderIndex !== -1) {
                    orders[orderIndex].confirmed = true;
                    orders[orderIndex].confirmedAt = new Date().toISOString();
                    orders[orderIndex].confirmedSent = true;
                    saveOrdersToLocalStorage();
                    displayOrders();
                }
        showNotification('Pedido confirmado', 'success');
                // Si ya no quedan pendientes sin confirmar, detener alerta
                try { if (!hasAnyUnconfirmedPending(orders)) stopNewOrderAlert(); } catch (_) {}
            }
        }

        // Marcar pedido como pagado
        async function markOrderPaid(orderId) {
            const orderIndex = orders.findIndex(o => o.id === orderId);
            const hadLocal = orderIndex !== -1;

            if (hadLocal && orders[orderIndex].paid) {
                showNotification('Este pedido ya estaba marcado como pagado', 'success');
                return;
            }

            // Optimistic UI update
            let prevPaid = null;
            let prevPaidAt = null;
            if (hadLocal) {
                prevPaid = !!orders[orderIndex].paid;
                prevPaidAt = orders[orderIndex].paidAt || null;
                orders[orderIndex].paid = true;
                orders[orderIndex].paidAt = new Date().toISOString();
                displayOrders();
                updateStats();
            }

            const payload = { paid: true, paidAt: new Date().toISOString() };

            const canCallApi = (location && (location.protocol === 'http:' || location.protocol === 'https:'));
            if (canCallApi) {
                try {
                    const storedKey = localStorage.getItem('sr_admin_key') || '';
                    const doRequest = async (key) => {
                        const r = await fetch('/api/mark-paid', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                ...(key ? { 'x-admin-key': key } : {})
                            },
                            body: JSON.stringify({ orderId })
                        });
                        const data = await r.json().catch(() => ({}));
                        return { status: r.status, ok: r.ok, data };
                    };

                    let apiRes = await doRequest(storedKey);
                    if (apiRes.status === 401) {
                        const entered = prompt('Clave admin requerida para marcar PAGADO (ADMIN_KEY):');
                        const key = (entered || '').trim();
                        if (key) {
                            localStorage.setItem('sr_admin_key', key);
                            apiRes = await doRequest(key);
                        }
                    }

                    if (!apiRes.ok || !apiRes.data || apiRes.data.ok !== true) {
                        throw new Error((apiRes.data && apiRes.data.error) || 'No se pudo marcar como pagado (API)');
                    }

                    showNotification(
                        apiRes.data.pointsCredited
                            ? `Pedido marcado como pagado (+${apiRes.data.pointsAdded || 0} pts)`
                            : 'Pedido marcado como pagado',
                        'success'
                    );
                    return;
                } catch (error) {
                    console.error('Error al marcar como pagado (API):', error);
                    // Continue below to fallback
                }
            }

            if (window.firebaseOrderManager) {
                try {
                    await window.firebaseOrderManager.updateOrder(orderId, payload);
                    showNotification('Pedido marcado como pagado', 'success');
                } catch (error) {
                    console.error('Error al marcar como pagado:', error);
                    // Revert optimistic change on error
                    if (hadLocal) {
                        orders[orderIndex].paid = prevPaid;
                        orders[orderIndex].paidAt = prevPaidAt;
                        displayOrders();
                        updateStats();
                    }
                    showNotification('Error al marcar el pedido como pagado', 'error');
                }
            } else {
                // Fallback localStorage
                if (!hadLocal) return;
                saveOrdersToLocalStorage();
                showNotification('Pedido marcado como pagado', 'success');
            }
        }

        // Enviar mensaje "Vamos en camino"
        function sendOnWayMessage(orderId) {
            const order = orders.find(o => o.id === orderId);
            if (!order) return;
            
            const message = encodeURIComponent(`Hola ${order.customer.name} üöóüí® ¬°Tu pedido ya va en camino! Tiempo estimado de llegada: ${order.estimatedTime} minutos. Prepara tu pago, ¬°ya casi llegamos! üçî‚ú®`);
            const whatsappUrl = `https://wa.me/${order.customer.phone.replace(/\D/g, '')}?text=${message}`;
            
            // Actualizar en Firebase o localStorage
            if (window.firebaseOrderManager) {
                window.firebaseOrderManager.updateOrder(orderId, { onWaySent: true })
                    .then(() => {
                        showNotification('Mensaje "En camino" enviado al cliente', 'success');
                    })
                    .catch((error) => {
                        console.error('Error al enviar mensaje:', error);
                        showNotification('Error al enviar mensaje', 'error');
                    });
            } else {
                // Fallback localStorage
                const orderIndex = orders.findIndex(o => o.id === orderId);
                if (orderIndex !== -1) {
                    orders[orderIndex].onWaySent = true;
                    saveOrdersToLocalStorage();
                    displayOrders();
                }
                showNotification('Mensaje "En camino" enviado al cliente', 'success');
            }
            
            window.open(whatsappUrl, '_blank');
        }

        // Enviar mensaje "Llegamos"
        function sendArrivedMessage(orderId) {
            const order = orders.find(o => o.id === orderId);
            if (!order) return;
            
            const message = encodeURIComponent(`¬°Hola ${order.customer.name}! üè† Ya estamos afuera de tu domicilio con tu delicioso pedido de Sr & Sra Burger. ¬°Salimos a entregarte! üçîüéâ`);
            const whatsappUrl = `https://wa.me/${order.customer.phone.replace(/\D/g, '')}?text=${message}`;
            
            // Actualizar en Firebase o localStorage
            if (window.firebaseOrderManager) {
                window.firebaseOrderManager.updateOrder(orderId, { arrivedSent: true })
                    .then(() => {
                        showNotification('Mensaje "Llegamos" enviado al cliente', 'success');
                    })
                    .catch((error) => {
                        console.error('Error al enviar mensaje:', error);
                        showNotification('Error al enviar mensaje', 'error');
                    });
            } else {
                // Fallback localStorage
                const orderIndex = orders.findIndex(o => o.id === orderId);
                if (orderIndex !== -1) {
                    orders[orderIndex].arrivedSent = true;
                    saveOrdersToLocalStorage();
                    displayOrders();
                }
                showNotification('Mensaje "Llegamos" enviado al cliente', 'success');
            }
            
            window.open(whatsappUrl, '_blank');
        }

        // Eliminar pedido con confirmaci√≥n
        function deleteOrder(orderId) {
            const order = orders.find(o => o.id === orderId);
            if (!order) return;
            
            // Crear modal de confirmaci√≥n
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
                    <div class="text-center">
                        <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
                            <i class="fas fa-exclamation-triangle text-red-600 text-2xl"></i>
                        </div>
                        <h3 class="text-lg font-bold text-gray-900 mb-2">¬øEliminar Pedido?</h3>
                        <p class="text-gray-600 mb-2">¬øEst√°s seguro de que quieres eliminar el pedido #${order.id.slice(-6)}?</p>
                        <p class="text-sm text-gray-500 mb-6">Cliente: ${order.customer.name} - Total: $${order.total}</p>
                        <div class="flex space-x-3">
                            <button onclick="cancelDelete()" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg transition duration-300">
                                Cancelar
                            </button>
                            <button onclick="confirmDelete('${orderId}')" class="flex-1 bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300">
                                <i class="fas fa-trash mr-2"></i>
                                Eliminar
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        // Cancelar eliminaci√≥n
        function cancelDelete() {
            const modal = document.querySelector('.fixed.inset-0');
            if (modal) {
                document.body.removeChild(modal);
            }
        }

        // Confirmar eliminaci√≥n
        function confirmDelete(orderId) {
            if (window.firebaseOrderManager) {
                window.firebaseOrderManager.deleteOrder(orderId)
                    .then(() => {
                        const deletedOrder = orders.find(o => o.id === orderId);
                        showNotification(`Pedido #${deletedOrder?.id?.slice(-6) || 'N/A'} eliminado correctamente`, 'success');
                    })
                    .catch((error) => {
                        console.error('Error al eliminar pedido:', error);
                        showNotification('Error al eliminar el pedido', 'error');
                    });
            } else {
                // Fallback localStorage
                const orderIndex = orders.findIndex(o => o.id === orderId);
                if (orderIndex !== -1) {
                    const deletedOrder = orders[orderIndex];
                    orders.splice(orderIndex, 1);
                    saveOrdersToLocalStorage();
                    displayOrders();
                    updateStats();
                    showNotification(`Pedido #${deletedOrder.id.slice(-6)} eliminado correctamente`, 'success');
                }
            }
            
            // Cerrar modal
            cancelDelete();
        }

        // Actualizar estado de orden
        function updateOrderStatus(orderId, newStatus) {
            const orderIndex = orders.findIndex(o => o.id === orderId);
            const hadLocal = orderIndex !== -1;

            // Caso especial: al marcar ENTREGADO, solo actualizar status (el Control lo oculta)
            if (String(newStatus).toLowerCase() === 'delivered') {
                // Optimistic UI: marcar delivered localmente para que desaparezca por el filtro
                let prevStatus = null;
                if (hadLocal) {
                    prevStatus = orders[orderIndex].status;
                    orders[orderIndex].status = 'delivered';
                    orders[orderIndex].deliveredAt = new Date().toISOString();
                    displayOrders();
                    updateStats();
                }

                const payload = { status: 'delivered', deliveredAt: new Date().toISOString() };

                if (window.firebaseOrderManager) {
                    window.firebaseOrderManager.updateOrder(orderId, payload)
                        .then(() => {
                            showNotification('Pedido marcado como entregado', 'success');
                        })
                        .catch((error) => {
                            console.error('Error al marcar entregado:', error);
                            // Revert optimistic change on error
                            if (hadLocal && prevStatus != null) {
                                orders[orderIndex].status = prevStatus;
                                displayOrders();
                                updateStats();
                            }
                            showNotification('Error al marcar el pedido como entregado', 'error');
                        });
                } else {
                    if (!hadLocal) return;
                    saveOrdersToLocalStorage();
                    showNotification('Pedido marcado como entregado', 'success');
                }
                return;
            }

            // Optimistic UI update
            let prevStatus = null;
            if (hadLocal) {
                prevStatus = orders[orderIndex].status;
                orders[orderIndex].status = newStatus;
                displayOrders();
                updateStats();
            }

            if (window.firebaseOrderManager) {
                window.firebaseOrderManager.updateOrder(orderId, { status: newStatus })
                    .then(() => {
                        const statusText = getStatusInfo(newStatus).text;
                        showNotification(`Pedido actualizado a: ${statusText}`, 'success');
                    })
                    .catch((error) => {
                        console.error('Error al actualizar estado:', error);
                        // Revert optimistic change on error
                        if (hadLocal && prevStatus) {
                            orders[orderIndex].status = prevStatus;
                            displayOrders();
                            updateStats();
                        }
                        showNotification('Error al actualizar el pedido', 'error');
                    });
            } else {
                // Fallback localStorage
                if (!hadLocal) return;
                saveOrdersToLocalStorage();
                const statusText = getStatusInfo(newStatus).text;
                showNotification(`Pedido actualizado a: ${statusText}`, 'success');
            }
        }

        // Refrescar √≥rdenes
        function refreshOrders() {
            showLoading();
            
            if (window.firebaseOrderManager) {
                // Firebase se actualiza autom√°ticamente, solo mostrar feedback
                setTimeout(() => {
                    hideLoading();
                    showNotification('Datos sincronizados con Firebase', 'success');
                }, 1000);
            } else {
                // Recargar desde localStorage
                setTimeout(() => {
                    loadOrdersFromLocalStorage();
                    hideLoading();
                    showNotification('√ìrdenes actualizadas', 'success');
                }, 1000);
            }
        }

        // Configurar auto-refresh (solo para localStorage)
        function setupAutoRefresh() {
            if (!window.firebaseOrderManager) {
                if (localAutoRefreshId) return;
                localAutoRefreshId = setInterval(() => {
                    loadOrdersFromLocalStorage();
                }, 30000); // Refresh cada 30 segundos
            }
        }

        // Filtrar √≥rdenes
        function filterOrders(filter) {
            currentFilter = filter;
            
            // Actualizar botones activos
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
                btn.classList.remove('btn-primary');
                btn.classList.add('btn-info');
            });
            
            const activeBtn = document.querySelector(`[data-filter="${filter}"]`);
            activeBtn.classList.add('active');
            activeBtn.classList.remove('btn-info');
            activeBtn.classList.add('btn-primary');
            
            displayOrders();
        }

        // Actualizar estad√≠sticas
    function updateStats() {
            const stats = {
        pending: orders.filter(o => !isOrderCanceled(o) && o.status === 'pending').length,
        preparing: orders.filter(o => !isOrderCanceled(o) && o.status === 'preparing').length,
        delivering: orders.filter(o => !isOrderCanceled(o) && o.status === 'delivering').length
            };
            
            // Desktop stats
            document.getElementById('pending-count').textContent = stats.pending;
            document.getElementById('preparing-count').textContent = stats.preparing;
            document.getElementById('delivering-count').textContent = stats.delivering;
            const completedEl = document.getElementById('completed-count');
            if (completedEl) completedEl.textContent = '0';
            
            // Mobile stats
            document.getElementById('mobile-pending').textContent = stats.pending;
            document.getElementById('mobile-preparing').textContent = stats.preparing;
            document.getElementById('mobile-delivering').textContent = stats.delivering;
        }

        // Calcular tiempo estimado
        function calculateEstimatedTime(items) {
            // Tiempo base + tiempo por item
            const baseTime = 15;
            const timePerItem = 5;
            return baseTime + (items.length * timePerItem);
        }

        // Obtener tiempo transcurrido
        function getTimeAgo(timestamp) {
            const now = new Date();
            const orderTime = new Date(timestamp);
            const diffMs = now - orderTime;
            const diffMins = Math.floor(diffMs / 60000);
            
            if (diffMins < 1) return 'Ahora mismo';
            if (diffMins < 60) return `Hace ${diffMins} min`;
            
            const diffHours = Math.floor(diffMins / 60);
            if (diffHours < 24) return `Hace ${diffHours}h`;
            
            const diffDays = Math.floor(diffHours / 24);
            return `Hace ${diffDays}d`;
        }

        // Enviar mensaje de "vamos en camino" (versi√≥n anterior - mantenida por compatibilidad)
        function sendDeliveryMessage(order) {
            const message = encodeURIComponent(`Hola ${order.customer.name}, ¬°Tu pedido ya va en camino! üöõüçî Tiempo estimado de llegada: ${order.estimatedTime} minutos. ¬°Gracias por elegir Sr & Sra Burger!`);
            const whatsappUrl = `https://wa.me/${order.customer.phone.replace(/\D/g, '')}?text=${message}`;
            
            window.open(whatsappUrl, '_blank');
        }

        // Mostrar notificaci√≥n
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type}`;
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        // Mostrar/ocultar loading
        function showLoading() {
            document.getElementById('loading-overlay').classList.remove('hidden');
        }

        function hideLoading() {
            document.getElementById('loading-overlay').classList.add('hidden');
        }

        // Reproducir sonido de notificaci√≥n
        function playNotificationSound() {
            // Crear un beep corto (reutiliza AudioContext si existe)
            ensureAudioUnlocked();
            const Ctx = window.AudioContext || window.webkitAudioContext;
            if (!Ctx) return;
            if (!_notifAudioCtx) _notifAudioCtx = new Ctx();
            const audioContext = _notifAudioCtx;
            if (audioContext.state === 'suspended') {
                audioContext.resume().catch(() => {});
            }

            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.value = 800;
            oscillator.type = 'sine';
            
            gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);
            
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.1);
        }

        // Crear √≥rdenes de ejemplo para testing
        function createSampleOrders() {
            const sampleOrders = [
                {
                    id: '1704117600000',
                    timestamp: new Date(Date.now() - 300000).toISOString(), // 5 min ago
                    status: 'pending',
                    customer: {
                        name: 'Juan P√©rez',
                        phone: '9221234567',
                        address: 'Calle Principal #123, Minatitl√°n'
                    },
                    items: [
                        { 
                            name: 'DOBLES DOBLES', 
                            quantity: 1, 
                            price: 220, 
                            customizations: '2 Hamburguesas a tu elecci√≥n' 
                        },
                        { 
                            name: 'Combo Pareja', 
                            quantity: 1, 
                            price: 250, 
                            customizations: '2 Hamburguesas + Papas Medianas + 7 Aros de Cebolla' 
                        },
                        { 
                            name: 'Combo Familiar', 
                            quantity: 1, 
                            price: 280, 
                            customizations: 'Incluye: Papas Francesas, Aros Medianos, Coca-Cola 3L' 
                        },
                        { name: 'Hamburguesa Cl√°sica', quantity: 2, price: 140, customizations: 'Sin cebolla, extra queso' },
                        { name: 'Papas Grandes', quantity: 1, price: 45 }
                    ],
                    total: 685,
                    notes: 'Entregar en la puerta principal',
                    estimatedTime: 25,
                    confirmed: false,
                    onWaySent: false,
                    arrivedSent: false
                },
                {
                    id: '1704117600001',
                    timestamp: new Date(Date.now() - 1800000).toISOString(), // 30 min ago
                    status: 'preparing',
                    customer: {
                        name: 'Carlos Rodr√≠guez',
                        phone: '9229876543',
                        address: 'Av. Universidad #234, Col. Centro'
                    },
                    items: [
                        { 
                            name: 'Combo Amigos', 
                            quantity: 1, 
                            price: 360, 
                            customizations: '3 Hamburguesas + Papas Medianas' 
                        },
                        { 
                            name: 'DOBLES DOBLES BBQ', 
                            quantity: 1, 
                            price: 220, 
                            customizations: '2 Hamburguesas BBQ' 
                        }
                    ],
                    total: 580,
                    notes: 'Cliente frecuente - pedido especial',
                    estimatedTime: 20,
                    confirmed: true,
                    onWaySent: false,
                    arrivedSent: false
                }
            ];
            
            orders = sampleOrders;
            // Guardar en localStorage usando la funci√≥n correcta de respaldo
            if (typeof saveOrdersToLocalStorage === 'function') {
                saveOrdersToLocalStorage();
            } else {
                try {
                    localStorage.setItem('orders', JSON.stringify(orders));
                } catch (e) {
                    console.warn('No se pudo guardar orders de ejemplo en localStorage:', e);
                }
            }
        }

    // Limpieza al salir de la p√°gina: desuscribir listener de Firebase si existe
        window.addEventListener('beforeunload', () => {
            try {
                if (typeof unsubscribeOrders === 'function') {
                    unsubscribeOrders();
                }
            } catch (e) {
                // noop
            }
        });

    // Exponer handlers al scope global para soporte de atributos onclick
    window.refreshOrders = refreshOrders;
    window.filterOrders = filterOrders;
    window.confirmOrder = confirmOrder;
    window.updateOrderStatus = updateOrderStatus;
    window.deleteOrder = deleteOrder;
    window.cancelDelete = cancelDelete;
    window.confirmDelete = confirmDelete;
    window.sendOnWayMessage = sendOnWayMessage;
    window.sendArrivedMessage = sendArrivedMessage;
    window.toggleItemChecked = toggleItemChecked;

        // Funci√≥n para ser llamada desde paginaburger.html
        window.addOrderToControl = addOrder;
    </script>
</body>
</html>
