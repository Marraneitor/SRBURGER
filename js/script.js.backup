// SR & SRA BURGER - Script Principal v4.2.2
// VERSI칍N ACTUALIZADA - Sin Google Maps
// Cambios v4.2.2:
// - Eliminado completamente Google Maps
// - Sistema simplificado con entrada de direcci칩n manual
// - Bot칩n "Mostrar men칰" reparado y funcionando
console.log('游 SR & SRA BURGER Script v4.2.2 - Cargando...');

// --- CONSTANTES GLOBALES ---
const FRIES_PRICE = 25;
const ONION_RINGS_PRICE = 25;
const DELIVERY_PRICE = 0; // (Legacy) ya no se usa como base
const EXTRA_KM_PRICE = 8; // Tarifa por km
const DELIVERY_RATE_PER_KM = 8; // $8 por KM (legacy)
// Requerimiento: variable expl칤cita para el cobro por KM
const COSTO_POR_KM = 8;
const MAX_DELIVERY_DISTANCE = 12; // Distancia m치xima de entrega en km
// Ubicaci칩n exacta del local (SR & SRA BURGER): Coahuila #36, Col. 10 de Mayo, Minatitl치n, Veracruz
// Coordenadas proporcionadas por el due침o
const RESTAURANT_LOCATION = { lat: 18.022398, lng: -94.546974 };

// Lugar seleccionado por el autocompletado/mapa (se declara desde el inicio
// para evitar ReferenceError antes de que Google Maps lo asigne)
let selectedPlace = null;

// Estado global del checkout (debe ser visible para funciones fuera de DOMContentLoaded)
var userAddress = null;
var deliveryCalcPending = 0;

// Wrapper global: algunas funciones viven fuera de DOMContentLoaded y requieren esto
function updateCheckoutTotals() {
    try {
        if (typeof window !== 'undefined' && typeof window.__sr_updateCheckoutTotals === 'function') {
            return window.__sr_updateCheckoutTotals();
        }
    } catch (_) {}
}

console.log('游닍 Constantes globales definidas');

document.addEventListener('DOMContentLoaded', () => {
    console.log('游꿢 DOMContentLoaded - Iniciando aplicaci칩n...');
    // Wait for Firebase to be available, then check service status
    const waitForFirebase = () => {
        if (window.firebaseManager) {
            initializeFirebaseFeatures();
        } else {
            setTimeout(waitForFirebase, 100);
        }
    };
    waitForFirebase();

    // Initialize Firebase-dependent features
    async function initializeFirebaseFeatures() {
        try {
            // Load hidden products from Firebase
            await loadHiddenProductsFromFirebase();
            
            // Setup real-time listeners
            setupHiddenProductsListener();
            
            // Check service status
            await checkServiceStatusFromFirebase();
            
            // Load and merge custom products before applying overrides
            await loadAndApplyCustomProducts();

            // Load and apply product order after custom products are merged
            await loadAndApplyProductOrder();

            // Load and apply price overrides
            await loadAndApplyPriceOverrides();
            
            // Load and apply image overrides
            await loadAndApplyImageOverrides();

            // Load and apply product info overrides (name/description)
            await loadAndApplyProductInfoOverrides();

            // Load overrides for Personalizar button visibility
            await loadCustomizeButtonOverrides();

            // Load overrides for per-product Especificaciones field
            await loadSpecificationsOverrides();
            
            console.log('Firebase features initialized successfully');
        } catch (error) {
            console.error('Error initializing Firebase features:', error);
            // Fallback to localStorage-based functionality
            checkServiceStatusFromLocalStorage();
        }
    }
    
    // --- SERVICE AND ADMIN CONTROLS ---
    
    // Check if service is active from Firebase
    async function checkServiceStatusFromFirebase() {
        try {
            const isActive = await window.firebaseManager.isServiceActive();
            if (!isActive) {
                showServiceClosedModal();
                return false;
            }
            return true;
        } catch (error) {
            console.error('Error checking service status:', error);
            // Fallback to localStorage
            checkServiceStatusFromLocalStorage();
        }
    }
    
    // Fallback: Check service status from localStorage
    function checkServiceStatusFromLocalStorage() {
        const serviceActive = localStorage.getItem('restaurantServiceActive');
        if (serviceActive === 'false') {
            showServiceClosedModal();
            return false;
        }
        return true;
    }
    
    // Show service closed modal
    function showServiceClosedModal() {
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-black/80 z-[100] flex items-center justify-center p-4';
        modal.innerHTML = `
            <div class="bg-white rounded-2xl shadow-2xl max-w-md mx-auto text-center p-8">
                <div class="w-24 h-24 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-6">
                    <i class="fas fa-store-slash text-red-500 text-4xl"></i>
                </div>
                <h2 class="text-3xl font-bold text-gray-800 mb-4">춰Temporalmente Cerrado!</h2>
                <p class="text-gray-600 mb-6 leading-relaxed">
                    Lo sentimos, nuestro servicio de pedidos est치 temporalmente cerrado. 
                    <br><br>
                    Pronto estaremos de vuelta con deliciosas hamburguesas para ti.
                </p>
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                    <p class="text-blue-800 text-sm font-semibold leading-relaxed">
                        <i class="fas fa-clock mr-2"></i>
                        HORARIO
                        <br>
                        Lunes descansamos
                        <br>
                        Entre semana (martes a viernes): 6 PM a 10 PM
                        <br>
                        Fines de semana (s치bado y domingo): 4 PM a 10 PM
                    </p>
                </div>
                <button onclick="window.location.reload()" 
                        class="bg-gradient-to-r from-yellow-500 to-orange-500 text-white px-8 py-3 rounded-full font-bold hover:from-yellow-600 hover:to-orange-600 transition-all duration-300 shadow-lg">
                    <i class="fas fa-refresh mr-2"></i>Intentar de nuevo
                </button>
            </div>
        `;
        document.body.appendChild(modal);
        
        // Disable all interactions
        document.body.style.overflow = 'hidden';
    }
    
    // Global variable to store hidden products and admin overrides from Firebase
    let hiddenProductsFromFirebase = [];
    let hiddenCategoriesFromFirebase = [];
    let priceOverridesFromFirebase = {};
    let imageOverridesFromFirebase = {};
    let customProductsFromFirebase = {};
    let categoriesFromFirebase = null;
    let productInfoOverridesFromFirebase = {};
    let customizeButtonOverridesFromFirebase = {};
    let specificationsOverridesFromFirebase = {};
    let productOrderFromFirebase = {};
    let currentCustomProductIds = new Set();

    // Carrusel por categor칤a (solo desktop): 칤ndice del primer elemento visible
    const categoryCarouselIndex = {};

    function normalizeCategoriesList(list) {
        const arr = Array.isArray(list) ? list : [];
        const seen = new Set();
        const out = [];
        arr.forEach((raw) => {
            const name = String(raw || '').trim();
            if (!name) return;
            const key = name.toLowerCase();
            if (seen.has(key)) return;
            seen.add(key);
            out.push(name);
        });
        return out;
    }

    function categoryKey(name) {
        return String(name || '').trim().toLowerCase();
    }

    function normalizeHiddenCategoriesList(list) {
        const arr = Array.isArray(list) ? list : [];
        const seen = new Set();
        const out = [];
        arr.forEach((raw) => {
            const k = categoryKey(raw);
            if (!k) return;
            if (seen.has(k)) return;
            seen.add(k);
            out.push(k);
        });
        return out;
    }

    function getHiddenCategoryKeys() {
        if (Array.isArray(hiddenCategoriesFromFirebase) && hiddenCategoriesFromFirebase.length > 0) {
            return normalizeHiddenCategoriesList(hiddenCategoriesFromFirebase);
        }
        // Fallback: localStorage
        try {
            const raw = localStorage.getItem('hiddenCategories');
            if (!raw) return [];
            const parsed = JSON.parse(raw);
            return normalizeHiddenCategoriesList(parsed);
        } catch (_) {
            return [];
        }
    }

    function getMenuCategoriesInOrder() {
        const base = Object.keys(menuData);
        const fromFirebase = normalizeCategoriesList(categoriesFromFirebase);

        // Orden por defecto (solo si a칰n no hay orden guardado en Firebase)
        const DEFAULT_CATEGORY_ORDER = [
            'Hamburguesas',
            'Hot Dogs',
            'Boneles',
            'Combos',
            'Extras',
            'Bebidas'
        ];

        // Punto de partida: si hay configuraci칩n en Firebase, respetarla; si no, usar base
        const initial = fromFirebase.length ? fromFirebase : base;

        // Asegurar que las categor칤as base sigan visibles aunque no est칠n en settings
        const withBase = [...initial];
        base.forEach((c) => {
            if (!withBase.some((x) => String(x).toLowerCase() === String(c).toLowerCase())) {
                withBase.push(c);
            }
        });

        let ordered = [];

        // Si Firebase trae un orden, ese manda
        if (fromFirebase.length) {
            ordered = [...withBase];
        } else {
            // Si no hay orden guardado, aplicar el orden por defecto
            const lowerPresent = new Set(withBase.map((c) => String(c).toLowerCase()));
            DEFAULT_CATEGORY_ORDER.forEach((cat) => {
                const key = String(cat).toLowerCase();
                if (lowerPresent.has(key)) {
                    const found = withBase.find((c) => String(c).toLowerCase() === key);
                    if (found && !ordered.includes(found)) ordered.push(found);
                }
            });
            withBase.forEach((c) => {
                if (!ordered.includes(c)) ordered.push(c);
            });
        }

        // Ocultar categor칤as seg칰n configuraci칩n del admin
        const hiddenKeys = getHiddenCategoryKeys();
        if (hiddenKeys.length) {
            const filtered = ordered.filter((c) => !hiddenKeys.includes(categoryKey(c)));
            // Evitar men칰 vac칤o por accidente
            return filtered.length ? filtered : ordered;
        }

        return ordered;
    }

    // Load custom products and merge into menuData
    async function loadAndApplyCustomProducts() {
        try {
            if (!window.firebaseManager || !window.firebaseManager.getCustomProducts) return;
            const custom = await window.firebaseManager.getCustomProducts();
            if (custom && typeof custom === 'object') {
                customProductsFromFirebase = custom;
                applyCustomProducts(customProductsFromFirebase);
                console.log('Productos personalizados cargados y aplicados:', customProductsFromFirebase);
            }
        } catch (error) {
            console.warn('No se pudieron cargar productos personalizados:', error);
        }
    }

    function applyCustomProducts(customByCategory) {
        // 1) Eliminar los productos personalizados previamente agregados
        if (currentCustomProductIds && currentCustomProductIds.size > 0) {
            for (const category in menuData) {
                if (!Array.isArray(menuData[category])) continue;
                menuData[category] = menuData[category].filter(item => !currentCustomProductIds.has(Number(item.id)));
            }
        }

        // 2) Agregar los nuevos productos personalizados y registrar sus IDs
        const newIds = new Set();
        for (const category in customByCategory || {}) {
            const arr = Array.isArray(customByCategory[category]) ? customByCategory[category] : [];
            if (!Array.isArray(menuData[category])) menuData[category] = [];

            arr.forEach(prod => {
                if (!prod) return;
                const norm = { ...prod };
                norm.id = Number(prod.id);
                // Evitar colisiones de ID con base
                if (menuData[category].some(i => Number(i.id) === norm.id)) {
                    // Si choca, lo omitimos para no duplicar o romper referencias
                    console.warn('ID de producto personalizado ya existe, se omite:', norm);
                    return;
                }
                // Asegurar campos m칤nimos
                if (typeof norm.customizable !== 'boolean') norm.customizable = false;
                if (!norm.name || typeof norm.price !== 'number') return;
                // Auto originalPrice para productos tipo "Dobles Dobles"
                try {
                    const nameStr = String(norm.name || '');
                    const isDobles = /dobles\s+dobles/i.test(nameStr);
                    if (isDobles) {
                        const baseOriginal = Number(norm.originalPrice) || 300;
                        if (!norm.originalPrice || baseOriginal <= Number(norm.price)) {
                            norm.originalPrice = 300;
                        }
                    }
                } catch {}
                menuData[category].push(norm);
                newIds.add(norm.id);
            });
        }
        currentCustomProductIds = newIds;
    }
    
    // Load hidden products from Firebase on page load
    async function loadHiddenProductsFromFirebase() {
        try {
            // Preferimos leer settings una sola vez para extraer m칰ltiples valores
            if (window.firebaseManager && typeof window.firebaseManager.getSettings === 'function') {
                const settings = await window.firebaseManager.getSettings();
                hiddenProductsFromFirebase = Array.isArray(settings?.hiddenProducts) ? settings.hiddenProducts : [];
                hiddenCategoriesFromFirebase = normalizeHiddenCategoriesList(settings?.hiddenCategories);
                categoriesFromFirebase = Array.isArray(settings?.categories) ? settings.categories : null;
                try { localStorage.setItem('hiddenCategories', JSON.stringify(hiddenCategoriesFromFirebase)); } catch (_) {}
                console.log('Productos ocultos cargados desde Firebase:', hiddenProductsFromFirebase);
                console.log('Categor칤as ocultas cargadas desde Firebase:', hiddenCategoriesFromFirebase);
                return;
            }

            hiddenProductsFromFirebase = await window.firebaseManager.getHiddenProducts();
            console.log('Productos ocultos cargados desde Firebase:', hiddenProductsFromFirebase);
        } catch (error) {
            console.error('Error loading hidden products from Firebase:', error);
            // Fallback to localStorage
            const hiddenProducts = localStorage.getItem('hiddenProducts');
            if (hiddenProducts) {
                hiddenProductsFromFirebase = JSON.parse(hiddenProducts);
            }

            try {
                const rawCats = localStorage.getItem('hiddenCategories');
                if (rawCats) hiddenCategoriesFromFirebase = normalizeHiddenCategoriesList(JSON.parse(rawCats));
            } catch (_) {}
        }
    }

    // Load price overrides and apply to menuData
    async function loadAndApplyPriceOverrides() {
        try {
            if (!window.firebaseManager || !window.firebaseManager.getPriceOverrides) return;
            priceOverridesFromFirebase = await window.firebaseManager.getPriceOverrides();
            if (priceOverridesFromFirebase && Object.keys(priceOverridesFromFirebase).length > 0) {
                applyPriceOverrides(priceOverridesFromFirebase);
                console.log('Overrides de precios aplicados:', priceOverridesFromFirebase);
            }
        } catch (error) {
            console.warn('No se pudieron cargar overrides de precios:', error);
        }
    }

    function applyPriceOverrides(overrides) {
        for (const category in menuData) {
            menuData[category] = menuData[category].map(item => {
                const override = overrides[item.id];
                if (!override) return item;
                const newItem = { ...item };
                if (override.price != null) newItem.price = override.price;
                if (override.originalPrice != null) newItem.originalPrice = override.originalPrice;
                return newItem;
            });
        }
    }
    
    // Load image overrides and apply to menuData
    async function loadAndApplyImageOverrides() {
        try {
            if (!window.firebaseManager || !window.firebaseManager.getImageOverrides) return;
            imageOverridesFromFirebase = await window.firebaseManager.getImageOverrides();
            if (imageOverridesFromFirebase && Object.keys(imageOverridesFromFirebase).length > 0) {
                applyImageOverrides(imageOverridesFromFirebase);
                console.log('Overrides de im치genes aplicados:', imageOverridesFromFirebase);
            }
        } catch (error) {
            console.warn('No se pudieron cargar overrides de im치genes:', error);
        }
    }

    function applyImageOverrides(overrides) {
        for (const category in menuData) {
            menuData[category] = menuData[category].map(item => {
                const override = overrides[item.id];
                if (!override || !override.image) return item;
                const newItem = { ...item };
                newItem.image = override.image;
                return newItem;
            });
        }
    }

    // Load product info overrides (name/description) and apply to menuData
    let __baseProductInfoById = null;
    let __baseProductIdSet = null;

    function ensureBaseProductInfoSnapshot() {
        if (__baseProductInfoById && __baseProductIdSet) return;
        const map = {};
        for (const cat in menuData) {
            const arr = Array.isArray(menuData[cat]) ? menuData[cat] : [];
            for (const item of arr) {
                const id = Number(item.id);
                if (Number.isNaN(id)) continue;
                if (map[id] == null) {
                    map[id] = { name: item.name, description: item.description };
                }
            }
        }
        __baseProductInfoById = map;
        __baseProductIdSet = new Set(Object.keys(map).map((k) => Number(k)));
    }

    async function loadAndApplyProductInfoOverrides() {
        try {
            if (!window.firebaseManager || !window.firebaseManager.getProductInfoOverrides) return;
            ensureBaseProductInfoSnapshot();
            productInfoOverridesFromFirebase = await window.firebaseManager.getProductInfoOverrides();
            applyProductInfoOverrides(productInfoOverridesFromFirebase || {});
            if (productInfoOverridesFromFirebase && Object.keys(productInfoOverridesFromFirebase).length > 0) {
                console.log('Overrides de informaci칩n aplicados:', productInfoOverridesFromFirebase);
            }
        } catch (error) {
            console.warn('No se pudieron cargar overrides de informaci칩n:', error);
        }
    }

    function applyProductInfoOverrides(overrides) {
        ensureBaseProductInfoSnapshot();

        // 1) Restaurar nombres/descripciones base (para que quitar overrides funcione)
        for (const category in menuData) {
            if (!Array.isArray(menuData[category])) continue;
            menuData[category] = menuData[category].map(item => {
                const id = Number(item.id);
                if (!__baseProductIdSet.has(id)) return item; // no tocar productos custom
                const base = __baseProductInfoById[id];
                if (!base) return item;
                const restored = { ...item };
                restored.name = base.name;
                restored.description = base.description;
                return restored;
            });
        }

        // 2) Aplicar overrides
        const ov = overrides || {};
        for (const category in menuData) {
            if (!Array.isArray(menuData[category])) continue;
            menuData[category] = menuData[category].map(item => {
                const id = Number(item.id);
                if (!__baseProductIdSet.has(id)) return item;
                const override = ov[id] || ov[String(id)];
                if (!override) return item;
                const updated = { ...item };
                if (override.name != null && String(override.name).trim()) updated.name = String(override.name).trim();
                if (override.description != null && String(override.description).trim()) updated.description = String(override.description).trim();
                return updated;
            });
        }
    }

    // Load overrides for showing/hiding the "Personalizar" button per product
    async function loadCustomizeButtonOverrides() {
        try {
            if (!window.firebaseManager || !window.firebaseManager.getCustomizeButtonOverrides) return;
            customizeButtonOverridesFromFirebase = await window.firebaseManager.getCustomizeButtonOverrides() || {};
            console.log('Overrides de bot칩n Personalizar cargados:', customizeButtonOverridesFromFirebase);
        } catch (error) {
            console.warn('No se pudieron cargar overrides de bot칩n Personalizar:', error);
        }
    }
    
    // Load overrides for enabling per-product specifications field
    async function loadSpecificationsOverrides() {
        try {
            if (!window.firebaseManager || !window.firebaseManager.getSpecificationsOverrides) return;
            specificationsOverridesFromFirebase = await window.firebaseManager.getSpecificationsOverrides() || {};
            console.log('Overrides de especificaciones cargados:', specificationsOverridesFromFirebase);
        } catch (error) {
            console.warn('No se pudieron cargar overrides de especificaciones:', error);
        }
    }

    function normalizeProductOrderMap(obj) {
        const out = {};
        if (!obj || typeof obj !== 'object') return out;
        for (const [category, ids] of Object.entries(obj)) {
            if (!Array.isArray(ids)) continue;
            const seen = new Set();
            const clean = [];
            for (const raw of ids) {
                const n = Number(raw);
                if (Number.isNaN(n)) continue;
                if (seen.has(n)) continue;
                seen.add(n);
                clean.push(n);
            }
            out[category] = clean;
        }
        return out;
    }

    function applyProductOrder(orderByCategory) {
        productOrderFromFirebase = normalizeProductOrderMap(orderByCategory);

        for (const category in menuData) {
            const desired = Array.isArray(productOrderFromFirebase[category]) ? productOrderFromFirebase[category] : [];
            const arr = Array.isArray(menuData[category]) ? menuData[category] : [];
            if (!arr.length || !desired.length) continue;

            const index = new Map(desired.map((id, idx) => [Number(id), idx]));
            const decorated = arr.map((item, idx) => {
                const id = Number(item && item.id);
                const pos = index.has(id) ? index.get(id) : 1e9;
                return { item, idx, pos };
            });
            decorated.sort((a, b) => (a.pos - b.pos) || (a.idx - b.idx));
            menuData[category] = decorated.map(d => d.item);
        }
    }

    async function loadAndApplyProductOrder() {
        try {
            if (window.firebaseManager && typeof window.firebaseManager.getProductOrder === 'function') {
                const order = await window.firebaseManager.getProductOrder();
                if (order && typeof order === 'object') {
                    applyProductOrder(order);
                    try { localStorage.setItem('productOrder', JSON.stringify(order)); } catch (_) {}
                }
                return;
            }
        } catch (error) {
            console.warn('No se pudo cargar el orden de productos desde Firebase:', error);
        }

        // Fallback: localStorage
        try {
            const raw = localStorage.getItem('productOrder');
            if (raw) {
                const parsed = JSON.parse(raw);
                if (parsed && typeof parsed === 'object') applyProductOrder(parsed);
            }
        } catch (_) {}
    }
    
    // Check if product is hidden by admin
    function isProductHidden(productId) {
        // First check Firebase data
        if (hiddenProductsFromFirebase.length > 0) {
            return hiddenProductsFromFirebase.includes(productId);
        }
        
        // Fallback to localStorage
        const hiddenProducts = localStorage.getItem('hiddenProducts');
        if (hiddenProducts) {
            const hiddenList = JSON.parse(hiddenProducts);
            return hiddenList.includes(productId);
        }
        return false;
    }
    
    // Setup real-time listener for hidden products changes
    function setupHiddenProductsListener() {
        if (window.firebaseManager && window.firebaseManager.listenToSettings) {
            let isUpdating = false; // Flag to prevent loops
            
            window.firebaseManager.listenToSettings((newSettings) => {
                if (newSettings && !isUpdating) {
                    // Handle hidden products changes
                    if (newSettings.hiddenProducts) {
                        const oldHiddenProducts = [...hiddenProductsFromFirebase];
                        hiddenProductsFromFirebase = newSettings.hiddenProducts;
                        
                        // Re-render menu if hidden products changed
                        if (JSON.stringify(oldHiddenProducts) !== JSON.stringify(hiddenProductsFromFirebase)) {
                            console.log('Productos ocultos actualizados, re-renderizando men칰...');
                            isUpdating = true;
                            renderMenu();
                            setTimeout(() => { isUpdating = false; }, 500); // Reset flag after delay
                        }
                    }
                    
                    // Handle price overrides changes
                    if (newSettings.priceOverrides) {
                        const oldPriceOverrides = JSON.stringify(priceOverridesFromFirebase || {});
                        const newPriceOverrides = JSON.stringify(newSettings.priceOverrides || {});
                        if (oldPriceOverrides !== newPriceOverrides) {
                            priceOverridesFromFirebase = newSettings.priceOverrides || {};
                            applyPriceOverrides(priceOverridesFromFirebase);
                            console.log('Precios actualizados por admin, re-renderizando men칰...');
                            isUpdating = true;
                            renderMenu();
                            setTimeout(() => { isUpdating = false; }, 500);
                        }
                    }

                    // Handle image overrides changes
                    if (newSettings.imageOverrides) {
                        const oldImageOverrides = JSON.stringify(imageOverridesFromFirebase || {});
                        const newImageOverrides = JSON.stringify(newSettings.imageOverrides || {});
                        if (oldImageOverrides !== newImageOverrides) {
                            imageOverridesFromFirebase = newSettings.imageOverrides || {};
                            applyImageOverrides(imageOverridesFromFirebase);
                            console.log('Im치genes actualizadas por admin, re-renderizando men칰...');
                            isUpdating = true;
                            renderMenu();
                            setTimeout(() => { isUpdating = false; }, 500);
                        }
                    }

                    // Handle custom products changes
                    if (newSettings.customProducts) {
                        const oldCustom = JSON.stringify(customProductsFromFirebase || {});
                        const newCustom = JSON.stringify(newSettings.customProducts || {});
                        if (oldCustom !== newCustom) {
                            customProductsFromFirebase = newSettings.customProducts || {};
                            applyCustomProducts(customProductsFromFirebase);
                            // Reaplicar orden despu칠s de mezclar productos personalizados
                            if (productOrderFromFirebase && Object.keys(productOrderFromFirebase).length > 0) {
                                applyProductOrder(productOrderFromFirebase);
                            }
                            // Reaplicar overrides para que afecten a los nuevos productos
                            if (priceOverridesFromFirebase && Object.keys(priceOverridesFromFirebase).length > 0) {
                                applyPriceOverrides(priceOverridesFromFirebase);
                            }
                            if (imageOverridesFromFirebase && Object.keys(imageOverridesFromFirebase).length > 0) {
                                applyImageOverrides(imageOverridesFromFirebase);
                            }
                            // Reaplicar overrides de informaci칩n
                            applyProductInfoOverrides(productInfoOverridesFromFirebase || {});
                            console.log('Productos personalizados actualizados, re-renderizando men칰...');
                            isUpdating = true;
                            renderMenu();
                            setTimeout(() => { isUpdating = false; }, 500);
                        }
                    }

                    // Handle categories changes
                    if (newSettings.categories !== undefined) {
                        const oldCats = JSON.stringify(categoriesFromFirebase || null);
                        const nextCats = Array.isArray(newSettings.categories) ? newSettings.categories : null;
                        const newCats = JSON.stringify(nextCats || null);
                        if (oldCats !== newCats) {
                            categoriesFromFirebase = nextCats;
                            console.log('Categor칤as actualizadas, re-renderizando men칰...');
                            isUpdating = true;
                            renderMenu();
                            setTimeout(() => { isUpdating = false; }, 500);
                        }
                    }

                    // Handle hidden categories changes
                    if (newSettings.hiddenCategories !== undefined) {
                        const oldHidden = JSON.stringify(normalizeHiddenCategoriesList(hiddenCategoriesFromFirebase || []));
                        const nextHidden = normalizeHiddenCategoriesList(newSettings.hiddenCategories || []);
                        const newHidden = JSON.stringify(nextHidden);
                        if (oldHidden !== newHidden) {
                            hiddenCategoriesFromFirebase = nextHidden;
                            try { localStorage.setItem('hiddenCategories', JSON.stringify(hiddenCategoriesFromFirebase)); } catch (_) {}
                            console.log('Categor칤as ocultas actualizadas, re-renderizando men칰...');
                            isUpdating = true;
                            renderMenu();
                            setTimeout(() => { isUpdating = false; }, 500);
                        }
                    }

                    // Handle product order changes
                    if (newSettings.productOrder !== undefined) {
                        const oldOrder = JSON.stringify(productOrderFromFirebase || {});
                        const newOrder = JSON.stringify(newSettings.productOrder || {});
                        if (oldOrder !== newOrder) {
                            productOrderFromFirebase = newSettings.productOrder || {};
                            applyProductOrder(productOrderFromFirebase);
                            console.log('Orden de productos actualizado, re-renderizando men칰...');
                            isUpdating = true;
                            renderMenu();
                            setTimeout(() => { isUpdating = false; }, 500);
                        }
                    }

                    // Handle product info overrides changes
                    if (newSettings.productInfoOverrides !== undefined) {
                        const oldInfo = JSON.stringify(productInfoOverridesFromFirebase || {});
                        const newInfo = JSON.stringify(newSettings.productInfoOverrides || {});
                        if (oldInfo !== newInfo) {
                            productInfoOverridesFromFirebase = newSettings.productInfoOverrides || {};
                            applyProductInfoOverrides(productInfoOverridesFromFirebase);
                            console.log('Informaci칩n actualizada por admin, re-renderizando men칰...');
                            isUpdating = true;
                            renderMenu();
                            setTimeout(() => { isUpdating = false; }, 500);
                        }
                    }

                    // Handle Personalizar button overrides changes
                    if (newSettings.customizeButtonOverrides !== undefined) {
                        const oldCustomize = JSON.stringify(customizeButtonOverridesFromFirebase || {});
                        const newCustomize = JSON.stringify(newSettings.customizeButtonOverrides || {});
                        if (oldCustomize !== newCustomize) {
                            customizeButtonOverridesFromFirebase = newSettings.customizeButtonOverrides || {};
                            console.log('Overrides de bot칩n Personalizar actualizados, re-renderizando men칰...');
                            isUpdating = true;
                            renderMenu();
                            setTimeout(() => { isUpdating = false; }, 500);
                        }
                    }

                    // Handle per-product specifications overrides changes
                    if (newSettings.specificationsOverrides !== undefined) {
                        const oldSpecs = JSON.stringify(specificationsOverridesFromFirebase || {});
                        const newSpecs = JSON.stringify(newSettings.specificationsOverrides || {});
                        if (oldSpecs !== newSpecs) {
                            specificationsOverridesFromFirebase = newSettings.specificationsOverrides || {};
                            console.log('Overrides de especificaciones actualizados, re-renderizando men칰...');
                            isUpdating = true;
                            renderMenu();
                            setTimeout(() => { isUpdating = false; }, 500);
                        }
                    }

                    // Handle service status changes (without reload loop)
                    if (newSettings.serviceActive !== undefined) {
                        const serviceClosedModal = document.querySelector('[class*="bg-black/80"], [class*="inset-0"]');
                        const isCurrentlyActive = !serviceClosedModal;
                        
                        if (!newSettings.serviceActive && isCurrentlyActive) {
                            console.log('Servicio desactivado desde panel de admin');
                            showServiceClosedModal();
                        }
                        // Removed the reload logic to prevent infinite reloads
                    }
                }
            });
        }
    }

    function getEligibleCategoryItems(category) {
        const src = Array.isArray(menuData[category]) ? menuData[category] : [];
        const out = [];
        src.forEach((originalItem) => {
            if (!originalItem || originalItem.hidden) return;
            if (isProductHidden(originalItem.id)) return;
            out.push(originalItem);
        });
        return out;
    }

    // Decide qu칠 tipo de bot칩n mostrar (combo/customize/add) teniendo en cuenta overrides de admin
    function getButtonTypeForItem(item, category) {
        const id = Number(item.id);
        const rawOverride = (customizeButtonOverridesFromFirebase && (customizeButtonOverridesFromFirebase[id] ?? customizeButtonOverridesFromFirebase[String(id)]));
        const hasOverrideTrue = rawOverride === true;
        const hasOverrideFalse = rawOverride === false;

        const looksLikeCombo = /\bcombo\b/i.test(item.name || '');
        const isComboLike = !!(item.isCombo || looksLikeCombo);

        if (hasOverrideFalse) return 'add';
        if (hasOverrideTrue) return isComboLike ? 'combo' : 'customize';

        if (isComboLike) return 'combo';
        if (item.customizable) return 'customize';
        return 'add';
    }

    // Decide si mostrar campo de "Especificaciones" para un producto dado
    function shouldShowSpecificationsForItem(item) {
        if (!item) return false;
        const id = Number(item.id);
        const rawOverride = specificationsOverridesFromFirebase && (specificationsOverridesFromFirebase[id] ?? specificationsOverridesFromFirebase[String(id)]);
        const hasOverrideTrue = rawOverride === true;
        const hasOverrideFalse = rawOverride === false;
        const baseAllowsSpecs = !!(item.isCombo || item.customizable);
        if (hasOverrideTrue) return true;
        if (hasOverrideFalse) return false;
        return baseAllowsSpecs;
    }
    
    // --- ADVANCED UX ENHANCEMENTS ---
    
    // Enhanced loading states and micro-interactions with better visibility
    function showLoading(element) {
        element.classList.add('loading');
        element.innerHTML = '<div class="loading-spinner"></div><span class="ml-2">Agregando...</span>';
        element.disabled = true;
        element.style.pointerEvents = 'none';
    }
    
    function hideLoading(element, originalText) {
        element.classList.remove('loading');
        element.classList.add('success-state', 'btn-bounce');
        element.innerHTML = '<i class="fas fa-check mr-2"></i>춰Agregado!';
        element.disabled = false;
        element.style.pointerEvents = 'auto';
        
        // Reset to original state after success animation
        setTimeout(() => {
            element.classList.remove('success-state', 'btn-bounce');
            element.innerHTML = originalText;
        }, 1500);
    }
    
    // Enhanced success notifications with better visibility
    function showSuccessNotification(message) {
        const notification = document.createElement('div');
        notification.className = 'fixed top-4 right-4 bg-gradient-to-r from-green-500 to-emerald-600 text-white px-6 py-4 rounded-xl shadow-2xl z-[100] transform translate-x-full transition-all duration-500 notification-enter border-l-4 border-green-300';
        notification.innerHTML = `
            <div class="flex items-center space-x-3">
                <div class="w-8 h-8 bg-white/20 rounded-full flex items-center justify-center">
                    <i class="fas fa-check text-lg"></i>
                </div>
                <div>
                    <div class="font-bold text-lg">${message}</div>
                    <div class="text-green-100 text-sm">Se ha agregado a tu carrito</div>
                </div>
            </div>
        `;
        document.body.appendChild(notification);
        
        // Slide in with enhanced animation
        setTimeout(() => {
            notification.classList.remove('translate-x-full');
            notification.classList.add('shadow-glow');
        }, 100);
        
        // Slide out and remove with better timing
        setTimeout(() => {
            notification.classList.add('translate-x-full', 'opacity-0');
            setTimeout(() => {
                if (document.body.contains(notification)) {
                    document.body.removeChild(notification);
                }
            }, 500);
        }, 3500);
    }
    
    // Add cart bounce animation when items are added
    function bounceCart() {
        const cartBtn = document.getElementById('open-cart-btn');
        cartBtn.classList.add('animate-bounce');
        setTimeout(() => cartBtn.classList.remove('animate-bounce'), 1000);
    }
    
    // Add urgency indicators for popular items
    function addUrgencyIndicators() {
        // Funci칩n deshabilitada - no agregar badges POPULAR adicionales
        // const popularItems = [1, 2, 6, 15]; // IDs of popular items
        // popularItems.forEach(itemId => {
        //     const itemElement = document.querySelector(`[data-id="${itemId}"]`)?.closest('.bg-white');
        //     if (itemElement) {
        //         const badge = document.createElement('div');
        //         badge.className = 'absolute top-2 right-2 bg-red-500 text-white px-2 py-1 rounded-full text-xs font-bold z-10';
        //         badge.innerHTML = '游댠 POPULAR';
        //         itemElement.style.position = 'relative';
        //         itemElement.appendChild(badge);
        //     }
        // });
    }
    
    // Add estimated delivery time
    function addDeliveryTimeEstimate() {
        // Deshabilitado: no mostrar badge flotante "Entrega: xx-xx min"
        return;

        const currentHour = new Date().getHours();
        let estimatedTime = '25-35 min';
        
        if (currentHour >= 18 && currentHour <= 21) { // Peak hours
            estimatedTime = '35-45 min';
        } else if (currentHour >= 14 && currentHour <= 16) { // Lunch hours
            estimatedTime = '30-40 min';
        }
        
        const deliveryBadge = document.createElement('div');
        deliveryBadge.className = 'fixed top-20 left-4 bg-gradient-to-r from-green-500 to-teal-500 text-white px-4 py-2 rounded-full shadow-lg z-40 animate-bounce';
        deliveryBadge.innerHTML = `
            <div class="flex items-center space-x-2">
                <i class="fas fa-clock"></i>
                <span class="font-bold text-sm">Entrega: ${estimatedTime}</span>
            </div>
        `;
        document.body.appendChild(deliveryBadge);
    }
    
    // Add progressive disclosure for combo customization
    function enhanceComboModals() {
        // Add step indicator for combo configuration
        const addStepIndicator = (currentStep, totalSteps) => {
            return `
                <div class="flex justify-center mb-6">
                    <div class="flex space-x-2">
                        ${Array.from({length: totalSteps}, (_, i) => `
                            <div class="w-3 h-3 rounded-full ${i <= currentStep ? 'bg-yellow-500' : 'bg-gray-300'} transition-colors duration-300"></div>
                        `).join('')}
                    </div>
                    <div class="text-sm text-gray-600 mt-2">Paso ${currentStep + 1} de ${totalSteps}</div>
                </div>
            `;
        };
    }
    
    // Add social proof indicators
    function addSocialProof() {
        const socialProofItems = [
            { id: 1, reviews: 127, rating: 4.8 },
            { id: 2, reviews: 93, rating: 4.9 },
            { id: 6, reviews: 156, rating: 4.7 },
            { id: 15, reviews: 89, rating: 4.6 }
        ];
        
        socialProofItems.forEach(item => {
            const itemElement = document.querySelector(`[data-id="${item.id}"]`)?.closest('.bg-white');
            if (itemElement) {
                const socialProof = document.createElement('div');
                socialProof.className = 'absolute bottom-2 left-2 bg-white/90 backdrop-blur-sm rounded-lg px-2 py-1 text-xs shadow-lg';
                socialProof.innerHTML = `
                    <div class="flex items-center space-x-1">
                        <div class="flex">
                            ${Array.from({length: 5}, (_, i) => `
                                <i class="fas fa-star ${i < Math.floor(item.rating) ? 'text-yellow-400' : 'text-gray-300'}" style="font-size: 10px;"></i>
                            `).join('')}
                        </div>
                        <span class="font-semibold text-gray-700">${item.rating}</span>
                        <span class="text-gray-500">(${item.reviews})</span>
                    </div>
                `;
                itemElement.style.position = 'relative';
                itemElement.appendChild(socialProof);
            }
        });
    }
    
    // Add cart abandonment prevention
    let cartAbandonmentTimer;
    function startCartAbandonmentTimer() {
        clearTimeout(cartAbandonmentTimer);
        if (cart.length > 0) {
            cartAbandonmentTimer = setTimeout(() => {
                const abandonmentModal = document.createElement('div');
                abandonmentModal.className = 'fixed inset-0 bg-black/60 z-[80] flex items-center justify-center p-4';
                abandonmentModal.innerHTML = `
                    <div class="bg-white rounded-lg shadow-xl max-w-md mx-auto p-6 text-center">
                        <div class="w-20 h-20 bg-yellow-100 rounded-full flex items-center justify-center mx-auto mb-4">
                            <i class="fas fa-shopping-cart text-yellow-500 text-3xl"></i>
                        </div>
                        <h3 class="text-2xl font-bold mb-2">춰No te vayas con hambre! 游꼢</h3>
                        <p class="text-gray-600 mb-6">Tienes ${cart.length} deliciosos productos en tu carrito esper치ndote.</p>
                        <div class="flex space-x-3">
                            <button onclick="this.parentElement.parentElement.parentElement.remove()" 
                                    class="flex-1 px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">
                                Seguir explorando
                            </button>
                            <button onclick="openCart(); this.parentElement.parentElement.parentElement.remove()" 
                                    class="flex-1 bg-yellow-500 text-white px-4 py-2 rounded-lg hover:bg-yellow-600">
                                Finalizar pedido
                            </button>
                        </div>
                    </div>
                `;
                document.body.appendChild(abandonmentModal);
            }, 120000); // 2 minutes
        }
    }
    
    // Add visual feedback for form validation
    function enhanceFormValidation() {
        const inputs = ['customer-name', 'customer-phone', 'address-input'];
        inputs.forEach(inputId => {
            const input = document.getElementById(inputId);
            if (input) {
                // Asegurar que el campo de direcci칩n siempre permita escritura
                if (inputId === 'address-input') {
                    input.addEventListener('focus', function() {
                        // Remover cualquier bloqueo que pueda haber
                        this.removeAttribute('readonly');
                        this.removeAttribute('disabled');
                        this.style.pointerEvents = 'auto';
                        console.log('Campo de direcci칩n enfocado - escritura habilitada');
                    });
                    
                    input.addEventListener('click', function() {
                        // Asegurar que siempre se pueda escribir al hacer clic
                        this.removeAttribute('readonly');
                        this.removeAttribute('disabled');
                        this.style.pointerEvents = 'auto';
                    });
                }
                
                input.addEventListener('blur', (e) => {
                    const value = e.target.value.trim();
                    const isValid = value.length > 0;
                    
                    if (isValid) {
                        e.target.classList.remove('border-red-300');
                        e.target.classList.add('border-green-300');
                        const checkIcon = e.target.parentElement.querySelector('.validation-icon');
                        if (checkIcon) checkIcon.remove();
                        
                        const icon = document.createElement('i');
                        icon.className = 'fas fa-check-circle text-green-500 absolute right-3 top-1/2 transform -translate-y-1/2 validation-icon';
                        e.target.parentElement.style.position = 'relative';
                        e.target.parentElement.appendChild(icon);
                    } else if (value.length === 0 && e.target.hasAttribute('required')) {
                        e.target.classList.remove('border-green-300');
                        e.target.classList.add('border-red-300');
                    }
                });
            }
        });
    }
    
    // Add smart recommendations
    function addSmartRecommendations(addedItemId) {
        const recommendations = {
            1: [8, 21], // Cl치sica -> Papas Gajo + Coca Cola
            2: [16, 22], // BBQ -> Papas Gajo Grandes + Coca Cola 1.75L
            11: [8, 21], // Alohawai -> Papas Gajo + Coca Cola
            12: [16, 23], // CheesseTorra -> Papas Gajo Grandes + Coca Cola 3L
        };
        
        const recommended = recommendations[addedItemId];
        if (recommended && !document.getElementById('recommendation-popup')) {
            const popup = document.createElement('div');
            popup.id = 'recommendation-popup';
            popup.className = 'fixed bottom-4 left-4 bg-white rounded-lg shadow-xl p-4 max-w-sm z-50 border-l-4 border-yellow-500';
            popup.innerHTML = `
                <div class="flex justify-between items-start mb-3">
                    <h4 class="font-bold text-gray-800">游뱄 Sugerencia Smart</h4>
                    <button onclick="this.parentElement.parentElement.remove()" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <p class="text-sm text-gray-600 mb-3">춰Otros clientes tambi칠n pidieron:</p>
                <div class="space-y-2">
                    ${recommended.map(id => {
                        const item = findItemById(id);
                        return `
                            <div class="flex items-center justify-between p-2 bg-gray-50 rounded">
                                <div class="flex items-center space-x-2">
                                    ${((typeof window.__MANUAL_FAST_MODE === 'undefined' || window.__MANUAL_FAST_MODE !== true) && item.image) ? `<img src="${item.image}" alt="${item.name}" class="w-8 h-8 rounded object-cover" referrerpolicy="no-referrer" onerror="this.onerror=null;this.style.display='none';">` : ''}
                                    <div>
                                        <div class="text-sm font-semibold">${item.name}</div>
                                        <div class="text-xs text-gray-500">$${item.price}</div>
                                    </div>
                                </div>
                                <button onclick="addToCart(${id})" class="bg-yellow-500 text-white px-2 py-1 rounded text-xs hover:bg-yellow-600">
                                    Agregar
                                </button>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
            document.body.appendChild(popup);
            
            // Auto remove after 10 seconds
            setTimeout(() => {
                if (document.getElementById('recommendation-popup')) {
                    document.getElementById('recommendation-popup').remove();
                }
            }, 10000);
        }
    }
    
    // Add real-time order total preview
    function addOrderTotalPreview() {
        let totalPreview = null;
        
        function createTotalPreview() {
            if (!totalPreview) {
                totalPreview = document.createElement('div');
                totalPreview.className = 'fixed bottom-20 left-1/2 transform -translate-x-1/2 bg-gradient-to-r from-yellow-500 to-orange-500 text-white px-6 py-3 rounded-full shadow-xl z-40 transition-all duration-300';
                totalPreview.style.display = 'none';
                document.body.appendChild(totalPreview);
            }
        }
        
        function updateTotalPreview() {
            createTotalPreview();
            
            if (cart.length > 0) {
                const total = calculateCartTotal();
                totalPreview.innerHTML = `
                    <div class="flex items-center space-x-3 cursor-pointer" onclick="openCart()">
                        <i class="fas fa-shopping-cart"></i>
                        <span class="font-bold">${cart.length} items  $${total.toFixed(0)}</span>
                        <i class="fas fa-chevron-right"></i>
                    </div>
                `;
                totalPreview.style.display = 'block';
            } else {
                totalPreview.style.display = 'none';
            }
        }
        
        return updateTotalPreview;
    }

    // --- DATA ---
    const toppingsData = [
        { id: 't6', name: 'Doble Carne', price: 30, description: '쯃a quieres con doble carne jugosa?', image: '' },
        { id: 't1', name: 'Tocino Extra', price: 15, description: '쯊e gusta el tocino crujiente?', image: '' },
        { id: 't8', name: 'Pi침a Extra', price: 15, description: '쯊e gusta la pi침a tropical?', image: '' },
        { id: 't7', name: 'Chezzy (Queso Cheddar liquido)', price: 10, description: '쯋n toque cremoso extra?', image: '' },
        { id: 't5', name: 'Chiles en rodajas', price: 0, description: 'Chiles en rodajas (gratis)', image: '' }
    ];
    const menuData = {
        "Hamburguesas": [
            { id: 1, name: "Cl치sica PREMIUM", price: 100, description: "Pan XL, carne 80/20 arrachera, queso Gouda, queso americano, cebolla caramelizada, lechuga, tomate y tocino.", image: "", customizable: true },
            { id: 2, name: "BBQ BEACON CRUNCH", price: 110, description: "Pan XL, carne 80/20 arrachera, queso americano, cebolla caramelizada, aros de cebolla, tocino y BBQ.", image: "", customizable: true },
            { id: 11, name: "Alohawai Burger", price: 120, description: "Pan XL, carne 80/20 arrachera, queso Gouda, queso americano, cebolla caramelizada, lechuga, tomate, tocino y pi침a.", image: "", customizable: true },
            { id: 12, name: "Chistorraburger", price: 120, description: "Pan XL, carne 80/20 arrachera, queso Gouda, cebolla caramelizada, chistorra y tocino.", image: "", customizable: true },
            { id: 13, name: "Choriargentina Burger", price: 120, description: "Pan XL, carne 80/20 arrachera, queso Gouda, cebolla caramelizada, chorizo argentino y tocino.", image: "", customizable: true },
            { id: 30, name: "Salchiburger", price: 120, description: "Pan XL, carne 80/20 arrachera, queso Gouda, queso americano, cebolla caramelizada, lechuga, tomate, tocino y salchicha.", image: "", customizable: true }
        ],
        "Hot Dogs": [
            { id: 5, name: "Hotdog Jumbo", price: 60, description: "游꺐 Salchicha jumbo jugosa en pan artesanal tostado, tocino crujiente, tomate fresco, cebolla y nuestros aderezos especiales. 춰Preparado al momento para ti!", image: "", customizable: true },
            { id: 27, name: "Jalape침o Dog", price: 60, description: "游꺘勇 Salchicha roja premium con queso manchego derretido, tocino crujiente, cebolla caramelizada y jalape침os frescos.", image: "", customizable: true }
        ],
        "Combos": [
            { id: 26, name: "DOBLES DOBLES", price: 220, originalPrice: 300, description: "游댠 2 hamburguesas a tu elecci칩n a precio especial. La Doble Doble cuesta $300, aqu칤 en combo te la llevas por $220. 춰Ahorras $80!", image: "", isCombo: true, burgerChoices: 2, availableBurgers: [1, 2, 11, 12, 13, 30] },
            { id: 6, name: "Combo Pareja", price: 250, originalPrice: 305, description: "游눗 Perfecto para compartir: 2 hamburguesas deliciosas a tu elecci칩n, papas medianas doradas y 7 aros de cebolla crujientes. 춰Ideal para una cita perfecta!", image: "", isCombo: true, burgerChoices: 2, availableBurgers: [1, 2, 11, 12, 13, 30] },
            { id: 15, name: "Combo D칰o", price: 180, originalPrice: 220, description: "游뱋 Lo mejor de dos mundos: 1 hamburguesa jugosa, 1 hotdog delicioso y papas medianas. 춰Para los que no pueden decidirse y quieren probarlo todo!", image: "", isCombo: true, burgerChoices: 1, availableBurgers: [1, 2, 11, 12, 13, 30], hotdogChoices: 1, availableHotdogs: [5, 27] },
            { id: 7, name: "Combo Amigos", price: 360, originalPrice: 400, description: "游논 Para compartir con tus mejores amigos: 3 hamburguesas espectaculares y papas medianas. 춰Momento perfecto para crear recuerdos!", image: "", isCombo: true, burgerChoices: 3, availableBurgers: [1, 2, 11, 12, 13, 30] },
            { id: 14, name: "Combo Familiar", price: 650, originalPrice: 730, description: "游녿꽳릠뽹꽳릠꽳릠 La experiencia familiar completa: 5 hamburguesas incre칤bles, papas XL (a elegir: gajo o francesas), aros de cebolla medianos y Coca-Cola 3L + ENV칈O GRATIS. 춰Todos felices en casa!", image: "", isCombo: true, burgerChoices: 5, availableBurgers: [1, 2, 11, 12, 13, 30] }
        ],
        "Extras": [
            { id: 8, name: "Papas Gajo Medianas", price: 60, description: "游 Papas gajo doradas y crujientes por fuera, suaves por dentro, sazonadas con nuestra mezcla especial de especias.", image: "" },
            { id: 16, name: "Papas Gajo Grandes", price: 120, description: "游 Porci칩n generosa de nuestras famosas papas gajo, perfectas para compartir. 춰Irresistiblemente adictivas!", image: "" },
            { id: 28, name: "Papas Francesas Medianas", price: 60, description: "游 Papas francesas cl치sicas, doradas y crujientes, cortadas en bastones perfectos. 춰El acompa침amiento tradicional que nunca pasa de moda!", image: "" },
            { id: 29, name: "Papas Francesas Grandes", price: 120, description: "游 Porci칩n grande de nuestras deliciosas papas francesas, cortadas al estilo tradicional y fritas hasta el punto perfecto.", image: "" },
            { id: 17, name: "Salchipapas Medianas", price: 80, description: "游꺐游 La combinaci칩n perfecta: papas doradas con trozos jugosos de salchicha premium. 춰Un cl치sico que nunca falla!", image: "https://i.imgur.com/YgEDfx3.jpeg" },
            { id: 18, name: "Salchipapas Grandes", price: 120, description: "游꺐游 Porci칩n familiar de salchipapas con salchicha premium y papas doradas. 춰Para los que aman los sabores intensos!", image: "https://i.imgur.com/YgEDfx3.jpeg" },
            { id: 19, name: "Aros de Cebolla (8 pz)", price: 45, description: "游븬 Aros de cebolla empanizados y fritos hasta la perfecci칩n, crujientes por fuera y tiernos por dentro.", image: "https://i.imgur.com/rK8wjox.jpeg" },
            { id: 20, name: "Aros de Cebolla Grande (15 pz)", price: 80, description: "游븬 Porci칩n generosa de aros de cebolla dorados. 춰El acompa침amiento perfecto que complementa cualquier orden!", image: "https://i.imgur.com/rK8wjox.jpeg" }
        ],
       "Bebidas": [
           { id: 21, name: "Coca-Cola 600ml", price: 30, description: "游볷 Coca-Cola helada y refrescante, el acompa침ante perfecto para tu comida. 춰Nada como la chispa de la vida!", image: "" },
           { id: 22, name: "Coca-Cola 1.75L", price: 40, description: "游볷 Coca-Cola familiar perfecta para compartir, siempre fr칤a y burbujeante. 춰Momentos especiales merecen la Coca-Cola!", image: "" },
           { id: 23, name: "Coca-Cola 3L", price: 60, description: "游볷 La Coca-Cola grande para toda la familia, helada y con esa burbuja inconfundible que todos amamos. 춰Alegr칤a para todos!", image: "" },
           { id: 24, name: "Agua Natural 600ml", price: 20, description: "游눦 Agua natural pura y refrescante para hidratarte mientras disfrutas de tu comida favorita.", image: "" }
       ]
    };

    // Antes se permit칤a 랃acer grande/XL desde el modal.
    // Ahora los tama침os grandes ya existen como productos separados en el men칰, as칤 que deshabilitamos ese upgrade.
    const EXTRA_LARGE_VARIANTS = {};
    const WHATSAPP_NUMBER = '5219221593688';
    // API base:
    // - If window.__API_BASE is set, use it.
    // - If served over http(s), use the same origin (works on LAN mobile: http://192.168.x.x:PORT).
    // - If opened as file:// (origin = "null"), fall back to localhost (PC-only).
    const API_BASE = (() => {
        try {
            if (typeof window !== 'undefined' && window.__API_BASE) return String(window.__API_BASE).replace(/\/$/, '');
            const origin = (typeof window !== 'undefined' && window.location && window.location.origin)
                ? String(window.location.origin)
                : '';
            if (origin && origin !== 'null') return origin.replace(/\/$/, '');
        } catch (_) {}
        return 'http://localhost:3000';
    })();
    const API_BASES = (() => {
        const list = [];
        try {
            if (typeof window !== 'undefined' && window.__API_BASE) list.push(String(window.__API_BASE).replace(/\/$/, ''));
            const origin = (typeof window !== 'undefined' && window.location && window.location.origin)
                ? String(window.location.origin)
                : '';
            if (origin && origin !== 'null') list.push(origin.replace(/\/$/, ''));
        } catch (_) {}
        list.push('http://localhost:3000');
        return Array.from(new Set(list));
    })();

    // Helper: POST order with fallback endpoints and timeout
    async function postOrderToApi(orderData) {
        const url = `${API_BASE}/api/send-order`;
        console.log('Enviando pedido a:', url);
        
        try {
            const resp = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(orderData)
            });

            if (!resp.ok) {
                let errorText = '';
                try {
                    const errorData = await resp.json();
                    errorText = errorData.error || await resp.text();
                } catch (e) {
                    errorText = await resp.text();
                }
                throw new Error(`Error ${resp.status}: ${errorText}`);
            }

            return await resp.json();
        } catch (err) {
            console.error('Error al enviar pedido:', err);
            throw err;
        }
    }
    let cart = [];
    let tempComboConfig = {};
    userAddress = null;
    deliveryCalcPending = 0;

    // Recompensa activa (canjeada en Mi cuenta) para aplicar en la siguiente compra
    let activeReward = null;

    // C칩digo de descuento activo (cup칩n)
    let activeDiscountCode = null;

    function setActiveRewardState(reward) {
        activeReward = (reward && typeof reward === 'object') ? reward : null;
        try {
            localStorage.setItem('activeReward', JSON.stringify(activeReward));
        } catch (_) {}
    }

    function getActiveRewardState() {
        if (activeReward) return activeReward;
        try {
            const raw = localStorage.getItem('activeReward');
            if (raw) {
                const parsed = JSON.parse(raw);
                activeReward = (parsed && typeof parsed === 'object') ? parsed : null;
            }
        } catch (_) {
            activeReward = null;
        }
        return activeReward;
    }

    function normalizeDiscountCode(raw) {
        const s = String(raw || '').trim().toUpperCase();
        // Permitir letras, n칰meros, guion y guion bajo
        return s.replace(/[^A-Z0-9_-]/g, '').slice(0, 32);
    }

    function setActiveDiscountCodeState(codeObj) {
        const normalized = codeObj && typeof codeObj === 'object'
            ? {
                code: normalizeDiscountCode(codeObj.code),
                amount: Number(codeObj.amount || 0),
                verifiedAt: Number(codeObj.verifiedAt || Date.now())
            }
            : null;

        if (!normalized || !normalized.code || !isFinite(normalized.amount) || normalized.amount <= 0) {
            activeDiscountCode = null;
            try { localStorage.removeItem('activeDiscountCode'); } catch (_) {}
            return;
        }

        activeDiscountCode = normalized;
        try { localStorage.setItem('activeDiscountCode', JSON.stringify(activeDiscountCode)); } catch (_) {}
    }

    function clearActiveDiscountCodeState() {
        activeDiscountCode = null;
        try { localStorage.removeItem('activeDiscountCode'); } catch (_) {}
    }

    function getActiveDiscountCodeState() {
        if (activeDiscountCode && typeof activeDiscountCode === 'object') return activeDiscountCode;
        try {
            const raw = localStorage.getItem('activeDiscountCode');
            if (raw) {
                const parsed = JSON.parse(raw);
                if (parsed && typeof parsed === 'object') {
                    const code = normalizeDiscountCode(parsed.code);
                    const amount = Number(parsed.amount || 0);
                    if (code && isFinite(amount) && amount > 0) {
                        activeDiscountCode = {
                            code,
                            amount,
                            verifiedAt: Number(parsed.verifiedAt || 0) || 0
                        };
                        return activeDiscountCode;
                    }
                }
            }
        } catch (_) {}
        activeDiscountCode = null;
        return null;
    }

    async function fetchDiscountCodeInfo(codeUpper) {
        const code = normalizeDiscountCode(codeUpper);
        if (!code) return null;
        if (!window.firebaseDb) throw new Error('Firebase no est치 listo');

        const firestore = await import('https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js');
        const ref = firestore.doc(window.firebaseDb, 'discount_codes', code);
        const snap = await firestore.getDoc(ref);
        if (!snap.exists()) return null;

        const data = snap.data() || {};
        const active = data.active !== false;
        const amount = Number(data.amount || data.discountAmount || 0);
        if (!active) throw new Error('C칩digo desactivado');
        if (!isFinite(amount) || amount <= 0) throw new Error('C칩digo inv치lido');

        return {
            code,
            amount: Number(amount.toFixed(2))
        };
    }

    function computeCheckoutPricing(deliveryTypeValue) {
        const subtotal = Number(getCartTotal() || 0);
        const reward = getActiveRewardState();
        const discountPercent = reward && isFinite(reward.discountPercent) ? Number(reward.discountPercent) : 0;

        const rewardDiscountAmount = (discountPercent > 0)
            ? Number(((subtotal * discountPercent) / 100).toFixed(2))
            : 0;

        const discountCodeState = getActiveDiscountCodeState();
        const discountCode = discountCodeState && discountCodeState.code ? String(discountCodeState.code) : '';
        const rawCodeAmount = discountCodeState && isFinite(discountCodeState.amount) ? Number(discountCodeState.amount) : 0;

        const subtotalAfterReward = Math.max(0, Number((subtotal - rewardDiscountAmount).toFixed(2)));
        const discountCodeAmount = discountCode ? Math.min(Math.max(0, rawCodeAmount), subtotalAfterReward) : 0;

        const discountAmount = Number((rewardDiscountAmount + discountCodeAmount).toFixed(2));
        const subtotalAfterDiscount = Math.max(0, Number((subtotalAfterReward - discountCodeAmount).toFixed(2)));

        const isDelivery = deliveryTypeValue === 'delivery';
        
        // MODO MANUAL: obtener costo de env칤o del input manual
        const isManualMode = (typeof window.__MANUAL_MODE !== 'undefined' && window.__MANUAL_MODE === true);
        let baseDeliveryFee = 0;
        
        if (isDelivery) {
            if (isManualMode) {
                // Modo manual: leer del input manual-delivery-cost
                const manualCostEl = document.getElementById('manual-delivery-cost');
                baseDeliveryFee = manualCostEl ? (parseFloat(manualCostEl.value) || 0) : 0;
            } else {
                // Modo normal: usar direcci칩n guardada
                baseDeliveryFee = (userAddress && typeof userAddress.deliveryPrice === 'number' && isFinite(userAddress.deliveryPrice))
                    ? Number(userAddress.deliveryPrice)
                    : 0;
            }
        }

        let deliveryFee = baseDeliveryFee;
        const freeDelivery = !!(reward && reward.freeDelivery);
        if (isDelivery && freeDelivery && baseDeliveryFee > 0) {
            deliveryFee = 0;
        }

        const total = Number((subtotalAfterDiscount + deliveryFee).toFixed(2));

        const rewardApplied = !!(
            reward && (
                (discountPercent > 0 && rewardDiscountAmount > 0) ||
                (isDelivery && freeDelivery && baseDeliveryFee > 0)
            )
        );

        const parts = [];
        if (rewardApplied && reward && reward.label) parts.push(`Recompensa: ${reward.label}`);
        if (discountCode) parts.push(`C칩digo: ${discountCode}`);
        const discountReason = parts.join(' + ');

        return {
            subtotal,
            discountPercent,
            discountAmount,
            rewardDiscountAmount,
            discountCode,
            discountCodeAmount,
            discountReason,
            subtotalAfterDiscount,
            baseDeliveryFee,
            deliveryFee,
            total,
            reward,
            rewardApplied
        };
    }

    function getCurrentDeliveryFee() {
        const deliveryTypeValue = document.querySelector('input[name="delivery-type"]:checked')?.value;
        if (deliveryTypeValue !== 'delivery') return 0;
        const baseFee = (userAddress && typeof userAddress.deliveryPrice === 'number' && isFinite(userAddress.deliveryPrice))
            ? Number(userAddress.deliveryPrice)
            : 0;
        const reward = getActiveRewardState();
        if (reward && reward.freeDelivery && baseFee > 0) return 0;
        return baseFee;
    }

    // --- PROMOCIONES DIARIAS ---
    const dailyPromotions = {
        2: { // Martes - HOTDOG MANIA (antes lunes)
            type: 'hotdog_discount',
            discount: 0.20, // 20% descuento
            description: '20% DESCUENTO EN HOTDOGS',
            categories: ['Hot Dogs']
        },
        3: { // Mi칠rcoles - BBQ BEACON CRUNCH a $100 (antes martes)
            type: 'specific_item',
            targetItem: 2, // BBQ BEACON CRUNCH
            specialPrice: 100,
            description: 'BBQ BEACON CRUNCH A $100',
            categories: ['Hamburguesas']
        },
        4: { // Jueves - Papas gratis complemento (antes mi칠rcoles)
            type: 'free_fries',
            description: 'PAPAS GRATIS CON HAMBURGUESA O HOTDOG',
            categories: ['Hamburguesas', 'Hot Dogs']
        }
    };

    // Funci칩n para obtener el d칤a actual y aplicar promociones
    function getCurrentDayPromotion() {
        const today = new Date().getDay(); // 0 = Domingo, 1 = Lunes, etc.
        return dailyPromotions[today] || null;
    }

    // Funci칩n para aplicar promociones a un item
    function applyDailyPromotion(item, category) {
        const promotion = getCurrentDayPromotion();
        if (!promotion) return { ...item };

        const promotedItem = { ...item, originalPrice: item.price };

        // Aplicar promoci칩n seg칰n el tipo
        switch (promotion.type) {
            case 'hotdog_discount':
                if (category === 'Hot Dogs') {
                    promotedItem.price = Math.round(item.price * (1 - promotion.discount));
                    promotedItem.hasPromotion = true;
                    promotedItem.promotionText = promotion.description;
                }
                break;
            
            case 'specific_item':
                if (item.id === promotion.targetItem) {
                    promotedItem.price = promotion.specialPrice;
                    promotedItem.hasPromotion = true;
                    promotedItem.promotionText = promotion.description;
                }
                break;
            
            case 'free_fries':
                if (category === 'Hamburguesas' || category === 'Hot Dogs') {
                    promotedItem.hasPromotion = true;
                    promotedItem.promotionText = promotion.description;
                    promotedItem.freeFries = true;
                }
                break;
            
            case 'meat_supreme':
                if (category === 'Hamburguesas') {
                    promotedItem.hasPromotion = true;
                    promotedItem.promotionText = promotion.description;
                    promotedItem.meatSupreme = true;
                }
                break;
        }

        return promotedItem;
    }

    // Funci칩n para verificar si las promociones del d칤a afectan a los combos
    function doesDailyPromotionAffectCombos() {
        const promotion = getCurrentDayPromotion();
        if (!promotion) return false;
        
        // Las promociones que afectan a hamburguesas o hotdogs afectan a los combos
        // porque los combos incluyen estos productos
        switch (promotion.type) {
            case 'hotdog_discount':
                // Lunes: descuento en hotdogs - afecta Combo D칰o
                return true;
            case 'specific_item':
                // Martes: BBQ BEACON CRUNCH a precio especial - afecta todos los combos que incluyan hamburguesas
                return true;
            case 'free_fries':
                // Mi칠rcoles: papas gratis con hamburguesas - afecta todos los combos
                return true;
            case 'meat_supreme':
                // Jueves: carne extra barata - afecta todos los combos que incluyan hamburguesas
                return true;
            default:
                return false;
        }
    }

    // --- ELEMENTS --- (Se inicializar치n dentro de initialize())
    let menuContainer;
    let cartSidebar;
    let cartOverlay;
    let openCartBtn;
    let closeCartBtn;
    let cartItemsContainer;
    let cartEmptyMsg;
    let cartCount;
    let cartTotal;
    let checkoutBtn;
    let stickyCartBar;
    let stickyCartItems;
    let stickyCartTotal;
    let stickyCartOpenBtn;
    let cartEmptyCtaBtn;
    let checkoutModal;
    let closeModalBtn;
    let orderSummaryContainer;
    let sendWhatsappBtn;
    let customerNameInput;
    let customerPhoneInput;
    let customModal;
    let customModalTitle;
    let toppingsContainer;
    let customModalTotal;
    let customNotesSection;
    let customNotesInput;
    let customNotesDivider;
    let addCustomToCartBtn;
    let closeCustomModalBtn;
    let addFriesCheckbox;
    let friesChoiceContainer;
    let comboModal;
    let comboModalTitle;
    let comboModalBody;
    let comboModalTotal;
    let addComboToCartBtn;
    let closeComboModalBtn;
    let promotionsBtn;
    let promotionsModal;
    let closePromotionsModalBtn;

    // --- DELIVERY DISTANCE CALCULATION ---
    
    // Funci칩n para calcular la distancia entre dos puntos usando la f칩rmula de Haversine
    function calculateDistance(lat1, lng1, lat2, lng2) {
        const R = 6371; // Radio de la Tierra en kil칩metros
        const dLat = (lat2 - lat1) * Math.PI / 180;
        const dLng = (lng2 - lng1) * Math.PI / 180;
        const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                  Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                  Math.sin(dLng/2) * Math.sin(dLng/2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        const distance = R * c; // Distancia en kil칩metros
        return distance;
    }

    // Distancia real por ruta (carro) usando Google Distance Matrix
    // Devuelve { distanceKm, durationMin, source }
    const drivingDistanceCache = new Map();

    function canUseDistanceMatrix() {
        return !!(window.google && window.google.maps && window.google.maps.DistanceMatrixService);
    }

    function cacheKeyForLatLng(lat, lng) {
        return `${Number(lat).toFixed(5)},${Number(lng).toFixed(5)}`;
    }

    function distanceMatrixRequest(originLatLng, destLatLng) {
        return new Promise((resolve, reject) => {
            try {
                let settled = false;
                const timeoutMs = 4500;
                const timer = setTimeout(() => {
                    if (settled) return;
                    settled = true;
                    reject(new Error('DistanceMatrix timeout'));
                }, timeoutMs);

                const service = new google.maps.DistanceMatrixService();
                service.getDistanceMatrix({
                    origins: [originLatLng],
                    destinations: [destLatLng],
                    travelMode: google.maps.TravelMode.DRIVING,
                    unitSystem: google.maps.UnitSystem.METRIC,
                    avoidHighways: false,
                    avoidTolls: false
                }, (response, status) => {
                    if (settled) return;
                    settled = true;
                    clearTimeout(timer);
                    if (status !== 'OK' || !response) {
                        reject(new Error(`DistanceMatrix status: ${status}`));
                        return;
                    }
                    const row = response.rows && response.rows[0];
                    const elem = row && row.elements && row.elements[0];
                    const elemStatus = elem && elem.status;
                    if (elemStatus !== 'OK') {
                        reject(new Error(`DistanceMatrix element status: ${elemStatus || 'UNKNOWN'}`));
                        return;
                    }
                    resolve(elem);
                });
            } catch (e) {
                reject(e);
            }
        });
    }

    async function getDeliveryDistanceKmAndDuration(customerLat, customerLng) {
        // 0) Preferir Distance Matrix v칤a backend (same-origin) para evitar dependencia de la carga de Google Maps JS
        try {
            const key = cacheKeyForLatLng(customerLat, customerLng);
            const cached = drivingDistanceCache.get(key);
            if (cached) return cached;

            const qs = new URLSearchParams({
                destLat: String(customerLat),
                destLng: String(customerLng)
            });
            const resp = await fetch(`/api/distance-matrix?${qs.toString()}`);
            if (resp && resp.ok) {
                const data = await resp.json();
                if (data && data.ok && typeof data.distanceKm === 'number' && isFinite(data.distanceKm)) {
                    const out = {
                        distanceKm: data.distanceKm,
                        durationMin: (typeof data.durationMin === 'number' && isFinite(data.durationMin)) ? data.durationMin : null,
                        source: 'driving'
                    };
                    drivingDistanceCache.set(key, out);
                    return out;
                }
            }
        } catch (e) {
            // Silencioso: se intentar치 por Google Maps JS / fallback
        }

        // 1) Prefer ruta real si Google Maps est치 disponible
        if (canUseDistanceMatrix()) {
            const key = cacheKeyForLatLng(customerLat, customerLng);
            const cached = drivingDistanceCache.get(key);
            if (cached) return cached;

            try {
                const origin = new google.maps.LatLng(RESTAURANT_LOCATION.lat, RESTAURANT_LOCATION.lng);
                const dest = new google.maps.LatLng(customerLat, customerLng);
                const elem = await distanceMatrixRequest(origin, dest);
                const distanceKm = (elem.distance && typeof elem.distance.value === 'number') ? (elem.distance.value / 1000) : null;
                const durationMin = (elem.duration && typeof elem.duration.value === 'number') ? Math.round(elem.duration.value / 60) : null;
                if (typeof distanceKm === 'number' && isFinite(distanceKm)) {
                    const out = { distanceKm, durationMin, source: 'driving' };
                    drivingDistanceCache.set(key, out);
                    return out;
                }
            } catch (e) {
                console.warn('丘멆잺 DistanceMatrix fall칩, usando Haversine como respaldo:', e);
            }
        }

        // 2) Fallback: distancia en l칤nea recta
        const distanceKm = calculateDistance(RESTAURANT_LOCATION.lat, RESTAURANT_LOCATION.lng, customerLat, customerLng);
        return { distanceKm, durationMin: null, source: 'haversine' };
    }

    function getEtaText(distanceKm, durationMin) {
        if (typeof durationMin === 'number' && isFinite(durationMin) && durationMin > 0) {
            return `~${durationMin} min`;
        }
        return distanceKm <= 4 ? '25-35 min' : '35-45 min';
    }
    
    // Funci칩n para calcular el precio de env칤o basado en la distancia
    function calculateDeliveryPrice(distance) {
        if (typeof distance !== 'number' || !isFinite(distance)) return null;
        if (distance <= 0) return 0;
        if (distance <= MAX_DELIVERY_DISTANCE) {
            // Redondeo al entero m치s cercano: <0.5 baja, >=0.5 sube
            const kmToCharge = Math.max(1, Math.round(distance));
            return kmToCharge * COSTO_POR_KM;
        }
        return null; // Fuera del rango de entrega
    }
    
    // Funci칩n para obtener la zona de entrega y precio
    function getDeliveryZone(distance) {
        const price = calculateDeliveryPrice(distance);
        if (price !== null) {
            return {
                zone: `Env칤o a $${COSTO_POR_KM}/km`,
                price: price,
                color: 'green',
                description: `Tarifa: $${COSTO_POR_KM} por KM (redondeo al entero m치s cercano)`
            };
        }
        return {
            zone: 'Fuera de cobertura',
            price: null,
            color: 'red',
            description: `Lo sentimos, no llegamos a ${distance.toFixed(1)} km de distancia`
        };
    }

    // --- FUNCTIONS ---
    function findItemById(itemId) {
        for (const category in menuData) {
            const item = menuData[category].find(i => i.id === itemId);
            if (item) return item;
        }
        return null;
    }

    function findItemByIdWithCategory(itemId) {
        for (const category in menuData) {
            const arr = Array.isArray(menuData[category]) ? menuData[category] : [];
            const item = arr.find(i => Number(i && i.id) === Number(itemId));
            if (item) return { category, item };
        }
        return null;
    }

    function getCategoryForItemId(itemId) {
        const found = findItemByIdWithCategory(itemId);
        return found ? String(found.category || '') : '';
    }

    function isFreeFriesPromotionActiveForCategory(category) {
        const promotion = getCurrentDayPromotion();
        if (!promotion || promotion.type !== 'free_fries') return false;
        return category === 'Hamburguesas' || category === 'Hot Dogs';
    }

    function getFreeFriesDisplayNameByType(friesType) {
        const normalized = String(friesType || '').toLowerCase();
        if (normalized.includes('frances')) return 'Papas Francesas Medianas';
        return 'Papas Gajo Medianas';
    }

    function openBonelesOptionsModal(itemId, buttonEl) {
        const found = findItemByIdWithCategory(itemId);
        if (!found || !found.item) return;
        const categoryName = String(found.category || '').trim();
        if (categoryName.toLowerCase() !== 'boneles') {
            addToCart(itemId);
            return;
        }

        const item = found.item;
        const basePrice = (typeof item.price === 'number' && isFinite(item.price)) ? Number(item.price) : 0;

        const gramOptions = [
            { grams: 250, label: '250 Gramos', price: basePrice },
            { grams: 500, label: '500 Gramos', price: 250 },
            { grams: 1000, label: '1000 Gramos', price: 480 }
        ];
        const friesOptions = ['Gajo', 'Francesas'];
        const sauceOptions = ['BBQ DULCE', 'BBQ PICANTE', 'RANCH PARMESANO'];

        let selectedGrams = 250;
        let selectedFries = friesOptions[0];
        let selectedSauce = sauceOptions[0];

        const getSelectedPrice = () => {
            const opt = gramOptions.find(o => o.grams === selectedGrams) || gramOptions[0];
            const p = Number(opt && opt.price);
            return (isFinite(p) && p >= 0) ? p : 0;
        };

        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-black/70 z-[200] flex items-center justify-center p-4';
        modal.innerHTML = `
            <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg overflow-hidden">
                <div class="bg-gradient-to-r from-yellow-500 to-orange-500 text-[#212121] p-5">
                    <div class="flex items-start justify-between">
                        <div>
                            <div class="text-xs font-bold opacity-90">Boneles</div>
                            <h3 class="text-xl sm:text-2xl font-extrabold">${String(item.name || 'Boneles')}</h3>
                        </div>
                        <button type="button" class="sr-boneles-close w-10 h-10 rounded-full bg-white/30 hover:bg-white/40 flex items-center justify-center" aria-label="Cerrar">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="mt-2 text-sm font-semibold">
                        Total: <span class="sr-boneles-price">$${getSelectedPrice().toFixed(0)}</span>
                    </div>
                </div>

                <div class="p-5 space-y-5">
                    <div>
                        <div class="font-bold text-gray-800 mb-2">Selecciona porci칩n</div>
                        <div class="grid grid-cols-1 sm:grid-cols-3 gap-2">
                            ${gramOptions.map(opt => {
                                const checked = opt.grams === 250 ? 'checked' : '';
                                return `
                                    <label class="border rounded-xl p-3 cursor-pointer hover:border-yellow-400 transition-colors">
                                        <input type="radio" name="boneles-grams" value="${opt.grams}" class="mr-2" ${checked}>
                                        <div class="inline-block align-middle">
                                            <div class="font-bold text-gray-800">${opt.label}</div>
                                            <div class="text-sm text-gray-600">$${Number(opt.price).toFixed(0)}</div>
                                        </div>
                                    </label>
                                `;
                            }).join('')}
                        </div>
                        <div class="text-xs text-gray-500 mt-2">250g usa el precio del producto. 500g: $250. 1000g: $480.</div>
                    </div>

                    <div>
                        <div class="font-bold text-gray-800 mb-2">Tipo de papas</div>
                        <div class="grid grid-cols-2 gap-2">
                            ${friesOptions.map((opt, idx) => {
                                const checked = idx === 0 ? 'checked' : '';
                                return `
                                    <label class="border rounded-xl p-3 cursor-pointer hover:border-yellow-400 transition-colors">
                                        <input type="radio" name="boneles-fries" value="${opt}" class="mr-2" ${checked}>
                                        <span class="font-semibold text-gray-800">${opt}</span>
                                    </label>
                                `;
                            }).join('')}
                        </div>
                    </div>

                    <div>
                        <div class="font-bold text-gray-800 mb-2">Tipo de salsa</div>
                        <div class="grid grid-cols-1 sm:grid-cols-3 gap-2">
                            ${sauceOptions.map((opt, idx) => {
                                const checked = idx === 0 ? 'checked' : '';
                                return `
                                    <label class="border rounded-xl p-3 cursor-pointer hover:border-yellow-400 transition-colors">
                                        <input type="radio" name="boneles-sauce" value="${opt}" class="mr-2" ${checked}>
                                        <span class="font-semibold text-gray-800">${opt}</span>
                                    </label>
                                `;
                            }).join('')}
                        </div>
                    </div>
                </div>

                <div class="p-5 pt-0 flex gap-3">
                    <button type="button" class="sr-boneles-cancel w-1/2 border rounded-xl py-3 font-bold">Cancelar</button>
                    <button type="button" class="sr-boneles-confirm w-1/2 bg-gradient-to-r from-yellow-400 to-orange-500 text-[#212121] rounded-xl py-3 font-extrabold shadow-lg hover:from-yellow-500 hover:to-orange-600">
                        Agregar
                    </button>
                </div>
            </div>
        `;

        const close = () => {
            try { document.removeEventListener('keydown', onKeyDown); } catch (_) {}
            if (modal && modal.parentElement) modal.parentElement.removeChild(modal);
        };
        const onKeyDown = (e) => {
            if (e.key === 'Escape') close();
        };
        document.addEventListener('keydown', onKeyDown);

        modal.addEventListener('click', (e) => {
            if (e.target === modal) close();
        });

        const priceEl = modal.querySelector('.sr-boneles-price');
        const refreshPrice = () => {
            const p = getSelectedPrice();
            if (priceEl) priceEl.textContent = `$${p.toFixed(0)}`;
        };

        modal.addEventListener('change', (e) => {
            const t = e.target;
            if (!t) return;
            if (t.name === 'boneles-grams') {
                selectedGrams = Number(t.value);
                refreshPrice();
            }
            if (t.name === 'boneles-fries') {
                selectedFries = String(t.value);
            }
            if (t.name === 'boneles-sauce') {
                selectedSauce = String(t.value);
            }
        });

        modal.querySelector('.sr-boneles-close')?.addEventListener('click', close);
        modal.querySelector('.sr-boneles-cancel')?.addEventListener('click', close);
        modal.querySelector('.sr-boneles-confirm')?.addEventListener('click', () => {
            const chosenPrice = getSelectedPrice();
            const originalText = buttonEl ? buttonEl.innerHTML : '';
            if (buttonEl) showLoading(buttonEl);

            close();

            setTimeout(() => {
                const cartItem = {
                    id: Date.now(),
                    baseItem: item,
                    customizations: [
                        { name: `Porci칩n: ${selectedGrams}g`, price: 0 },
                        { name: `Papas: ${selectedFries}`, price: 0 },
                        { name: `Salsa: ${selectedSauce}`, price: 0 }
                    ],
                    fries: null,
                    onionRings: null,
                    menuExtras: [],
                    price: chosenPrice,
                    quantity: 1,
                    boneles: {
                        grams: selectedGrams,
                        friesType: selectedFries,
                        sauce: selectedSauce
                    }
                };

                cart.push(cartItem);
                updateCart();

                if (buttonEl) hideLoading(buttonEl, originalText);

                setTimeout(() => {
                    showSuccessNotification(`${item.name} agregado al carrito`);
                    bounceCart();
                    startCartAbandonmentTimer();
                }, 200);
            }, 800);
        });

        document.body.appendChild(modal);
    }
    
    // Enhanced addToCart with better visual feedback
    function addToCart(itemId) {
        const item = findItemById(itemId);
        if (!item) return;
        
        // Add loading state to button with better visual feedback
        const button = document.querySelector(`[data-id="${itemId}"].add-to-cart-btn`);
        if (button) {
            const originalText = button.innerHTML;
            showLoading(button);
            
            // Add vibration for mobile devices
            if (navigator.vibrate) {
                navigator.vibrate([50, 30, 50]);
            }
            
            setTimeout(() => {
                const cartItem = {
                    id: Date.now(),
                    baseItem: item,
                    customizations: [],
                    fries: null,
                    onionRings: null,
                    menuExtras: [],
                    price: item.price,
                    quantity: 1
                };
                
                cart.push(cartItem);
                updateCart();
                hideLoading(button, originalText);
                
                // Enhanced feedback with better timing
                setTimeout(() => {
                    showSuccessNotification(`${item.name} agregado al carrito 游꿀`);
                    bounceCart();
                    addSmartRecommendations(itemId);
                    startCartAbandonmentTimer();
                }, 200);
                
            }, 800); // Longer loading time for better visual feedback
        }
    }
    
    // Enhanced cart calculation
    function calculateCartTotal() {
        let total = 0;
        cart.forEach(item => {
            total += item.price * item.quantity;
        });
        
        // Add delivery fee if applicable
        const deliveryType = document.querySelector('input[name="delivery-type"]:checked')?.value;
        if (deliveryType === 'delivery') {
            // Si hay una direcci칩n seleccionada, usar el precio calculado
            if (userAddress && userAddress.deliveryPrice !== undefined) {
                total += userAddress.deliveryPrice;
            } else {
                // Usar precio base si no hay direcci칩n espec칤fica
                total += DELIVERY_PRICE;
            }
        }
        
        return total;
    }
    
    // Enhanced updateCart with better animations
    function updateCart() {
        const cartItemsContainer = document.getElementById('cart-items');
        const cartEmptyMsg = document.getElementById('cart-empty-msg');
        const cartCount = document.getElementById('cart-count');
        const cartTotal = document.getElementById('cart-total');
        const checkoutBtn = document.getElementById('checkout-btn');
        
        // Update cart count with enhanced animation
        const oldCount = cartCount.textContent;
        cartCount.textContent = cart.length;
        if (cart.length > oldCount) {
            cartCount.classList.add('animate-pulse', 'bg-red-500', 'scale-110');
            setTimeout(() => {
                cartCount.classList.remove('animate-pulse', 'bg-red-500', 'scale-110');
            }, 1000);
        }
        
        if (cart.length === 0) {
            cartEmptyMsg.style.display = 'block';
            cartItemsContainer.innerHTML = '';
            cartTotal.textContent = '$0.00';
            checkoutBtn.disabled = true;
            checkoutBtn.classList.add('opacity-50');
            return;
        }
        
        cartEmptyMsg.style.display = 'none';
        checkoutBtn.disabled = false;
        checkoutBtn.classList.remove('opacity-50');
        
        // Enhanced cart items rendering with better UX
        cartItemsContainer.innerHTML = cart.map((item, index) => `
            <div class="cart-item-enter bg-gradient-to-r from-white to-gray-50 p-4 rounded-lg shadow-sm border border-gray-100 mb-3 hover:shadow-md transition-all duration-300">
                <div class="flex items-start space-x-3">
                ${((typeof window.__MANUAL_FAST_MODE === 'undefined' || window.__MANUAL_FAST_MODE !== true) && item.baseItem && item.baseItem.image) ? `<img src="${item.baseItem.image}" alt="${item.baseItem.name}" class="w-16 h-16 object-cover rounded-lg shadow-sm" referrerpolicy="no-referrer" onerror="this.onerror=null;this.style.display='none';">` : `<div class="w-16 h-16 rounded-lg bg-gray-100"></div>`}
                    <div class="flex-grow">
                        <h4 class="font-bold text-gray-800 text-lg">${item.baseItem.name}</h4>
                        
                        ${item.isCombo ? `
                            <div class="text-sm text-gray-600 mb-2">
                                <div class="bg-blue-50 p-2 rounded mb-2">
                                    <strong class="text-blue-800">Combo incluye:</strong>
                                    <ul class="mt-1 space-y-1">
                                        ${item.choices.map(choice => `
                                            <li class="flex items-center text-xs">
                                                <i class="fas fa-hamburger text-blue-600 mr-1"></i>
                                                ${choice.burger.name}
                                                ${choice.customizations.length > 0 ? 
                                                    `<span class="ml-2 bg-yellow-100 text-yellow-800 px-1 rounded text-xs">
                                                        +${choice.customizations.length} extras
                                                    </span>` : ''}
                                            </li>
                                        `).join('')}
                                        ${item.hotdogs ? item.hotdogs.map(hotdog => `
                                            <li class="flex items-center text-xs">
                                                <i class="fas fa-hotdog text-red-600 mr-1"></i>
                                                ${hotdog.hotdog.name}
                                            </li>
                                        `).join('') : ''}
                                        <li class="flex items-center text-xs">
                                            <i class="fas fa-fries text-yellow-600 mr-1"></i>
                                            Papas ${item.includedFries.type} ${item.includedFries.size}
                                        </li>
                                        ${item.baseItem.name.includes('Coca-Cola') ? 
                                            `<li class="flex items-center text-xs">
                                                <i class="fas fa-glass text-blue-600 mr-1"></i>
                                                Bebida incluida
                                            </li>` : ''}
                                    </ul>
                                </div>
                            </div>
                        ` : ''}
                        
                        ${(item.customizations && item.customizations.length > 0) || item.fries || item.onionRings || (item.menuExtras && item.menuExtras.length > 0) || item.freeFriesIncluded ? `
                            <div class="text-sm text-gray-600 bg-green-50 p-2 rounded mb-2">
                                <strong class="text-green-800">Personalizaciones:</strong>
                                <ul class="mt-1 space-y-1">
                                    ${item.customizations ? item.customizations.map(custom => `
                                        <li class="flex justify-between text-xs">
                                            <span> ${custom.name}</span>
                                            <span class="font-semibold text-green-700">+$${custom.price}</span>
                                        </li>
                                    `).join('') : ''}
                                    ${item.fries ? `
                                        <li class="flex justify-between text-xs">
                                            <span> Papas ${item.fries.type}</span>
                                            <span class="font-semibold text-green-700">+$${item.fries.price}</span>
                                        </li>
                                    ` : ''}
                                    ${item.onionRings ? `
                                        <li class="flex justify-between text-xs">
                                            <span> Aros de Cebolla</span>
                                            <span class="font-semibold text-green-700">+$${item.onionRings.price}</span>
                                        </li>
                                    ` : ''}
                                    ${item.menuExtras ? item.menuExtras.map(extra => `
                                        <li class="flex justify-between text-xs">
                                            <span> ${extra.name} ${extra.quantity > 1 ? `(${extra.quantity})` : ''}</span>
                                            <span class="font-semibold text-green-700">+$${(extra.price * extra.quantity)}</span>
                                        </li>
                                    `).join('') : ''}
                                    ${item.freeFriesIncluded ? `
                                        <li class="flex justify-between text-xs">
                                            <span> ${item.freeFriesIncluded.name}</span>
                                            <span class="font-semibold text-green-700">GRATIS</span>
                                        </li>
                                    ` : ''}
                                </ul>
                            </div>
                        ` : ''}
                        
                        <div class="flex justify-between items-center mt-3">
                            <div class="flex items-center space-x-3 bg-gray-100 rounded-full p-1">
                                <button onclick="changeQuantity(${index}, -1)" 
                                        class="w-8 h-8 bg-white text-gray-600 rounded-full hover:bg-gray-200 hover:text-gray-800 transition-colors duration-200 flex items-center justify-center shadow-sm">
                                    <i class="fas fa-minus text-sm"></i>
                                </button>
                                <span class="font-bold text-lg min-w-[2rem] text-center">${item.quantity}</span>
                                <button onclick="changeQuantity(${index}, 1)" 
                                        class="w-8 h-8 bg-white text-gray-600 rounded-full hover:bg-gray-200 hover:text-gray-800 transition-colors duration-200 flex items-center justify-center shadow-sm">
                                    <i class="fas fa-plus text-sm"></i>
                                </button>
                            </div>
                            <div class="text-right">
                                <div class="text-xl font-bold text-[#FFB300]">$${(item.price * item.quantity).toFixed(0)}</div>
                                ${item.quantity > 1 ? `<div class="text-xs text-gray-500">$${item.price.toFixed(0)} c/u</div>` : ''}
                            </div>
                        </div>
                    </div>
                    <button onclick="removeFromCart(${index})" 
                            class="text-red-400 hover:text-red-600 hover:bg-red-50 p-2 rounded-full transition-colors duration-200">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                </div>
            </div>
        `).join('');
        
        // Update total with animation
        const total = calculateCartTotal();
        cartTotal.textContent = `$${total.toFixed(0)}`;
        
        // Update floating total preview
        if (window.updateTotalPreview) {
            window.updateTotalPreview();
        }
        
        // Add progress bar for free delivery
        addFreeDeliveryProgress(total);
    }
    
    // Add free delivery progress indicator
    function addFreeDeliveryProgress(currentTotal) {
        const freeDeliveryThreshold = 500;
        let progressContainer = document.getElementById('free-delivery-progress');
        
        if (!progressContainer) {
            progressContainer = document.createElement('div');
            progressContainer.id = 'free-delivery-progress';
            progressContainer.className = 'bg-gradient-to-r from-green-50 to-emerald-50 p-4 mb-4 rounded-lg border border-green-200';
            
            const cartItems = document.getElementById('cart-items');
            cartItems.parentNode.insertBefore(progressContainer, cartItems);
        }
        
        const remaining = Math.max(0, freeDeliveryThreshold - currentTotal);
        const progress = Math.min(100, (currentTotal / freeDeliveryThreshold) * 100);
        
        if (currentTotal >= freeDeliveryThreshold) {
            progressContainer.innerHTML = `
                <div class="text-center">
                    <div class="flex items-center justify-center space-x-2 text-green-700 font-bold">
                        <i class="fas fa-check-circle text-xl"></i>
                        <span>춰ENV칈O GRATIS desbloqueado! 游뚴</span>
                    </div>
                    <p class="text-sm text-green-600 mt-1">Tu pedido califica para env칤o gratuito</p>
                </div>
            `;
        } else {
            progressContainer.innerHTML = `
                <div class="space-y-2">
                    <div class="flex justify-between items-center">
                        <span class="text-sm font-semibold text-gray-700">Progreso para ENV칈O GRATIS:</span>
                        <span class="text-sm font-bold text-green-600">$${remaining} restantes</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2 overflow-hidden">
                        <div class="bg-gradient-to-r from-green-400 to-emerald-500 h-2 rounded-full transition-all duration-500 relative" 
                             style="width: ${progress}%">
                            <div class="absolute inset-0 bg-white/30 animate-pulse"></div>
                        </div>
                    </div>
                    <p class="text-xs text-gray-600">
                        <i class="fas fa-truck mr-1"></i>
                        Agrega $${remaining} m치s para obtener env칤o gratuito
                    </p>
                </div>
            `;
        }
    }
    
    // Enhanced quantity change with animations
    function changeQuantity(index, change) {
        if (cart[index]) {
            const newQuantity = cart[index].quantity + change;
            if (newQuantity <= 0) {
                removeFromCart(index);
                return;
            }
            
            cart[index].quantity = newQuantity;
            updateCart();
            
            // Add subtle animation feedback
            const quantityElement = document.querySelector(`[onclick="changeQuantity(${index}, ${change})"]`);
            if (quantityElement) {
                quantityElement.classList.add('scale-110');
                setTimeout(() => quantityElement.classList.remove('scale-110'), 150);
            }
            
            showSuccessNotification(`Cantidad actualizada 游늵`);
        }
    }
    
    // Enhanced remove from cart with confirmation
    function removeFromCart(index) {
        if (cart[index]) {
            const itemName = cart[index].baseItem.name;
            
            // Add confirmation for expensive items
            if (cart[index].price > 100) {
                const confirmModal = document.createElement('div');
                confirmModal.className = 'fixed inset-0 bg-black/60 z-[90] flex items-center justify-center p-4';
                confirmModal.innerHTML = `
                    <div class="bg-white rounded-lg shadow-xl max-w-sm mx-auto p-6 text-center">
                        <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
                            <i class="fas fa-trash-alt text-red-500 text-2xl"></i>
                        </div>
                        <h3 class="text-xl font-bold mb-2">Remover del carrito?</h3>
                        <p class="text-gray-600 mb-6">쮼st치s seguro que quieres remover "${itemName}" de tu pedido?</p>
                        <div class="flex space-x-3">
                            <button onclick="this.parentElement.parentElement.parentElement.remove()" 
                                    class="flex-1 px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">
                                Cancelar
                            </button>
                            <button onclick="confirmRemove(${index}); this.parentElement.parentElement.parentElement.remove()" 
                                    class="flex-1 bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600">
                                Remover
                            </button>
                        </div>
                    </div>
                `;
                document.body.appendChild(confirmModal);
            } else {
                confirmRemove(index);
            }
        }
    }
    
    function confirmRemove(index) {
        const itemName = cart[index].baseItem.name;
        cart.splice(index, 1);
        updateCart();
        showSuccessNotification(`${itemName} removido del carrito 游딈勇`);
    }
    
    // Initialize all enhancements
    function initializeEnhancements() {
        // addDeliveryTimeEstimate(); // deshabilitado
        enhanceFormValidation();
        window.updateTotalPreview = addOrderTotalPreview();
        // One-time attention nudge for delivery selection
        try {
            if (!sessionStorage.getItem('deliverySelectorHintShown')) {
                const sel = document.getElementById('hero-delivery-selector');
                if (sel) {
                    const hint = document.createElement('div');
                    hint.className = 'absolute -bottom-8 left-1/2 -translate-x-1/2 bg-black/70 text-white text-xs px-3 py-1 rounded-full shadow-lg';
                    hint.textContent = 'Elige: Recoger en local o Env칤o a domicilio';
                    sel.style.position = 'relative';
                    sel.appendChild(hint);
                    setTimeout(() => hint.remove(), 3500);
                    sessionStorage.setItem('deliverySelectorHintShown', '1');
                }
            }
        } catch {}
        
        // Monitor admin changes
        monitorAdminChanges();
        
    // Monitor admin changes
    function monitorAdminChanges() {
        // Check for changes in localStorage every 2 seconds
        let lastHiddenProducts = localStorage.getItem('hiddenProducts') || '[]';
        let lastServiceStatus = localStorage.getItem('restaurantServiceActive') || 'true';
        
        setInterval(() => {
            const currentHiddenProducts = localStorage.getItem('hiddenProducts') || '[]';
            const currentServiceStatus = localStorage.getItem('restaurantServiceActive') || 'true';
            
            // Check if service status changed
            if (currentServiceStatus !== lastServiceStatus) {
                if (currentServiceStatus === 'false') {
                    showServiceClosedModal();
                } else {
                    // Reload page if service was reactivated
                    window.location.reload();
                }
                lastServiceStatus = currentServiceStatus;
            }
            
            // Check if hidden products changed
            if (currentHiddenProducts !== lastHiddenProducts) {
                // Reload menu to reflect changes
                renderMenu();
                
                const hiddenCount = JSON.parse(currentHiddenProducts).length;
                if (hiddenCount > 0) {
                    showSuccessNotification(`丘멆잺 Algunos productos han sido actualizados por el administrador`);
                }
                
                lastHiddenProducts = currentHiddenProducts;
            }
        }, 2000);
    }
    
    // Add intersection observer for animations
        const observerOptions = {
            threshold: 0.1,
            rootMargin: '0px 0px -50px 0px'
        };
        
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    entry.target.classList.add('animate-fade-in-up');
                }
            });
        }, observerOptions);
        
        // Observe menu items for scroll animations
        setTimeout(() => {
            document.querySelectorAll('.bg-white.rounded-lg.shadow-lg').forEach(el => {
                observer.observe(el);
            });
        }, 1000);
    }
    
    // --- Mobile hold-to-preview helpers ---
    function stripHtml(html) {
        return html ? String(html).replace(/<[^>]+>/g, '') : '';
    }

    function findItemById(id) {
        const n = Number(id);
        for (const cat in menuData) {
            const arr = menuData[cat] || [];
            const it = arr.find(i => Number(i.id) === n);
            if (it) return it;
        }
        return null;
    }

    function ensureHoldPreviewOverlay() {
        let overlay = document.getElementById('hold-preview-overlay');
        if (!overlay) {
            overlay = document.createElement('div');
            overlay.id = 'hold-preview-overlay';
            overlay.className = 'fixed inset-0 bg-black/70 backdrop-blur-sm hidden items-center justify-center z-50';
            overlay.style.display = 'none';
            overlay.style.overscrollBehavior = 'contain'; // evitar scroll chaining en m칩vil
            overlay.innerHTML = `
                <div class="relative max-w-sm w-11/12 bg-white rounded-2xl shadow-2xl overflow-hidden" role="dialog" aria-modal="true">
                    <button id="hold-preview-close" aria-label="Cerrar" class="absolute top-2 right-2 z-10 inline-flex items-center justify-center w-10 h-10 rounded-full bg-black/70 text-white hover:bg-black focus:outline-none focus:ring-2 focus:ring-white">
                        <span class="text-xl leading-none">칑</span>
                    </button>
                    <img id="hold-preview-image" class="w-full h-64 object-cover" alt="Preview">
                    <div class="p-4">
                        <h3 id="hold-preview-title" class="text-lg font-bold mb-1 text-gray-900"></h3>
                        <p id="hold-preview-desc" class="text-gray-600 text-sm"></p>
                    </div>
                </div>`;
            document.body.appendChild(overlay);

            // Close on backdrop click
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) {
                    api.hide();
                }
            });

            // Evitar scroll del body cuando se interact칰a con el overlay en m칩vil
            overlay.addEventListener('touchmove', (e) => {
                // Permitimos scroll interno si el contenido lo requiere m치s adelante
                // pero prevenimos que burbujee al body
                e.stopPropagation();
            }, { passive: true });
        }
        const imgEl = overlay.querySelector('#hold-preview-image');
        const titleEl = overlay.querySelector('#hold-preview-title');
        const descEl = overlay.querySelector('#hold-preview-desc');
        const closeBtn = overlay.querySelector('#hold-preview-close');

        const api = {
            show(item) {
                if (!item) return;
                const url = (item.image || '').trim();
                if (url) {
                    imgEl.style.display = '';
                    imgEl.src = url;
                } else {
                    imgEl.style.display = 'none';
                    imgEl.removeAttribute('src');
                }
                titleEl.textContent = item.name || '';
                descEl.textContent = stripHtml(item.description || '');
                overlay.classList.remove('hidden');
                overlay.style.display = 'flex';
                // Bloquear scroll de fondo
                try {
                    overlay.dataset.prevOverflowBody = document.body.style.overflow || '';
                    overlay.dataset.prevOverflowHtml = document.documentElement.style.overflow || '';
                    document.body.style.overflow = 'hidden';
                    document.documentElement.style.overflow = 'hidden';
                    document.body.style.touchAction = 'none';
                } catch (_) {}
                // Trap simple focus to the close button
                try { closeBtn.focus(); } catch(_) {}
            },
            hide() {
                overlay.classList.add('hidden');
                overlay.style.display = 'none';
                // Restaurar scroll de fondo
                try {
                    document.body.style.overflow = overlay.dataset.prevOverflowBody || '';
                    document.documentElement.style.overflow = overlay.dataset.prevOverflowHtml || '';
                    document.body.style.touchAction = '';
                } catch (_) {}
            }
        };

        if (closeBtn && !closeBtn._bound) {
            closeBtn.addEventListener('click', () => api.hide());
            closeBtn._bound = true;
            // ESC to close
            window.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') api.hide();
            });
        }

        return api;
    }

    function attachImagePreviewListeners() {
        // Use event delegation to handle dynamic content
        if (window.__imagePreviewBound) return;
        window.__imagePreviewBound = true;
        const overlay = ensureHoldPreviewOverlay();
        document.addEventListener('click', (e) => {
            const img = e.target.closest('img[data-item-id]');
            if (!img) return;
            // Ignore if clicking on buttons inside the card
            if (e.target.closest('button')) return;
            const id = img.getAttribute('data-item-id');
            const item = findItemById(id);
            if (item) {
                overlay.show(item);
            }
        });
    }

    // Enhanced renderMenu with mobile-first responsive design
    function renderMenu() {
        console.log('游꼢 renderMenu() ejecut치ndose...');
        // Record open categories and scroll position to restore after re-render
        const openCategories = Array.from(document.querySelectorAll('.category-section'))
            .map(sec => ({
                category: sec.getAttribute('data-category'),
                isOpen: !sec.querySelector('.menu-grid, .menu-grid-mobile, .menu-grid-pos')?.classList.contains('hidden')
            }))
            .filter(x => x.isOpen)
            .map(x => x.category);
        const prevScrollY = window.scrollY;
        
        const menuCategoriesEl = document.getElementById('menu-categories');
        if (!menuCategoriesEl) {
            console.error('仇 No se encontr칩 el elemento menu-categories');
            return;
        }
        
        // Si el contenedor est치 oculto por el gate, renderizamos pero no mostramos
        // (preparamos el contenido para cuando se muestre)
        console.log('游늶 Estado del men칰:', menuCategoriesEl.classList.contains('hidden') ? 'Oculto' : 'Visible');
        
        menuContainer.innerHTML = '';
        console.log('游댣 Construyendo men칰...');
        
        // Detect if user is on mobile
        const isMobile = window.innerWidth <= 640;
        const manualFastModeGlobal = (typeof window.__MANUAL_FAST_MODE !== 'undefined' && window.__MANUAL_FAST_MODE === true);

        for (const category of getMenuCategoriesInOrder()) {
            const categoryDiv = document.createElement('div');
            categoryDiv.className = 'category-section';
            categoryDiv.dataset.category = category;
            
            // Enhanced category header with icons and descriptions
            const categoryIcons = {
                'Hamburguesas': '游꼢',
                'Hot Dogs': '游꺐',
                'Combos': '游꽇勇',
                'Extras': '游',
                'Bebidas': '游볷'
            };
            
            const categoryDescriptions = {
                'Hamburguesas': 'Nuestras hamburguesas artesanales hechas con amor',
                'Hot Dogs': 'Hotdogs gourmet con ingredientes premium',
                'Combos': 'Combos dise침ados para compartir y ahorrar',
                'Extras': 'Acompa침amientos perfectos para tu pedido',
                'Bebidas': 'Refrescos helados para completar tu experiencia'
            };
            
            categoryDiv.innerHTML = `
                <div class="text-center mb-4 sm:mb-6 category-header-mobile">
                    <div data-category-header="${category}" class="inline-flex items-center space-x-2 sm:space-x-3 bg-gradient-to-r from-yellow-100 to-orange-100 px-4 sm:px-6 py-2 sm:py-3 rounded-full mb-2 sm:mb-3 cursor-pointer select-none">
                        <span class="text-2xl sm:text-3xl">${categoryIcons[category] || '游꽇勇'}</span>
                        <h3 class="text-xl sm:text-3xl font-bold font-poppins text-gray-900">${category}</h3>
                        <i class="fas fa-chevron-down text-gray-600 ml-2"></i>
                    </div>
                    <p class="text-sm sm:text-lg text-gray-600 max-w-2xl mx-auto px-4">${categoryDescriptions[category] || ''}</p>
                </div>
            `;
            
            const grid = document.createElement('div');
            // Pedido manual (modo r치pido): cuadr칤cula estilo POS
            if (manualFastModeGlobal) {
                grid.className = isMobile ? 'menu-grid-pos container-mobile' : 'menu-grid-pos';
            } else {
                // Carrusel horizontal: mismo layout base, ajustado por CSS
                if (isMobile) {
                    grid.className = 'menu-grid menu-grid-horizontal container-mobile';
                } else {
                    grid.className = 'menu-grid menu-grid-horizontal';
                }
            }
            // Inicialmente oculto: se mostrar치 al hacer clic en el encabezado de la categor칤a
            grid.classList.add('hidden');

            // Build eligible list first (so carousel can loop cleanly)
            const eligibleItems = getEligibleCategoryItems(category);

            // Wrap grid and arrows in a shared shell (solo si NO es modo POS)
            let carouselShell = null;
            if (!manualFastModeGlobal) {
                carouselShell = document.createElement('div');
                carouselShell.className = 'category-carousel-shell relative';

                // Desktop carousel arrows (only if more than 1 item)
                if (eligibleItems.length > 1) {
                    const navWrap = document.createElement('div');
                    // Hidden by default, shown cuando la categor칤a se expande
                    navWrap.className = 'carousel-nav-wrap hidden absolute inset-y-0 left-0 right-0 flex items-center justify-between px-3 pointer-events-none';
                    navWrap.innerHTML = `
                        <button type="button" class="carousel-nav-btn category-arrow-desktop category-arrow-left pointer-events-auto" data-dir="-1" aria-label="Anterior">
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        <button type="button" class="carousel-nav-btn category-arrow-desktop category-arrow-right pointer-events-auto" data-dir="1" aria-label="Siguiente">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    `;
                    carouselShell.appendChild(navWrap);
                }
            }

            // Mostrar todos los 칤tems y usar scroll horizontal / snap para navegar
            const itemsToRender = eligibleItems;

            itemsToRender.forEach((originalItem, index) => {
                if(!originalItem || originalItem.hidden) return;

                const manualFastMode = (typeof window.__MANUAL_FAST_MODE !== 'undefined' && window.__MANUAL_FAST_MODE === true);
                
                // Apply daily promotion
                const item = applyDailyPromotion(originalItem, category);
                const isExtraCategory = category === 'Extras';
                const canUpgradeExtraSize = isExtraCategory && !!EXTRA_LARGE_VARIANTS[item.id];

                const buttonType = getButtonTypeForItem(item, category);
                let buttonHtml;
                if (buttonType === 'combo') {
                    buttonHtml = `
                        <button data-id="${item.id}" class="choose-combo-btn w-full bg-gradient-to-r from-yellow-400 to-orange-500 text-[#212121] px-3 sm:px-6 py-2 sm:py-4 rounded-lg sm:rounded-xl font-bold text-xs sm:text-base hover:from-yellow-500 hover:to-orange-600 transform hover:-translate-y-1 transition-all duration-300 shadow-lg hover:shadow-xl">
                            <i class="fas fa-utensils mr-1 sm:mr-2"></i>Personalizar
                        </button>
                    `;
                } else if (buttonType === 'customize') {
                    const iconClass = canUpgradeExtraSize ? 'fa-up-long' : 'fa-hamburger';
                    buttonHtml = `
                        <button data-id="${item.id}" class="customize-btn w-full bg-gradient-to-r from-yellow-400 to-orange-500 text-[#212121] px-3 sm:px-6 py-2 sm:py-4 rounded-lg sm:rounded-xl font-bold text-xs sm:text-base hover:from-yellow-500 hover:to-orange-600 transform hover:-translate-y-1 transition-all duration-300 shadow-lg hover:shadow-xl">
                            <i class="fas ${iconClass} mr-1 sm:mr-2"></i>Personalizar
                        </button>
                    `;
                } else {
                    buttonHtml = `
                        <button data-id="${item.id}" class="add-to-cart-btn w-full bg-gradient-to-r from-yellow-400 to-orange-500 text-[#212121] px-3 sm:px-6 py-2 sm:py-4 rounded-lg sm:rounded-xl font-bold text-xs sm:text-base hover:from-yellow-500 hover:to-orange-600 transform hover:-translate-y-1 transition-all duration-300 shadow-lg hover:shadow-xl active:scale-95">
                            <i class="fas fa-cart-plus mr-1 sm:mr-2"></i>Agregar
                        </button>
                    `;
                }
                
                // Enhanced price display with better visual hierarchy
                let priceHtml;
                
                if (item.isCombo) {
                    const realPrice = calculateComboRealPrice(item);
                    const savings = realPrice - item.price;
                    priceHtml = `
                        <div class="p-3 rounded-lg border border-gray-200 bg-gray-50">
                            <div class="flex items-baseline justify-between">
                                <span class="text-sm font-semibold text-gray-700">Combo</span>
                                <span class="text-2xl font-extrabold text-gray-900">$${item.price.toFixed(0)}</span>
                            </div>
                            <div class="flex items-center justify-between mt-1">
                                <span class="text-xs text-gray-500 line-through">$${realPrice.toFixed(0)}</span>
                                <span class="text-xs font-bold text-green-700">Ahorras $${savings.toFixed(0)}</span>
                            </div>
                        </div>
                    `;
                } else if (item.originalPrice && item.originalPrice > item.price) {
                    const savings = item.originalPrice - item.price;
                    priceHtml = `
                        <div class="p-3 rounded-lg border border-gray-200 bg-gray-50">
                            <div class="flex items-baseline justify-between">
                                <div class="min-w-0">
                                    <span class="text-xs text-gray-500 line-through">$${item.originalPrice.toFixed(0)}</span>
                                    <span class="ml-2 text-xs font-bold text-green-700">Ahorras $${savings.toFixed(0)}</span>
                                </div>
                                <span class="text-2xl font-extrabold text-gray-900">$${item.price.toFixed(0)}</span>
                            </div>
                        </div>
                    `;
                } else {
                    priceHtml = `
                        <div class="p-3 rounded-lg border border-gray-200 bg-gray-50">
                            <div class="flex items-baseline justify-between">
                                <span class="text-sm font-semibold text-gray-700">Precio</span>
                                <span class="text-2xl font-extrabold text-gray-900">$${item.price.toFixed(0)}</span>
                            </div>
                        </div>
                    `;
                }
                
                // Enhanced description processing
                let processedDescription = item.description;
                if (item.description.includes('ENV칈O GRATIS')) {
                    processedDescription = item.description.replace(
                        'ENV칈O GRATIS',
                        '<span class="bg-green-500 text-white px-3 py-1 rounded-full text-xs font-bold animate-pulse inline-block mt-2">游뚴 ENV칈O GRATIS</span>'
                    );
                }

                const stripHtml = (s) => String(s || '').replace(/<[^>]*>/g, '').trim();
                const plainDesc = stripHtml(processedDescription);
                const shouldShowDescToggle = !isMobile && plainDesc.length > 120;
                
                // Multiple badge system - Mobile responsive
                let badges = '';
                let mobileInlineBadges = '';
                
                if (item.hasPromotion) {
                    badges += `<div class="absolute top-2 left-2 bg-red-500 text-white px-2 py-1 rounded-full text-xs font-bold animate-pulse z-10 shadow-lg">游꿀 OFERTA</div>`;
                    mobileInlineBadges += `<span class="inline-block bg-red-500 text-white px-2 py-1 rounded-full text-xs font-bold animate-pulse mr-1 mb-1">游꿀 OFERTA</span>`;
                }
                if ([1, 2, 6, 15].includes(item.id)) {
                    // Solo mantenemos el badge inline que S칈 parpadea (el que encerraste)
                    mobileInlineBadges += `<span class="inline-block bg-orange-500 text-white px-2 py-1 rounded-full text-xs font-bold mr-1 mb-1 animate-pulse">游댠 POPULAR</span>`;
                }
                if (item.isCombo || (item.originalPrice && item.originalPrice > item.price)) {
                    badges += `<div class="absolute top-8 left-2 bg-blue-500 text-white px-2 py-1 rounded-full text-xs font-bold z-10 shadow-lg">游눯 AHORRO</div>`;
                    mobileInlineBadges += `<span class="inline-block bg-blue-500 text-white px-2 py-1 rounded-full text-xs font-bold mr-1 mb-1">游눯 AHORRO</span>`;
                }
                
                // Create different card layouts for mobile vs desktop
                let cardHtml;

                // MODO R츼PIDO (pedido manual): tarjetas sin fotos ni descripci칩n para cargar m치s r치pido
                if (manualFastMode) {
                    const priceQuick = `$${item.price.toFixed(0)}`;
                    cardHtml = `
                        <div class="menu-card-mobile sr-pos-card" data-item-id="${item.id}">
                            <div class="sr-pos-name" title="${stripHtml(item.name).replace(/\"/g, '&quot;')}">${item.name}</div>
                            <div class="sr-pos-price">${priceQuick}</div>
                            ${buttonType === 'combo'
                                ? `<button data-id="${item.id}" class="choose-combo-btn sr-pos-action" aria-label="Personalizar"><i class=\"fas fa-utensils\"></i></button>`
                                : buttonType === 'customize'
                                    ? `<button data-id="${item.id}" class="customize-btn sr-pos-action" aria-label="Personalizar"><i class=\"fas fa-hamburger\"></i></button>`
                                    : `<button data-id="${item.id}" class="add-to-cart-btn sr-pos-action" aria-label="Agregar"><i class=\"fas fa-cart-plus\"></i></button>`
                            }
                        </div>
                    `;
                } else if (isMobile) {
                    // Mobile layout - vertical tile (grid 2-3 cols)
                    let mobileBtn;
                    if (buttonType === 'combo') {
                        mobileBtn = `<button data-id="${item.id}" class="choose-combo-btn w-full bg-gradient-to-r from-yellow-400 to-orange-500 text-[#212121] px-3 py-2 rounded-lg font-bold text-xs"><i class="fas fa-utensils"></i>Personalizar</button>`;
                    } else if (buttonType === 'customize') {
                        const iconClass = canUpgradeExtraSize ? 'fa-up-long' : 'fa-hamburger';
                        mobileBtn = `<button data-id="${item.id}" class="customize-btn w-full bg-gradient-to-r from-yellow-400 to-orange-500 text-[#212121] px-3 py-2 rounded-lg font-bold text-xs"><i class="fas ${iconClass}"></i>Personalizar</button>`;
                    } else {
                        mobileBtn = `<button data-id="${item.id}" class="add-to-cart-btn w-full bg-gradient-to-r from-yellow-400 to-orange-500 text-[#212121] px-3 py-2 rounded-lg font-bold text-xs"><i class="fas fa-cart-plus"></i>Agregar</button>`;
                    }

                    cardHtml = `
                        <div class="group bg-white rounded-xl shadow-md overflow-hidden relative border border-gray-100 hover:shadow-lg hover:border-yellow-300 menu-card menu-card-mobile transition-all duration-300" 
                             style="animation-delay: ${index * 50}ms;">
                            
                            <!-- Image -->
                            <div class="menu-card-image-mobile relative overflow-hidden bg-gray-100 ${(!manualFastMode && item.image) ? 'sr-skeleton' : ''}">
                                ${(!manualFastMode && item.image) ? `<img src="${item.image}" alt="Imagen de ${item.name}" class="w-full h-full object-cover sr-img-init" data-sr-img="1" data-item-id="${item.id}" loading="lazy" decoding="async" fetchpriority="low" referrerpolicy="no-referrer" onerror="this.onerror=null;this.style.display='none';">` : ''}
                            </div>
                            
                            <!-- Content -->
                            <div class="menu-card-content-mobile">
                                ${mobileInlineBadges ? `<div class=\"mb-1\">${mobileInlineBadges}</div>` : ''}
                                <h4 class="font-bold text-gray-900 text-sm leading-snug line-clamp-2">${item.name}</h4>
                                <div class="text-yellow-600 font-extrabold text-base">$${item.price.toFixed(0)}</div>
                                ${item.hasPromotion ? `<div class=\"text-[10px] text-red-600 font-bold\">${item.promotionText}</div>` : ''}
                                ${mobileBtn}
                            </div>
                        </div>
                    `;
                } else {
                    // Desktop layout - vertical card
                    cardHtml = `
                        <div class="group bg-white rounded-2xl shadow-lg overflow-hidden flex flex-col h-full transform hover:-translate-y-3 transition-all duration-500 relative border border-gray-100 hover:shadow-2xl hover:border-yellow-300 menu-card" 
                             style="animation-delay: ${index * 100}ms;">
                            ${badges}
                            
                            <!-- Image container with hover effects -->
                            <div class="relative overflow-hidden bg-gray-100 h-48 sm:h-56 md:h-64 ${(!manualFastMode && item.image) ? 'sr-skeleton' : ''}">
                                                    ${(!manualFastMode && item.image) ? `<img src="${item.image}" alt="Imagen de ${item.name}" class="w-full h-full object-cover transition-all duration-500 group-hover:scale-110 sr-img-init" data-sr-img="1" data-item-id="${item.id}" loading="lazy" decoding="async" fetchpriority="low" referrerpolicy="no-referrer" onerror="this.onerror=null;this.style.display='none';">` : ''}
                                
                                <!-- Overlay on hover -->
                                <div class="absolute inset-0 bg-black/20 opacity-0 group-hover:opacity-100 transition-opacity duration-300 flex items-center justify-center">
                                    <div class="transform translate-y-4 group-hover:translate-y-0 transition-transform duration-300">
                                        <i class="fas fa-eye text-white text-2xl"></i>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Content -->
                            <div class="p-4 sm:p-6 flex flex-col flex-grow space-y-3 sm:space-y-4">
                                <!-- Title and description -->
                                <div class="flex-grow">
                                    <h4 class="text-lg sm:text-xl font-bold mb-2 text-gray-900 group-hover:text-yellow-600 transition-colors duration-300">
                                        ${item.name}
                                    </h4>
                                    <div class="mt-2">
                                        ${priceHtml}
                                    </div>
                                    ${plainDesc ? `
                                        <p class="text-gray-600 text-sm leading-relaxed line-clamp-3 mt-3" data-sr-desc="1">
                                            ${processedDescription}
                                        </p>
                                        ${shouldShowDescToggle ? `
                                            <button type="button" class="sr-desc-toggle text-sm font-semibold text-yellow-700 hover:text-yellow-800 mt-2" aria-label="Ver m치s detalles" data-item-id="${item.id}">
                                                Ver m치s
                                            </button>
                                        ` : ''}
                                    ` : ''}
                                </div>
                                
                                <!-- Promotion banner -->
                                ${item.hasPromotion ? `
                                    <div class="bg-gradient-to-r from-red-500 to-pink-500 text-white p-2 sm:p-3 rounded-lg text-center shadow-lg">
                                        <div class="font-bold text-xs sm:text-sm animate-pulse">${item.promotionText}</div>
                                    </div>
                                ` : ''}
                                
                                <!-- Action button -->
                                <div class="pt-2">
                                    ${buttonHtml}
                                </div>
                            </div>
                        </div>
                    `;
                }
                
                grid.innerHTML += cardHtml;
            });

            if (carouselShell) {
                carouselShell.appendChild(grid);
                categoryDiv.appendChild(carouselShell);
            } else {
                categoryDiv.appendChild(grid);
            }
            menuContainer.appendChild(categoryDiv);
        }

        // Si no hab칤a categor칤as abiertas antes, abrimos por defecto la primera (Hamburguesas)
        if (!openCategories.length) {
            const firstSection = menuContainer.querySelector('.category-section');
            if (firstSection) {
                const grid = firstSection.querySelector('.menu-grid, .menu-grid-mobile, .menu-grid-pos');
                const navWrap = firstSection.querySelector('.carousel-nav-wrap');
                const chevron = firstSection.querySelector('.fa-chevron-down');
                if (grid) grid.classList.remove('hidden');
                if (navWrap) navWrap.classList.remove('hidden');
                if (chevron) chevron.style.transform = 'rotate(180deg)';
            }
        }
        
        console.log('九 Men칰 renderizado correctamente con', Object.keys(menuData).length, 'categor칤as');
        
    // Initialize enhancements after rendering
        setTimeout(() => {
            addUrgencyIndicators();
            addSocialProof();
            initializeEnhancements();
            attachImagePreviewListeners();
            // Restore previously open categories
            if (openCategories.length) {
                openCategories.forEach(cat => {
                    const section = document.querySelector(`.category-section[data-category="${cat}"]`);
                    const grid = section?.querySelector('.menu-grid, .menu-grid-mobile, .menu-grid-pos');
                    const navWrap = section?.querySelector('.carousel-nav-wrap');
                    const chevron = section?.querySelector('.fa-chevron-down');
                    if (grid) grid.classList.remove('hidden');
                    if (navWrap) navWrap.classList.remove('hidden');
                    if (chevron) chevron.style.transform = 'rotate(180deg)';
                });
                // Restore scroll to reduce perceived jumps
                window.scrollTo({ top: prevScrollY, behavior: 'instant' });
            }
        }, 500);
    }
    
    // Add window resize listener for responsive updates (stable on mobile)
    (function() {
        let lastIsMobile = window.innerWidth <= 640;
        window.addEventListener('resize', () => {
            clearTimeout(window.resizeTimeout);
            window.resizeTimeout = setTimeout(() => {
                const isMobileNow = window.innerWidth <= 640;
                // Solo re-render si cambiamos de modo m칩vil a desktop o viceversa
                if (isMobileNow !== lastIsMobile) {
                    lastIsMobile = isMobileNow;
                    renderMenu();
                }
            }, 250);
        });
    })();

    // Configurar event listeners
    function setupEventListeners() {
        console.log('丘뙖잺 setupEventListeners() ejecut치ndose...');

        // Cup칩n: aplicar / quitar
        try {
            const discountInput = document.getElementById('discount-code-input');
            const applyBtn = document.getElementById('apply-discount-code-btn');
            const clearBtn = document.getElementById('clear-discount-code-btn');
            const msgEl = document.getElementById('discount-code-msg');

            const setMsg = (text, tone) => {
                if (!msgEl) return;
                msgEl.textContent = String(text || '');
                msgEl.classList.remove('text-gray-600', 'text-green-700', 'text-red-600', 'text-amber-600');
                if (tone === 'ok') msgEl.classList.add('text-green-700');
                else if (tone === 'err') msgEl.classList.add('text-red-600');
                else if (tone === 'warn') msgEl.classList.add('text-amber-600');
                else msgEl.classList.add('text-gray-600');
            };

            const syncUiFromState = () => {
                const st = getActiveDiscountCodeState();
                if (discountInput && st && st.code) discountInput.value = st.code;
                if (clearBtn) clearBtn.classList.toggle('hidden', !(st && st.code));
                if (st && st.code) {
                    setMsg(`C칩digo aplicado: ${st.code}`, 'ok');
                } else {
                    setMsg('', '');
                }
                try { updateCheckoutTotals(); } catch (_) {}
                try { renderOrderSummary(); } catch (_) {}
            };

            const applyFromInput = async () => {
                const raw = discountInput ? discountInput.value : '';
                const code = normalizeDiscountCode(raw);
                if (!code) {
                    clearActiveDiscountCodeState();
                    syncUiFromState();
                    setMsg('Ingresa un c칩digo v치lido.', 'err');
                    return;
                }

                if (applyBtn) applyBtn.disabled = true;
                setMsg('Verificando c칩digo...', 'warn');
                try {
                    const info = await fetchDiscountCodeInfo(code);
                    if (!info) {
                        clearActiveDiscountCodeState();
                        syncUiFromState();
                        setMsg('C칩digo no encontrado.', 'err');
                        return;
                    }

                    setActiveDiscountCodeState({ code: info.code, amount: info.amount, verifiedAt: Date.now() });
                    syncUiFromState();
                    setMsg(`C칩digo aplicado: ${info.code} (-$${Number(info.amount || 0).toFixed(0)})`, 'ok');
                } catch (e) {
                    console.warn('No se pudo verificar el c칩digo de descuento:', e);
                    setMsg('No se pudo verificar el c칩digo. Intenta de nuevo.', 'err');
                } finally {
                    if (applyBtn) applyBtn.disabled = false;
                }
            };

            const clearCoupon = () => {
                clearActiveDiscountCodeState();
                if (discountInput) discountInput.value = '';
                syncUiFromState();
                setMsg('C칩digo removido.', '');
            };

            if (applyBtn) applyBtn.addEventListener('click', applyFromInput);
            if (clearBtn) clearBtn.addEventListener('click', clearCoupon);
            if (discountInput) {
                discountInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        applyFromInput();
                    }
                });
            }

            // Cargar cup칩n guardado y revalidar en segundo plano
            syncUiFromState();
            const st = getActiveDiscountCodeState();
            if (st && st.code) {
                setTimeout(async () => {
                    try {
                        const info = await fetchDiscountCodeInfo(st.code);
                        if (!info) {
                            clearActiveDiscountCodeState();
                            syncUiFromState();
                            setMsg('El c칩digo guardado ya no est치 disponible.', 'warn');
                            return;
                        }
                        setActiveDiscountCodeState({ code: info.code, amount: info.amount, verifiedAt: Date.now() });
                        syncUiFromState();
                    } catch (_) {
                        // Si no hay conexi칩n, dejamos el cup칩n como estaba.
                    }
                }, 800);
            }
        } catch (_) {}

        // Carrusel por categor칤a: flechas izq/der que hacen scroll horizontal suave
        if (!window.__carouselNavBound) {
            window.__carouselNavBound = true;
            document.addEventListener('click', (e) => {
                const btn = e.target.closest('.carousel-nav-btn');
                if (!btn) return;
                const dir = Number(btn.getAttribute('data-dir')) || 0;
                if (!dir) return;

                const shell = btn.closest('.category-carousel-shell');
                if (!shell) return;
                const scroller = shell.querySelector('.menu-grid-horizontal');
                if (!scroller) return;

                const firstCard = scroller.querySelector('.menu-card, .menu-card-mobile');
                const cardWidth = firstCard ? firstCard.getBoundingClientRect().width : scroller.clientWidth * 0.8;
                const styles = window.getComputedStyle(scroller);
                const gapPx = styles.columnGap || styles.gap || '24px';
                const gap = parseFloat(gapPx) || 24;
                const delta = dir * (cardWidth + gap);

                scroller.scrollBy({ left: delta, behavior: 'smooth' });
            });
        }
        
        // ============================================
        // BOT칍N "MOSTRAR MEN칔" - Sistema simplificado
        // ============================================
        const showMenuBtn = document.getElementById('show-menu-btn');
        const menuGate = document.getElementById('menu-gate');
        const menuCategoriesEl = document.getElementById('menu-categories');
        
        console.log('游댌 Verificando elementos del bot칩n:', {
            showMenuBtn: !!showMenuBtn,
            menuGate: !!menuGate,
            menuCategoriesEl: !!menuCategoriesEl
        });
        
        // Verificar si ya se abri칩 el men칰 anteriormente
        const menuAlreadyOpened = sessionStorage.getItem('menuOpened') === '1';
        if (menuAlreadyOpened && menuGate && menuCategoriesEl) {
            console.log('游늭 Men칰 ya fue abierto previamente, restaurando estado...');
            menuGate.style.display = 'none';
            menuCategoriesEl.classList.remove('hidden');
        }
        
        if (showMenuBtn) {
            console.log('九 Configurando evento click para bot칩n "Mostrar men칰"');
            
            showMenuBtn.onclick = function(event) {
                event.preventDefault();
                event.stopPropagation();
                
                console.log('游꿢 춰CLICK EN BOT칍N DETECTADO!');
                console.log('游늸 Evento:', event.type);
                console.log('游둼勇 Target:', event.target);
                
                // Guardar en sessionStorage
                sessionStorage.setItem('menuOpened', '1');
                console.log('游 Guardado en sessionStorage: menuOpened = 1');
                
                // Ocultar el gate
                if (menuGate) {
                    menuGate.style.display = 'none';
                    console.log('九 Gate ocultado (display: none)');
                }
                
                // Mostrar el men칰
                if (menuCategoriesEl) {
                    menuCategoriesEl.classList.remove('hidden');
                    console.log('九 Men칰 visible (clase hidden removida)');
                    
                    // Scroll suave al men칰
                    setTimeout(() => {
                        menuCategoriesEl.scrollIntoView({ 
                            behavior: 'smooth', 
                            block: 'start' 
                        });
                        console.log('游닆 Scroll al men칰 ejecutado');
                    }, 100);
                }
                
                console.log('九 Proceso completado exitosamente');
            };
            
            // Tambi칠n agregar con addEventListener como respaldo
            showMenuBtn.addEventListener('click', function(e) {
                console.log('游녝 Event listener addEventListener tambi칠n disparado');
            }, { once: false });
            
        } else {
            console.error('仇 ERROR: No se encontr칩 el bot칩n show-menu-btn');
        }
        
        // Toggle categories (accordion-like): show products only when clicking category title
        document.addEventListener('click', (e) => {
            const headerEl = e.target.closest('[data-category-header]');
            if (headerEl) {
                const category = headerEl.getAttribute('data-category-header');
                const section = document.querySelector(`.category-section[data-category="${category}"]`);
                if (!section) return;
                const grid = section.querySelector('.menu-grid, .menu-grid-mobile, .menu-grid-pos');
                if (!grid) return;
                const navWrap = section.querySelector('.carousel-nav-wrap');
                const chevron = headerEl.querySelector('.fa-chevron-down');
                const hide = !grid.classList.contains('hidden');
                if (hide) {
                    grid.classList.add('hidden');
                    if (navWrap) navWrap.classList.add('hidden');
                    if (chevron) chevron.style.transform = 'rotate(0deg)';
                } else {
                    // Optionally close others for a clean view
                    document.querySelectorAll('.category-section .menu-grid, .category-section .menu-grid-mobile, .category-section .menu-grid-pos').forEach(g => {
                        if (g !== grid) g.classList.add('hidden');
                    });
                    document.querySelectorAll('.category-section .carousel-nav-wrap').forEach(n => {
                        if (n !== navWrap) n.classList.add('hidden');
                    });
                    grid.classList.remove('hidden');
                    if (navWrap) navWrap.classList.remove('hidden');
                    if (chevron) chevron.style.transform = 'rotate(180deg)';
                }
            }
        });
        // Hero delivery selector -> sincroniza radios del checkout
        const heroSelector = document.getElementById('hero-delivery-selector');
        if (heroSelector) {
            // helper to update active styles
            const setHeroActive = (val) => {
                heroSelector.querySelectorAll('.hero-delivery-option').forEach(lbl => {
                    const isActive = lbl.getAttribute('data-value') === val;
                    lbl.classList.toggle('bg-white', isActive);
                    lbl.classList.toggle('text-gray-900', isActive);
                    lbl.classList.toggle('shadow-xl', isActive);
                    lbl.classList.toggle('ring-white/70', isActive);
                    lbl.classList.toggle('ring-2', isActive);
                });
            };
            // initialize once with the checked radio
            const initial = heroSelector.querySelector('input[name="hero-delivery-type"]:checked')?.value || 'delivery';
            setHeroActive(initial);

            heroSelector.addEventListener('change', (e) => {
                if (e.target && e.target.name === 'hero-delivery-type') {
                    const val = e.target.value;
                    setHeroActive(val);
                    const checkoutPickup = document.querySelector('input[name="delivery-type"][value="pickup"]');
                    const checkoutDelivery = document.querySelector('input[name="delivery-type"][value="delivery"]');
                    if (val === 'pickup' && checkoutPickup) checkoutPickup.checked = true;
                    if (val === 'delivery' && checkoutDelivery) checkoutDelivery.checked = true;
                    // Dispara cambio para actualizar UI/totales
                    const evt = new Event('change', { bubbles: true });
                    const targetRadio = val === 'delivery' ? checkoutDelivery : checkoutPickup;
                    if (targetRadio) targetRadio.dispatchEvent(evt);
                }
            });
        }
        // Event listener para los botones de a침adir al carrito
        document.addEventListener('click', (e) => {
            const btn = e.target.closest('.add-to-cart-btn');
            if (!btn) return;
            const itemId = parseInt(btn.dataset.id);
            const found = findItemByIdWithCategory(itemId);
            const category = found ? String(found.category || '').trim() : '';
            if (category.toLowerCase() === 'boneles') {
                openBonelesOptionsModal(itemId, btn);
                return;
            }
            addToCart(itemId);
        });
        
        // Event listener para los botones de personalizar
        document.addEventListener('click', (e) => {
            const btn = e.target.closest('.customize-btn');
            if (!btn) return;
            const itemId = parseInt(btn.dataset.id);
            openCustomizationModal({ isCombo: false, itemId });
        });
        
        // Event listener para los botones de elegir combo
        document.addEventListener('click', (e) => {
            const btn = e.target.closest('.choose-combo-btn');
            if (!btn) return;
            const comboId = parseInt(btn.dataset.id);
            openComboModal(comboId);
        });

        // Toggle "Ver m치s" en descripciones largas (delegaci칩n)
        if (!window.__srDescToggleBound) {
            window.__srDescToggleBound = true;
            document.addEventListener('click', (e) => {
                const btn = e.target.closest('.sr-desc-toggle');
                if (!btn) return;
                const card = btn.closest('.menu-card');
                const desc = card ? card.querySelector('[data-sr-desc="1"]') : null;
                if (!desc) return;
                const isExpanded = card.getAttribute('data-sr-desc-expanded') === '1';
                if (isExpanded) {
                    card.setAttribute('data-sr-desc-expanded', '0');
                    desc.classList.add('line-clamp-3');
                    btn.textContent = 'Ver m치s';
                } else {
                    card.setAttribute('data-sr-desc-expanded', '1');
                    desc.classList.remove('line-clamp-3');
                    btn.textContent = 'Ver menos';
                }
            });
        }
        // Skeleton/fade-in para im치genes (capturing porque load/error no bubbean)
        const __srMarkImgLoaded = (img) => {
            if (!img) return;
            img.classList.remove('sr-img-init');
            img.classList.add('sr-img-loaded');
            const shell = img.closest('.sr-skeleton');
            if (shell) shell.classList.remove('sr-skeleton');
        };
        document.addEventListener('load', (e) => {
            const img = e.target;
            if (!img || img.tagName !== 'IMG') return;
            if (img.dataset && img.dataset.srImg === '1') {
                __srMarkImgLoaded(img);
            }
        }, true);
        document.addEventListener('error', (e) => {
            const img = e.target;
            if (!img || img.tagName !== 'IMG') return;
            if (img.dataset && img.dataset.srImg === '1') {
                const shell = img.closest('.sr-skeleton');
                if (shell) shell.classList.remove('sr-skeleton');
            }
        }, true);

        // Si alguna imagen ya estaba en cach칠 y carg칩 antes del listener
        try {
            document.querySelectorAll('img[data-sr-img="1"]').forEach((img) => {
                if (img && img.complete && img.naturalWidth > 0) __srMarkImgLoaded(img);
            });
        } catch (_) {}

        // Event listener para los botones de combo en el modal de promociones
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('promo-combo-btn')) {
                const comboId = parseInt(e.target.dataset.comboId);
                // Cerrar modal de promociones primero
                document.getElementById('promotions-modal').classList.add('hidden');
                // Abrir modal de configuraci칩n del combo
                openComboModal(comboId);
            }
        });

        // Event listener para el bot칩n "Ver Todos los Combos"
        document.addEventListener('click', (e) => {
            if (e.target.id === 'scroll-to-combos') {
                // Cerrar modal de promociones
                document.getElementById('promotions-modal').classList.add('hidden');
                // Hacer scroll a la secci칩n de combos
                const combosSection = document.querySelector('[data-category="Combos"]');
                if (combosSection) {
                    combosSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            }
        });
        
        // Abrir carrito
        openCartBtn.addEventListener('click', openCart);
        
        // Cerrar carrito
        closeCartBtn.addEventListener('click', () => {
            cartSidebar.classList.add('translate-x-full');
            cartOverlay.classList.add('hidden');
        });
        
        // Cerrar carrito al hacer clic en el overlay
        cartOverlay.addEventListener('click', () => {
            cartSidebar.classList.add('translate-x-full');
            cartOverlay.classList.add('hidden');
        });
        
        // Cerrar modal de combo
        closeComboModalBtn.addEventListener('click', closeComboModal);
        
        // Event listener para navegar entre hamburguesas del combo
        document.addEventListener('click', (e) => {
            const btn = e.target.closest('.prev-burger-btn, .next-burger-btn');
            if (!btn) return;

            const choiceIndex = parseInt(btn.dataset.choiceIndex, 10);
            if (!Number.isFinite(choiceIndex)) return;

            const direction = btn.classList.contains('next-burger-btn') ? 'next' : 'prev';
            navigateBurger(choiceIndex, direction);
        });
        
        // Event listener para navegar entre hotdogs del combo
        document.addEventListener('click', (e) => {
            const btn = e.target.closest('.prev-hotdog-btn, .next-hotdog-btn');
            if (!btn) return;

            const hotdogIndex = parseInt(btn.dataset.hotdogIndex, 10);
            if (!Number.isFinite(hotdogIndex)) return;

            const direction = btn.classList.contains('next-hotdog-btn') ? 'next' : 'prev';
            navigateHotdog(hotdogIndex, direction);
        });
        
        // Event listener para personalizar hamburguesa dentro de combo
        document.addEventListener('click', (e) => {
            const btn = e.target.closest('.combo-customize-btn');
            if (!btn) return;

            const wrapper = btn.closest('[data-choice-index]');
            const choiceIndex = parseInt(wrapper?.dataset?.choiceIndex, 10);
            if (!Number.isFinite(choiceIndex)) return;

            openCustomizationModal({ isCombo: true, choiceIndex });
        });
        
        // Event listener para personalizar hotdog dentro de combo
        document.addEventListener('click', (e) => {
            const btn = e.target.closest('.hotdog-customize-btn');
            if (!btn) return;

            const hotdogIndex = parseInt(btn.dataset.hotdogIndex, 10);
            if (!Number.isFinite(hotdogIndex)) return;

            openCustomizationModal({ isCombo: true, isHotdog: true, hotdogIndex });
        });
        
        // Event listener para cambio de tipo de papas en combos
        document.addEventListener('change', (e) => {
            if (e.target.name === 'combo-fries-type') {
                tempComboConfig.includedFries.type = e.target.value;
                
                // Actualizar estilos visuales
                document.querySelectorAll('input[name="combo-fries-type"]').forEach(radio => {
                    const label = radio.closest('label');
                    if (radio.checked) {
                        label.classList.add('bg-[#FFB300]/10', 'border-[#FFB300]');
                    } else {
                        label.classList.remove('bg-[#FFB300]/10', 'border-[#FFB300]');
                    }
                });
            }
        });

        // Event listener para selecci칩n de salsa en Combo Boneles (solo 1)
        document.addEventListener('change', (e) => {
            if (e.target.name === 'combo-boneles-sauce') {
                const selected = document.querySelector('input[name="combo-boneles-sauce"]:checked')?.value;
                tempComboConfig.boneles = tempComboConfig.boneles || {};
                tempComboConfig.boneles.sauce = selected || 'BBQ DULCE';

                // Actualizar estilos visuales
                document.querySelectorAll('input[name="combo-boneles-sauce"]').forEach(radio => {
                    const label = radio.closest('label');
                    if (!label) return;
                    if (radio.checked) {
                        label.classList.add('bg-[#FFB300]/10', 'border-[#FFB300]');
                    } else {
                        label.classList.remove('bg-[#FFB300]/10', 'border-[#FFB300]');
                    }
                });
            }
        });
        
        // Cerrar modal de personalizaci칩n
        closeCustomModalBtn.addEventListener('click', closeCustomizationModal);
        
        // Event listeners para modal de promociones
        promotionsBtn.addEventListener('click', () => {
            promotionsModal.classList.remove('hidden');
            promotionsModal.classList.add('flex');
            // Inicializar las tabs m칩viles al abrir el modal
            setTimeout(() => {
                updateDailyPromotions(); // Actualizar promociones antes de mostrar
                showMobilePromo('daily');
            }, 100);
        });
        
        closePromotionsModalBtn.addEventListener('click', () => {
            promotionsModal.classList.add('hidden');
            promotionsModal.classList.remove('flex');
        });
        
        // Cerrar modal de promociones al hacer clic fuera
        promotionsModal.addEventListener('click', (e) => {
            if (e.target === promotionsModal) {
                promotionsModal.classList.add('hidden');
                promotionsModal.classList.remove('flex');
            }
        });

        // Event listeners para men칰 m칩vil
        const mobileMenuBtn = document.getElementById('mobile-menu-btn');
        const mobileMenu = document.getElementById('mobile-menu');
        const mobileMenuOverlay = document.getElementById('mobile-menu-overlay');
        const closeMobileMenuBtn = document.getElementById('close-mobile-menu');
        const mobilePromotionsBtn = document.getElementById('mobile-promotions-btn');

        // Abrir men칰 m칩vil
        mobileMenuBtn.addEventListener('click', () => {
            mobileMenu.classList.remove('-translate-x-full');
            mobileMenu.classList.add('translate-x-0');
            mobileMenuOverlay.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        });

        // Cerrar men칰 m칩vil
        function closeMobileMenu() {
            mobileMenu.classList.add('-translate-x-full');
            mobileMenu.classList.remove('translate-x-0');
            mobileMenuOverlay.classList.add('hidden');
            document.body.style.overflow = 'auto';
        }

        closeMobileMenuBtn.addEventListener('click', closeMobileMenu);
        mobileMenuOverlay.addEventListener('click', closeMobileMenu);

        // Bot칩n de promociones en men칰 m칩vil
        mobilePromotionsBtn.addEventListener('click', () => {
            closeMobileMenu(); // Cerrar men칰 m칩vil primero
            setTimeout(() => {
                promotionsModal.classList.remove('hidden');
                promotionsModal.classList.add('flex');
                // Inicializar las tabs m칩viles al abrir el modal
                setTimeout(() => {
                    updateDailyPromotions(); // Actualizar promociones antes de mostrar
                    showMobilePromo('daily');
                }, 100);
            }, 300); // Esperar a que se cierre el men칰 m칩vil
        });

        // Cerrar men칰 m칩vil al hacer clic en enlaces de navegaci칩n
        document.querySelectorAll('#mobile-menu a[href^="#"]').forEach(link => {
            link.addEventListener('click', () => {
                closeMobileMenu();
            });
        });
        
        // Event listeners para los checkboxes y controles en el modal de personalizaci칩n
        document.addEventListener('change', (e) => {
            if (e.target.classList.contains('topping-checkbox') || 
                e.target.id === 'add-fries-checkbox' || 
                e.target.id === 'add-onion-rings-checkbox' ||
                e.target.classList.contains('menu-extra-checkbox')) {
                
                // Actualizar estados visuales
                if (e.target.classList.contains('topping-checkbox')) {
                    updateToppingsVisualState();
                } else if (e.target.id === 'add-fries-checkbox') {
                    updateFriesVisualState();
                } else if (e.target.classList.contains('menu-extra-checkbox')) {
                    updateMenuExtrasVisualState();
                }
                
                // Actualizar precio
                updateCustomModalPrice();
            }
        });
        
        // Event listeners para los botones de cantidad en extras del men칰
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('quantity-plus') || e.target.classList.contains('quantity-minus')) {
                const itemId = e.target.dataset.id;
                const displayElement = document.querySelector(`.quantity-display[data-id="${itemId}"]`);
                let quantity = parseInt(displayElement.textContent);
                
                if (e.target.classList.contains('quantity-plus')) {
                    quantity++;
                } else if (quantity > 1) {
                    quantity--;
                }
                
                displayElement.textContent = quantity;
                updateCustomModalPrice();
            }
        });
        
        // Event listener para a침adir al carrito desde el modal de personalizaci칩n
        addCustomToCartBtn.addEventListener('click', () => {
            const context = JSON.parse(addCustomToCartBtn.dataset.context || '{}');
            const { isCombo, itemId, choiceIndex, isHotdog, hotdogIndex } = context;
            
            // Recopilar personalizaciones seleccionadas
            const customizations = [];
            document.querySelectorAll('.topping-checkbox:checked').forEach(checkbox => {
                customizations.push({
                    name: checkbox.dataset.name,
                    price: parseFloat(checkbox.dataset.price)
                });
            });
            
            // Recopilar acompa침amientos
            const friesRequested = Boolean(addFriesCheckbox.checked);
            const selectedFriesType = friesRequested
                ? document.querySelector('input[name="fries-type"]:checked')?.value
                : null;

            let fries = null;
            let freeFriesIncluded = null;
            
            let onionRings = null;
            if (document.getElementById('add-onion-rings-checkbox').checked) {
                onionRings = {
                    price: ONION_RINGS_PRICE
                };
            }
            
            // Recopilar extras del men칰
            const menuExtras = [];
            document.querySelectorAll('.menu-extra-checkbox:checked').forEach(checkbox => {
                const extraId = parseInt(checkbox.dataset.id);
                const quantity = parseInt(document.querySelector(`.quantity-display[data-id="${extraId}"]`)?.textContent || '1');
                
                menuExtras.push({
                    id: extraId,
                    name: checkbox.dataset.name,
                    price: parseFloat(checkbox.dataset.price),
                    quantity: quantity
                });
            });

            const specifications = customNotesInput ? customNotesInput.value.trim() : '';
            
            if (isCombo) {
                fries = friesRequested ? { type: selectedFriesType, price: FRIES_PRICE } : null;
                if (isHotdog) {
                    // Actualizar configuraci칩n del hotdog en el combo
                    tempComboConfig.hotdogs[hotdogIndex].customizations = customizations;
                    tempComboConfig.hotdogs[hotdogIndex].fries = fries;
                    tempComboConfig.hotdogs[hotdogIndex].onionRings = onionRings;
                    tempComboConfig.hotdogs[hotdogIndex].menuExtras = menuExtras;
                    tempComboConfig.hotdogs[hotdogIndex].specifications = specifications;
                    
                    // Actualizar el resumen de personalizaci칩n en el modal de combo
                    const summaryEl = document.querySelector(`[data-hotdog-index="${hotdogIndex}"] .customizations-summary`);
                    let summaryText = [];
                    
                    if (customizations.length > 0) {
                        summaryText.push(`${customizations.length} ingredientes extra`);
                    }
                    
                    if (fries) {
                        summaryText.push(`Papas ${fries.type}`);
                    }
                    
                    if (onionRings) {
                        summaryText.push('Aros de Cebolla');
                    }
                    
                    if (menuExtras.length > 0) {
                        summaryText.push(`${menuExtras.length} extras del men칰`);
                    }

                    if (specifications) {
                        summaryText.push(`Nota: ${specifications}`);
                    }
                    
                    summaryEl.textContent = summaryText.length > 0 ? summaryText.join(', ') : 'Sin personalizaci칩n.';
                } else {
                    // Actualizar configuraci칩n de la hamburguesa en el combo
                    tempComboConfig.choices[choiceIndex].customizations = customizations;
                    tempComboConfig.choices[choiceIndex].fries = fries;
                    tempComboConfig.choices[choiceIndex].onionRings = onionRings;
                    tempComboConfig.choices[choiceIndex].menuExtras = menuExtras;

                    tempComboConfig.choices[choiceIndex].specifications = specifications;
                    
                    // Actualizar el resumen de personalizaci칩n en el modal de combo
                    const summaryEl = document.querySelector(`[data-choice-index="${choiceIndex}"] .customizations-summary`);
                    let summaryText = [];
                    
                    if (customizations.length > 0) {
                        summaryText.push(`${customizations.length} ingredientes extra`);
                    }
                    
                    if (fries) {
                        summaryText.push(`Papas ${fries.type}`);
                    }
                    
                    if (onionRings) {
                        summaryText.push('Aros de Cebolla');
                    }
                    
                    if (menuExtras.length > 0) {
                        summaryText.push(`${menuExtras.length} extras del men칰`);
                    }

                    if (specifications) {
                        summaryText.push(`Nota: ${specifications}`);
                    }
                    
                    summaryEl.textContent = summaryText.length > 0 ? summaryText.join(', ') : 'Sin personalizaci칩n.';
                }
                
                // Actualizar el precio total del combo
                updateComboModalTotal();
            } else {
                // A침adir el producto personalizado al carrito
                const originalItem = findItemById(itemId);
                if (!originalItem) return;

                // Determinar la categor칤a y aplicar tambi칠n la promoci칩n diaria al producto personalizado
                const category = getCategoryForItemId(itemId);
                const item = applyDailyPromotion(originalItem, category);

                if (friesRequested) {
                    const isFreeFriesEligible = Boolean(item.freeFries) && isFreeFriesPromotionActiveForCategory(category);
                    if (isFreeFriesEligible) {
                        freeFriesIncluded = {
                            name: getFreeFriesDisplayNameByType(selectedFriesType),
                            price: 0
                        };
                        fries = null;
                    } else {
                        fries = {
                            type: selectedFriesType,
                            price: FRIES_PRICE
                        };
                    }
                }
                
                const cartItem = {
                    id: Date.now(), // ID 칰nico para el carrito
                    baseItem: item,
                    customizations,
                    fries,
                    onionRings,
                    menuExtras,
                    freeFriesIncluded,
                    specifications: specifications || '',
                    price: parseFloat(customModalTotal.textContent.replace('$', '')),
                    quantity: 1,
                    hasPromotion: item.hasPromotion || false,
                    promotionText: item.promotionText || '',
                    freeFries: item.freeFries || false
                };
                
                cart.push(cartItem);
                updateCart();
                openCart();
            }
            
            closeCustomizationModal();
        });
        
        // Event listener para a침adir combo al carrito
        addComboToCartBtn.addEventListener('click', () => {
            const comboItem = {
                id: Date.now(), // ID 칰nico para el carrito
                baseItem: tempComboConfig.baseCombo,
                choices: JSON.parse(JSON.stringify(tempComboConfig.choices)), // Deep copy
                hotdogs: tempComboConfig.hotdogs ? JSON.parse(JSON.stringify(tempComboConfig.hotdogs)) : null, // Deep copy de hotdogs si existen
                includedFries: JSON.parse(JSON.stringify(tempComboConfig.includedFries)), // Deep copy de las papas incluidas
                boneles: tempComboConfig.boneles ? JSON.parse(JSON.stringify(tempComboConfig.boneles)) : null,
                price: parseFloat(comboModalTotal.textContent.replace('$', '')),
                quantity: 1,
                isCombo: true
            };
            
            cart.push(comboItem);
            updateCart();
            closeComboModal();
            openCart();
        });

        // Event listener para tipo de entrega
        document.addEventListener('change', (e) => {
            if (e.target.name === 'delivery-type') {
                const locationSection = document.getElementById('location-section');
                
                if (e.target.value === 'delivery') {
                    locationSection.classList.remove('hidden');
                    // El costo se toma desde direcciones guardadas (Mi cuenta)
                    updateCheckoutTotals();
                } else {
                    locationSection.classList.add('hidden');
                    userAddress = null;
                    try { displaySelectedAddress({ formatted_address: '' }); } catch (_) {}
                }
                
                validateCheckoutForm();
            }
        });

        // Checkout
        checkoutBtn.addEventListener('click', async () => {
            checkoutModal.classList.add('flex');
            checkoutModal.classList.remove('hidden');
            try { loadCustomerData(); } catch (_) {}
            renderOrderSummary();
            updateCheckoutTotals(); // Nueva funci칩n para actualizar totales
            handlePaymentMethodChange(); // Configurar m칠todo de pago inicial
            validateCheckoutForm();
        });

        // Cerrar modal de checkout
        closeModalBtn.addEventListener('click', () => {
            checkoutModal.classList.add('hidden');
            checkoutModal.classList.remove('flex');
        });

        // Validaci칩n en tiempo real para los campos del formulario
        customerNameInput.addEventListener('input', validateCheckoutForm);
        customerNameInput.addEventListener('blur', validateCheckoutForm);
        
        const phoneInput = document.getElementById('customer-phone');
        if (phoneInput) {
            phoneInput.addEventListener('input', validateCheckoutForm);
            phoneInput.addEventListener('blur', validateCheckoutForm);
        }
        
        const addressInput = document.getElementById('address-input');
        if (addressInput) {
            addressInput.addEventListener('input', validateCheckoutForm);
            addressInput.addEventListener('blur', validateCheckoutForm);
            addressInput.addEventListener('input', () => {
                // Marcar que el usuario modific칩 manualmente la direcci칩n
                addressInput.dataset.userEdited = '1';
            });
        }
        
        const cashAmountInput = document.getElementById('cash-amount');
        if (cashAmountInput) {
            cashAmountInput.addEventListener('input', () => {
                calculateChange();
                validateCheckoutForm();
            });
            cashAmountInput.addEventListener('blur', () => {
                calculateChange();
                validateCheckoutForm();
            });
        }
        
        // Validaci칩n cuando cambian los radio buttons
        document.addEventListener('change', (e) => {
            if (e.target.name === 'payment') {
                handlePaymentMethodChange();
                validateCheckoutForm();
            }
            if (e.target.name === 'delivery-type') {
                updateCheckoutTotals(); // Actualizar totales cuando cambie el tipo de entrega
                calculateChange(); // Recalcular cambio con el nuevo total
                validateCheckoutForm();
            }
        });

        function getLoggedInClientUid() {
            try {
                if (window.firebaseClientManager && typeof window.firebaseClientManager.getCurrentUser === 'function') {
                    const u = window.firebaseClientManager.getCurrentUser();
                    if (u && u.uid) return u.uid;
                }
            } catch (_) {}
            try {
                if (window.firebaseAuth && window.firebaseAuth.currentUser && window.firebaseAuth.currentUser.uid) {
                    return window.firebaseAuth.currentUser.uid;
                }
            } catch (_) {}
            return null;
        }

        function redirectToLoginForCheckout() {
            try {
                // Si existe un modal de autenticaci칩n en la misma p치gina, 칰salo y NO navegues.
                if (typeof window.srOpenAuthModal === 'function') {
                    window.srOpenAuthModal({ tab: 'login', reason: 'checkout' });
                    return;
                }
                const next = encodeURIComponent('paginaburger.html');
                window.location.href = `cliente.html?next=${next}`;
            } catch (_) {
                window.location.href = 'cliente.html';
            }
        }

        // Confirmaci칩n de pedido: enviar a backend y mostrar confirmaci칩n
        sendWhatsappBtn.addEventListener('click', async () => {
            const isManualMode = (typeof window.__MANUAL_MODE !== 'undefined' && window.__MANUAL_MODE === true);
            const sessionUid = getLoggedInClientUid();
            if (!isManualMode && !sessionUid) {
                try {
                    showNotification('Debes iniciar sesi칩n para finalizar tu compra. Te enviamos a Mi cuenta.', 'warning');
                } catch (_) {
                    alert('Debes iniciar sesi칩n para finalizar tu compra.');
                }
                redirectToLoginForCheckout();
                return;
            }

            // MODO MANUAL: no enviar/redirigir a WhatsApp; usar flujo local del pedido manual.
            if (isManualMode) {
                try {
                    if (typeof window.placeOrder === 'function') {
                        await window.placeOrder();
                        return;
                    }
                } catch (e) {
                    console.warn('Error en placeOrder manual:', e);
                }
                try {
                    showNotification('Pedido manual: no se env칤a WhatsApp autom치ticamente.', 'info');
                } catch (_) {
                    alert('Pedido manual: no se env칤a WhatsApp autom치ticamente.');
                }
                return;
            }
            // Bloquear bot칩n y mostrar loading
            const originalHtml = sendWhatsappBtn.innerHTML;
            sendWhatsappBtn.disabled = true;
            sendWhatsappBtn.classList.add('loading');
            sendWhatsappBtn.innerHTML = '<span class="loading-spinner mr-2"></span> Enviando...';

            try {
                // Construir payload igual que addToOrderControl
                const deliveryTypeElement = document.querySelector('input[name="delivery-type"]:checked');
                const paymentMethodElement = document.querySelector('input[name="payment"]:checked');
                const customerName = customerNameInput ? customerNameInput.value.trim() : '';
                const customerPhone = customerPhoneInput ? customerPhoneInput.value.trim() : '';
                if (!customerName || !customerPhone || !deliveryTypeElement || !paymentMethodElement) {
                    throw new Error('Faltan datos requeridos');
                }

                const deliveryTypeValue = deliveryTypeElement.value;
                const paymentMethod = paymentMethodElement.value;

                // MODO MANUAL: Si window.__MANUAL_MODE est치 activado, NO validar direcciones guardadas
                const isManualMode = (typeof window.__MANUAL_MODE !== 'undefined' && window.__MANUAL_MODE === true);

                if (deliveryTypeValue === 'delivery' && !isManualMode) {
                    const selectEl = document.getElementById('saved-address-select');
                    const selectedOk = !!(selectEl && selectEl.value && selectEl.value !== '__select__');
                    const addrOk = !!(userAddress && userAddress.formatted_address);
                    const priceOk = !!(userAddress && typeof userAddress.deliveryPrice === 'number' && isFinite(userAddress.deliveryPrice));
                    if (!selectedOk || !addrOk || !priceOk) {
                        throw new Error('Por favor selecciona una direcci칩n guardada (Mi cuenta)');
                    }
                }

                let address = '';
                let deliveryCoords = null;
                if (deliveryTypeValue === 'delivery') {
                    // MODO MANUAL: usar direcci칩n manual si est치 disponible
                    if (isManualMode) {
                        const manualAddressEl = document.getElementById('manual-address');
                        address = manualAddressEl ? manualAddressEl.value.trim() : '';
                        // En modo manual no tenemos coordenadas precisas
                        deliveryCoords = null;
                    } else {
                        // Modo normal: usar direcci칩n guardada
                        address = (userAddress && userAddress.formatted_address) ? String(userAddress.formatted_address) : '';
                        if (userAddress && userAddress.coordinates && isFinite(userAddress.coordinates.lat) && isFinite(userAddress.coordinates.lng)) {
                            deliveryCoords = { lat: userAddress.coordinates.lat, lng: userAddress.coordinates.lng };
                        }
                    }
                } else {
                    address = 'Recoger en local - SR & SRA BURGER';
                }

                let cashAmount = '';
                if (paymentMethod === 'Efectivo') {
                    const cashAmountInput = document.getElementById('cash-amount');
                    if (cashAmountInput && cashAmountInput.value.trim()) {
                        cashAmount = parseFloat(cashAmountInput.value.trim()).toFixed(2);
                    }
                }

                const orderItems = cart.map(item => {
                    let customizations = '';
                    let specificationsText = '';

                    if (item.isCombo) {
                        const hasMultipleBurgers = Array.isArray(item.choices) && item.choices.length > 1;
                        const choiceDetails = (item.choices || []).map((choice, idx) => {
                                const prefix = hasMultipleBurgers ? `Hamburguesa ${idx + 1}: ` : 'Hamburguesa: ';
                                let text = prefix + (choice?.burger?.name || 'Hamburguesa');
                                if (choice.customizations && choice.customizations.length > 0) {
                                    text += ` (+ ${choice.customizations.map(c => c.name).join(', ')})`;
                                }
                                if (choice.fries) text += `, Papas ${choice.fries.type}`;
                                if (choice.onionRings) text += `, Aros de Cebolla`;

                                // Extras del men칰 (por ejemplo, papas adicionales) ligados a esta hamburguesa dentro del combo
                                if (choice.menuExtras && choice.menuExtras.length > 0) {
                                    choice.menuExtras.forEach(extra => {
                                        const qty = Number(extra.quantity) || 1;
                                        const name = String(extra.name || '').trim();
                                        if (name) {
                                            text += `, ${qty}x ${name}`;
                                        }
                                    });
                                }

                                return text;
                            }).join(' | ');
                        // Anexar informaci칩n de acompa침amientos incluidos del combo (para Control de Env칤os)
                        const extraInfo = [];
                        if (item.includedFries && item.includedFries.type && item.includedFries.size) {
                            extraInfo.push(`Papas ${item.includedFries.type} ${item.includedFries.size}`);
                        }

                        if (item.boneles && typeof item.boneles.sauce === 'string' && item.boneles.sauce.trim()) {
                            extraInfo.push(`Salsa: ${item.boneles.sauce.trim()}`);
                        }
                        // Detalles espec칤ficos por combo
                        if (item.baseItem && Number(item.baseItem.id) === 14) {
                            // Combo Familiar incluye Aros Medianos y Coca-Cola 3L
                            extraInfo.push('Aros de Cebolla Medianos', 'Coca-Cola 3L');
                        } else if (item.baseItem && Number(item.baseItem.id) === 6) {
                            // Combo Pareja incluye aros (7 pz)
                            extraInfo.push('Aros de Cebolla (7 pz)');
                        }

                        customizations = choiceDetails + (extraInfo.length ? ` | Incluye: ${extraInfo.join(', ')}` : '');

                        // Especificaciones por cada hamburguesa dentro del combo
                        const specsPieces = [];
                        if (Array.isArray(item.choices)) {
                            item.choices.forEach(choice => {
                                if (choice && choice.specifications) {
                                    specsPieces.push(`${choice.burger && choice.burger.name ? choice.burger.name : 'Elecci칩n'}: ${choice.specifications}`);
                                }
                            });
                        }
                        if (Array.isArray(item.hotdogs)) {
                            item.hotdogs.forEach((hotdog, idx) => {
                                if (hotdog && hotdog.specifications) {
                                    const name = hotdog.name || `Hot Dog ${idx + 1}`;
                                    specsPieces.push(`${name}: ${hotdog.specifications}`);
                                }
                            });
                        }
                        specificationsText = specsPieces.join(' | ');
                    } else {
                        const details = [];
                        if (item.customizations && item.customizations.length > 0) {
                            const custNames = item.customizations
                                .map(c => String(c && c.name ? c.name : '').trim())
                                .filter(Boolean);

                            // Boneless/Boneles: separar Papas y Salsa para que Control las detecte.
                            if (item.boneles) {
                                const portionLine = custNames.find(n => /^Porci[o칩]n\s*:/i.test(n));
                                const friesLine = custNames.find(n => /^Papas\s*:/i.test(n));
                                const sauceLine = custNames.find(n => /^(Salsa|Salsas)\s*:/i.test(n));

                                const other = custNames.filter(n => n !== portionLine && n !== friesLine && n !== sauceLine);

                                if (portionLine) details.push(`+ ${portionLine}`);
                                if (other.length) details.push(`+ ${other.join(', ')}`);
                                if (friesLine) details.push(friesLine);
                                if (sauceLine) details.push(sauceLine);
                            } else {
                                // Productos normales: mantener formato de toppings con "+"
                                details.push(`+ ${custNames.join(', ')}`);
                            }
                        }
                        if (item.fries) details.push(`Papas ${item.fries.type}`);
                        if (!item.fries && item.freeFriesIncluded && item.freeFriesIncluded.name) {
                            details.push(`${item.freeFriesIncluded.name} (GRATIS)`);
                        }
                        if (item.onionRings) details.push('Aros de Cebolla');
                        if (item.menuExtras && item.menuExtras.length > 0) {
                            item.menuExtras.forEach(extra => details.push(`${extra.quantity}x ${extra.name}`));
                        }
                        customizations = details.join(', ');

                                // Especificaciones para productos individuales
                                if (item.specifications) {
                                    specificationsText = item.specifications;
                                }
                            }
                            const baseId = Number(item.baseItem && item.baseItem.id);
                            const unitPrice = Number(item.price || 0);
                            return {
                            id: baseId,
                            productId: baseId,
                            name: item.baseItem.name,
                            quantity: item.quantity,
                            unitPrice: parseFloat(unitPrice.toFixed(2)),
                            price: parseFloat((unitPrice * item.quantity).toFixed(2)),
                            customizations: customizations || '',
                            specifications: specificationsText || ''
                        };
                });

                const pricing = computeCheckoutPricing(deliveryTypeValue);
                const total = pricing.total;

                let notes = '';
                let changeAmount = '';
                if (paymentMethod === 'Efectivo' && cashAmount) {
                    const change = parseFloat(cashAmount) - total;
                    changeAmount = isFinite(change) ? change.toFixed(2) : '';
                    notes += `Pago: $${cashAmount} | Cambio: $${change.toFixed(2)}`;
                }
                if (paymentMethod !== 'Efectivo') {
                    notes += `Pago: ${paymentMethod}`;
                }

                if (pricing.rewardApplied && pricing.reward && pricing.reward.label) {
                    notes += (notes ? ' | ' : '') + `Recompensa: ${pricing.reward.label}`;
                }

                if (pricing.discountCode) {
                    notes += (notes ? ' | ' : '') + `Cup칩n: ${pricing.discountCode}`;
                }

                // Sesi칩n requerida (excepto modo manual): asociar siempre el pedido al usuario autenticado
                const clienteId = isManualMode ? (sessionUid || null) : sessionUid;

                const orderData = {
                    customer: { name: customerName, phone: customerPhone, address, coordinates: deliveryCoords },
                    items: orderItems,
                    // Totales y desglose
                    subtotal: parseFloat(pricing.subtotal.toFixed(2)),
                    subtotalAfterDiscount: parseFloat(pricing.subtotalAfterDiscount.toFixed(2)),
                    deliveryFee: parseFloat(pricing.deliveryFee.toFixed(2)),
                    total: parseFloat(total.toFixed(2)),
                    notes: notes || '',
                    deliveryType: deliveryTypeValue,
                    paymentMethod: paymentMethod,
                    cashAmount: cashAmount || undefined,
                    changeAmount: changeAmount || undefined,
                    clienteId: clienteId || undefined,
                    reward: (pricing.rewardApplied && pricing.reward) ? pricing.reward : undefined,
                    discountAmount: pricing.discountAmount || 0,
                    discountReason: pricing.discountReason || undefined,
                    discountCode: pricing.discountCode || undefined,
                    discountCodeAmount: pricing.discountCodeAmount || 0,
                    rewardDiscountAmount: pricing.rewardDiscountAmount || 0
                };

                // 1) Crear la orden y obtener el n칰mero (Firebase o respaldo local)
                let createdOrderNumber = null;
                let createdOrderId = null;
                if (window.firebaseOrderManager && window.firebaseOrderManager.addOrder) {
                    try {
                        const res = await window.firebaseOrderManager.addOrder(orderData);
                        createdOrderNumber = res && res.orderNumber ? res.orderNumber : null;
                        createdOrderId = res && res.id ? res.id : null;
                        console.log('九 Orden creada en Firebase. No. Orden:', createdOrderNumber);
                    } catch (e) {
                        console.warn('丘멆잺 Error guardando en Firebase, usando respaldo local:', e);
                    }
                }

                if (!createdOrderNumber) {
                    // Si Firebase fall칩, generar n칰mero y guardar solo en localStorage
                    createdOrderNumber = saveToLocalStorageBackup(orderData);
                    console.log('游 Orden guardada localmente. No. Orden:', createdOrderNumber);
                } else {
                    // Si Firebase funcion칩, tambi칠n guardar una copia en localStorage
                    saveToLocalStorageBackup(orderData, createdOrderNumber);
                }

                // Mostrar el n칰mero en el modal de 칠xito
                setLastOrderNumber(createdOrderNumber);

                // Si el m칠todo de pago es "Pago en l칤nea", crear preferencia de Mercado Pago y redirigir
                if (paymentMethod === 'Pago en linea' || paymentMethod === 'Pago en l칤nea') {
                    try {
                        // Preparar link de WhatsApp (se mostrar치 al aprobar pago, porque abrir WA autom치tico suele ser bloqueado)
                        let pendingWhatsAppUrl = null;
                        try {
                            let waMessage = generateWhatsAppMessage(pricing);
                            if (createdOrderNumber) {
                                let trackingBase = '';
                                try {
                                    if (typeof window !== 'undefined' && window.location && window.location.origin) {
                                        const origin = String(window.location.origin);
                                        trackingBase = (origin && origin !== 'null') ? origin.replace(/\/$/, '') : '';
                                    }
                                } catch (_) { trackingBase = ''; }

                                const trackingUrl = trackingBase
                                    ? `${trackingBase}/tuenvio.html?order=${encodeURIComponent(createdOrderNumber)}`
                                    : `tuenvio.html?order=${encodeURIComponent(createdOrderNumber)}`;

                                waMessage += `\n\n*N칰mero de orden:* ${createdOrderNumber}`;
                                waMessage += `\n游닍 *Rastrea tu pedido:*`;
                                waMessage += `\n${trackingUrl}`;
                            }
                            const encodedMessage = encodeURIComponent(waMessage);
                            const phone = String(WHATSAPP_NUMBER).replace(/\D/g, '');
                            pendingWhatsAppUrl = `https://wa.me/${phone}?text=${encodedMessage}`;
                            try { localStorage.setItem('sr_last_whatsapp_url', pendingWhatsAppUrl); } catch (_) {}
                        } catch (_) {
                            pendingWhatsAppUrl = null;
                        }

                        // Importante: si la p치gina se abre como file://, las rutas relativas fallan.
                        // Usar API_BASE (que cae a http://localhost:3000) mantiene el pago funcionando.
                        const mpUrl = `${API_BASE}/api/mercadopago/create-preference`;
                        const mpRes = await fetch(mpUrl, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                orderNumber: createdOrderNumber,
                                orderData,
                            }),
                        });

                        const mpJson = await mpRes.json().catch(() => null);
                        const initPoint = mpJson && (mpJson.initPoint || (mpJson.raw && (mpJson.raw.init_point || mpJson.raw.sandbox_init_point)));

                        if (!mpRes.ok || !mpJson || !mpJson.ok || !initPoint) {
                            throw new Error((mpJson && mpJson.error) || 'No se pudo iniciar el pago en l칤nea');
                        }

                        // Enviar tambi칠n al backend (no bloqueante para el usuario)
                        try {
                            await postOrderToApi({ ...orderData, orderNumber: createdOrderNumber });
                        } catch (apiErr) {
                            console.warn('No se pudo enviar el pedido al backend:', apiErr);
                        }

                        // En localhost/LAN Mercado Pago puede NO redirigir de vuelta.
                        // Abrir el checkout en otra pesta침a y confirmar desde aqu칤 con polling.
                        // Guardar estado pendiente para poder confirmar aunque el usuario regrese con "atr치s"
                        // o si el navegador bloquea popups.
                        try { setPendingMpOrder(createdOrderNumber, createdOrderId, pendingWhatsAppUrl); } catch (_) {}

                        const opened = window.open(initPoint, '_blank', 'noopener,noreferrer');
                        if (!opened) {
                            // Si el navegador bloque칩 popups, caer al redirect normal.
                            window.location.href = initPoint;
                            return;
                        }
                        try {
                            showNotification('游눱 Se abri칩 Mercado Pago en otra pesta침a. Completa el pago y vuelve aqu칤; esta p치gina confirmar치 autom치ticamente.', 'info');
                        } catch (_) {}
                        startMercadoPagoStatusPolling(createdOrderNumber, createdOrderId);
                        return; // No continuar con el flujo de WhatsApp
                    } catch (mpErr) {
                        console.error('Error iniciando pago en l칤nea con Mercado Pago:', mpErr);
                        try {
                            showNotification('No se pudo iniciar el pago en l칤nea. Intenta de nuevo o elige otro m칠todo.', 'error');
                        } catch (_) {
                            alert('No se pudo iniciar el pago en l칤nea. Intenta de nuevo o elige otro m칠todo.');
                        }
                        return; // Evitar abrir WhatsApp si el usuario eligi칩 Pago en l칤nea
                    }
                }

                // 2) Abrir WhatsApp con el detalle del pedido hacia el n칰mero del negocio
                try {
                    let waMessage = generateWhatsAppMessage(pricing);
                    if (createdOrderNumber) {
                        // A침adir n칰mero de orden y link de rastreo para el cliente
                        let trackingBase = '';
                        try {
                            if (typeof window !== 'undefined' && window.location && window.location.origin) {
                                const origin = String(window.location.origin);
                                // En file://, origin suele ser "null"
                                trackingBase = (origin && origin !== 'null') ? origin.replace(/\/$/, '') : '';
                            }
                        } catch (e) {
                            trackingBase = '';
                        }

                        const trackingUrl = trackingBase
                            ? `${trackingBase}/tuenvio.html?order=${encodeURIComponent(createdOrderNumber)}`
                            : `tuenvio.html?order=${encodeURIComponent(createdOrderNumber)}`;

                        waMessage += `\n\n*N칰mero de orden:* ${createdOrderNumber}`;
                        waMessage += `\n游닍 *Rastrea tu pedido:*`;
                        waMessage += `\n${trackingUrl}`;
                    }
                    const encodedMessage = encodeURIComponent(waMessage);
                    const phone = String(WHATSAPP_NUMBER).replace(/\D/g, '');
                    const whatsappUrl = `https://wa.me/${phone}?text=${encodedMessage}`;

                    // Consumir recompensa activa si se aplic칩 en esta compra (no bloqueante)
                    if (pricing.rewardApplied && clienteId && window.firebaseClientManager && typeof window.firebaseClientManager.clearActiveReward === 'function') {
                        try {
                            Promise.resolve()
                                .then(() => window.firebaseClientManager.clearActiveReward(clienteId))
                                .then(() => setActiveRewardState(null))
                                .catch((e) => console.warn('No se pudo limpiar la recompensa activa:', e));
                        } catch (e) {
                            console.warn('No se pudo iniciar limpieza de recompensa activa:', e);
                        }
                    }

                    // Redirigir directamente a WhatsApp para evitar bloqueos de pop-up
                    window.location.href = whatsappUrl;
                } catch (waErr) {
                    console.warn('No se pudo abrir WhatsApp:', waErr);
                }

                // 3) Enviar al backend incluyendo el n칰mero de orden (no bloqueante para el usuario)
                try {
                    await postOrderToApi({ ...orderData, orderNumber: createdOrderNumber });
                } catch (apiErr) {
                    console.warn('No se pudo enviar el pedido al backend:', apiErr);
                }

                // 4) Guardar datos del cliente
                saveCustomerData();

                // Cerrar checkout y limpiar carrito
                checkoutModal.classList.add('hidden');
                checkoutModal.classList.remove('flex');
                cart = [];
                updateCart();

                // Mostrar modal de 칠xito
                const successModal = document.getElementById('order-success-modal');
                if (successModal) {
                    successModal.classList.add('flex');
                    successModal.classList.remove('hidden');
                    const closeBtn = document.getElementById('close-order-success');
                    if (closeBtn) {
                        closeBtn.onclick = () => {
                            successModal.classList.add('hidden');
                            successModal.classList.remove('flex');
                        };
                    }
                } else {
                    showNotification('춰Orden recibida! Te confirmaremos por WhatsApp en breve.', 'success');
                }

            } catch (err) {
                console.error(err);
                showNotification('No se pudo enviar el pedido. Int칠ntalo de nuevo.', 'error');
            } finally {
                // Restaurar bot칩n
                sendWhatsappBtn.classList.remove('loading');
                sendWhatsappBtn.innerHTML = originalHtml;
                try { validateCheckoutForm(); } catch (_) { sendWhatsappBtn.disabled = false; }
            }
        });

        // Help modal
        document.getElementById('help-btn').addEventListener('click', () => {
            document.getElementById('help-modal').classList.add('flex');
            document.getElementById('help-modal').classList.remove('hidden');
        });
        
        document.getElementById('close-help-modal-btn').addEventListener('click', () => {
            document.getElementById('help-modal').classList.add('hidden');
            document.getElementById('help-modal').classList.remove('flex');
        });
    }

    // Funciones para el modal de personalizaci칩n
    function openCustomizationModal(context) {
        const { isCombo, choiceIndex, isHotdog, hotdogIndex } = context;
        let item, currentCustomizations, currentFries, currentMenuExtras, currentSpecifications;
        
        if (isCombo) {
            if (isHotdog) {
                const hotdogChoice = tempComboConfig.hotdogs[hotdogIndex];
                item = hotdogChoice.hotdog;
                currentCustomizations = hotdogChoice.customizations || [];
                currentFries = hotdogChoice.fries;
                currentMenuExtras = hotdogChoice.menuExtras || [];
                currentSpecifications = hotdogChoice.specifications || '';
                customModalTitle.textContent = `Personaliza tu ${item.name} (Combo)`;
            } else {
                const choice = tempComboConfig.choices[choiceIndex];
                item = choice.burger;
                currentCustomizations = choice.customizations;
                currentFries = choice.fries;
                currentMenuExtras = choice.menuExtras || [];
                currentSpecifications = choice.specifications || '';
                customModalTitle.textContent = `Personaliza tu ${item.name} (Combo)`;
            }
        } else {
            item = findItemById(context.itemId);
            currentCustomizations = [];
            currentFries = null;
            currentMenuExtras = [];
            currentSpecifications = '';
            customModalTitle.textContent = `Personaliza tu ${item.name}`;

            // Ajustar el pill de papas seg칰n promo del d칤a (jueves: papas gratis)
            const friesPill = document.getElementById('fries-price-pill');
            if (friesPill) {
                const category = getCategoryForItemId(context.itemId);
                const isFreeFries = isFreeFriesPromotionActiveForCategory(category);
                friesPill.textContent = isFreeFries ? 'GRATIS' : `+${FRIES_PRICE.toFixed(0)}`;
                friesPill.classList.toggle('bg-green-100', isFreeFries);
                friesPill.classList.toggle('text-green-700', isFreeFries);
                friesPill.classList.toggle('bg-yellow-100', !isFreeFries);
                friesPill.classList.toggle('text-yellow-800', !isFreeFries);
            }
        }

        // Guardar el contexto desde el inicio (esto se lee en updateCustomModalPrice y al confirmar)
        addCustomToCartBtn.dataset.context = JSON.stringify(context);

        // Si el producto base es un Extra (y tiene versi칩n Grande/XL), mostrar selector de tama침o aqu칤
        // Nota: esto es para el producto que est치s personalizando, no para los extras dentro del modal.
        const modalBody = document.getElementById('custom-modal-body');
        let baseSizeContainer = document.getElementById('base-extra-size-container');
        if (!baseSizeContainer && modalBody) {
            baseSizeContainer = document.createElement('div');
            baseSizeContainer.id = 'base-extra-size-container';
            modalBody.prepend(baseSizeContainer);
        }
        if (baseSizeContainer) {
            baseSizeContainer.innerHTML = '';
            baseSizeContainer.className = 'mb-4';

            // Reset: por si el modal se abri칩 antes como "solo talla", restaurar visibilidad
            if (modalBody) {
                modalBody.querySelectorAll('.custom-section, .custom-divider').forEach(el => el.classList.remove('hidden'));
            }

            const isBaseExtra = !isCombo && Array.isArray(menuData.Extras) && menuData.Extras.some(i => i.id === item?.id);
            const mediumIdFromValue = Object.keys(EXTRA_LARGE_VARIANTS).find(k => EXTRA_LARGE_VARIANTS[Number(k)] === item?.id);
            const mediumId = isBaseExtra
                ? (EXTRA_LARGE_VARIANTS[item?.id] ? item.id : (mediumIdFromValue ? Number(mediumIdFromValue) : null))
                : null;
            const largeId = mediumId != null ? EXTRA_LARGE_VARIANTS[mediumId] : null;
            const mediumItem = mediumId != null ? findItemById(mediumId) : null;
            const largeItem = largeId != null ? findItemById(largeId) : null;
            const showSize = !!(isBaseExtra && mediumItem && largeItem);

            if (showSize) {
                const currentIsLarge = item.id === largeItem.id;
                baseSizeContainer.innerHTML = `
                    <div class="p-3 border rounded-xl">
                        <p class="font-semibold mb-2">游늺 Tama침o</p>
                        <div class="grid grid-cols-2 gap-2">
                            <label class="flex items-center justify-between gap-2 p-3 rounded-xl border cursor-pointer hover:bg-gray-50 transition-all duration-200">
                                <div class="flex items-center gap-2">
                                    <input type="radio" name="base-extra-size" value="medium" class="form-radio text-[#FFB300]" ${currentIsLarge ? '' : 'checked'}>
                                    <span class="font-medium">Mediana</span>
                                </div>
                                <span class="text-sm font-semibold text-gray-600">$${Number(mediumItem.price).toFixed(0)}</span>
                            </label>
                            <label class="flex items-center justify-between gap-2 p-3 rounded-xl border cursor-pointer hover:bg-gray-50 transition-all duration-200">
                                <div class="flex items-center gap-2">
                                    <input type="radio" name="base-extra-size" value="large" class="form-radio text-[#FFB300]" ${currentIsLarge ? 'checked' : ''}>
                                    <span class="font-medium">Grande / XL</span>
                                </div>
                                <span class="text-sm font-semibold text-gray-600">$${Number(largeItem.price).toFixed(0)}</span>
                            </label>
                        </div>
                    </div>
                `;

                baseSizeContainer.querySelectorAll('input[name="base-extra-size"]').forEach(radio => {
                    radio.addEventListener('change', () => {
                        const ctx = JSON.parse(addCustomToCartBtn.dataset.context || '{}');
                        const nextId = radio.value === 'large' ? largeItem.id : mediumItem.id;
                        ctx.itemId = nextId;
                        addCustomToCartBtn.dataset.context = JSON.stringify(ctx);
                        const nextItem = findItemById(nextId);
                        if (nextItem) customModalTitle.textContent = `Personaliza tu ${nextItem.name}`;
                        updateCustomModalPrice();
                    });
                });

                // Para Extras: en el modal solo debe mostrarse la selecci칩n Mediana/XL
                // Ocultamos toppings/acompa침amiento/extras del men칰 y limpiamos cualquier selecci칩n.
                try {
                    const toppingsSection = toppingsContainer?.closest('.custom-section');
                    const friesSection = document.getElementById('fries-container')?.closest('.custom-section');
                    const menuExtrasSection = document.getElementById('menu-extras-container')?.closest('.custom-section');
                    if (toppingsSection) toppingsSection.classList.add('hidden');
                    if (friesSection) friesSection.classList.add('hidden');
                    if (menuExtrasSection) menuExtrasSection.classList.add('hidden');
                    if (modalBody) modalBody.querySelectorAll('.custom-divider').forEach(el => el.classList.add('hidden'));

                    // Limpieza defensiva: por si ven칤a de otra personalizaci칩n
                    toppingsContainer.innerHTML = '';
                    document.querySelectorAll('.topping-checkbox').forEach(cb => { cb.checked = false; });
                    if (addFriesCheckbox) addFriesCheckbox.checked = false;
                    if (friesChoiceContainer) friesChoiceContainer.classList.add('hidden');
                    const onionCb = document.getElementById('add-onion-rings-checkbox');
                    if (onionCb) onionCb.checked = false;
                    const menuExtrasContainer = document.getElementById('menu-extras-container');
                    if (menuExtrasContainer) menuExtrasContainer.innerHTML = '';
                } catch (_) {}

                // Mostrar modal y calcular precio
                updateCustomModalPrice();
                customModal.classList.add('flex');
                customModal.classList.remove('hidden');
                return;
            }
        }

        // Configurar secci칩n de especificaciones (notas libres) seg칰n producto
        if (customNotesSection && customNotesInput) {
            const allowSpecs = shouldShowSpecificationsForItem(item);
            if (allowSpecs) {
                customNotesSection.classList.remove('hidden');
                if (customNotesDivider) customNotesDivider.classList.remove('hidden');
                customNotesInput.value = currentSpecifications || '';
            } else {
                customNotesSection.classList.add('hidden');
                if (customNotesDivider) customNotesDivider.classList.add('hidden');
                customNotesInput.value = '';
            }
        }
        
        toppingsContainer.innerHTML = '';
        const currentToppingNames = currentCustomizations.map(c => c.name);
        
        // Determinar si es hotdog para filtrar toppings
        let isHotdogItem = false;
        if (isCombo && isHotdog) {
            isHotdogItem = true;
        } else if (!isCombo) {
            // Verificar si el item est치 en la categor칤a Hot Dogs
            for (const category in menuData) {
                if (category === 'Hot Dogs' && menuData[category].some(i => i.id === item.id)) {
                    isHotdogItem = true;
                    break;
                }
            }
        }
        
        // Filtrar toppings seg칰n el tipo de producto
        let availableToppings = toppingsData;
        if (isHotdogItem) {
            // Para hotdogs: mismo men칰 que hamburguesas, pero sin Doble Carne
            availableToppings = toppingsData.filter(topping => topping.id !== 't6');
        }
        
        availableToppings.forEach(topping => {
            const isChecked = currentToppingNames.includes(topping.name) ? 'checked' : '';
            
            // Aplicar promoci칩n de jueves para Carne Extra (ahora Doble Carne)
            let toppingPrice = topping.price;
            let promotionText = '';
            const todayPromotion = getCurrentDayPromotion();
            
            if (todayPromotion && todayPromotion.type === 'meat_supreme' && topping.name === 'Doble Carne') {
                toppingPrice = 10; // Precio especial de jueves
                promotionText = '<span class="ml-2 px-2 py-0.5 bg-red-100 text-red-700 rounded-full text-[10px] font-bold">HOY</span>';
            }
            
            const displayTitle = topping.price === 0 ? topping.description : topping.name;
            const pricePill = topping.price === 0 
                ? '<span class="px-2 py-0.5 bg-green-100 text-green-700 rounded-full text-xs font-semibold">Gratis</span>'
                : `<span class=\"px-2 py-0.5 bg-yellow-100 text-yellow-800 rounded-full text-xs font-semibold\">+${toppingPrice.toFixed(0)}</span>`;
            const oldPrice = (toppingPrice !== topping.price)
                ? `<span class=\"ml-2 text-xs text-gray-400 line-through\">+${topping.price.toFixed(0)}</span>`
                : '';
            
            toppingsContainer.innerHTML += `
                <label class="flex items-center p-3 border rounded-xl cursor-pointer hover:bg-gray-50 transition-all duration-200 ${isChecked ? 'bg-[#FFB300]/10 border-[#FFB300]' : 'border-gray-200'}">
                    <input type="checkbox" data-price="${toppingPrice}" data-name="${topping.name}" class="topping-checkbox form-checkbox h-5 w-5 text-[#FFB300] rounded focus:ring-[#FFA000]" ${isChecked}>
                    <div class="ml-3 flex-grow">
                        <div class="flex items-center flex-wrap gap-2">
                            <span class="font-semibold text-gray-800">${displayTitle}</span>
                            ${promotionText}
                        </div>
                        <div class="mt-1 flex items-center gap-2 text-sm text-gray-600">
                            ${pricePill}
                            ${oldPrice}
                        </div>
                    </div>
                </label>
            `;
        });
        
        // Poblar extras del men칰
        const menuExtrasContainer = document.getElementById('menu-extras-container');
        menuExtrasContainer.innerHTML = '';
        const menuExtras = [...(menuData.Extras || [])];
        menuExtras.forEach(extra => {
            const existing = currentMenuExtras.find(e => e.id === extra.id);
            const isChecked = existing ? 'checked' : '';
            const quantity = existing?.quantity || 1;
            const displayName = extra.name;
            const displayPrice = extra.price;
            menuExtrasContainer.innerHTML += `
                <label class="flex items-center p-3 border rounded-lg cursor-pointer hover:bg-gray-50 transition-all duration-200 ${isChecked ? 'bg-[#FFB300]/10 border-[#FFB300]' : ''}">
                    <input type="checkbox" data-price="${displayPrice}" data-name="${displayName}" data-id="${extra.id}" class="menu-extra-checkbox form-checkbox h-5 w-5 text-[#FFB300] rounded focus:ring-[#FFA000]" ${isChecked}>
                    <div class="ml-3 flex-grow">
                        <span class="menu-extra-name font-semibold text-gray-800">${displayName}</span>
                        <div class="menu-extra-price text-sm text-gray-600">+${displayPrice.toFixed(0)}</div>
                    </div>
                    <div class="ml-2 ${isChecked ? '' : 'hidden'}" data-quantity-controls="${extra.id}">
                        <div class="flex items-center space-x-2">
                            <button type="button" class="quantity-minus bg-gray-200 hover:bg-gray-300 rounded-full w-6 h-6 flex items-center justify-center text-sm" data-id="${extra.id}">-</button>
                            <span class="quantity-display w-8 text-center text-sm font-semibold" data-id="${extra.id}">${quantity}</span>
                            <button type="button" class="quantity-plus bg-gray-200 hover:bg-gray-300 rounded-full w-6 h-6 flex items-center justify-center text-sm" data-id="${extra.id}">+</button>
                        </div>
                    </div>
                </label>
            `;
        });
            
        // Actualizar selecci칩n de acompa침amientos
        if (currentFries) {
            addFriesCheckbox.checked = true;
            friesChoiceContainer.classList.remove('hidden');
            
            // Seleccionar el tipo de papas correcto
            document.querySelector(`input[name="fries-type"][value="${currentFries.type}"]`).checked = true;
        } else {
            addFriesCheckbox.checked = false;
            friesChoiceContainer.classList.add('hidden');
        }
        
        if (currentFries || currentCustomizations.length > 0 || (currentMenuExtras && currentMenuExtras.length > 0)) {
            updateToppingsVisualState();
            updateFriesVisualState();
            updateMenuExtrasVisualState();
        }
        
        // Mostrar modal y calcular precio
        updateCustomModalPrice();
        
        // Mostrar el modal
        customModal.classList.add('flex');
        customModal.classList.remove('hidden');
    }

    function closeCustomizationModal() {
        customModal.classList.add('hidden');
        customModal.classList.remove('flex');
    }

    // Funciones para actualizar estados visuales
    function updateToppingsVisualState() {
        const checkboxes = toppingsContainer.querySelectorAll('.topping-checkbox');
        checkboxes.forEach(checkbox => {
            const label = checkbox.closest('label');
            if (checkbox.checked) {
                label.classList.add('bg-[#FFB300]/10', 'border-[#FFB300]');
            } else {
                label.classList.remove('bg-[#FFB300]/10', 'border-[#FFB300]');
            }
        });
    }
    
    function updateFriesVisualState() {
        const label = addFriesCheckbox.closest('label');
        if (addFriesCheckbox.checked) {
            label.classList.add('bg-[#FFB300]/10', 'border-[#FFB300]');
            friesChoiceContainer.classList.remove('hidden');
        } else {
            label.classList.remove('bg-[#FFB300]/10', 'border-[#FFB300]');
            friesChoiceContainer.classList.add('hidden');
        }
    }
    
    function updateMenuExtrasVisualState() {
        const checkboxes = document.querySelectorAll('.menu-extra-checkbox');
        checkboxes.forEach(checkbox => {
            const label = checkbox.closest('label');
            const controls = label.querySelector(`[data-quantity-controls="${checkbox.dataset.id}"]`);
            
            if (checkbox.checked) {
                label.classList.add('bg-[#FFB300]/10', 'border-[#FFB300]');
                if (controls) controls.classList.remove('hidden');
            } else {
                label.classList.remove('bg-[#FFB300]/10', 'border-[#FFB300]');
                if (controls) controls.classList.add('hidden');
            }
        });
    }
    
    // Funci칩n para actualizar el precio total en el modal de personalizaci칩n
    function updateCustomModalPrice() {
        const context = JSON.parse(addCustomToCartBtn.dataset.context || '{}');
        const { isCombo, itemId, choiceIndex, isHotdog, hotdogIndex } = context;
        
        let basePrice = 0;
        let isFreeFriesEligible = false;
        
        if (isCombo) {
            if (isHotdog) {
                const hotdog = tempComboConfig.hotdogs?.[hotdogIndex]?.hotdog;
                basePrice = hotdog && typeof hotdog.price === 'number' ? hotdog.price : 0;
            } else {
                // Para combos, usamos el precio base de la hamburguesa
                const burger = tempComboConfig.choices?.[choiceIndex]?.burger;
                basePrice = burger && typeof burger.price === 'number' ? burger.price : 0;
            }
        } else if (itemId) {
            // Para 칤tems individuales, usamos el precio del 칤tem
            // aplicando la promoci칩n diaria si corresponde (ej. HOTDOG MANIA)
            const originalItem = findItemById(itemId);
            const category = getCategoryForItemId(itemId);
            const promotedItem = applyDailyPromotion(originalItem, category);
            basePrice = promotedItem.price;
            isFreeFriesEligible = Boolean(promotedItem.freeFries) && isFreeFriesPromotionActiveForCategory(category);
        }
        
        // Sumar precio de los toppings seleccionados
        let total = basePrice;
        
        document.querySelectorAll('.topping-checkbox:checked').forEach(checkbox => {
            total += parseFloat(checkbox.dataset.price);
        });
        
        // Sumar precio de papas si est치n seleccionadas
        if (addFriesCheckbox.checked) {
            total += isFreeFriesEligible ? 0 : FRIES_PRICE;
        }
        
        // Sumar precio de aros de cebolla si est치n seleccionados
        if (document.getElementById('add-onion-rings-checkbox').checked) {
            total += ONION_RINGS_PRICE;
        }
        
        // Sumar precio de extras del men칰 seleccionados
        document.querySelectorAll('.menu-extra-checkbox:checked').forEach(checkbox => {
            const itemId = checkbox.dataset.id;
            const quantity = parseInt(document.querySelector(`.quantity-display[data-id="${itemId}"]`)?.textContent || '1');
            total += parseFloat(checkbox.dataset.price) * quantity;
        });
        
        // Mostrar el precio total
        customModalTotal.textContent = `${total.toFixed(0)}`;
    }

    // Funciones para combos
    function getPremiumBurgerPrice() {
        const premium = findItemById(1);
        if (premium && typeof premium.price === 'number' && !Number.isNaN(premium.price)) return premium.price;

        const burgers = (menuData && Array.isArray(menuData['Hamburguesas'])) ? menuData['Hamburguesas'] : [];
        const first = burgers[0];
        if (first && typeof first.price === 'number' && !Number.isNaN(first.price)) return first.price;
        return 0;
    }

    function getBurgerPriceDiffText(burger) {
        const premiumPrice = getPremiumBurgerPrice();
        const burgerPrice = (burger && typeof burger.price === 'number') ? burger.price : premiumPrice;
        const diff = burgerPrice - premiumPrice;
        if (diff === 0) return 'Precio base';
        if (diff > 0) return `(+ ${diff.toFixed(0)})`;
        return `(- ${Math.abs(diff).toFixed(0)})`;
    }

    function getComboAvailableBurgerIds(combo) {
        const burgers = (menuData && Array.isArray(menuData['Hamburguesas'])) ? menuData['Hamburguesas'] : [];
        const ids = burgers
            .map(b => Number(b?.id))
            .filter(id => Number.isFinite(id));

        const filtered = (typeof isProductHidden === 'function')
            ? ids.filter(id => !isProductHidden(id))
            : ids;

        if (filtered.length > 0) return filtered;

        const fallback = Array.isArray(combo?.availableBurgers) ? combo.availableBurgers.map(Number).filter(Number.isFinite) : [];
        return fallback;
    }

    function openComboModal(comboId) {
        const combo = findItemById(comboId);
        if (!combo) return;

        const isBonelesCombo = /boneles/i.test(String(combo.name || ''));
        const burgerChoicesCount = Number.isFinite(Number(combo.burgerChoices))
            ? Number(combo.burgerChoices)
            : (isBonelesCombo ? 1 : 0);
        
        tempComboConfig = {
            baseCombo: combo,
            choices: [],
            includedFries: {
                type: 'Gajo', // Tipo por defecto
                size: (combo && Number(combo.id) === 14) ? 'Grandes' : 'Medianas'
            },
            boneles: isBonelesCombo ? { sauce: 'BBQ DULCE' } : null
        };
        
        comboModalTitle.textContent = `Configura tu ${combo.name}`;
        comboModalBody.innerHTML = '';

        // Guardar opciones disponibles (incluye hamburguesas agregadas desde Admin)
        tempComboConfig.availableBurgers = getComboAvailableBurgerIds(combo);
        const premiumPrice = getPremiumBurgerPrice();
        
        // A침adir hamburguesas al combo
        for (let i = 0; i < burgerChoicesCount; i++) {
            const preferredDefaultId = tempComboConfig.availableBurgers.includes(1)
                ? 1
                : (tempComboConfig.availableBurgers[0] ?? (combo.availableBurgers ? combo.availableBurgers[0] : 1));
            const defaultBurger = findItemById(preferredDefaultId)
                || findItemById(tempComboConfig.availableBurgers[0])
                || findItemById(combo.availableBurgers ? combo.availableBurgers[0] : preferredDefaultId)
                || ((Array.isArray(menuData?.['Hamburguesas']) ? menuData['Hamburguesas'] : [])[0])
                || { id: preferredDefaultId, name: 'Hamburguesa', price: premiumPrice, image: '' };
            
            tempComboConfig.choices[i] = {
                burger: defaultBurger,
                customizations: [],
                fries: null
            };
            
            const choiceHtml = `
                <div class="border rounded-lg p-4" data-choice-index="${i}">
                    <h4 class="font-bold text-lg mb-3">Hamburguesa ${i + 1}</h4>
                    <div class="burger-selector mb-4">
                        <div class="relative bg-gray-100 rounded-lg overflow-hidden">
                            ${(typeof window.__MANUAL_FAST_MODE !== 'undefined' && window.__MANUAL_FAST_MODE === true)
                                ? `<div class="w-full h-40 sm:h-48 md:h-52 bg-white rounded-lg"></div>`
                                : `<img id="burger-img-${i}" src="${defaultBurger.image}" alt="${defaultBurger.name}" class="w-full h-40 sm:h-48 md:h-52 object-contain bg-white rounded-lg" referrerpolicy="no-referrer" onerror="this.onerror=null;">`
                            }
                            <div class="absolute inset-0 flex items-center justify-between px-3">
                                <button class="prev-burger-btn bg-black/60 hover:bg-black/80 text-white rounded-full w-10 h-10 flex items-center justify-center transition-all duration-200 shadow-lg backdrop-blur-sm" data-choice-index="${i}">
                                    <i class="fas fa-chevron-left"></i>
                                </button>
                                <button class="next-burger-btn bg-black/60 hover:bg-black/80 text-white rounded-full w-10 h-10 flex items-center justify-center transition-all duration-200 shadow-lg backdrop-blur-sm" data-choice-index="${i}">
                                    <i class="fas fa-chevron-right"></i>
                                </button>
                            </div>
                        </div>
                        <div class="text-center mt-3">
                            <h5 id="burger-name-${i}" class="font-semibold text-lg text-gray-800">${defaultBurger.name}</h5>
                            <p id="burger-price-${i}" class="text-sm text-gray-600 font-medium">${getBurgerPriceDiffText(defaultBurger)}</p>
                        </div>
                    </div>
                    <div class="customizations-summary text-sm text-gray-600 mb-3 p-2 bg-gray-50 rounded">Sin personalizaci칩n.</div>
                    <button class="combo-customize-btn w-full text-sm bg-gray-200 hover:bg-gray-300 text-black py-2 px-4 rounded-md transition-colors duration-200">Personalizar</button>
                </div>
            `;
            
            comboModalBody.innerHTML += choiceHtml;
        }
        
        // A침adir hotdogs al combo (si aplica)
        if (combo.hotdogChoices && combo.availableHotdogs) {
            for (let i = 0; i < combo.hotdogChoices; i++) {
                const baseHotdogItem = findItemById(5);
                const baseHotdogPrice = baseHotdogItem && typeof baseHotdogItem.price === 'number' ? baseHotdogItem.price : 0;
                const defaultHotdog = findItemById(combo.availableHotdogs[0])
                    || findItemById(5)
                    || { id: combo.availableHotdogs[0], name: 'Hot Dog', price: baseHotdogPrice, image: '' };
                
                tempComboConfig.hotdogs = tempComboConfig.hotdogs || [];
                tempComboConfig.hotdogs[i] = {
                    hotdog: defaultHotdog,
                    customizations: [],
                    fries: null
                };
                
                const hotdogIndex = i;
                const choiceHtml = `
                    <div class="border rounded-lg p-4 mt-6" data-hotdog-index="${hotdogIndex}">
                        <h4 class="font-bold text-lg mb-3">Hot Dog ${hotdogIndex + 1}</h4>
                        <div class="hotdog-selector mb-4">
                            <div class="relative bg-gray-100 rounded-lg overflow-hidden">
                                ${(typeof window.__MANUAL_FAST_MODE !== 'undefined' && window.__MANUAL_FAST_MODE === true)
                                    ? `<div class="w-full h-40 sm:h-48 md:h-52 bg-white rounded-lg"></div>`
                                    : `<img id="hotdog-img-${hotdogIndex}" src="${defaultHotdog.image}" alt="${defaultHotdog.name}" class="w-full h-40 sm:h-48 md:h-52 object-contain bg-white rounded-lg" referrerpolicy="no-referrer" onerror="this.onerror=null;">`
                                }
                                <div class="absolute inset-0 flex items-center justify-between px-3">
                                    <button class="prev-hotdog-btn bg-black/60 hover:bg-black/80 text-white rounded-full w-10 h-10 flex items-center justify-center transition-all duration-200 shadow-lg backdrop-blur-sm" data-hotdog-index="${hotdogIndex}">
                                        <i class="fas fa-chevron-left"></i>
                                    </button>
                                    <button class="next-hotdog-btn bg-black/60 hover:bg-black/80 text-white rounded-full w-10 h-10 flex items-center justify-center transition-all duration-200 shadow-lg backdrop-blur-sm" data-hotdog-index="${hotdogIndex}">
                                        <i class="fas fa-chevron-right"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="text-center mt-3">
                                <h5 id="hotdog-name-${hotdogIndex}" class="font-semibold text-lg text-gray-800">${defaultHotdog.name}</h5>
                                <p id="hotdog-price-${hotdogIndex}" class="text-sm text-gray-600 font-medium">Precio base</p>
                            </div>
                        </div>
                        <div class="customizations-summary text-sm text-gray-600 mb-3 p-2 bg-gray-50 rounded">Sin personalizaci칩n.</div>
                        <button class="hotdog-customize-btn w-full text-sm bg-gray-200 hover:bg-gray-300 text-black py-2 px-4 rounded-md transition-colors duration-200" data-hotdog-index="${hotdogIndex}">Personalizar</button>
                    </div>
                `;
                
                comboModalBody.innerHTML += choiceHtml;
            }
        }

        // Combo Boneles: selecci칩n de salsa
        if (isBonelesCombo) {
            const sauceOptions = ['BBQ DULCE', 'BBQ PICANTE', 'RANCH PARMESANO'];
            const selectedSauce = (tempComboConfig.boneles && typeof tempComboConfig.boneles.sauce === 'string' && tempComboConfig.boneles.sauce.trim())
                ? tempComboConfig.boneles.sauce.trim()
                : 'BBQ DULCE';
            tempComboConfig.boneles = { sauce: selectedSauce };

            const saucesHtml = `
                <div class="border rounded-lg p-4 mt-6">
                    <h4 class="font-bold text-lg mb-2">Salsas (Boneles)</h4>
                    <p class="text-sm text-gray-600 mb-3">Elige 1 salsa:</p>
                    <div class="space-y-3">
                        ${sauceOptions.map((opt, idx) => {
                            const checked = (selectedSauce === opt) || (!selectedSauce && idx === 0);
                            return `
                                <label class="flex items-center cursor-pointer p-3 border rounded-lg hover:bg-gray-50 transition-all duration-200 ${checked ? 'bg-[#FFB300]/10 border-[#FFB300]' : ''}">
                                    <input type="radio" name="combo-boneles-sauce" value="${opt}" class="form-radio text-[#FFB300]" ${checked ? 'checked' : ''}>
                                    <span class="font-medium">${opt}</span>
                                </label>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
            comboModalBody.innerHTML += saucesHtml;
        }
        
        // A침adir selecci칩n de papas incluidas en el combo
        const isComboFamiliar = !!(tempComboConfig && tempComboConfig.baseCombo && tempComboConfig.baseCombo.id === 14);
        const friesTitle = isComboFamiliar
            ? 'Incluye: Papas Grandes, Aros de Cebolla Medianos y Coca-Cola 3L'
            : 'Papas Medianas Incluidas';
        const friesGajoLabel = isComboFamiliar ? 'Papas Gajo Grandes' : 'Papas Gajo Medianas';
        const friesFrancesasLabel = isComboFamiliar ? 'Papas a la Francesa Grandes' : 'Papas a la Francesa Medianas';

        const friesSelectionHtml = `
            <div class="border rounded-lg p-4 mt-6">
                <h4 class="font-bold text-lg mb-3">${friesTitle}</h4>
                <p class="text-sm text-gray-600 mb-3">Elige qu칠 tipo de papas quieres en tu combo:</p>
                <div class="space-y-3">
                    <label class="flex items-center cursor-pointer p-3 border rounded-lg hover:bg-gray-50 transition-all duration-200 bg-[#FFB300]/10 border-[#FFB300]">
                        <input type="radio" name="combo-fries-type" value="Gajo" class="form-radio text-[#FFB300]" checked>
                        <span class="font-medium">${friesGajoLabel}</span>
                    </label>
                    <label class="flex items-center cursor-pointer p-3 border rounded-lg hover:bg-gray-50 transition-all duration-200">
                        <input type="radio" name="combo-fries-type" value="Francesas" class="form-radio text-[#FFB300]">
                        <span class="font-medium">${friesFrancesasLabel}</span>
                    </label>
                </div>
            </div>
        `;
        
        comboModalBody.innerHTML += friesSelectionHtml;
        
        updateComboModalTotal();
        
        comboModal.classList.add('flex');
        comboModal.classList.remove('hidden');
    }

    function closeComboModal() {
        comboModal.classList.add('hidden');
        comboModal.classList.remove('flex');
    }

    function updateComboModalTotal() {
        let total = tempComboConfig.baseCombo.price;
        const clasicaPrice = getPremiumBurgerPrice();
        const baseHotdogItem = findItemById(5);
        const baseHotdogPrice = baseHotdogItem && typeof baseHotdogItem.price === 'number' ? baseHotdogItem.price : 0; // Precio base del Hotdog Jumbo
        
        // Calcular precio de las hamburguesas
        tempComboConfig.choices.forEach(choice => {
            const upgradeCost = choice.burger.price - clasicaPrice;
            total += upgradeCost;
            
            if (choice.customizations) {
                choice.customizations.forEach(cust => total += cust.price);
            }
            
            if (choice.fries) total += choice.fries.price;
            if (choice.onionRings) total += choice.onionRings.price;
            
            if (choice.menuExtras && choice.menuExtras.length > 0) {
                choice.menuExtras.forEach(extra => total += extra.price * extra.quantity);
            }
        });
        
        // Calcular precio de los hotdogs (si existen)
        if (tempComboConfig.hotdogs) {
            tempComboConfig.hotdogs.forEach(hotdogChoice => {
                const upgradeCost = hotdogChoice.hotdog.price - baseHotdogPrice;
                total += upgradeCost;
                
                if (hotdogChoice.customizations) {
                    hotdogChoice.customizations.forEach(cust => total += cust.price);
                }
                
                if (hotdogChoice.fries) total += hotdogChoice.fries.price;
                if (hotdogChoice.onionRings) total += hotdogChoice.onionRings.price;
                
                if (hotdogChoice.menuExtras && hotdogChoice.menuExtras.length > 0) {
                    hotdogChoice.menuExtras.forEach(extra => total += extra.price * extra.quantity);
                }
            });
        }
        
        comboModalTotal.textContent = `${total.toFixed(0)}`;
    }

    // Funci칩n para calcular el precio real de un combo basado en sus componentes
    function calculateComboRealPrice(combo) {
        let realPrice = 0;
        
        switch (combo.id) {
            case 26: // Combo Dobles Dobles: referencia de precio individual $300
                realPrice = 300;
                break;
            case 6: // Combo Pareja: 2 Hamburguesas + 1 Papas Medianas + 7 Aros de Cebolla
                realPrice = (100 * 2) + 60 + 45; // 2 Cl치sicas + Papas Medianas + Aros (7pz)
                break;
                
            case 15: // Combo D칰o: 1 Hamburguesa + 1 Hotdog + 1 Papas Medianas
                realPrice = 100 + 60 + 60; // Cl치sica + Hotdog + Papas Medianas
                break;
                
            case 7: // Combo Amigos: baseline de comparaci칩n anterior (ahorro visible)
                realPrice = 400; // Antes: 3 Cl치sicas + Papas Medianas + Coca 1.75L
                break;
                
            case 14: // Combo Familiar: 5 Hamburguesas + 1 Papas Grandes (Gajo o Francesas) + 1 Aros Grande + 1 Coca 3L
                realPrice = (100 * 5) + 120 + 80 + 60; // 5 Cl치sicas + Papas Grandes (120) + Aros Grandes + Coca 3L
                break;
                
            default:
                realPrice = combo.originalPrice || combo.price;
        }
        
        return realPrice;
    }

    function navigateBurger(choiceIndex, direction) {
        const combo = tempComboConfig.baseCombo;
        const availableBurgerIds = Array.isArray(tempComboConfig.availableBurgers) && tempComboConfig.availableBurgers.length
            ? tempComboConfig.availableBurgers
            : (Array.isArray(combo.availableBurgers) ? combo.availableBurgers : []);

        if (!Array.isArray(availableBurgerIds) || availableBurgerIds.length === 0) return;

        const currentId = Number(tempComboConfig.choices[choiceIndex].burger.id);
        const currentBurgerIndex = availableBurgerIds.map(Number).indexOf(currentId);
        
        let newIndex;
        if (direction === 'next') {
            const safeIndex = currentBurgerIndex >= 0 ? currentBurgerIndex : 0;
            newIndex = (safeIndex + 1) % availableBurgerIds.length;
        } else {
            const safeIndex = currentBurgerIndex >= 0 ? currentBurgerIndex : 0;
            newIndex = safeIndex === 0 ? availableBurgerIds.length - 1 : safeIndex - 1;
        }

        const newBurgerId = availableBurgerIds[newIndex];
        const newBurger = findItemById(newBurgerId);
        if (!newBurger) return;
        
        tempComboConfig.choices[choiceIndex].burger = newBurger;
        tempComboConfig.choices[choiceIndex].customizations = [];
        tempComboConfig.choices[choiceIndex].fries = null;
        tempComboConfig.choices[choiceIndex].onionRings = null;
        
        updateBurgerDisplay(choiceIndex, newBurger);
        
        const summaryEl = document.querySelector(`[data-choice-index="${choiceIndex}"] .customizations-summary`);
        summaryEl.textContent = 'Sin personalizaci칩n.';
        
        updateComboModalTotal();
    }

    function updateBurgerDisplay(choiceIndex, burger) {
        const priceText = getBurgerPriceDiffText(burger);
        
        document.getElementById(`burger-img-${choiceIndex}`).src = burger.image;
        document.getElementById(`burger-img-${choiceIndex}`).alt = burger.name;
        document.getElementById(`burger-name-${choiceIndex}`).textContent = burger.name;
        document.getElementById(`burger-price-${choiceIndex}`).textContent = priceText;
    }
    
    function navigateHotdog(hotdogIndex, direction) {
        const combo = tempComboConfig.baseCombo;
        const availableHotdogIds = Array.isArray(combo.availableHotdogs) ? combo.availableHotdogs : [];
        if (availableHotdogIds.length === 0) return;

        const currentId = Number(tempComboConfig.hotdogs?.[hotdogIndex]?.hotdog?.id);
        const currentHotdogIndex = availableHotdogIds.map(Number).indexOf(currentId);
        
        let newIndex;
        if (direction === 'next') {
            const safeIndex = currentHotdogIndex >= 0 ? currentHotdogIndex : 0;
            newIndex = (safeIndex + 1) % availableHotdogIds.length;
        } else {
            const safeIndex = currentHotdogIndex >= 0 ? currentHotdogIndex : 0;
            newIndex = safeIndex === 0 ? availableHotdogIds.length - 1 : safeIndex - 1;
        }
        
        const newHotdogId = availableHotdogIds[newIndex];
        const newHotdog = findItemById(newHotdogId);
        if (!newHotdog) return;
        
        tempComboConfig.hotdogs[hotdogIndex].hotdog = newHotdog;
        tempComboConfig.hotdogs[hotdogIndex].customizations = [];
        tempComboConfig.hotdogs[hotdogIndex].fries = null;
        tempComboConfig.hotdogs[hotdogIndex].onionRings = null;
        
        updateHotdogDisplay(hotdogIndex, newHotdog);
        
        const summaryEl = document.querySelector(`[data-hotdog-index="${hotdogIndex}"] .customizations-summary`);
        summaryEl.textContent = 'Sin personalizaci칩n.';
        
        updateComboModalTotal();
    }
    
    function updateHotdogDisplay(hotdogIndex, hotdog) {
        const baseHotdogPrice = findItemById(5).price; // Precio base del Hotdog Jumbo
        const priceDiff = hotdog.price - baseHotdogPrice;
        const priceText = priceDiff === 0
            ? 'Precio base'
            : (priceDiff > 0 ? `(+ ${priceDiff.toFixed(0)})` : `(- ${Math.abs(priceDiff).toFixed(0)})`);
        
        document.getElementById(`hotdog-img-${hotdogIndex}`).src = hotdog.image;
        document.getElementById(`hotdog-img-${hotdogIndex}`).alt = hotdog.name;
        document.getElementById(`hotdog-name-${hotdogIndex}`).textContent = hotdog.name;
        document.getElementById(`hotdog-price-${hotdogIndex}`).textContent = priceText;
    }

    // Funciones de carrito
    function addToCart(itemId) {
        const originalItem = findItemById(itemId);
        if (!originalItem) return;
        
        // Determinar la categor칤a del item
        let category = '';
        for (const cat in menuData) {
            if (menuData[cat].some(i => i.id === itemId)) {
                category = cat;
                break;
            }
        }
        
        // Aplicar promoci칩n diaria
        const item = applyDailyPromotion(originalItem, category);
        
        const cartItem = {
            id: Date.now(), // ID 칰nico para el carrito
            baseItem: item,
            price: item.price,
            quantity: 1,
            hasPromotion: item.hasPromotion || false,
            promotionText: item.promotionText || '',
            freeFries: item.freeFries || false,
            meatSupreme: item.meatSupreme || false
        };
        
        // Si la promo del d칤a incluye papas gratis, agregarlas al carrito
        if (item.freeFries && (category === 'Hamburguesas' || category === 'Hot Dogs')) {
            cartItem.freeFriesIncluded = {
                name: 'Papas Gajo Medianas',
                price: 0 // Gratis
            };
        }
        
        cart.push(cartItem);
        updateCart();
        openCart();
    }

    function openCart() {
        if (cartSidebar && cartOverlay) {
            cartSidebar.classList.remove('translate-x-full');
            cartOverlay.classList.remove('hidden');
        }
    }

    function updateCart() {
        const units = cart.reduce((sum, item) => sum + (Number(item.quantity) || 1), 0);
        const total = getCartTotal();
        cartCount.textContent = cart.length;
        cartTotal.textContent = `$${total.toFixed(0)}`;

        // Sticky cart (m칩vil)
        try {
            if (stickyCartItems) stickyCartItems.textContent = String(units);
            if (stickyCartTotal) stickyCartTotal.textContent = `$${total.toFixed(0)}`;
            const shouldShowSticky = units > 0;
            if (stickyCartBar) {
                stickyCartBar.classList.toggle('hidden', !shouldShowSticky);
            }
            document.body.classList.toggle('sr-sticky-cart-visible', shouldShowSticky);
        } catch (_) {}
        
        // Guardar carrito en localStorage
        localStorage.setItem('cart', JSON.stringify(cart));
        
        // Actualizar vista del carrito
        updateCartView();
    }

    function getCartTotal() {
        return cart.reduce((total, item) => total + item.price * item.quantity, 0);
    }

    function updateCartView() {
        // Preserve the empty-state node; updateCartView previously wiped it out.
        const preservedEmptyMsg = document.getElementById('cart-empty-msg') || cartEmptyMsg;
        cartItemsContainer.innerHTML = '';
        if (preservedEmptyMsg) {
            cartItemsContainer.appendChild(preservedEmptyMsg);
            cartEmptyMsg = preservedEmptyMsg;
        }
        
        if (cart.length === 0) {
            cartEmptyMsg.classList.remove('hidden');
            checkoutBtn.disabled = true;
            checkoutBtn.classList.add('bg-gray-400', 'cursor-not-allowed');
        } else {
            cartEmptyMsg.classList.add('hidden');
            checkoutBtn.disabled = false;
            checkoutBtn.classList.remove('bg-gray-400', 'cursor-not-allowed');
            
            cart.forEach(item => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'cart-item-card flex items-start p-3 bg-white rounded-xl border border-gray-100 shadow-sm mb-3';
                
                let itemName = item.baseItem.name;
                let customizationsText = '';
                
                if (item.isCombo) {
                    // Para combos, listar hamburguesas seleccionadas y papas incluidas
                    const burgerNames = item.choices.map(choice => choice.burger.name);
                    let comboDetails = burgerNames.join(', ');
                    
                    // A침adir hotdogs si existen
                    if (item.hotdogs && item.hotdogs.length > 0) {
                        const hotdogNames = item.hotdogs.map(hotdog => hotdog.hotdog.name);
                        comboDetails += ', ' + hotdogNames.join(', ');
                    }
                    
                    // A침adir informaci칩n de papas incluidas
                    if (item.includedFries) {
                        comboDetails += `, Papas ${item.includedFries.type} ${item.includedFries.size}`;
                    }

                    // A침adir salsas para Combo Boneles
                    if (item.boneles && typeof item.boneles.sauce === 'string' && item.boneles.sauce.trim()) {
                        comboDetails += `, Salsa: ${item.boneles.sauce.trim()}`;
                    }
                    
                    // A침adir extras espec칤ficos por combo
                    if (item.baseItem && Number(item.baseItem.id) === 14) {
                        // Combo Familiar incluye Aros Medianos y Coca-Cola 3L
                        comboDetails += `, Aros de Cebolla Medianos, Coca-Cola 3L`;
                    } else if (item.baseItem && Number(item.baseItem.id) === 6) {
                        // Combo Pareja incluye aros (7 pz)
                        comboDetails += `, Aros de Cebolla (7 pz)`;
                    }
                    
                    customizationsText = comboDetails;
                } else if (item.customizations && item.customizations.length > 0) {
                    // Para items personalizados, listar extras
                    const customizationNames = item.customizations.map(c => c.name);
                    customizationsText = `+ ${customizationNames.join(', ')}`;
                    
                    if (item.fries) {
                        customizationsText += `, Papas ${item.fries.type}`;
                    }
                    
                    if (item.onionRings) {
                        customizationsText += ', Aros de Cebolla';
                    }
                }
                
                // A침adir papas gratis si aplica
                if (item.freeFriesIncluded) {
                    if (customizationsText) customizationsText += ', ';
                    customizationsText += `游꿀 ${item.freeFriesIncluded.name} (GRATIS)`;
                }
                
                // Mostrar badge de promoci칩n si aplica
                let promotionBadge = '';
                if (item.hasPromotion) {
                    promotionBadge = '<span class="inline-block bg-red-500 text-white text-xs px-2 py-1 rounded-full ml-2 animate-pulse">游꿀 PROMO</span>';
                }
                
                itemDiv.innerHTML = `
                    <div class="cart-item-thumb flex-shrink-0 w-16 h-16 bg-gray-100 rounded-lg overflow-hidden ring-1 ring-gray-200">
                        ${item.baseItem && item.baseItem.image ? `<img src="${item.baseItem.image}" alt="${itemName}" class="w-full h-full object-cover" referrerpolicy="no-referrer" onerror="this.onerror=null;this.style.display='none';">` : ''}
                    </div>
                    <div class="ml-4 flex-grow">
                        <div class="flex justify-between items-start">
                            <h4 class="font-semibold text-gray-800 leading-tight">${itemName}${promotionBadge}</h4>
                            <button class="remove-item-btn text-gray-400 hover:text-red-500" data-id="${item.id}" aria-label="Eliminar">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                        ${customizationsText ? `<p class=\"text-xs text-gray-500 mt-1\">${customizationsText}</p>` : ''}
                        <div class="mt-2 flex items-center justify-between">
                            <div class="cart-qty-pill inline-flex items-center bg-gray-100 rounded-full overflow-hidden">
                                <button class="cart-qty-btn w-8 h-8 grid place-items-center text-gray-700 hover:bg-gray-200" data-id="${item.id}" data-action="decrease" aria-label="Disminuir"></button>
                                <span class="min-w-[2rem] text-center text-sm font-semibold">${item.quantity}</span>
                                <button class="cart-qty-btn w-8 h-8 grid place-items-center text-gray-700 hover:bg-gray-200" data-id="${item.id}" data-action="increase" aria-label="Aumentar">庸</button>
                            </div>
                            <span class="font-bold text-[#FFB300] text-lg">$${(item.price * item.quantity).toFixed(0)}</span>
                        </div>
                    </div>
                `;
                
                cartItemsContainer.appendChild(itemDiv);
            });
            
            // Event listeners para botones de cantidad y eliminar
            document.querySelectorAll('.cart-qty-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const id = parseInt(e.currentTarget.dataset.id);
                    const action = e.currentTarget.dataset.action;
                    const itemIndex = cart.findIndex(item => item.id === id);
                    
                    if (itemIndex !== -1) {
                        if (action === 'increase') {
                            cart[itemIndex].quantity++;
                        } else if (action === 'decrease') {
                            if (cart[itemIndex].quantity > 1) {
                                cart[itemIndex].quantity--;
                            }
                        }
                        updateCart();
                    }
                });
            });
            
            document.querySelectorAll('.remove-item-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const id = parseInt(e.currentTarget.dataset.id);
                    cart = cart.filter(item => item.id !== id);
                    updateCart();
                });
            });
        }
    }

    // Exponer funciones clave al 치mbito global para los onclick inline
    window.openCart = openCart;
    window.getCartTotal = getCartTotal;
    window.updateCart = updateCart;

    // Funciones de checkout
    function renderOrderSummary() {
        orderSummaryContainer.innerHTML = '<h4 class="font-semibold text-lg mb-3 flex items-center"><i class="fas fa-receipt mr-2 text-yellow-600"></i>Resumen de tu pedido:</h4>';

        const list = document.createElement('div');
        list.className = 'space-y-2';

        cart.forEach(item => {
            let customizationsText = '';
            if (item.isCombo) {
                const burgerList = item.choices.map(choice => {
                    let text = `${choice.burger.name}`;
                    if (choice.customizations && choice.customizations.length > 0) {
                        text += ` (+ ${choice.customizations.map(c => c.name).join(', ')})`;
                    }
                    return text;
                });
                if (item.hotdogs && item.hotdogs.length > 0) {
                    const hotdogList = item.hotdogs.map(hotdog => {
                        let text = `${hotdog.hotdog.name}`;
                        if (hotdog.customizations && hotdog.customizations.length > 0) {
                            text += ` (+ ${hotdog.customizations.map(c => c.name).join(', ')})`;
                        }
                        return text;
                    });
                    burgerList.push(...hotdogList);
                }
                // A침adir informaci칩n de papas incluidas
                if (item.includedFries) {
                    burgerList.push(`Papas ${item.includedFries.type} ${item.includedFries.size}`);
                }

                if (item.boneles && typeof item.boneles.sauce === 'string' && item.boneles.sauce.trim()) {
                    burgerList.push(`Salsa: ${item.boneles.sauce.trim()}`);
                }
                
                // A침adir extras espec칤ficos por combo
                if (item.baseItem && Number(item.baseItem.id) === 14) {
                    // Combo Familiar incluye Aros Medianos y Coca-Cola 3L
                    burgerList.push(`Aros de Cebolla Medianos`);
                    burgerList.push(`Coca-Cola 3L`);
                } else if (item.baseItem && Number(item.baseItem.id) === 6) {
                    // Combo Pareja incluye aros (7 pz)
                    burgerList.push(`Aros de Cebolla (7 pz)`);
                }
                customizationsText = burgerList.join('  ');
            } else {
                const extras = [];
                if (item.customizations && item.customizations.length > 0) extras.push(`${item.customizations.map(c => c.name).join(', ')}`);
                if (item.fries) extras.push(`Papas ${item.fries.type}`);
                if (item.onionRings) extras.push('Aros de Cebolla');
                if (item.freeFriesIncluded) extras.push(`${item.freeFriesIncluded.name} (GRATIS)`);
                customizationsText = extras.join('  ');
            }

            const priceHTML = item.isCombo
                ? (() => {
                    const realPrice = calculateComboRealPrice(item.baseItem);
                    const savings = realPrice - item.baseItem.price;
                    return `
                        <div class=\"text-right\">
                            <div class=\"text-[11px] text-gray-400 line-through\">$${realPrice.toFixed(0)}</div>
                            <div class=\"font-bold\">$${(item.price * item.quantity).toFixed(0)}</div>
                            <div class=\"text-[11px] text-green-600\">Ahorras $${(savings * item.quantity).toFixed(0)}</div>
                        </div>
                    `;
                })()
                : `<div class=\"font-bold text-right\">$${(item.price * item.quantity).toFixed(0)}</div>`;

            const itemRow = document.createElement('div');
            itemRow.className = 'order-summary-item flex items-start justify-between p-3 bg-white rounded-lg border border-gray-100 shadow-sm';
            itemRow.innerHTML = `
                <div class=\"flex items-start\">
                    ${item.baseItem && item.baseItem.image ? `<img src=\"${item.baseItem.image}\" alt=\"${item.baseItem.name}\" class=\"w-10 h-10 rounded-md object-cover mr-3\" referrerpolicy=\"no-referrer\" onerror=\"this.onerror=null;this.style.display='none';\">` : ''}
                    <div>
                        <div class=\"order-summary-title font-semibold text-sm\">${item.quantity}x ${item.baseItem.name}</div>
                        ${customizationsText ? `<div class=\"order-summary-meta mt-0.5 text-[12px]\">${customizationsText}</div>` : ''}
                    </div>
                </div>
                ${priceHTML}
            `;
            list.appendChild(itemRow);
        });

        // Totales
        const deliveryTypeValue = document.querySelector('input[name="delivery-type"]:checked').value;
        const pricing = computeCheckoutPricing(deliveryTypeValue);
        const subtotal = pricing.subtotal;
        const deliveryCost = pricing.deliveryFee;
        const total = pricing.total;

        const totals = document.createElement('div');
        totals.className = 'order-summary-totals mt-3 p-3 bg-gray-50 rounded-lg border';
        totals.innerHTML = `
            <div class=\"flex items-center justify-between text-sm text-gray-600\"><span>Subtotal:</span><span>$${subtotal.toFixed(0)}</span></div>
            ${pricing.discountAmount > 0 ? `<div class=\"flex items-center justify-between text-sm text-gray-600\"><span>Descuento${pricing.discountReason ? ` (${pricing.discountReason})` : ''}:</span><span>-$${pricing.discountAmount.toFixed(0)}</span></div>` : ''}
            <div class=\"flex items-center justify-between text-sm text-gray-600\"><span>Env칤o:</span><span>${deliveryTypeValue === 'delivery' ? (deliveryCost > 0 ? `+$${deliveryCost.toFixed(0)}` : 'Pendiente de cotizar') : 'Gratis'}</span></div>
            <div class=\"flex items-center justify-between font-bold text-lg mt-2 pt-2 border-t\"><span>Total:</span><span class=\"text-[#FFB300]\">$${total.toFixed(0)}</span></div>
        `;

        orderSummaryContainer.appendChild(list);
        orderSummaryContainer.appendChild(totals);
    }

    // Validaci칩n del formulario de checkout
    function validateCheckoutForm() {
        function setInlineError(inputEl, errorEl, message) {
            if (!inputEl || !errorEl) return;
            const hasError = !!message;
            errorEl.textContent = message || '';
            errorEl.classList.toggle('hidden', !hasError);

            inputEl.classList.toggle('border-red-400', hasError);
            inputEl.classList.toggle('focus:ring-red-300', hasError);
            inputEl.classList.toggle('focus:border-red-400', hasError);
        }

        // Obtener los valores relevantes
        const name = customerNameInput ? customerNameInput.value.trim() : '';
        const phone = customerPhoneInput ? customerPhoneInput.value.trim() : '';
        const deliveryTypeElement = document.querySelector('input[name="delivery-type"]:checked');
        const paymentMethodElement = document.querySelector('input[name="payment"]:checked');

        // Sesi칩n requerida para finalizar
        const isManualMode = (typeof window.__MANUAL_MODE !== 'undefined' && window.__MANUAL_MODE === true);
        let isLoggedIn = false;
        try {
            isLoggedIn = !!(
                (window.firebaseClientManager && typeof window.firebaseClientManager.getCurrentUser === 'function' && window.firebaseClientManager.getCurrentUser() && window.firebaseClientManager.getCurrentUser().uid) ||
                (window.firebaseAuth && window.firebaseAuth.currentUser && window.firebaseAuth.currentUser.uid)
            );
        } catch (_) {
            isLoggedIn = false;
        }
        if (isManualMode) isLoggedIn = true;
        
        if (!deliveryTypeElement || !paymentMethodElement) {
            return; // No se han seleccionado todas las opciones necesarias
        }
        
        const deliveryTypeValue = deliveryTypeElement.value;
        const paymentMethod = paymentMethodElement.value;

        const nameErrorEl = document.getElementById('customer-name-error');
        const phoneErrorEl = document.getElementById('customer-phone-error');
        const deliveryErrorEl = document.getElementById('delivery-address-error');
        const cashErrorEl = document.getElementById('cash-amount-error');
        const savedAddressSelect = document.getElementById('saved-address-select');

        // Validaci칩n del nombre y tel칠fono
        const nameValid = name.length > 0;
        // Validar tel칠fono: eliminar espacios, guiones y par칠ntesis, y verificar que tenga al menos 8 d칤gitos
        const phoneDigits = phone.replace(/[\s\-\(\)]/g, '');
        const phoneValid = phoneDigits.length >= 8;
        
        // Validaci칩n de direcci칩n s칩lo para entrega a domicilio
        // MODO MANUAL: detectar si estamos en pedido-manual.html
        let locationValid = true;
        
        if (deliveryTypeValue === 'delivery' && !isManualMode) {
            const selectEl = document.getElementById('saved-address-select');
            const selectedOk = !!(selectEl && selectEl.value && selectEl.value !== '__select__');
            const priceOk = !!(userAddress && typeof userAddress.deliveryPrice === 'number' && isFinite(userAddress.deliveryPrice));
            const addrOk = !!(userAddress && userAddress.formatted_address);
            locationValid = selectedOk && priceOk && addrOk;
        } else if (deliveryTypeValue === 'delivery' && isManualMode) {
            // MODO MANUAL: validar campos manuales
            const manualAddress = document.getElementById('manual-address')?.value.trim();
            locationValid = !!(manualAddress && manualAddress.length > 0);
        }
        
        // Validaci칩n de pago efectivo
        let paymentValid = true;
        if (paymentMethod === 'Efectivo') {
            const cashAmountInput = document.getElementById('cash-amount');
            const cashAmountValue = cashAmountInput.value.trim();
            
            // Si hay un valor ingresado y el campo NO est치 en foco (usuario termin칩 de escribir),
            // validar que sea suficiente
            if (cashAmountValue) {
                const cashAmount = parseFloat(cashAmountValue);
                const total = computeCheckoutPricing(deliveryTypeValue).total;
                // Usar una peque침a tolerancia para evitar problemas de precisi칩n con n칰meros flotantes
                paymentValid = !isNaN(cashAmount) && (cashAmount >= total || Math.abs(cashAmount - total) < 0.01);
            } else {
                // Si no hay valor y el campo no est치 en foco, marcar como inv치lido
                paymentValid = document.activeElement !== cashAmountInput;
            }
        }

        // Errores inline (m치s claros)
        setInlineError(customerNameInput, nameErrorEl, nameValid ? '' : 'Escribe tu nombre para identificar tu pedido.');
        setInlineError(customerPhoneInput, phoneErrorEl, phoneValid ? '' : 'Escribe un tel칠fono v치lido (m칤n. 8 d칤gitos).');

        if (deliveryTypeValue === 'delivery') {
            setInlineError(savedAddressSelect, deliveryErrorEl, locationValid ? '' : 'Selecciona una direcci칩n guardada (Mi cuenta).');
        } else {
            setInlineError(savedAddressSelect, deliveryErrorEl, '');
        }

        if (paymentMethod === 'Efectivo') {
            const cashAmountInput = document.getElementById('cash-amount');
            const cashAmountValue = cashAmountInput ? cashAmountInput.value.trim() : '';
            // Mostrar error en vivo si ya escribi칩 algo y es insuficiente
            let cashMsg = '';
            if (cashAmountInput) {
                if (cashAmountValue) {
                    cashMsg = paymentValid ? '' : 'El monto es insuficiente para cubrir el total.';
                } else if (document.activeElement !== cashAmountInput) {
                    cashMsg = paymentValid ? '' : 'Indica con cu치nto pagar치s para calcular el cambio.';
                }
            }
            setInlineError(cashAmountInput, cashErrorEl, cashMsg);
        } else {
            const cashAmountInput = document.getElementById('cash-amount');
            setInlineError(cashAmountInput, cashErrorEl, '');
        }
        
        // Mostrar mensajes de error relevantes
        const errorMsgId = 'checkout-validation-msg';
        let errorMsg = document.getElementById(errorMsgId);
        
        if (!errorMsg) {
            errorMsg = document.createElement('div');
            errorMsg.id = errorMsgId;
            errorMsg.className = 'bg-red-50 text-red-700 p-3 rounded-md mt-3 text-sm hidden';
            sendWhatsappBtn.parentNode.insertBefore(errorMsg, sendWhatsappBtn);
        }
        
        // Determinar qu칠 mensaje mostrar
        if (!isLoggedIn) {
            errorMsg.textContent = 'Debes iniciar sesi칩n (Mi cuenta) para finalizar tu compra.';
            errorMsg.classList.remove('hidden');
        } else if (!nameValid) {
            errorMsg.textContent = "Por favor ingresa tu nombre";
            errorMsg.classList.remove('hidden');
        } else if (!phoneValid) {
            errorMsg.textContent = "Por favor ingresa un n칰mero de tel칠fono v치lido";
            errorMsg.classList.remove('hidden');
        } else if (deliveryTypeValue === 'delivery' && !locationValid && !isManualMode) {
            errorMsg.textContent = "Por favor selecciona una direcci칩n guardada (Mi cuenta)";
            errorMsg.classList.remove('hidden');
        } else if (deliveryTypeValue === 'delivery' && !locationValid && isManualMode) {
            errorMsg.textContent = "Por favor ingresa la direcci칩n de entrega";
            errorMsg.classList.remove('hidden');
        } else if (paymentMethod === 'Efectivo' && !paymentValid && document.activeElement !== document.getElementById('cash-amount')) {
            errorMsg.textContent = "El monto de efectivo es insuficiente";
            errorMsg.classList.remove('hidden');
        } else {
            errorMsg.classList.add('hidden');
        }
        
        // Habilitar o deshabilitar bot칩n de WhatsApp
        const isFormValid = isLoggedIn && nameValid && phoneValid && locationValid && paymentValid;
        sendWhatsappBtn.disabled = !isFormValid;
    }

    // Nueva funci칩n para actualizar los totales del checkout
    function updateCheckoutTotals() {
        const subtotalElement = document.getElementById('checkout-subtotal');
        const deliveryFeeElement = document.getElementById('checkout-delivery-fee');
        const totalElement = document.getElementById('checkout-total');
        const discountRowEl = document.getElementById('checkout-discount-row');
        const discountLabelEl = document.getElementById('checkout-discount-label');
        const discountAmountEl = document.getElementById('checkout-discount-amount');
        const deliveryOptionFeeEl = document.getElementById('delivery-option-fee');
        const deliveryLiveInfoEl = document.getElementById('delivery-live-info');
        
        if (!subtotalElement || !totalElement) return;
        
        const deliveryTypeValue = document.querySelector('input[name="delivery-type"]:checked')?.value || 'pickup';
        const pricing = computeCheckoutPricing(deliveryTypeValue);
        const subtotal = pricing.subtotal;
        
        // Verificar si es entrega a domicilio
        const isDelivery = deliveryTypeValue === 'delivery';
        
        // Calcular fee de delivery
        let deliveryFee = pricing.deliveryFee;
        let deliveryText = '';
        
        if (isDelivery) {
            if (userAddress && userAddress.deliveryPrice !== undefined) {
                const kmToCharge = Math.floor(userAddress.distance || 0);
                if (pricing.reward && pricing.reward.freeDelivery && pricing.baseDeliveryFee > 0) {
                    deliveryText = `Env칤o (recompensa: env칤o gratis):`;
                } else {
                    deliveryText = `Env칤o (${(userAddress.distance || 0).toFixed(1)} km  ${kmToCharge} km x $${COSTO_POR_KM}):`;
                }
            } else if (deliveryCalcPending > 0) {
                deliveryFee = 0;
                deliveryText = 'Env칤o a domicilio (calculando...):';
            } else {
                deliveryFee = 0;
                deliveryText = 'Env칤o a domicilio (pendiente de cotizar):';
            }
        }
        
        const total = pricing.total;
        
        // Actualizar elementos
        subtotalElement.textContent = `$${subtotal.toFixed(0)}`;
        totalElement.textContent = `$${total.toFixed(0)}`;

        // Descuento (recompensa y/o cup칩n)
        try {
            if (discountRowEl && discountLabelEl && discountAmountEl) {
                if (pricing.discountAmount > 0) {
                    const label = pricing.discountReason
                        ? `Descuento (${pricing.discountReason}):`
                        : 'Descuento:';
                    discountLabelEl.textContent = label;
                    discountAmountEl.textContent = `-$${Number(pricing.discountAmount || 0).toFixed(0)}`;
                    discountRowEl.classList.remove('hidden');
                } else {
                    discountRowEl.classList.add('hidden');
                }
            }
        } catch (_) {}

        // Resumen fijo (footer): env칤o + total
        const stickyDeliveryEl = document.getElementById('checkout-sticky-delivery');
        const stickyTotalEl = document.getElementById('checkout-sticky-total');
        if (stickyTotalEl) stickyTotalEl.textContent = `$${total.toFixed(0)}`;
        if (stickyDeliveryEl) {
            if (!isDelivery) {
                stickyDeliveryEl.textContent = 'Gratis';
            } else if (userAddress && userAddress.deliveryPrice !== undefined) {
                if (pricing.reward && pricing.reward.freeDelivery && pricing.baseDeliveryFee > 0) {
                    stickyDeliveryEl.textContent = 'Gratis (recompensa)';
                } else {
                    stickyDeliveryEl.textContent = `+$${deliveryFee.toFixed(0)}`;
                }
            } else if (deliveryCalcPending > 0) {
                stickyDeliveryEl.textContent = 'Calculando';
            } else {
                stickyDeliveryEl.textContent = 'Pendiente';
            }
        }
        
        // Mostrar/ocultar fee de delivery
        if (deliveryFeeElement) {
            if (isDelivery) {
                const deliverySpan = deliveryFeeElement.querySelector('span:first-child');
                const priceSpan = deliveryFeeElement.querySelector('span:last-child');
                
                if (deliverySpan) deliverySpan.textContent = deliveryText;
                if (priceSpan) {
                    if (pricing.reward && pricing.reward.freeDelivery && pricing.baseDeliveryFee > 0) {
                        priceSpan.textContent = `+$0`;
                    } else {
                        priceSpan.textContent = `+$${deliveryFee.toFixed(0)}`;
                    }
                }
                
                deliveryFeeElement.classList.remove('hidden');
            } else {
                deliveryFeeElement.classList.add('hidden');
            }
        }

        // Info visible (km/costo/tiempo) al finalizar el pedido
        if (deliveryLiveInfoEl) {
            if (!isDelivery) {
                deliveryLiveInfoEl.classList.add('hidden');
                deliveryLiveInfoEl.innerHTML = '';
            } else if (userAddress && userAddress.deliveryPrice !== undefined) {
                const km = Number(userAddress.distance || 0);
                const kmToCharge = Math.floor(km);
                const fee = Number(deliveryFee || 0);
                const modeText = (userAddress.distanceSource === 'driving')
                    ? ' (ruta en carro)'
                    : '';
                const eta = (typeof userAddress.durationMin === 'number' && isFinite(userAddress.durationMin) && userAddress.durationMin > 0)
                    ? `  Tiempo aprox: <strong>${userAddress.durationMin} min</strong>`
                    : '';

                const rewardLine = (pricing.rewardApplied && pricing.reward && pricing.reward.label)
                    ? `<br><i class=\"fas fa-tag mr-1 text-green-600\"></i>Recompensa aplicada: <strong>${pricing.reward.label}</strong>${pricing.rewardDiscountAmount > 0 ? `  Descuento: <strong>-$${pricing.rewardDiscountAmount.toFixed(0)}</strong>` : ''}`
                    : (pricing.reward && pricing.reward.label)
                        ? `<br><i class=\"fas fa-tag mr-1 text-green-600\"></i>Recompensa activa: <strong>${pricing.reward.label}</strong>${pricing.reward.freeDelivery ? ' (solo a domicilio)' : ''}`
                        : '';

                const couponLine = (pricing.discountCode)
                    ? `<br><i class=\"fas fa-tag mr-1 text-emerald-500\"></i>C칩digo aplicado: <strong>${pricing.discountCode}</strong>${pricing.discountCodeAmount > 0 ? `  Descuento: <strong>-$${pricing.discountCodeAmount.toFixed(0)}</strong>` : ''}`
                    : '';
                deliveryLiveInfoEl.innerHTML = `
                    <i class="fas fa-route mr-1 text-blue-600"></i>
                    Distancia: <strong>${km.toFixed(1)} km</strong>${modeText}  Env칤o: <strong>$${fee.toFixed(0)}</strong>${(pricing.reward && pricing.reward.freeDelivery && pricing.baseDeliveryFee > 0) ? ' (gratis con recompensa)' : ` (${kmToCharge} km x $${COSTO_POR_KM})`}${eta}
                    ${rewardLine}${couponLine}
                `;
                deliveryLiveInfoEl.classList.remove('hidden');
            } else if (deliveryCalcPending > 0) {
                deliveryLiveInfoEl.innerHTML = `
                    <i class="fas fa-route mr-1 text-blue-600"></i>
                    Calculando ruta y costo del env칤o...
                `;
                deliveryLiveInfoEl.classList.remove('hidden');
            } else {
                // Sin CTA: ocultar el bloque hasta que haya costo o c치lculo en progreso
                deliveryLiveInfoEl.classList.add('hidden');
                deliveryLiveInfoEl.innerHTML = '';
            }
        }

        // Actualizar etiqueta del radio "Env칤o a domicilio" (quitar "base" fijo)
        if (deliveryOptionFeeEl) {
            if (isDelivery) {
                if (userAddress && userAddress.deliveryPrice !== undefined) {
                    const kmToCharge = Math.floor(userAddress.distance || 0);
                    if (pricing.reward && pricing.reward.freeDelivery && pricing.baseDeliveryFee > 0) {
                        deliveryOptionFeeEl.textContent = `Gratis (recompensa)`;
                    } else {
                        deliveryOptionFeeEl.textContent = `$${deliveryFee.toFixed(0)} (${kmToCharge} km x $${COSTO_POR_KM})`;
                    }
                } else if (deliveryCalcPending > 0) {
                    deliveryOptionFeeEl.textContent = 'Calculando...';
                } else {
                    deliveryOptionFeeEl.textContent = '';
                }
            } else {
                // Cuando no est치 seleccionado env칤o a domicilio, no mostrar cifra aqu칤 para evitar confusi칩n
                deliveryOptionFeeEl.textContent = '';
            }
        }
        
        // Recalcular cambio si est치 en modo efectivo
        calculateChange();
    }

    // Exponer implementaci칩n para funciones fuera de este scope
    try { window.__sr_updateCheckoutTotals = updateCheckoutTotals; } catch (_) {}

    // Nueva funci칩n para calcular el cambio
    function calculateChange() {
        const cashAmountInput = document.getElementById('cash-amount');
        const changeDisplay = document.getElementById('change-display');
        const changeAmount = document.getElementById('change-amount');
        const insufficientCash = document.getElementById('insufficient-cash');
        
        if (!cashAmountInput || !changeDisplay || !changeAmount) return;
        
        // Solo calcular si el m칠todo de pago es efectivo
        const paymentMethod = document.querySelector('input[name="payment"]:checked');
        if (!paymentMethod || paymentMethod.value !== 'Efectivo') {
            changeDisplay.classList.add('hidden');
            if (insufficientCash) insufficientCash.classList.add('hidden');
            return;
        }
        
        const cashValue = parseFloat(cashAmountInput.value) || 0;
        
        if (cashValue <= 0) {
            changeDisplay.classList.add('hidden');
            if (insufficientCash) insufficientCash.classList.add('hidden');
            return;
        }
        
        // Calcular total actual
        const deliveryType = document.querySelector('input[name="delivery-type"]:checked');
        const deliveryTypeValue = deliveryType && deliveryType.value ? deliveryType.value : 'pickup';
        const total = computeCheckoutPricing(deliveryTypeValue).total;
        
        if (cashValue >= total) {
            // Suficiente dinero - mostrar cambio
            const change = cashValue - total;
            changeAmount.textContent = `$${change.toFixed(0)}`;
            changeDisplay.classList.remove('hidden');
            if (insufficientCash) insufficientCash.classList.add('hidden');
        } else {
            // Dinero insuficiente - mostrar advertencia
            changeDisplay.classList.add('hidden');
            if (insufficientCash) insufficientCash.classList.remove('hidden');
        }
    }

    // Nueva funci칩n para manejar cambio de m칠todo de pago
    function handlePaymentMethodChange() {
        const cashContainer = document.getElementById('cash-amount-container');
        const paymentMethod = document.querySelector('input[name="payment"]:checked');
        
        if (!cashContainer || !paymentMethod) return;
        
        if (paymentMethod.value === 'Efectivo') {
            cashContainer.style.display = 'block';
            calculateChange();
        } else {
            cashContainer.style.display = 'none';
            // Limpiar displays de cambio
            const changeDisplay = document.getElementById('change-display');
            const insufficientCash = document.getElementById('insufficient-cash');
            if (changeDisplay) changeDisplay.classList.add('hidden');
            if (insufficientCash) insufficientCash.classList.add('hidden');
        }
    }

    function generateWhatsAppMessage(pricingOverride) {
        const customerName = customerNameInput ? customerNameInput.value.trim() : '';
        const customerPhone = customerPhoneInput ? customerPhoneInput.value.trim() : '';
        const deliveryTypeElement = document.querySelector('input[name="delivery-type"]:checked');
        const paymentMethodElement = document.querySelector('input[name="payment"]:checked');
        
        if (!deliveryTypeElement || !paymentMethodElement) {
            return 'Error: Faltan datos del formulario';
        }
        
        const deliveryTypeValue = deliveryTypeElement.value;
        const paymentMethod = paymentMethodElement.value;
        
        let address = '';
        let addressDetails = '';
        if (deliveryTypeValue === 'delivery') {
            // MODO MANUAL: usar direcci칩n manual si est치 disponible
            const isManualMode = (typeof window.__MANUAL_MODE !== 'undefined' && window.__MANUAL_MODE === true);
            
            if (isManualMode) {
                const manualAddressEl = document.getElementById('manual-address');
                address = manualAddressEl ? manualAddressEl.value.trim() : '';
                
                if (!address) {
                    address = '';
                    addressDetails += '\n丘멆잺 *Falta ingresar direcci칩n*';
                }
                // No hay coordenadas en modo manual, por lo que no generamos link de mapa
            } else {
                // Modo normal: usar direcci칩n guardada
                address = (userAddress && userAddress.formatted_address)
                    ? String(userAddress.formatted_address)
                    : '';

                // Link clickeable a la direcci칩n (Google Maps)
                try {
                    let mapsUrl = '';
                    if (userAddress && userAddress.coordinates && isFinite(userAddress.coordinates.lat) && isFinite(userAddress.coordinates.lng)) {
                        const lat = Number(userAddress.coordinates.lat).toFixed(6);
                        const lng = Number(userAddress.coordinates.lng).toFixed(6);
                        mapsUrl = `https://www.google.com/maps?q=${encodeURIComponent(lat + ',' + lng)}`;
                    } else if (address) {
                        mapsUrl = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(address)}`;
                    }
                    if (mapsUrl) {
                        addressDetails += `\n游딬勇 Ver en mapa:\n${mapsUrl}`;
                    }
                } catch (_) {}

                // Si no hay direcci칩n guardada, avisar (esto no deber칤a pasar si el formulario est치 validado)
                if (!address) {
                    address = '';
                    addressDetails += '\n丘멆잺 *Falta seleccionar direcci칩n en Mi cuenta*';
                }
            }
        }
        
        let cashAmount = '';
        if (paymentMethod === 'Efectivo') {
            const cashAmountInput = document.getElementById('cash-amount').value.trim();
            if (cashAmountInput) {
                cashAmount = parseFloat(cashAmountInput).toFixed(2);
            }
        }
        
        // Calcular totales (y puntos) para el mensaje
        const pricing = pricingOverride || computeCheckoutPricing(deliveryTypeValue);
        const subtotal = pricing.subtotal;
        const total = pricing.total;
        const pointsEarned = Math.max(0, Math.floor(Number(total || 0) / 10)); // 1 punto por cada $10 MXN

        // Detectar si hay sesi칩n para acreditar puntos
        let isLoggedIn = false;
        try {
            if (window.firebaseClientManager && typeof window.firebaseClientManager.getCurrentUser === 'function') {
                const u = window.firebaseClientManager.getCurrentUser();
                isLoggedIn = !!(u && u.uid);
            } else if (window.firebaseAuth && window.firebaseAuth.currentUser) {
                isLoggedIn = !!window.firebaseAuth.currentUser.uid;
            }
        } catch (_) {
            isLoggedIn = false;
        }

        const deliveryLabel = deliveryTypeValue === 'delivery' ? '游뚴 A domicilio' : '游낅 Recoger en local';
        const paymentLabel = paymentMethod === 'Efectivo' ? '游눳 Efectivo' : `游눱 ${paymentMethod}`;

        // Construir el mensaje (m치s agradable)
        let message = `*游꼢 SR & SRA BURGER*\n`;
        message += `*Pedido nuevo*\n\n`;
        message += `Hola, soy *${customerName}* 游녦\n`;
        message += `游 *Tel:* ${customerPhone}\n`;
        message += `\n*Entrega:* ${deliveryLabel}\n`;
        if (deliveryTypeValue === 'delivery') {
            message += `游늸 *Direcci칩n:* ${address}${addressDetails}\n`;
        }
        message += `*Pago:* ${paymentLabel}\n`;

        if (paymentMethod === 'Efectivo' && cashAmount) {
            const change = parseFloat(cashAmount) - total;
            message += `*Pagar치 con:* $${Number(cashAmount).toFixed(0)}\n`;
            message += `*Cambio:* $${change.toFixed(0)}\n`;
        }

        if (pricing.reward && pricing.reward.label) {
            if (pricing.rewardApplied) {
                message += `\n游낑勇 *Recompensa aplicada:* ${pricing.reward.label}`;
                if (pricing.rewardDiscountAmount > 0) {
                    message += ` (ahorro -$${pricing.rewardDiscountAmount.toFixed(0)})`;
                }
                message += `\n`;
            } else if (pricing.reward.freeDelivery && deliveryTypeValue !== 'delivery') {
                message += `\n游낑勇 *Recompensa activa:* ${pricing.reward.label} (se aplica solo a domicilio)\n`;
            }
        }

        if (pricing.discountCode) {
            message += `\n游낑勇 *C칩digo aplicado:* ${pricing.discountCode}`;
            if (pricing.discountCodeAmount > 0) {
                message += ` (ahorro -$${pricing.discountCodeAmount.toFixed(0)})`;
            }
            message += `\n`;
        }

        if (pointsEarned > 0) {
            message += `\n游꾸 *Puntos ganados:* ${pointsEarned}${isLoggedIn ? '' : ' (requiere iniciar sesi칩n)'}\n`;
        }

        message += `\n*游 Detalle del pedido:*\n`;
        
        cart.forEach(item => {
            message += `\n ${item.quantity}x ${ item.baseItem.name} - $${(item.price * item.quantity).toFixed(2)}\n`;
            
            if (item.isCombo) {
                // Detalles de hamburguesas en combo
                message += item.choices.map(choice => {
                    let text = `   ${choice.burger.name}`;
                    if (choice.customizations && choice.customizations.length > 0) {
                        text += ` (+ ${choice.customizations.map(c => c.name).join(', ')})`;
                    }
                    if (choice.fries) {
                        text += `, Papas ${choice.fries.type}`;
                    }
                    if (choice.onionRings) {
                        text += `, Aros de Cebolla`;
                    }
                    if (choice.specifications) {
                        text += `, Nota: ${choice.specifications}`;
                    }
                    return text;
                }).join('\n');

                // Papas incluidas del combo
                if (item.includedFries && item.includedFries.type && item.includedFries.size) {
                    message += `\n   Papas incluidas: ${item.includedFries.type} ${item.includedFries.size}`;
                }

                // Salsa de Combo Boneles (compat: formato nuevo/antiguo)
                const bonelesSauce = (item.boneles && typeof item.boneles.sauce === 'string' && item.boneles.sauce.trim())
                    ? item.boneles.sauce.trim()
                    : (item.boneles && Array.isArray(item.boneles.sauces) && item.boneles.sauces.length ? String(item.boneles.sauces[0] || '').trim() : '');
                if (bonelesSauce) {
                    message += `\n   Salsa: ${bonelesSauce}`;
                }

                message += '\n';
            } else if (item.customizations && item.customizations.length > 0) {
                // Detalles de personalizaciones
                message += `   Con: ${item.customizations.map(c => c.name).join(', ')}\n`;
            }
            
            if (!item.isCombo && item.fries) {
                message += `   Con Papas ${item.fries.type}\n`;
            }
            
            if (!item.isCombo && item.onionRings) {
                message += `   Con Aros de Cebolla\n`;
            }
            
            if (item.menuExtras && item.menuExtras.length > 0) {
                item.menuExtras.forEach(extra => {
                    message += `   ${extra.quantity}x ${extra.name}\n`;
                });
            }

            if (!item.isCombo && item.specifications) {
                message += `   Nota: ${item.specifications}\n`;
            }
        });
        
        // Totales
        message += `\n*Subtotal:* $${subtotal.toFixed(0)}`;
        if (pricing.discountAmount > 0) {
            const label = pricing.discountReason ? `Descuento (${pricing.discountReason})` : 'Descuento';
            message += `\n*${label}:* -$${pricing.discountAmount.toFixed(0)}`;
        }
        message += `\n*Env칤o:* ${deliveryTypeValue === 'delivery' ? (pricing.deliveryFee > 0 ? `$${pricing.deliveryFee.toFixed(0)}` : (pricing.reward && pricing.reward.freeDelivery && pricing.baseDeliveryFee > 0 ? 'Gratis (recompensa)' : 'Pendiente de cotizar')) : 'Gratis'}`;
        message += `\n*TOTAL:* $${total.toFixed(0)}`;

        message += `\n\n九 *Espera nuestra confirmaci칩n en breve de recibido.*`;
        message += `\nGracias 游똂`;
        
        return message;
    }

    // Guardar y cargar datos
    function loadCustomerData() {
        // 1) Rellenar desde sesi칩n de Firebase si existe
        try {
            if (window.firebaseClientManager && typeof window.firebaseClientManager.getClient === 'function') {
                const manager = window.firebaseClientManager;
                manager.getClient().then(function(cliente) {
                    if (!cliente) return;

                    try { setActiveRewardState(cliente.activeReward || null); } catch (_) {}

                    const phoneFromProfile = (cliente.telefono || cliente.phone || cliente.celular || '');

                    if (customerNameInput && !customerNameInput.dataset.userEdited && !customerNameInput.value) {
                        customerNameInput.value = cliente.nombre || '';
                    }
                    // Si hay sesi칩n iniciada, priorizar el tel칠fono del perfil (evita que localStorage 랂ane)
                    if (customerPhoneInput && !customerPhoneInput.dataset.userEdited && phoneFromProfile) {
                        customerPhoneInput.value = phoneFromProfile;
                        try { localStorage.setItem('customerPhone', phoneFromProfile); } catch (_) {}
                    }

                    // Direcci칩n para env칤o a domicilio
                    var d = cliente.direccion || {};
                    var direccionTexto = (d.formatted || '').trim() || [d.calle, d.numero, d.colonia].filter(Boolean).join(' ');
                    var addressInput = document.getElementById('address-input');
                    if (addressInput && !addressInput.value && direccionTexto) {
                        addressInput.value = direccionTexto;
                    }

                    // Si el perfil ya tiene coords, pre-cargar selectedPlace y disparar c치lculo
                    try {
                        var latNum = d.lat != null ? Number(d.lat) : null;
                        var lngNum = d.lng != null ? Number(d.lng) : null;
                        if (Number.isFinite(latNum) && Number.isFinite(lngNum)) {
                            window.selectedPlace = {
                                formatted_address: direccionTexto || (addressInput ? addressInput.value : ''),
                                geometry: {
                                    location: {
                                        lat: latNum,
                                        lng: lngNum
                                    }
                                }
                            };
                            selectedPlace = window.selectedPlace;
                            if (typeof displaySelectedAddress === 'function') {
                                displaySelectedAddress(window.selectedPlace);
                            }
                            if (typeof validateAddressZone === 'function') {
                                validateAddressZone(window.selectedPlace);
                            }
                        }
                    } catch (_) {}
                }).catch(function(e) {
                    console.warn('No se pudo cargar datos del cliente desde Firebase:', e);
                });
            }
        } catch (e) {
            console.warn('Error leyendo datos de sesi칩n del cliente:', e);
        }

        // 2) Fallback: tel칠fono almacenado en localStorage
        const savedPhone = localStorage.getItem('customerPhone');
        if (savedPhone && customerPhoneInput && !customerPhoneInput.dataset.userEdited && !customerPhoneInput.value) {
            customerPhoneInput.value = savedPhone;
        }
    }

    // Modal CTA de registro: solo para usuarios SIN sesi칩n iniciada
    let registerCtaDismissed = false;
    function updateRegisterCtaModalVisibility(authUser) {
        const modal = document.getElementById('register-cta-modal');
        if (!modal) return;

        let isLoggedIn = false;

        // Si nos pasan el usuario desde onAuthChange, 칰salo como fuente de verdad
        if (authUser !== undefined) {
            isLoggedIn = !!(authUser && authUser.uid);
        } else {
            // Fallback: intenta detectar sesi칩n actual
            try {
                if (window.firebaseClientManager && typeof window.firebaseClientManager.getCurrentUser === 'function') {
                    const u = window.firebaseClientManager.getCurrentUser();
                    isLoggedIn = !!(u && u.uid);
                } else if (window.firebaseAuth && window.firebaseAuth.currentUser) {
                    isLoggedIn = !!window.firebaseAuth.currentUser.uid;
                }
            } catch (_) {
                isLoggedIn = false;
            }
        }

        // Mostrar solo si NO hay sesi칩n y no fue cerrado en esta vista
        const shouldShow = !isLoggedIn && !registerCtaDismissed;
        modal.classList.toggle('hidden', !shouldShow);
        modal.classList.toggle('flex', shouldShow);
    }

    // Configurar auto-completado basado en Firebase Auth (escucha cambios de sesi칩n)
    function setupFirebaseCustomerAutofill() {
        function applyFromCliente(cliente) {
            if (!cliente) return;
            try {
                try { setActiveRewardState(cliente.activeReward || null); } catch (_) {}
                const phoneFromProfile = (cliente.telefono || cliente.phone || cliente.celular || '');
                if (customerNameInput && !customerNameInput.value) {
                    customerNameInput.value = cliente.nombre || cliente.correo || '';
                }
                // Si el usuario no lo edit칩 manualmente, mantener sincronizado con el perfil
                if (customerPhoneInput && !customerPhoneInput.dataset.userEdited && phoneFromProfile) {
                    customerPhoneInput.value = phoneFromProfile;
                    try { localStorage.setItem('customerPhone', phoneFromProfile); } catch (_) {}
                }

                var d = cliente.direccion || {};
                var direccionTexto = (d.formatted || '').trim() || [d.calle, d.numero, d.colonia].filter(Boolean).join(' ');
                var addressInput = document.getElementById('address-input');
                if (addressInput && !addressInput.value && direccionTexto && !addressInput.dataset.userEdited) {
                    addressInput.value = direccionTexto;
                }

                // Si hay coords guardadas, pre-cargar selectedPlace y disparar c치lculo
                try {
                    var latNum = d.lat != null ? Number(d.lat) : null;
                    var lngNum = d.lng != null ? Number(d.lng) : null;
                    if (Number.isFinite(latNum) && Number.isFinite(lngNum)) {
                        window.selectedPlace = {
                            formatted_address: direccionTexto || (addressInput ? addressInput.value : ''),
                            geometry: {
                                location: {
                                    lat: latNum,
                                    lng: lngNum
                                }
                            }
                        };
                        selectedPlace = window.selectedPlace;
                        if (typeof displaySelectedAddress === 'function') {
                            displaySelectedAddress(window.selectedPlace);
                        }
                        if (typeof validateAddressZone === 'function') {
                            validateAddressZone(window.selectedPlace);
                        }
                    }
                } catch (_) {}
            } catch (e) {
                console.warn('No se pudo aplicar datos de cliente al formulario:', e);
            }
        }

        function initWithManager(manager) {
            try {
                try { updateRegisterCtaModalVisibility(manager.getCurrentUser ? manager.getCurrentUser() : undefined); } catch (_) { updateRegisterCtaModalVisibility(); }

                // Intento inicial
                manager.getClient().then(applyFromCliente).catch(function(e) {
                    console.warn('No se pudo obtener cliente inicial:', e);
                });

                // Escuchar cambios de sesi칩n (por si inicia/cierra sesi칩n en otra pesta침a)
                if (typeof manager.onAuthChange === 'function') {
                    manager.onAuthChange(function(user) {
                        try { updateRegisterCtaModalVisibility(user); } catch (_) {}
                        if (user) {
                            manager.getClient(user.uid).then(applyFromCliente).catch(function(e) {
                                console.warn('No se pudo obtener cliente al cambiar sesi칩n:', e);
                            });
                        }
                    });
                }
            } catch (e) {
                console.warn('Error configurando auto-completado de cliente:', e);
            }
        }

        function waitForManager(tries) {
            tries = tries || 0;
            if (window.firebaseClientManager) {
                initWithManager(window.firebaseClientManager);
            } else if (tries < 50) {
                setTimeout(function() { waitForManager(tries + 1); }, 150);
            }
        }

        waitForManager(0);
    }

    // --- Direcciones guardadas en carrito (selector) ---
    const SAVED_ADDRESS_STORAGE_KEY = 'sr_saved_address_selection_v1';

    function getSavedSelection() {
        try {
            const raw = localStorage.getItem(SAVED_ADDRESS_STORAGE_KEY);
            return raw ? JSON.parse(raw) : null;
        } catch (_) {
            return null;
        }
    }

    function setSavedSelection(obj) {
        try {
            if (!obj) {
                localStorage.removeItem(SAVED_ADDRESS_STORAGE_KEY);
            } else {
                localStorage.setItem(SAVED_ADDRESS_STORAGE_KEY, JSON.stringify(obj));
            }
        } catch (_) {}
    }

    function buildAddressOptions(cliente) {
        const out = [];
        out.push({ value: '__select__', label: 'Selecciona una direcci칩n', disabled: true });

        function hasSavedDeliveryMeta(obj) {
            if (!obj) return false;
            const price = obj.deliveryPrice != null ? Number(obj.deliveryPrice) : null;
            const km = obj.distanceKm != null ? Number(obj.distanceKm) : null;
            return Number.isFinite(price) && Number.isFinite(km);
        }

        // Direcci칩n principal (si existe y ya tiene costo guardado)
        const d = (cliente && cliente.direccion) || {};
        const formattedPrimary = (d.formatted || '').trim() || [d.calle, d.numero, d.colonia].filter(Boolean).join(' ');
        if (formattedPrimary && hasSavedDeliveryMeta(d)) {
            out.push({ value: '__primary__', label: `Direcci칩n principal: ${formattedPrimary}` });
        }

        const list = Array.isArray(cliente && cliente.direcciones) ? cliente.direcciones.slice() : [];
        // Mostrar las m치s recientes primero
        list.sort((a, b) => Number(b && b.createdAtMs || 0) - Number(a && a.createdAtMs || 0));
        list.forEach((entry) => {
            if (!entry) return;
            const formatted = (entry.formatted || '').trim();
            if (!formatted) return;
            const id = entry.id ? String(entry.id) : '';
            if (!id) return;
            if (!hasSavedDeliveryMeta(entry)) return;
            out.push({ value: `addr:${id}`, label: formatted, entry });
        });
        return out;
    }

    async function applyAddressSelection(choice, cliente) {
        // En checkout ya no se escribe direcci칩n ni se calcula aqu칤.
        // Solo se permite usar direcciones guardadas con costo.
        userAddress = null;
        updateCheckoutTotals();

        if (!choice || choice === '__select__') {
            setSavedSelection(null);
            try { displaySelectedAddress({ formatted_address: '' }); } catch (_) {}
            return;
        }

        // Direcci칩n principal
        if (choice === '__primary__') {
            const d = (cliente && cliente.direccion) || {};
            const formatted = (d.formatted || '').trim() || [d.calle, d.numero, d.colonia].filter(Boolean).join(' ');
            const lat = d.lat != null ? Number(d.lat) : null;
            const lng = d.lng != null ? Number(d.lng) : null;
            setSavedSelection({ type: 'primary' });

            const savedDeliveryPrice = d.deliveryPrice != null ? Number(d.deliveryPrice) : null;
            const savedDistanceKm = d.distanceKm != null ? Number(d.distanceKm) : null;
            const savedDurationMin = d.durationMin != null ? Number(d.durationMin) : null;
            if (!Number.isFinite(savedDeliveryPrice) || !Number.isFinite(savedDistanceKm) || !formatted) return;

            userAddress = {
                formatted_address: formatted,
                distance: savedDistanceKm,
                deliveryPrice: savedDeliveryPrice,
                zone: `Env칤o a $${COSTO_POR_KM}/km`,
                coordinates: (Number.isFinite(lat) && Number.isFinite(lng)) ? { lat, lng } : null,
                durationMin: Number.isFinite(savedDurationMin) ? savedDurationMin : null,
                distanceSource: 'firebase'
            };
            try { displaySelectedAddress({ formatted_address: formatted }); } catch (_) {}
            updateCheckoutTotals();

            try {
                const payload = {
                    formatted_address: userAddress.formatted_address,
                    lat: userAddress.coordinates ? userAddress.coordinates.lat : null,
                    lng: userAddress.coordinates ? userAddress.coordinates.lng : null,
                    distance: savedDistanceKm,
                    deliveryPrice: savedDeliveryPrice,
                    savedAt: Date.now()
                };
                localStorage.setItem('clientDeliveryInfo', JSON.stringify(payload));
            } catch (_) {}
            return;
        }

        // Direcci칩n guardada espec칤fica
        if (choice.startsWith('addr:')) {
            const id = choice.slice('addr:'.length);
            const list = Array.isArray(cliente && cliente.direcciones) ? cliente.direcciones : [];
            const entry = list.find((x) => x && String(x.id) === id);
            if (!entry) return;

            const formatted = (entry.formatted || '').trim();
            const lat = entry.lat != null ? Number(entry.lat) : null;
            const lng = entry.lng != null ? Number(entry.lng) : null;
            setSavedSelection({ type: 'addr', id });

            const savedDeliveryPrice = entry.deliveryPrice != null ? Number(entry.deliveryPrice) : null;
            const savedDistanceKm = entry.distanceKm != null ? Number(entry.distanceKm) : null;
            const savedDurationMin = entry.durationMin != null ? Number(entry.durationMin) : null;
            if (!Number.isFinite(savedDeliveryPrice) || !Number.isFinite(savedDistanceKm) || !formatted) return;

            userAddress = {
                formatted_address: formatted,
                distance: savedDistanceKm,
                deliveryPrice: savedDeliveryPrice,
                zone: `Env칤o a $${COSTO_POR_KM}/km`,
                coordinates: (Number.isFinite(lat) && Number.isFinite(lng)) ? { lat, lng } : null,
                durationMin: Number.isFinite(savedDurationMin) ? savedDurationMin : null,
                distanceSource: 'firebase'
            };
            try { displaySelectedAddress({ formatted_address: formatted }); } catch (_) {}
            updateCheckoutTotals();

            // Marcar tambi칠n como direcci칩n activa en el perfil (para que quede como principal)
            try {
                if (window.firebaseClientManager && typeof window.firebaseClientManager.setPrimaryClientLocation === 'function') {
                    window.firebaseClientManager.setPrimaryClientLocation(entry).catch(() => {});
                }
            } catch (_) {}

            try {
                const payload = {
                    formatted_address: userAddress.formatted_address,
                    lat: userAddress.coordinates ? userAddress.coordinates.lat : null,
                    lng: userAddress.coordinates ? userAddress.coordinates.lng : null,
                    distance: savedDistanceKm,
                    deliveryPrice: savedDeliveryPrice,
                    savedAt: Date.now()
                };
                localStorage.setItem('clientDeliveryInfo', JSON.stringify(payload));
            } catch (_) {}
        }
    }

    function setupSavedAddressesSelector() {
        const section = document.getElementById('saved-addresses-section');
        const initialSelect = document.getElementById('saved-address-select');
        const hintEl = document.getElementById('saved-addresses-hint');
        if (!section || !initialSelect) return;

        let selectEl = initialSelect;

        function showDisabled(message) {
            section.classList.remove('hidden');
            selectEl.innerHTML = '';
            const o = document.createElement('option');
            o.value = '__select__';
            o.textContent = message || 'Selecciona una direcci칩n';
            selectEl.appendChild(o);
            selectEl.value = '__select__';
            selectEl.disabled = true;
            if (hintEl) hintEl.textContent = message || '';
        }

        function show() {
            section.classList.remove('hidden');
            selectEl.disabled = false;
        }

        async function refresh(cliente) {
            if (!cliente) {
                showDisabled('Inicia sesi칩n en Mi cuenta para ver tus direcciones guardadas.');
                return;
            }

            // Sincronizar recompensa activa desde el perfil (para aplicar env칤o gratis / descuentos)
            try { setActiveRewardState(cliente.activeReward || null); } catch (_) {}

            show();

            const options = buildAddressOptions(cliente);
            selectEl.innerHTML = '';
            options.forEach((opt) => {
                const o = document.createElement('option');
                o.value = opt.value;
                o.textContent = opt.label;
                if (opt.disabled) o.disabled = true;
                selectEl.appendChild(o);
            });

            // Si no hay direcciones elegibles (solo placeholder), deshabilitar
            if (options.length <= 1) {
                showDisabled('No tienes direcciones guardadas con costo. Entra a Mi cuenta y guarda una direcci칩n.');
                return;
            }

            // Restaurar selecci칩n previa
            const saved = getSavedSelection();
            if (saved) {
                if (saved.type === 'primary') selectEl.value = '__primary__';
                else if (saved.type === 'addr' && saved.id) selectEl.value = `addr:${saved.id}`;
                else selectEl.value = '__select__';
            } else {
                // Si el usuario tiene activeAddressId, seleccionarla
                const active = (cliente && cliente.activeAddressId) ? String(cliente.activeAddressId) : '';
                if (active && options.some(o => o.value === `addr:${active}`)) {
                    selectEl.value = `addr:${active}`;
                } else if (options.some(o => o.value === '__primary__')) {
                    selectEl.value = '__primary__';
                } else {
                    selectEl.value = '__select__';
                }
            }

            if (hintEl) hintEl.textContent = 'Si quieres agregar otra direcci칩n, usa el bot칩n Mi cuenta.';

            // Si ya hay una selecci칩n real, aplicarla
            if (selectEl.value && selectEl.value !== '__select__') {
                try { await applyAddressSelection(selectEl.value, cliente); } catch (_) {}
            }

            // Recalcular totales (por si la recompensa afecta env칤o/total)
            try { updateCheckoutTotals(); } catch (_) {}
        }

        // Evitar listeners duplicados
        const selectClone = selectEl.cloneNode(true);
        selectEl.parentNode.replaceChild(selectClone, selectEl);
        selectEl = selectClone;

        selectEl.addEventListener('change', async (e) => {
            const value = e.target.value;
            try {
                const cliente = window.__cachedClienteForAddresses || null;
                await applyAddressSelection(value, cliente);
            } catch (_) {}
        });

        function waitForManager(tries) {
            tries = tries || 0;
            if (window.firebaseClientManager && typeof window.firebaseClientManager.onAuthChange === 'function') {
                const manager = window.firebaseClientManager;
                manager.onAuthChange(async (user) => {
                    if (!user) {
                        window.__cachedClienteForAddresses = null;
                        showDisabled('Inicia sesi칩n en Mi cuenta para ver tus direcciones guardadas.');
                        return;
                    }
                    try {
                        const cliente = await manager.getClient(user.uid);
                        window.__cachedClienteForAddresses = cliente;
                        await refresh(cliente);
                    } catch (_) {
                        window.__cachedClienteForAddresses = null;
                        showDisabled('No se pudieron cargar tus direcciones. Intenta de nuevo.');
                    }
                });

                // Carga inicial
                manager.getClient().then((cliente) => {
                    window.__cachedClienteForAddresses = cliente;
                    refresh(cliente);
                }).catch(() => {
                    window.__cachedClienteForAddresses = null;
                    showDisabled('Inicia sesi칩n en Mi cuenta para ver tus direcciones guardadas.');
                });
            } else if (tries < 50) {
                setTimeout(() => waitForManager(tries + 1), 150);
            } else {
                showDisabled('Inicia sesi칩n en Mi cuenta para ver tus direcciones guardadas.');
            }
        }

        waitForManager(0);
    }
    
    function saveCustomerData() {
        localStorage.setItem('customerPhone', customerPhoneInput.value.trim());
    }
    
    function loadCart() {
        try {
            const savedCart = JSON.parse(localStorage.getItem('cart'));
            if (savedCart && Array.isArray(savedCart)) {
                cart = savedCart;
            }
        } catch (e) {
            console.error('Error loading cart:', e);
            localStorage.removeItem('cart');
        }
    }

    async function handleMercadoPagoReturn() {
        try {
            const params = new URLSearchParams(window.location.search || '');
            const payment = (params.get('payment') || params.get('status') || params.get('collection_status') || '').trim().toLowerCase();
            if (!payment) return;

            const orderNumber = (params.get('order') || params.get('external_reference') || '').trim();
            if (orderNumber) {
                try { setLastOrderNumber(orderNumber); } catch (_) {}
            }

            if (payment === 'approved') {
                showNotification(`九 Tu pago ha sido acreditado con 칠xito${orderNumber ? `  Orden #${orderNumber}` : ''}.`, 'success');

                // Marcar como pagado en Firebase (si existe el pedido)
                try {
                    if (orderNumber) {
                        await markFirebaseOrderPaidFromMercadoPago(orderNumber, null, params.get('payment_id') || params.get('payment') || null);
                    }
                } catch (_) {}

                // Limpiar estado pendiente de Mercado Pago (si exist칤a)
                try { localStorage.removeItem('mp_pending_order'); } catch (_) {}

                // Limpiar carrito al volver del pago aprobado
                try { localStorage.removeItem('cart'); } catch (_) {}
                try { cart = []; updateCart(); } catch (_) {}

                // Mostrar modal con n칰mero de orden y acceso a rastreo
                const successModal = document.getElementById('order-success-modal');
                if (successModal) {
                    try {
                        const titleEl = successModal.querySelector('h3');
                        const descEl = successModal.querySelector('p');
                        if (titleEl) titleEl.textContent = 'Tu pago ha sido acreditado con 칠xito';
                        if (descEl) descEl.textContent = 'Guarda tu n칰mero de orden para rastrear tu pedido:';
                    } catch (_) {}
                    successModal.classList.add('flex');
                    successModal.classList.remove('hidden');
                    try { updateOrderSuccessWhatsAppLink(orderNumber); } catch (_) {}
                    const closeBtn = document.getElementById('close-order-success');
                    if (closeBtn) {
                        closeBtn.onclick = () => {
                            successModal.classList.add('hidden');
                            successModal.classList.remove('flex');
                        };
                    }
                }

                // Llevar al usuario al men칰
                try {
                    const menu = document.getElementById('menu');
                    if (menu) menu.scrollIntoView({ behavior: 'smooth', block: 'start' });
                } catch (_) {}
            } else if (payment === 'pending') {
                showNotification(`낍 Pago pendiente${orderNumber ? `  Orden #${orderNumber}` : ''}. Si ya pagaste, espera confirmaci칩n.`, 'warning');
                try {
                    const menu = document.getElementById('menu');
                    if (menu) menu.scrollIntoView({ behavior: 'smooth', block: 'start' });
                } catch (_) {}
            } else if (payment === 'failure') {
                showNotification('仇 Pago cancelado o fallido. Puedes intentar de nuevo o elegir otro m칠todo.', 'error');

                // Limpiar estado pendiente si fall칩
                try { localStorage.removeItem('mp_pending_order'); } catch (_) {}
            }

            // Limpiar par치metros para que no se repita el mensaje al recargar
            try {
                const clean = window.location.pathname + (window.location.hash || '');
                window.history.replaceState({}, document.title, clean);
            } catch (_) {}
        } catch (e) {
            console.warn('No se pudo procesar retorno de Mercado Pago:', e);
        }
    }

    function applyPaymentApprovedUI(orderNumber) {
        try {
            if (orderNumber) {
                try { setLastOrderNumber(orderNumber); } catch (_) {}
            }

            // Limpiar carrito
            try { localStorage.removeItem('cart'); } catch (_) {}
            try { cart = []; updateCart(); } catch (_) {}

            // Limpiar estado pendiente de Mercado Pago
            try { localStorage.removeItem('mp_pending_order'); } catch (_) {}

            // Cerrar checkout si est치 abierto
            try {
                if (checkoutModal) {
                    checkoutModal.classList.add('hidden');
                    checkoutModal.classList.remove('flex');
                }
            } catch (_) {}

            // Mostrar modal de 칠xito
            const successModal = document.getElementById('order-success-modal');
            if (successModal) {
                try {
                    const titleEl = successModal.querySelector('h3');
                    const descEl = successModal.querySelector('p');
                    if (titleEl) titleEl.textContent = 'Tu pago ha sido acreditado con 칠xito';
                    if (descEl) descEl.textContent = 'Guarda tu n칰mero de orden para rastrear tu pedido:';
                } catch (_) {}
                successModal.classList.add('flex');
                successModal.classList.remove('hidden');
                try { updateOrderSuccessWhatsAppLink(orderNumber); } catch (_) {}
                const closeBtn = document.getElementById('close-order-success');
                if (closeBtn) {
                    closeBtn.onclick = () => {
                        successModal.classList.add('hidden');
                        successModal.classList.remove('flex');
                    };
                }
            }

            // Llevar al usuario al men칰
            try {
                const menu = document.getElementById('menu');
                if (menu) menu.scrollIntoView({ behavior: 'smooth', block: 'start' });
            } catch (_) {}
        } catch (e) {
            console.warn('No se pudo aplicar UI de pago aprobado:', e);
        }
    }

    async function markFirebaseOrderPaidFromMercadoPago(orderNumber, orderId, paymentId) {
        try {
            if (!window.firebaseOrderManager) return;

            let targetId = orderId ? String(orderId) : '';
            if (!targetId && orderNumber && typeof window.firebaseOrderManager.findOrderByNumber === 'function') {
                const found = await window.firebaseOrderManager.findOrderByNumber(orderNumber);
                if (found && found.id) targetId = String(found.id);
            }
            if (!targetId || typeof window.firebaseOrderManager.updateOrder !== 'function') return;

            const updatePayload = {
                paid: true,
                paidAtIso: new Date().toISOString(),
            };
            if (paymentId != null && String(paymentId).trim()) {
                updatePayload.mpPaymentId = String(paymentId).trim();
            }

            await window.firebaseOrderManager.updateOrder(targetId, updatePayload);
        } catch (e) {
            console.warn('No se pudo marcar como pagado en Firebase:', e);
        }
    }

    function setPendingMpOrder(orderNumber, orderId) {
        try {
            if (!orderNumber) return;
            // whatsappUrl es opcional; se usa para mostrar un bot칩n "Enviar por WhatsApp" al aprobar pago.
            const whatsappUrl = arguments.length >= 3 ? arguments[2] : null;
            localStorage.setItem('mp_pending_order', JSON.stringify({ orderNumber, orderId: orderId || null, startedAt: Date.now(), whatsappUrl: whatsappUrl || null }));
        } catch (_) {}
    }

    function getPendingMpOrder() {
        try {
            const raw = localStorage.getItem('mp_pending_order');
            if (!raw) return null;
            const parsed = JSON.parse(raw);
            const orderNumber = parsed && parsed.orderNumber ? String(parsed.orderNumber) : '';
            const orderId = parsed && parsed.orderId ? String(parsed.orderId) : null;
            const startedAt = parsed && parsed.startedAt ? Number(parsed.startedAt) : 0;
            const whatsappUrl = parsed && parsed.whatsappUrl ? String(parsed.whatsappUrl) : null;
            if (!orderNumber) return null;
            // Expirar pendientes muy viejos (24h)
            if (startedAt && Date.now() - startedAt > 24 * 60 * 60 * 1000) {
                localStorage.removeItem('mp_pending_order');
                return null;
            }
            return { orderNumber, orderId, startedAt, whatsappUrl };
        } catch (_) {
            return null;
        }
    }

    function updateOrderSuccessWhatsAppLink(orderNumber) {
        try {
            const waBtn = document.getElementById('order-wa-link');
            if (!waBtn) return;

            let url = null;
            try {
                const pending = getPendingMpOrder();
                if (pending && pending.orderNumber && String(pending.orderNumber) === String(orderNumber) && pending.whatsappUrl) {
                    url = pending.whatsappUrl;
                }
            } catch (_) {}

            if (!url) {
                try { url = localStorage.getItem('sr_last_whatsapp_url'); } catch (_) { url = null; }
            }

            if (url && /^https?:\/\//i.test(url)) {
                waBtn.href = url;
                waBtn.classList.remove('hidden');
            } else {
                waBtn.classList.add('hidden');
            }
        } catch (_) {}
    }

    function stopMercadoPagoStatusPolling() {
        try {
            const st = window.__mpPollingState;
            if (st && st.timer) clearInterval(st.timer);
        } catch (_) {}
        try { window.__mpPollingState = null; } catch (_) {}
    }

    function startMercadoPagoStatusPolling(orderNumber, orderId) {
        try {
            if (!orderNumber) return;

            // Evitar m칰ltiples pollings
            try {
                const st = window.__mpPollingState;
                if (st && st.orderNumber === orderNumber && st.timer) return;
            } catch (_) {}
            stopMercadoPagoStatusPolling();

            setPendingMpOrder(orderNumber, orderId);

            const startedAt = Date.now();
            const timeoutMs = 10 * 60 * 1000; // 10 min
            let lastToast = '';

            const tick = async () => {
                try {
                    if (Date.now() - startedAt > timeoutMs) {
                        stopMercadoPagoStatusPolling();
                        try { showNotification('낍 No pudimos confirmar el pago todav칤a. Si ya pagaste, espera unos minutos y vuelve a esta p치gina.', 'warning'); } catch (_) {}
                        return;
                    }

                    const url = `${API_BASE}/api/mercadopago/payment-status?order=${encodeURIComponent(orderNumber)}`;
                    const r = await fetch(url);
                    const j = await r.json().catch(() => null);
                    if (!r.ok || !j || !j.ok) return;

                    const status = String(j.status || '').toLowerCase();
                    if (status === 'approved') {
                        stopMercadoPagoStatusPolling();
                        try { showNotification(`九 Tu pago ha sido acreditado con 칠xito  Orden #${orderNumber}.`, 'success'); } catch (_) {}
                        try { await markFirebaseOrderPaidFromMercadoPago(orderNumber, orderId, j && j.paymentId); } catch (_) {}
                        applyPaymentApprovedUI(orderNumber);
                        return;
                    }
                    if (status === 'failure') {
                        stopMercadoPagoStatusPolling();
                        try { showNotification('仇 El pago fue rechazado/cancelado. Puedes intentar de nuevo.', 'error'); } catch (_) {}
                        try { localStorage.removeItem('mp_pending_order'); } catch (_) {}
                        return;
                    }
                    if ((status === 'pending' || status === 'in_process') && lastToast !== 'pending') {
                        lastToast = 'pending';
                        try { showNotification('낍 Pago pendiente. En cuanto se apruebe te mostramos la confirmaci칩n aqu칤.', 'warning'); } catch (_) {}
                    }
                } catch (_) {
                    // Ignorar errores transitorios
                }
            };

            const timer = setInterval(tick, 4000);
            window.__mpPollingState = { orderNumber, orderId: orderId || null, timer };
            tick();
        } catch (e) {
            console.warn('No se pudo iniciar polling de Mercado Pago:', e);
        }
    }

    function resumeMercadoPagoPollingIfPending() {
        try {
            const pending = getPendingMpOrder();
            if (!pending || !pending.orderNumber) return;
            startMercadoPagoStatusPolling(pending.orderNumber, pending.orderId || null);
        } catch (_) {}
    }

    function applyPaymentApprovedUI_legacy(orderNumber) {
        try {
            if (orderNumber) {
                try { setLastOrderNumber(orderNumber); } catch (_) {}
            }

            // Limpiar carrito
            try { localStorage.removeItem('cart'); } catch (_) {}
            try { cart = []; updateCart(); } catch (_) {}

            // Cerrar checkout si est치 abierto
            try {
                if (checkoutModal) {
                    checkoutModal.classList.add('hidden');
                    checkoutModal.classList.remove('flex');
                }
            } catch (_) {}

            // Mostrar modal de 칠xito
            const successModal = document.getElementById('order-success-modal');
            if (successModal) {
                try {
                    const titleEl = successModal.querySelector('h3');
                    const descEl = successModal.querySelector('p');
                    if (titleEl) titleEl.textContent = 'Tu pago ha sido acreditado con 칠xito';
                    if (descEl) descEl.textContent = 'Guarda tu n칰mero de orden para rastrear tu pedido:';
                } catch (_) {}
                successModal.classList.add('flex');
                successModal.classList.remove('hidden');
                const closeBtn = document.getElementById('close-order-success');
                if (closeBtn) {
                    closeBtn.onclick = () => {
                        successModal.classList.add('hidden');
                        successModal.classList.remove('flex');
                    };
                }
            }

            // Llevar al usuario al men칰
            try {
                const menu = document.getElementById('menu');
                if (menu) menu.scrollIntoView({ behavior: 'smooth', block: 'start' });
            } catch (_) {}
        } catch (e) {
            console.warn('No se pudo aplicar UI de pago aprobado:', e);
        }
    }

    function startMercadoPagoStatusPolling_legacy(orderNumber) {
        try {
            if (!orderNumber) return;

            const startedAt = Date.now();
            const timeoutMs = 10 * 60 * 1000; // 10 min
            let lastToast = '';

            const tick = async () => {
                try {
                    if (Date.now() - startedAt > timeoutMs) {
                        clearInterval(timer);
                        try { showNotification('낍 No pudimos confirmar el pago todav칤a. Si ya pagaste, espera unos minutos y recarga.', 'warning'); } catch (_) {}
                        return;
                    }

                    const url = `${API_BASE}/api/mercadopago/payment-status?order=${encodeURIComponent(orderNumber)}`;
                    const r = await fetch(url);
                    const j = await r.json().catch(() => null);
                    if (!r.ok || !j || !j.ok) return;

                    const status = String(j.status || '').toLowerCase();
                    if (status === 'approved') {
                        clearInterval(timer);
                        try { showNotification(`九 Tu pago ha sido acreditado con 칠xito  Orden #${orderNumber}.`, 'success'); } catch (_) {}
                        applyPaymentApprovedUI(orderNumber);
                        return;
                    }
                    if (status === 'failure') {
                        clearInterval(timer);
                        try { showNotification('仇 El pago fue rechazado/cancelado. Puedes intentar de nuevo.', 'error'); } catch (_) {}
                        return;
                    }
                    if (status === 'pending' && lastToast !== 'pending') {
                        lastToast = 'pending';
                        try { showNotification('낍 Pago pendiente. En cuanto se apruebe te mostramos la confirmaci칩n aqu칤.', 'warning'); } catch (_) {}
                    }
                } catch (_) {
                    // Ignorar errores transitorios
                }
            };

            const timer = setInterval(tick, 4000);
            tick();
        } catch (e) {
            console.warn('No se pudo iniciar polling de Mercado Pago:', e);
        }
    }
    
    // Initialize everything when page loads
    function initialize() {
        console.log('游꿟 Inicializando aplicaci칩n...');
        
        // Inicializar referencias a elementos del DOM
        menuContainer = document.getElementById('menu-categories');
        cartSidebar = document.getElementById('cart-sidebar');
        cartOverlay = document.getElementById('cart-overlay');
        openCartBtn = document.getElementById('open-cart-btn');
        closeCartBtn = document.getElementById('close-cart-btn');
        cartItemsContainer = document.getElementById('cart-items');
        cartEmptyMsg = document.getElementById('cart-empty-msg');
        cartCount = document.getElementById('cart-count');
        cartTotal = document.getElementById('cart-total');
        checkoutBtn = document.getElementById('checkout-btn');
        stickyCartBar = document.getElementById('sticky-cart-bar');
        stickyCartItems = document.getElementById('sticky-cart-items');
        stickyCartTotal = document.getElementById('sticky-cart-total');
        stickyCartOpenBtn = document.getElementById('sticky-cart-open');
        cartEmptyCtaBtn = document.getElementById('cart-empty-cta');
        checkoutModal = document.getElementById('checkout-modal');
        closeModalBtn = document.getElementById('close-modal-btn');
        orderSummaryContainer = document.getElementById('order-summary');
        sendWhatsappBtn = document.getElementById('send-whatsapp-btn');
        customerNameInput = document.getElementById('customer-name');
        customerPhoneInput = document.getElementById('customer-phone');
        customModal = document.getElementById('customization-modal');
        customModalTitle = document.getElementById('custom-modal-title');
        toppingsContainer = document.getElementById('toppings-container');
        customModalTotal = document.getElementById('custom-modal-total');
        customNotesSection = document.getElementById('custom-notes-section');
        customNotesInput = document.getElementById('custom-notes-input');
        customNotesDivider = document.getElementById('custom-notes-divider');
        addCustomToCartBtn = document.getElementById('add-custom-to-cart-btn');
        closeCustomModalBtn = document.getElementById('close-custom-modal-btn');
        addFriesCheckbox = document.getElementById('add-fries-checkbox');
        friesChoiceContainer = document.getElementById('fries-choice-container');
        comboModal = document.getElementById('combo-modal');
        comboModalTitle = document.getElementById('combo-modal-title');
        comboModalBody = document.getElementById('combo-modal-body');
        comboModalTotal = document.getElementById('combo-modal-total');
        addComboToCartBtn = document.getElementById('add-combo-to-cart-btn');
        closeComboModalBtn = document.getElementById('close-combo-modal-btn');
        promotionsBtn = document.getElementById('promotions-btn');
        promotionsModal = document.getElementById('promotions-modal');
        closePromotionsModalBtn = document.getElementById('close-promotions-modal-btn');
        
        console.log('九 Elementos del DOM inicializados');

        // Sticky cart + empty state CTA
        try {
            if (stickyCartOpenBtn && openCartBtn) {
                stickyCartOpenBtn.addEventListener('click', () => {
                    openCartBtn.click();
                });
            }
            if (cartEmptyCtaBtn) {
                cartEmptyCtaBtn.addEventListener('click', () => {
                    // cerrar carrito si est치 abierto
                    try {
                        if (cartSidebar) cartSidebar.classList.add('translate-x-full');
                        if (cartOverlay) cartOverlay.classList.add('hidden');
                    } catch (_) {}
                    const menu = document.getElementById('menu');
                    if (menu) menu.scrollIntoView({ behavior: 'smooth', block: 'start' });
                });
            }
        } catch (_) {}

        // Modal CTA registro: cerrar
        try {
            const modal = document.getElementById('register-cta-modal');
            const closeBtn = document.getElementById('register-cta-close');
            const laterBtn = document.getElementById('register-cta-later');
            function dismiss() {
                registerCtaDismissed = true;
                updateRegisterCtaModalVisibility();
            }
            if (closeBtn) closeBtn.addEventListener('click', dismiss);
            if (laterBtn) laterBtn.addEventListener('click', dismiss);
            if (modal) {
                modal.addEventListener('click', (e) => {
                    // click fuera de la tarjeta
                    if (e.target === modal) dismiss();
                });
            }
        } catch (_) {}

        // Marcar edici칩n manual para no pisar con autofill
        if (customerNameInput) {
            customerNameInput.addEventListener('input', () => {
                customerNameInput.dataset.userEdited = '1';
            });
        }
        if (customerPhoneInput) {
            customerPhoneInput.addEventListener('input', () => {
                customerPhoneInput.dataset.userEdited = '1';
            });
        }
        
        renderMenu();
        setupEventListeners();
        initializeEnhancements();
        updateRegisterCtaModalVisibility();
        loadCustomerData();
        setupFirebaseCustomerAutofill();
        setupSavedAddressesSelector();
        loadCart();
        updateCart();

        // Retorno de pago (Mercado Pago): mostrar confirmaci칩n y volver al men칰
        handleMercadoPagoReturn();

        // Si Mercado Pago no redirige (com칰n en localhost/LAN), reanudar verificaci칩n al volver a esta pesta침a.
        try {
            resumeMercadoPagoPollingIfPending();
            window.addEventListener('focus', () => {
                try { resumeMercadoPagoPollingIfPending(); } catch (_) {}
            });
            window.addEventListener('pageshow', () => {
                try { resumeMercadoPagoPollingIfPending(); } catch (_) {}
            });
            document.addEventListener('visibilitychange', () => {
                if (document.visibilityState === 'visible') {
                    try { resumeMercadoPagoPollingIfPending(); } catch (_) {}
                }
            });
        } catch (_) {}

        // Deep link: abrir carrito autom치ticamente (ej. desde cliente.html)
        try {
            const params = new URLSearchParams(window.location.search || '');
            if (params.get('openCart') === '1') {
                setTimeout(() => {
                    try { openCart(); } catch (_) {}
                }, 50);
            }
        } catch (_) {}
        
        // Set current year in footer
        document.getElementById('year').textContent = '2024';
        
        // Add smooth scrolling for anchor links
        document.querySelectorAll('a[href^="#"]').forEach(anchor => {
            anchor.addEventListener('click', function (e) {
                const href = String(this.getAttribute('href') || '');
                // Si el href cambi칩 din치micamente a una URL (ej. WhatsApp), no interceptar.
                if (!href.startsWith('#') || href.length < 2) return;
                e.preventDefault();

                let target = null;
                try {
                    target = document.querySelector(href);
                } catch (_) {
                    target = null;
                }
                if (target) {
                    target.scrollIntoView({
                        behavior: 'smooth',
                        block: 'start'
                    });
                }
            });
        });
        
        // Add progressive web app features
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/sw.js').catch(() => {
                // Service worker registration failed, but that's ok
            });
        }
        
        // Add performance monitoring
        if ('PerformanceObserver' in window) {
            const observer = new PerformanceObserver((list) => {
                for (const entry of list.getEntries()) {
                    if (entry.entryType === 'largest-contentful-paint') {
                        // Log LCP for optimization
                        console.log('LCP:', entry.startTime);
                    }
                }
            });
            observer.observe({entryTypes: ['largest-contentful-paint']});
        }
        
        // Initialize theme preference
        const prefersDark = window.matchMedia('(prefers-color-scheme: dark)');
        function handleThemeChange(e) {
            document.documentElement.setAttribute('data-theme', e.matches ? 'dark' : 'light');
        }
        handleThemeChange(prefersDark);
        prefersDark.addEventListener('change', handleThemeChange);
        
        // Add error boundary for JavaScript errors
        window.addEventListener('error', (e) => {
            console.error('JavaScript Error:', e.error);
            // Could send to analytics service
        });
        
        // Add visibility change handler for performance
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                // Page is hidden, pause expensive operations
                clearTimeout(cartAbandonmentTimer);
            } else {
                // Page is visible, resume operations
                startCartAbandonmentTimer();
            }
        });
        
        console.log('游꼢 SR & SRA BURGER - Sistema inicializado correctamente!');
        console.log('游눠 Todas las mejoras UX/UI est치n activas');
        console.log('游 Experiencia de usuario optimizada para conversiones');
    }
    
    // Start the application
    initialize();

    // A침o del footer
    document.getElementById('year').textContent = new Date().getFullYear();

    console.log('九 Aplicaci칩n SR & SRA BURGER cargada completamente');
        
        // Verificar si Google Maps est치 realmente disponible
        if (window.google && window.google.maps && window.google.maps.places) {
            console.log('九 Google Maps API disponible - configurando autocompletado avanzado');
            try {
                initializeAddressAutocomplete();
                console.log('游꿢 Autocompletado de Google Maps configurado exitosamente');
            } catch (error) {
                console.warn('丘멆잺 Error configurando autocompletado, usando entrada manual:', error);
                const addressInput = document.getElementById('address-input');
                if (addressInput) {
                    setupFreeTextInput(addressInput);
                }
            }
        } else {
            console.log('丘멆잺 Google Maps no disponible - configurando entrada manual');
            const addressInput = document.getElementById('address-input');
            if (addressInput) {
                setupFreeTextInput(addressInput);
            }
        }
        
        // Si el bloque de ubicaci칩n del hero est치 visible, inicializar el mapa ah칤 tambi칠n
        const heroSection = document.getElementById('hero-location');
        if (heroSection && !heroSection.classList.contains('hidden')) {
            setTimeout(() => {
                if (window.google && window.google.maps) {
                    console.log('游딬勇 Inicializando mapa del hero...');
                    try {
                        initializeHeroMap();
                        console.log('九 Mapa del hero inicializado');
                    } catch (error) {
                        console.warn('丘멆잺 Error inicializando mapa del hero:', error);
                        setupHeroLocationFallback();
                    }
                } else {
                    console.log('游늸 Hero map no disponible - usando entrada manual');
                    setupHeroLocationFallback();
                }
            }, 100);
        }
    });
    
    // Intentar inicializar inmediatamente si Google Maps ya est치 disponible
    if (window.google && window.google.maps && window.google.maps.places) {
        console.log('九 Google Maps ya disponible - inicializando ahora');
        initializeAddressAutocomplete();
    } else {
        // No hay Google Maps disponible, inicializar sin maps
        console.log('游댃 Google Maps no disponible - inicializando sin mapas');
        setTimeout(() => {
            if (typeof window.initializeGoogleMaps === 'function') {
                window.initializeGoogleMaps();
            }
        }, 1000);
    }
    
    // Fallback mejorado: esperar un poco m치s para la carga de Google Maps
    setTimeout(() => {
        const addressInput = document.getElementById('address-input');
        if (addressInput && !autocomplete) {
            console.log('丘멆잺 Activando autocompletado simulado como respaldo');
            setupFreeTextInput(addressInput);
        }
    }, 3000); // Aumentado a 3 segundos para mejor carga

    // Conectar confirmaci칩n del modal grande al c치lculo de env칤o
    initModalConfirmHook();

    // --- Checkout delivery calc (similar a cliente.html): geocode + km/costo ---
    let lastDeliveryGeocodeQuery = '';
    let lastDeliveryGeocodeAtMs = 0;

    async function geocodeAddressToCoords(query) {
        const q = String(query || '').trim();
        if (!q) return null;

        // Prefer Google Geocoder when available
        if (window.google && window.google.maps && window.google.maps.Geocoder) {
            try {
                const geocoder = new google.maps.Geocoder();
                const res = await geocoder.geocode({ address: q, region: 'MX' });
                const first = res && res.results && res.results[0];
                const loc = first && first.geometry && first.geometry.location;
                if (first && loc) {
                    const lat = typeof loc.lat === 'function' ? loc.lat() : Number(loc.lat);
                    const lng = typeof loc.lng === 'function' ? loc.lng() : Number(loc.lng);
                    if (Number.isFinite(lat) && Number.isFinite(lng)) {
                        return {
                            formatted_address: first.formatted_address || q,
                            lat,
                            lng
                        };
                    }
                }
            } catch (e) {
                console.warn('丘멆잺 Geocoder fall칩, usando fallback:', e);
            }
        }

        // Fallback (server /api/geocode)
        try {
            const r = await fallbackGeocodeAddress(q);
            if (r && r.location && isFinite(Number(r.location.lat)) && isFinite(Number(r.location.lng))) {
                return {
                    formatted_address: r.formatted_address || q,
                    lat: Number(r.location.lat),
                    lng: Number(r.location.lng)
                };
            }
        } catch (e) {
            console.warn('丘멆잺 fallbackGeocodeAddress fall칩:', e);
        }

        return null;
    }

    function setDeliveryInfoMessage(html, kind) {
        const el = document.getElementById('delivery-live-info');
        if (!el) return;
        el.innerHTML = html || '';
        el.classList.remove('hidden');
        if (kind === 'error') {
            el.classList.remove('text-gray-700');
            el.classList.add('text-red-700');
        } else {
            el.classList.remove('text-red-700');
            el.classList.add('text-gray-700');
        }
    }

    async function confirmAddressAndCalculateFromInput(reason) {
        const deliveryType = document.querySelector('input[name="delivery-type"]:checked');
        const isDelivery = deliveryType && deliveryType.value === 'delivery';
        if (!isDelivery) return;

        const addressInput = document.getElementById('address-input');
        const q = (addressInput && addressInput.value || '').trim();
        if (!q) return;

        // Evitar re-c치lculos si ya tenemos precio calculado
        if (userAddress && typeof userAddress.deliveryPrice === 'number' && isFinite(userAddress.deliveryPrice)) return;

        const now = Date.now();
        if (q === lastDeliveryGeocodeQuery && (now - lastDeliveryGeocodeAtMs) < 8000) return;
        lastDeliveryGeocodeQuery = q;
        lastDeliveryGeocodeAtMs = now;

        try {
            deliveryCalcPending++;
            updateCheckoutTotals();
            setDeliveryInfoMessage('<i class="fas fa-route mr-1 text-blue-600"></i>Calculando ruta y costo del env칤o...', 'info');

            const geo = await geocodeAddressToCoords(q);
            if (!geo || !isFinite(geo.lat) || !isFinite(geo.lng)) {
                userAddress = null;
                updateCheckoutTotals();
                setDeliveryInfoMessage('<i class="fas fa-exclamation-triangle mr-1"></i>No se pudo localizar esa direcci칩n. Intenta ser m치s espec칤fico.', 'error');
                return;
            }

            // Construir un "place" compatible con el resto de la l칩gica
            selectedPlace = {
                formatted_address: geo.formatted_address || q,
                geometry: { location: { lat: geo.lat, lng: geo.lng } }
            };
            window.selectedPlace = selectedPlace;
            if (addressInput) addressInput.value = selectedPlace.formatted_address;

            try { displaySelectedAddress(selectedPlace); } catch (_) {}
            await validateAddressZone(selectedPlace);
        } finally {
            deliveryCalcPending = Math.max(0, deliveryCalcPending - 1);
            updateCheckoutTotals();
        }
    }

    // Confirmaci칩n desde el modal de mapa grande (sin depender del minimapa)
    async function confirmModalAddressAndCalculate(source) {
        const deliveryType = document.querySelector('input[name="delivery-type"]:checked');
        const isDelivery = deliveryType && deliveryType.value === 'delivery';
        if (!isDelivery) return;

        const modalInput = document.getElementById('modal-search-input');
        const q = (modalInput && modalInput.value || '').trim();

        try {
            deliveryCalcPending++;
            updateCheckoutTotals();
            setDeliveryInfoMessage('<i class="fas fa-route mr-1 text-blue-600"></i>Calculando ruta y costo del env칤o...', 'info');

            let geo = null;
            if (q) {
                geo = await geocodeAddressToCoords(q);
            }

            let lat, lng, formatted;
            if (geo && isFinite(geo.lat) && isFinite(geo.lng)) {
                lat = geo.lat; lng = geo.lng; formatted = geo.formatted_address || q;
            } else if (window.selectedPlace && window.selectedPlace.geometry && window.selectedPlace.geometry.location) {
                const loc = window.selectedPlace.geometry.location;
                lat = typeof loc.lat === 'function' ? loc.lat() : Number(loc.lat);
                lng = typeof loc.lng === 'function' ? loc.lng() : Number(loc.lng);
                formatted = window.selectedPlace.formatted_address || q;
            } else {
                userAddress = null;
                updateCheckoutTotals();
                setDeliveryInfoMessage('<i class="fas fa-exclamation-triangle mr-1"></i>No se pudo confirmar la ubicaci칩n del modal. Escribe tu direcci칩n y confirma.', 'error');
                return;
            }

            selectedPlace = {
                formatted_address: formatted,
                geometry: { location: { lat, lng } }
            };
            window.selectedPlace = selectedPlace;

            const addressInput = document.getElementById('address-input');
            if (addressInput) addressInput.value = formatted;

            try { displaySelectedAddress(selectedPlace); } catch (_) {}
            await validateAddressZone(selectedPlace);
        } finally {
            deliveryCalcPending = Math.max(0, deliveryCalcPending - 1);
            updateCheckoutTotals();
        }
    }

    function initModalConfirmHook() {
        const btn = document.getElementById('modal-confirm-location');
        if (!btn) return;
        // Evitar listeners duplicados
        const newBtn = btn.cloneNode(true);
        btn.parentNode.replaceChild(newBtn, btn);
        newBtn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            confirmModalAddressAndCalculate('modal-click');
        });
    }
    
    function initializeAddressAutocomplete() {
        const addressInput = document.getElementById('address-input');
        
        if (!addressInput) {
            console.log('丘멆잺 Elemento address-input no encontrado');
            return;
        }

        // Primero, asegurar que el campo siempre permita escribir libremente
        addressInput.removeAttribute('readonly');
        addressInput.removeAttribute('disabled');
        addressInput.style.pointerEvents = 'auto';
        
        console.log('游댌 Verificando disponibilidad de Google Maps...');
        
        // Si Google Maps no est치 disponible, usar entrada libre inmediatamente
        if (!window.google || !window.google.maps || !window.google.maps.places) {
            console.log('丘멆잺 Google Maps no disponible - usando autocompletado simulado');
            setupFreeTextInput(addressInput);
            return;
        }
        
        try {
            console.log('九 Google Maps disponible - configurando autocompletado para Coahuila 36, Minatitl치n');
            
            // Configure autocomplete options - Optimizado para 치rea de entrega de 4km desde Coahuila 36
            const options = {
                types: ['address'], // Enfocado en direcciones
                componentRestrictions: { country: 'mx' }, // Restringir a M칠xico
                bounds: {
                    // 츼rea de entrega: ~4 km radio desde Coahuila 36, Col. 10 de Mayo, Minatitl치n
                    // Coordenadas del local: 18.022398, -94.546974
                    north: 18.0584,  // ~+4km Norte
                    south: 17.9864,  // ~-4km Sur
                    east: -94.5090,  // ~+4km Este
                    west: -94.5850   // ~-4km Oeste
                },
                strictBounds: false, // Permitir sugerencias cercanas tambi칠n
                fields: ['address_components', 'formatted_address', 'geometry', 'name', 'place_id']
            };
            
            // Initialize autocomplete
            autocomplete = new google.maps.places.Autocomplete(addressInput, options);
            
            // Configurar preferencias adicionales
            autocomplete.setOptions({
                strictBounds: false,
                placeIdOnly: false
            });
            
            // Add place changed listener
            autocomplete.addListener('place_changed', onPlaceChanged);
            
            // Mejorar la experiencia de usuario
            addressInput.addEventListener('focus', function() {
                console.log('游꿢 Campo de direcci칩n enfocado - Google Maps listo');
                // Dar una pista al usuario con 치rea de cobertura espec칤fica
                if (this.value === '') {
                    this.placeholder = 'Escribe tu direcci칩n... (Cobertura: hasta 7 km desde Coahuila 36, Minatitl치n)';
                }
            });
            
            addressInput.addEventListener('input', function(e) {
                console.log('游닇 Escribiendo con Google Maps activo:', e.target.value.length + ' caracteres');

                // Marcar que el usuario edit칩 y limpiar c치lculo previo si cambi칩 el texto
                try {
                    addressInput.dataset.userEdited = '1';
                } catch (_) {}
                if (userAddress) {
                    userAddress = null;
                    updateCheckoutTotals();
                }
                
                // Verificar que las sugerencias aparezcan
                setTimeout(() => {
                    const pacContainer = document.querySelector('.pac-container');
                    if (pacContainer && e.target.value.length > 2) {
                        console.log('游눠 Sugerencias de Google Maps disponibles');
                    }
                }, 500);
            });

            // Si el usuario presiona Enter sin seleccionar sugerencia, geocodificar y calcular
            addressInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    confirmAddressAndCalculateFromInput('enter');
                }
            });

            // Al salir del campo, intentar calcular (con peque침o delay para no chocar con place_changed)
            addressInput.addEventListener('blur', function() {
                setTimeout(() => {
                    confirmAddressAndCalculateFromInput('blur');
                }, 250);
            });
            
            console.log('九 Autocompletado de Google Maps inicializado para 치rea de entrega (hasta 7 km desde Coahuila 36)');
            
        } catch (error) {
            console.error('仇 Error al inicializar Google Maps:', error);
            console.log('游댃 Activando autocompletado simulado como respaldo');
            setupFreeTextInput(addressInput);
        }
        
    }

    // --- HERO MAP: Selecci칩n de ubicaci칩n en el hero ---
    function initializeHeroMap() {
        const mapDiv = document.getElementById('hero-map');
        if (!mapDiv) return;

        if (!window.google || !window.google.maps) {
            const preview = document.getElementById('hero-address-preview');
            if (preview) preview.textContent = 'Escribe tu direcci칩n en el buscador y confirma para validar cobertura.';
            // Fallback: permitir b칰squeda por texto y confirmaci칩n sin Google Maps
            const inputA = document.getElementById('hero-search-input');
            const btnA = document.getElementById('hero-search-btn');
            const geoBtn = document.getElementById('hero-use-geolocation');
            const confirmBtn = document.getElementById('hero-confirm-location');
            let lastResult = null; // {formatted_address, location:{lat,lng}}

            const updatePreviewFromResult = (res) => {
                if (!res || !preview) return;
                const { lat, lng } = res.location;
                const distance = calculateDistance(RESTAURANT_LOCATION.lat, RESTAURANT_LOCATION.lng, lat, lng);
                const zone = getDeliveryZone(distance);
                const feeText = zone && zone.price !== null ? `$${zone.price}` : 'Lo sentimos estas demasiado lejos';
                preview.innerHTML = `
                    <div><strong>Direcci칩n:</strong> ${res.formatted_address}</div>
                    <div class="text-sm text-gray-700">Distancia: ${distance.toFixed(1)} km  Env칤o: ${feeText}</div>
                `;
            };

            const doSearch = async (el) => {
                if (!el) return;
                const q = el.value.trim();
                if (!q) return;
                try {
                    const r = await fallbackGeocodeAddress(q);
                    lastResult = r;
                    updatePreviewFromResult(r);
                } catch (_) { /* ignore */ }
            };

            if (inputA) inputA.addEventListener('keydown', (e) => { if (e.key === 'Enter') { e.preventDefault(); doSearch(inputA); } });
            if (btnA) btnA.addEventListener('click', () => doSearch(inputA));
            if (geoBtn && navigator.geolocation) {
                geoBtn.addEventListener('click', () => {
                    geoBtn.disabled = true; geoBtn.textContent = 'Localizando';
                    navigator.geolocation.getCurrentPosition((pos) => {
                        const { latitude, longitude } = pos.coords;
                        lastResult = {
                            formatted_address: `Lat ${latitude.toFixed(5)}, Lng ${longitude.toFixed(5)}`,
                            location: { lat: latitude, lng: longitude }
                        };
                        updatePreviewFromResult(lastResult);
                        geoBtn.disabled = false; geoBtn.textContent = 'Usar mi ubicaci칩n';
                    }, () => { geoBtn.disabled = false; geoBtn.textContent = 'Usar mi ubicaci칩n'; }, { enableHighAccuracy: true, timeout: 8000 });
                });
            }
            if (confirmBtn) {
                console.log('九 Bot칩n hero-confirm-location encontrado, agregando event listener');
                
                // Asegurar que el bot칩n sea clickeable
                confirmBtn.style.pointerEvents = 'auto';
                confirmBtn.style.cursor = 'pointer';
                confirmBtn.style.touchAction = 'manipulation';
                
                confirmBtn.addEventListener('click', async (event) => {
                    event.preventDefault();
                    event.stopPropagation();
                    
                    console.log('游댖 춰CLICK! Bot칩n "Confirmar ubicaci칩n" clickeado');
                    console.log('游님 Tipo de evento:', event.type);
                    console.log('游둼勇 Origen:', event.target);
                    
                    // Feedback visual inmediato
                    confirmBtn.style.opacity = '0.7';
                    setTimeout(() => { confirmBtn.style.opacity = '1'; }, 200);
                    
                    // Si no hay resultado previo, intentar con texto
                    if (!lastResult) {
                        console.log('丘멆잺 No hay lastResult, intentando obtener de input');
                        const q = (inputA && inputA.value.trim()) || '';
                        if (q) {
                            console.log('游댌 Buscando direcci칩n:', q);
                            try { 
                                lastResult = await fallbackGeocodeAddress(q);
                                console.log('九 Direcci칩n encontrada:', lastResult);
                            } catch (err) {
                                console.error('仇 Error geocoding:', err);
                            }
                        } else {
                            console.log('丘멆잺 No hay direcci칩n en el input');
                        }
                    }
                    
                    console.log('游늸 LastResult:', lastResult);
                    
                    // Remover mensajes anteriores
                    const noticeId = 'hero-confirm-notice';
                    const old = document.getElementById(noticeId);
                    if (old) old.remove();
                    
                    if (lastResult) {
                        const { lat, lng } = lastResult.location;
                        const d = calculateDistance(RESTAURANT_LOCATION.lat, RESTAURANT_LOCATION.lng, lat, lng);
                        const zone = getDeliveryZone(d);
                        
                        console.log('游늺 Distancia:', d.toFixed(2), 'km');
                        console.log('游딬勇 Zona:', zone);
                        
                        if (zone && zone.price !== null) {
                            console.log('九 S칈 ENTREGAMOS - Mostrando modal grande');
                            
                            // 九 S칈 ENTREGAMOS - Mensaje grande y llamativo
                            
                            // Guardar la ubicaci칩n confirmada para el checkout
                            userAddress = {
                                formatted_address: lastResult.formatted_address,
                                distance: d,
                                deliveryPrice: zone.price,
                                zone: zone.zone,
                                coordinates: { lat, lng }
                            };
                            
                            // Crear mensaje compacto y visible
                            const bigMessage = document.createElement('div');
                            bigMessage.id = noticeId;
                            bigMessage.className = 'fixed bottom-4 left-4 right-4 sm:left-auto sm:right-4 sm:max-w-sm z-50 animate-fade-in';
                            bigMessage.innerHTML = `
                                <div class="bg-gradient-to-br from-green-500 to-emerald-600 rounded-2xl shadow-2xl p-4 sm:p-5 transform animate-scale-in">
                                    <!-- Header compacto -->
                                    <div class="flex items-start justify-between mb-3">
                                        <div class="flex items-center space-x-3">
                                            <div class="w-10 h-10 bg-white/20 backdrop-blur-sm rounded-full flex items-center justify-center flex-shrink-0">
                                                <i class="fas fa-check-circle text-white text-xl"></i>
                                            </div>
                                            <h3 class="text-lg font-bold text-white leading-tight">
                                                춰S칤 entregamos! 游꿀
                                            </h3>
                                        </div>
                                        <button id="hero-close-message-btn" class="text-white/70 hover:text-white transition-colors">
                                            <i class="fas fa-times text-xl"></i>
                                        </button>
                                    </div>
                                    
                                    <!-- Info compacta -->
                                    <div class="bg-white/15 backdrop-blur-sm rounded-xl p-3 mb-3">
                                        <div class="flex items-center justify-between text-white text-sm mb-2">
                                            <span><i class="fas fa-route mr-1"></i> ${d.toFixed(1)} km</span>
                                            <span><i class="fas fa-dollar-sign mr-1"></i> $${zone.price}</span>
                                            <span><i class="fas fa-clock mr-1"></i> ${d <= 4 ? '25-35' : '35-45'} min</span>
                                        </div>
                                        <p class="text-white/90 text-xs truncate">
                                            <i class="fas fa-map-marker-alt mr-1"></i>
                                            ${lastResult.formatted_address}
                                        </p>
                                    </div>
                                    
                                    <!-- Bot칩n compacto -->
                                    <button id="hero-go-to-menu-btn" class="w-full bg-white text-green-600 px-4 py-3 rounded-xl font-bold text-sm hover:bg-green-50 transform hover:scale-105 transition-all duration-300 shadow-lg">
                                        <i class="fas fa-utensils mr-2"></i>
                                        VER MEN칔 Y ORDENAR
                                    </button>
                                </div>
                            `;
                            document.body.appendChild(bigMessage);
                            
                            // Event listener para ir al men칰
                            const goToMenuBtn = document.getElementById('hero-go-to-menu-btn');
                            if (goToMenuBtn) {
                                goToMenuBtn.addEventListener('click', () => {
                                    // Cerrar el modal
                                    bigMessage.style.opacity = '0';
                                    setTimeout(() => bigMessage.remove(), 300);
                                    
                                    // Ir al men칰 con scroll suave
                                    setTimeout(() => {
                                        const menuSection = document.getElementById('menu');
                                        if (menuSection) {
                                            menuSection.scrollIntoView({ 
                                                behavior: 'smooth', 
                                                block: 'start' 
                                            });
                                            
                                            // Mostrar mensaje de bienvenida flotante
                                            const welcomeMsg = document.createElement('div');
                                            welcomeMsg.className = 'fixed top-20 left-1/2 transform -translate-x-1/2 bg-green-500 text-white px-6 py-3 rounded-full shadow-2xl z-50 animate-bounce';
                                            welcomeMsg.innerHTML = '游꼢 춰Elige tus hamburguesas favoritas!';
                                            document.body.appendChild(welcomeMsg);
                                            
                                            setTimeout(() => {
                                                welcomeMsg.style.opacity = '0';
                                                welcomeMsg.style.transition = 'opacity 0.5s';
                                                setTimeout(() => welcomeMsg.remove(), 500);
                                            }, 3000);
                                        }
                                    }, 100);
                                });
                            }
                            
                            // Event listener para cerrar
                            const closeBtn = document.getElementById('hero-close-message-btn');
                            if (closeBtn) {
                                closeBtn.addEventListener('click', () => {
                                    bigMessage.style.opacity = '0';
                                    setTimeout(() => bigMessage.remove(), 300);
                                });
                            }
                            
                            // Cerrar al hacer clic fuera del modal
                            bigMessage.addEventListener('click', (e) => {
                                if (e.target === bigMessage) {
                                    bigMessage.style.opacity = '0';
                                    setTimeout(() => bigMessage.remove(), 300);
                                }
                            });
                            
                        } else {
                            // 仇 NO ENTREGAMOS - Mensaje de error compacto
                            const errorMessage = document.createElement('div');
                            errorMessage.id = noticeId;
                            errorMessage.className = 'fixed bottom-4 left-4 right-4 sm:left-auto sm:right-4 sm:max-w-sm z-50 animate-fade-in';
                            errorMessage.innerHTML = `
                                <div class="bg-gradient-to-br from-red-500 to-rose-600 rounded-2xl shadow-2xl p-4 sm:p-5 transform animate-scale-in">
                                    <!-- Header compacto -->
                                    <div class="flex items-start justify-between mb-3">
                                        <div class="flex items-center space-x-3">
                                            <div class="w-10 h-10 bg-white/20 backdrop-blur-sm rounded-full flex items-center justify-center flex-shrink-0">
                                                <i class="fas fa-exclamation-triangle text-white text-xl"></i>
                                            </div>
                                            <h3 class="text-lg font-bold text-white leading-tight">
                                                Demasiado lejos 游땞
                                            </h3>
                                        </div>
                                        <button id="hero-close-error-btn" class="text-white/70 hover:text-white transition-colors">
                                            <i class="fas fa-times text-xl"></i>
                                        </button>
                                    </div>
                                    
                                    <!-- Info compacta -->
                                    <div class="bg-white/15 backdrop-blur-sm rounded-xl p-3 mb-3">
                                        <p class="text-white text-sm mb-2">
                                            <i class="fas fa-route mr-1"></i> 
                                            Distancia: <strong>${d.toFixed(1)} km</strong>
                                        </p>
                                        <p class="text-white/80 text-xs">
                                            Cobertura m치xima: ${MAX_DELIVERY_DISTANCE} km
                                        </p>
                                    </div>
                                    
                                    <!-- Alternativa -->
                                    <div class="bg-white/10 backdrop-blur-sm rounded-lg p-3 mb-3">
                                        <p class="text-white text-xs">
                                            <i class="fas fa-store mr-1"></i>
                                            <strong>Recoge en local:</strong><br>
                                            Coahuila 36, Minatitl치n
                                        </p>
                                    </div>
                                    
                                    <!-- Bot칩n compacto -->
                                    <button id="hero-close-error-btn-main" class="w-full bg-white text-red-600 px-4 py-2 rounded-xl font-bold text-sm hover:bg-red-50 transition-all shadow-lg">
                                        Entendido
                                    </button>
                                </div>
                            `;
                            document.body.appendChild(errorMessage);
                            
                            // Event listeners para cerrar (ambos botones)
                            const closeErrorBtn = document.getElementById('hero-close-error-btn');
                            const closeErrorBtnMain = document.getElementById('hero-close-error-btn-main');
                            
                            const closeError = () => {
                                errorMessage.style.opacity = '0';
                                setTimeout(() => errorMessage.remove(), 300);
                            };
                            
                            if (closeErrorBtn) closeErrorBtn.addEventListener('click', closeError);
                            if (closeErrorBtnMain) closeErrorBtnMain.addEventListener('click', closeError);
                        }
                    } else {
                        // 丘멆잺 NO HAY DIRECCI칍N - Pedir que escriba una
                        const warningMessage = document.createElement('div');
                        warningMessage.id = noticeId;
                        warningMessage.className = 'bg-orange-50 border-l-4 border-orange-500 p-4 rounded-lg mt-3 animate-fade-in';
                        warningMessage.innerHTML = `
                            <div class="flex items-center">
                                <i class="fas fa-exclamation-circle text-orange-500 text-xl mr-3"></i>
                                <p class="text-orange-800 font-medium">
                                    丘멆잺 Por favor, escribe tu direcci칩n arriba y haz clic en "Buscar" primero.
                                </p>
                            </div>
                        `;
                        if (preview) preview.appendChild(warningMessage);
                        
                        // Auto-eliminar despu칠s de 5 segundos
                        setTimeout(() => {
                            warningMessage.style.opacity = '0';
                            setTimeout(() => warningMessage.remove(), 300);
                        }, 5000);
                    }
                });
            }
            return;
        }

        try {
            if (!heroGeocoder) heroGeocoder = new google.maps.Geocoder();
            // Centro: ubicaci칩n del restaurante por defecto o la 칰ltima posici칩n elegida
            const center = heroSelectedLatLng || new google.maps.LatLng(RESTAURANT_LOCATION.lat, RESTAURANT_LOCATION.lng);
            heroMap = new google.maps.Map(mapDiv, {
                center,
                zoom: 15,
                mapTypeControl: false,
                streetViewControl: false,
                fullscreenControl: false
            });
            heroMarker = new google.maps.Marker({
                map: heroMap,
                position: center,
                draggable: true,
                icon: {
                    url: 'data:image/svg+xml;base64,' + btoa(`
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="36" height="36">
                            <path fill="#FFB300" d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/>
                        </svg>
                    `),
                    scaledSize: new google.maps.Size(36, 36)
                }
            });

            heroSelectedLatLng = center;
            // Actualizar preview inicial
            updateHeroLocation(center);

            // Drag para ajustar ubicaci칩n
            heroMarker.addListener('dragend', () => {
                const pos = heroMarker.getPosition();
                heroSelectedLatLng = pos;
                updateHeroLocation(pos);
            });

            // Botones del hero
            const geoBtn = document.getElementById('hero-use-geolocation');
            if (geoBtn) {
                geoBtn.addEventListener('click', () => {
                    if (!navigator.geolocation) return;
                    geoBtn.disabled = true;
                    geoBtn.textContent = 'Localizando';
                    navigator.geolocation.getCurrentPosition((res) => {
                        const { latitude, longitude } = res.coords;
                        const pos = new google.maps.LatLng(latitude, longitude);
                        heroSelectedLatLng = pos;
                        heroMap.setCenter(pos);
                        heroMarker.setPosition(pos);
                        updateHeroLocation(pos);
                        geoBtn.disabled = false;
                        geoBtn.textContent = 'Usar mi ubicaci칩n';
                    }, () => {
                        geoBtn.disabled = false;
                        geoBtn.textContent = 'Usar mi ubicaci칩n';
                    }, { enableHighAccuracy: true, timeout: 8000 });
                });
            }

            // NOTA: Event listener para hero-confirm-location ya est치 definido arriba
            // con el modal grande y llamativo. Este c칩digo est치 comentado para evitar duplicados.
            /*
            const confirmBtn = document.getElementById('hero-confirm-location');
            if (confirmBtn) {
                confirmBtn.addEventListener('click', async () => {
                    if (!heroSelectedLatLng) return;
                    const preview = document.getElementById('hero-address-preview');
                    let formatted = '';
                    if (heroGeocoder) {
                        try {
                            const geoRes = await heroGeocoder.geocode({ location: heroSelectedLatLng });
                            if (geoRes && geoRes.results && geoRes.results[0]) {
                                formatted = geoRes.results[0].formatted_address;
                            }
                        } catch (e) { }
                    }
                    if (!formatted) formatted = `Lat ${heroSelectedLatLng.lat().toFixed(5)}, Lng ${heroSelectedLatLng.lng().toFixed(5)}`;

                    // Calcular distancia y zona
                    const distance = calculateDistance(RESTAURANT_LOCATION.lat, RESTAURANT_LOCATION.lng, heroSelectedLatLng.lat(), heroSelectedLatLng.lng());
                    const zone = getDeliveryZone(distance);

                    // Establecer como direcci칩n seleccionada global
                    if (window.google && window.google.maps) {
                        selectedPlace = {
                            formatted_address: formatted,
                            geometry: { location: heroSelectedLatLng }
                        };
                        window.selectedPlace = selectedPlace;
                    }

                    if (zone && zone.price !== null) {
                        userAddress = {
                            formatted_address: formatted,
                            distance: distance,
                            deliveryPrice: zone.price,
                            zone: zone.zone,
                            coordinates: { lat: heroSelectedLatLng.lat(), lng: heroSelectedLatLng.lng() }
                        };
                    } else {
                        userAddress = null;
                    }

                    // Escribir en el input de direcci칩n del checkout si existe
                    const checkoutInput = document.getElementById('address-input');
                    if (checkoutInput) checkoutInput.value = formatted;

                    updateCheckoutTotals();
                    if (preview) {
                        // Quitar aviso anterior
                        const noticeId = 'hero-confirm-notice';
                        const old = document.getElementById(noticeId);
                        if (old) old.remove();
                        const msg = document.createElement('div');
                        msg.id = noticeId;
                        msg.className = 'mt-2 text-sm';
                        if (zone && zone.price !== null) {
                            msg.classList.add('text-green-700');
                            msg.textContent = 'S칤, entregamos en tu zona 九';
                        } else {
                            msg.classList.add('text-red-700');
                            msg.textContent = 'Lo sentimos estas demasiado lejos';
                        }
                        preview.appendChild(msg);
                    }
                });
            }
            */

            // Hero search: Places if available, else Enter/click to fallback geocode
    const heroSearch = document.getElementById('hero-search-input');
    const heroSearchBtn = document.getElementById('hero-search-btn');
        const runHeroSearch = async (el) => {
            if (!el) return;
            const q = el.value.trim();
            if (!q) return;
            try {
                const r = await fallbackGeocodeAddress(q);
                if (r && r.location && window.google && window.google.maps) {
                    const loc = new google.maps.LatLng(r.location.lat, r.location.lng);
                    heroMap.panTo(loc);
                    heroMap.setZoom(15);
                    heroMarker.setPosition(loc);
                    heroSelectedLatLng = loc;
                    updateHeroLocation(loc);
                }
            } catch (err) {
                console.warn('No se pudo geocodificar la b칰squeda del h칠roe', err);
            }
        };
        const hookSearch = (el) => {
        if (!el) return;
                if (google.maps.places) {
                    try {
            const heroAutocomplete = new google.maps.places.Autocomplete(el, {
                            fields: ['geometry','formatted_address'],
                            componentRestrictions: { country: ['mx'] }
                        });
                        heroAutocomplete.addListener('place_changed', () => {
                            const p = heroAutocomplete.getPlace();
                            if (p && p.geometry && p.geometry.location) {
                                const loc = p.geometry.location;
                                heroMap.panTo(loc);
                                heroMap.setZoom(15);
                                heroMarker.setPosition(loc);
                                heroSelectedLatLng = loc;
                                updateHeroLocation(loc);
                            }
                        });
                    } catch (_) { /* ignore */ }
                }
        // Fallback Enter handling (works with or without Places)
        el.addEventListener('keydown', async (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
            runHeroSearch(el);
                    }
        });
        };
    hookSearch(heroSearch);
    if (heroSearchBtn) heroSearchBtn.addEventListener('click', () => runHeroSearch(heroSearch));
        } catch (err) {
            console.error('Error inicializando hero map', err);
        }
    }

    async function updateHeroLocation(latLng) {
        const preview = document.getElementById('hero-address-preview');
        if (!preview) return;
        if (!window.google || !window.google.maps) {
            preview.textContent = 'Google Maps no est치 cargado.';
            return;
        }
        try {
            if (!heroGeocoder) heroGeocoder = new google.maps.Geocoder();
            const res = await heroGeocoder.geocode({ location: latLng });
            const formatted = res && res.results && res.results[0] ? res.results[0].formatted_address : null;
            const { distanceKm, durationMin, source } = await getDeliveryDistanceKmAndDuration(latLng.lat(), latLng.lng());
            const zone = getDeliveryZone(distanceKm);
            if (formatted) {
                const feeText = zone && zone.price !== null ? `$${zone.price}` : 'Lo sentimos estas demasiado lejos';
                const modeText = source === 'driving' ? ' (ruta en carro)' : '';
                const etaText = durationMin ? `  Tiempo: ~${durationMin} min` : '';
                preview.innerHTML = `
                    <div><strong>Direcci칩n:</strong> ${formatted}</div>
                    <div class="text-sm text-gray-700">Distancia: ${distanceKm.toFixed(1)} km${modeText}${etaText}  Env칤o: ${feeText}</div>
                `;
            } else {
                preview.textContent = `Lat ${latLng.lat().toFixed(5)}, Lng ${latLng.lng().toFixed(5)}`;
            }
        } catch (e) {
            preview.textContent = `Lat ${latLng.lat().toFixed(5)}, Lng ${latLng.lng().toFixed(5)}`;
        }
    }
    
    // Funci칩n para configurar entrada libre de texto con simulaci칩n de autocompletado
    function setupFreeTextInput(addressInput) {
        // Asegurar que el campo permita escritura libre
        addressInput.style.backgroundColor = 'white';
        addressInput.removeAttribute('readonly');
        addressInput.removeAttribute('disabled');
        
        console.log('九 Configurando entrada libre de texto con autocompletado simulado');
        
        // Crear contenedor de sugerencias
        let suggestionsContainer = document.getElementById('address-suggestions');
        if (!suggestionsContainer) {
            suggestionsContainer = document.createElement('div');
            suggestionsContainer.id = 'address-suggestions';
            suggestionsContainer.className = 'absolute top-full left-0 right-0 bg-white border border-gray-200 rounded-lg shadow-lg z-50 hidden';
            addressInput.parentElement.appendChild(suggestionsContainer);
        }
        
        // Direcciones de ejemplo para 치rea de cobertura (hasta 7 km desde Coahuila 36)
        const sampleAddresses = [
            'Coahuila 36, Col. 10 de Mayo, Minatitl치n, Veracruz (SEDE)',
            'Calle Zaragoza 123, Col. Centro, Minatitl치n, Veracruz',
            'Av. Hidalgo 456, Col. Deportiva, Minatitl치n, Veracruz',
            'Calle Morelos 789, Col. Petrolera, Minatitl치n, Veracruz',
            'Av. Universidad 321, Col. Universitaria, Minatitl치n, Veracruz',
            'Calle Ju치rez 654, Col. Centro, Minatitl치n, Veracruz',
            'Av. Insurgentes 987, Col. Las Flores, Minatitl치n, Veracruz',
            'Calle Galeana 147, Col. Emiliano Zapata, Minatitl치n, Veracruz',
            'Av. 20 de Noviembre 258, Col. Benito Ju치rez, Minatitl치n, Veracruz',
            'Calle Aldama 369, Col. La Cangrejera, Minatitl치n, Veracruz',
            'Av. Obreg칩n 741, Col. Insurgentes, Minatitl치n, Veracruz',
            'Calle Victoria 852, Col. Francisco Villa, Minatitl치n, Veracruz',
            'Av. Reforma 963, Col. 10 de Mayo, Minatitl치n, Veracruz'
        ];
        
        // Event listener para mostrar sugerencias
        addressInput.addEventListener('input', function(e) {
            const value = e.target.value.trim();
            console.log('Direcci칩n escrita:', value, 'Longitud:', value.length);
            
            if (value.length >= 3) {
                // Filtrar direcciones que coincidan
                const matches = sampleAddresses.filter(addr => 
                    addr.toLowerCase().includes(value.toLowerCase())
                );
                
                if (matches.length > 0) {
                    showSuggestions(matches, value);
                } else {
                    hideSuggestions();
                }
                
                // Simular validaci칩n despu칠s de ciertos caracteres
                if (value.length > 10) {
                    showAddressConfirmation(value);
                }
            } else {
                hideSuggestions();
            }
        });

        // Validar de inmediato al presionar Enter
        addressInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                const value = addressInput.value.trim();
                if (value.length >= 3) {
                    showAddressConfirmation(value);
                }
            }
        });
        
        // Funci칩n para mostrar sugerencias
        function showSuggestions(suggestions, query) {
            suggestionsContainer.innerHTML = suggestions.slice(0, 5).map(addr => {
                const isSede = addr.includes('SEDE');
                return `
                <div class="suggestion-item p-3 hover:bg-gray-50 cursor-pointer border-b border-gray-100 last:border-b-0 ${isSede ? 'bg-blue-50 border-blue-200' : ''}"
                     onclick="selectSuggestion('${addr}')">
                    <div class="flex items-center space-x-2">
                        <i class="fas fa-map-marker-alt ${isSede ? 'text-blue-600' : 'text-blue-500'}"></i>
                        <div class="flex-grow">
                            <div class="font-medium text-gray-800">${highlightMatch(addr, query)}</div>
                            <div class="text-xs ${isSede ? 'text-blue-600 font-semibold' : 'text-gray-500'}">
                                ${isSede ? '游낅 Nuestra ubicaci칩n principal' : '츼rea de cobertura de entrega'}
                            </div>
                        </div>
                        ${isSede ? '<span class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded-full">SEDE</span>' : ''}
                    </div>
                </div>
            `}).join('');
            
            suggestionsContainer.classList.remove('hidden');
        }
        
        // Funci칩n para resaltar coincidencias
        function highlightMatch(text, query) {
            const regex = new RegExp(`(${query})`, 'gi');
            return text.replace(regex, '<mark class="bg-yellow-200">$1</mark>');
        }
        
        // Funci칩n para ocultar sugerencias
        function hideSuggestions() {
            suggestionsContainer.classList.add('hidden');
        }
        
        // Funci칩n global para seleccionar sugerencia
        window.selectSuggestion = function(address) {
            addressInput.value = address;
            hideSuggestions();
            showAddressConfirmation(address);
        };
        
        // Confirmaci칩n y validaci칩n con geocoding de respaldo
        async function showAddressConfirmation(address) {
            const mapContainer = document.getElementById('map-container');
            const selectedAddressDiv = document.getElementById('selected-address');
            if (!mapContainer || !selectedAddressDiv) return;

            mapContainer.classList.remove('hidden');
            selectedAddressDiv.innerHTML = `
                <div class="flex items-start space-x-2">
                    <i class="fas fa-map-marker-alt text-green-600 mt-1"></i>
                    <div>
                        <div class="font-medium text-gray-800">${address}</div>
                    </div>
                </div>
            `;

            try {
                const result = await fallbackGeocodeAddress(address);
                if (!result) {
                    showAddressError('No se pudo localizar esa direcci칩n. Intenta ser m치s espec칤fico.');
                    return;
                }
                const lat = result.location.lat;
                const lng = result.location.lng;
                const distance = calculateDistance(RESTAURANT_LOCATION.lat, RESTAURANT_LOCATION.lng, lat, lng);
                const zone = getDeliveryZone(distance);

                if (zone.price !== null) {
                    userAddress = {
                        formatted_address: result.formatted_address,
                        distance,
                        deliveryPrice: zone.price,
                        zone: zone.zone,
                        coordinates: { lat, lng }
                    };

                    selectedAddressDiv.innerHTML = `
                        <div class="flex items-start space-x-2">
                            <i class="fas fa-map-marker-alt text-green-600 mt-1"></i>
                            <div>
                                <div class="font-medium text-gray-800">${result.formatted_address}</div>
                                <div class="text-xs text-blue-600 mt-1">
                                    <i class="fas fa-route mr-1"></i>
                                    Aproximadamente ${distance.toFixed(1)} km desde SR & SRA BURGER
                                </div>
                            </div>
                        </div>
                    `;

                    showDeliveryZoneInfo({
                        name: zone.zone,
                        distance,
                        fee: zone.price,
                        time: distance <= 4 ? '25-35 min' : '35-45 min',
                        description: zone.description,
                        color: zone.color
                    });
                    updateCheckoutTotals();
                } else {
                    userAddress = null;
                    // Mostrar mensaje exacto solicitado
                    const existingInfo = mapContainer.querySelector('.zone-info');
                    if (existingInfo) existingInfo.remove();
                    const warning = document.createElement('div');
                    warning.className = 'zone-info bg-red-50 border border-red-200 rounded-lg p-3 mt-2';
                    warning.innerHTML = `
                        <div class="flex items-center space-x-2">
                            <i class="fas fa-exclamation-triangle text-red-600"></i>
                            <div>
                                <div class="font-medium text-red-800">Lo sentimos estas demasiado lejos</div>
                                <div class="text-sm text-red-700">Tu direcci칩n est치 a ${distance.toFixed(1)} km. Solo entregamos dentro de ${MAX_DELIVERY_DISTANCE} km.</div>
                            </div>
                        </div>
                    `;
                    mapContainer.appendChild(warning);
                }
            } catch (e) {
                console.error('Fallback geocoding failed', e);
                showAddressError('No se pudo validar la direcci칩n en este momento.');
            }
        }
        
        // Ocultar sugerencias al hacer clic fuera
        document.addEventListener('click', function(e) {
            if (!addressInput.contains(e.target) && !suggestionsContainer.contains(e.target)) {
                hideSuggestions();
            }
        });
        
    console.log('九 Entrada libre de texto con autocompletado simulado configurada');
    }
    
    function onPlaceChanged() {
        const place = autocomplete && typeof autocomplete.getPlace === 'function'
            ? autocomplete.getPlace()
            : null;

        if (!place || !place.formatted_address) {
            console.log('仇 No se encontraron detalles para esta direcci칩n');
            showAddressError('No se encontraron detalles para esta direcci칩n');
            return;
        }

        // Guardar solo la direcci칩n; geometry puede faltar y no la necesitamos
        selectedPlace = {
            formatted_address: place.formatted_address,
            geometry: place.geometry && place.geometry.location
                ? { location: place.geometry.location }
                : null
        };
        window.selectedPlace = selectedPlace;

        displaySelectedAddress(selectedPlace);
        // Si tenemos coordenadas, validar cobertura/costo con distancia por ruta
        if (selectedPlace.geometry && selectedPlace.geometry.location) {
            validateAddressZone(selectedPlace);
        }

        console.log('游늸 Direcci칩n seleccionada:', selectedPlace.formatted_address);
    }
    
    function displaySelectedAddress(place) {
        const selectedAddressDiv = document.getElementById('selected-address');
        
        if (!selectedAddressDiv) return;

        const text = (place && place.formatted_address) ? String(place.formatted_address) : '';
        selectedAddressDiv.innerHTML = `
            <div class="flex items-start space-x-2">
                <i class="fas fa-map-marker-alt text-green-600 mt-1"></i>
                <div>
                    <div class="font-medium text-gray-800">${text}</div>
                </div>
            </div>
        `;
    }
    
    async function validateAddressZone(place) {
        if (!place || !place.geometry || !place.geometry.location) return;

        const coords = getCoordsFromLocation(place.geometry.location);
        if (!coords) return;
        const lat = coords.lat;
        const lng = coords.lng;

        deliveryCalcPending++;
        updateCheckoutTotals();

        let distanceKm = null;
        let durationMin = null;
        let source = 'haversine';

        try {
            const r = await getDeliveryDistanceKmAndDuration(lat, lng);
            distanceKm = r && typeof r.distanceKm === 'number' ? r.distanceKm : null;
            durationMin = r && typeof r.durationMin === 'number' ? r.durationMin : null;
            source = (r && r.source) || 'haversine';
        } catch (e) {
            console.warn('丘멆잺 validateAddressZone fall칩; usando Haversine:', e);
            distanceKm = calculateDistance(RESTAURANT_LOCATION.lat, RESTAURANT_LOCATION.lng, lat, lng);
            durationMin = null;
            source = 'haversine';
        } finally {
            deliveryCalcPending = Math.max(0, deliveryCalcPending - 1);
        }

        if (typeof distanceKm !== 'number' || !isFinite(distanceKm)) {
            userAddress = null;
            updateCheckoutTotals();
            return;
        }

        const deliveryZone = getDeliveryZone(distanceKm);

        if (deliveryZone.price !== null) {
            userAddress = {
                formatted_address: place.formatted_address,
                distance: distanceKm,
                deliveryPrice: deliveryZone.price,
                zone: deliveryZone.zone,
                coordinates: { lat: lat, lng: lng },
                durationMin: durationMin,
                distanceSource: source
            };

            // Persist delivery info for reuse (localStorage)
            try {
                const payload = {
                    formatted_address: userAddress.formatted_address,
                    lat: lat,
                    lng: lng,
                    distance: distanceKm,
                    deliveryPrice: deliveryZone.price,
                    savedAt: Date.now()
                };
                localStorage.setItem('clientDeliveryInfo', JSON.stringify(payload));
            } catch (_) {}

            showDeliveryZoneInfo({
                name: deliveryZone.zone,
                distance: distanceKm,
                fee: deliveryZone.price,
                time: getEtaText(distanceKm, durationMin),
                description: deliveryZone.description,
                color: deliveryZone.color
            });

            updateCheckoutTotals();
        } else {
            userAddress = null;
            showDeliveryZoneWarning(distanceKm);
            updateCheckoutTotals();
        }
    }

    async function estimateDeliveryDistance(place) {
        const selectedAddressDiv = document.getElementById('selected-address');
        if (!selectedAddressDiv) return;

        const existing = selectedAddressDiv.querySelector('[data-distance-info]');
        if (existing) existing.remove();

        if (!place || !place.geometry || !place.geometry.location) return;

        // Si ya tenemos userAddress con costo, no mostrar "Calculando ruta..."
        let distanceInfo = selectedAddressDiv.querySelector('[data-distance-info]');
        if (!distanceInfo) {
            distanceInfo = document.createElement('div');
            distanceInfo.dataset.distanceInfo = '1';
            distanceInfo.className = 'text-xs text-blue-600 mt-1';
            if (!userAddress || typeof userAddress.deliveryPrice !== 'number') {
                distanceInfo.innerHTML = `
                    <i class="fas fa-route mr-1"></i>
                    Calculando ruta...
                `;
            } else {
                // Mantener el contenedor sin texto; se llenar치 abajo con los datos finales
                distanceInfo.innerHTML = '';
            }
            selectedAddressDiv.appendChild(distanceInfo);
        }

        const coords = getCoordsFromLocation(place.geometry.location);
        if (!coords) return;
        const customerLat = coords.lat;
        const customerLng = coords.lng;

        deliveryCalcPending++;
        updateCheckoutTotals();

        let distanceKm = null;
        let durationMin = null;
        let source = 'haversine';

        try {
            const r = await getDeliveryDistanceKmAndDuration(customerLat, customerLng);
            distanceKm = r && typeof r.distanceKm === 'number' ? r.distanceKm : null;
            durationMin = r && typeof r.durationMin === 'number' ? r.durationMin : null;
            source = (r && r.source) || 'haversine';
        } catch (e) {
            console.warn('丘멆잺 estimateDeliveryDistance fall칩; usando Haversine:', e);
            distanceKm = calculateDistance(RESTAURANT_LOCATION.lat, RESTAURANT_LOCATION.lng, customerLat, customerLng);
            durationMin = null;
            source = 'haversine';
        } finally {
            deliveryCalcPending = Math.max(0, deliveryCalcPending - 1);
        }

        if (typeof distanceKm !== 'number' || !isFinite(distanceKm)) {
            distanceInfo.innerHTML = `
                <i class="fas fa-route mr-1"></i>
                No se pudo calcular la ruta en este momento.
            `;
            updateCheckoutTotals();
            return;
        }

        const etaText = (typeof durationMin === 'number' && isFinite(durationMin) && durationMin > 0)
            ? `  ~${durationMin} min`
            : '';
        const fee = calculateDeliveryPrice(distanceKm);
        const feeText = (fee !== null) ? `  Env칤o: $${fee} ($${COSTO_POR_KM}/km)` : '';

        distanceInfo.innerHTML = `
            <i class="fas fa-route mr-1"></i>
            La distancia es de ${distanceKm.toFixed(1)} km, cobra ${COSTO_POR_KM} pesos por KM${feeText}${etaText}
        `;

        // Fallback: si el c치lculo informativo obtuvo fee v치lido, establecer userAddress para totales
        if (fee !== null) {
            try {
                const zoneInfo = getDeliveryZone(distanceKm);
                userAddress = {
                    formatted_address: place.formatted_address,
                    distance: distanceKm,
                    deliveryPrice: zoneInfo.price,
                    zone: zoneInfo.zone,
                    coordinates: { lat: customerLat, lng: customerLng },
                    durationMin: durationMin,
                    distanceSource: source
                };

                // Persist delivery info for reuse
                try {
                    const payload = {
                        formatted_address: userAddress.formatted_address,
                        lat: customerLat,
                        lng: customerLng,
                        distance: distanceKm,
                        deliveryPrice: zoneInfo.price,
                        savedAt: Date.now()
                    };
                    localStorage.setItem('clientDeliveryInfo', JSON.stringify(payload));
                } catch (_) {}
            } catch (_) { /* ignore */ }
        }

        // Refrescar totales/estado aunque el c치lculo sea solo informativo
        updateCheckoutTotals();
    }
    
    function showDeliveryZoneInfo(zone) {
        const mapContainer = document.getElementById('map-container');
        if (!mapContainer) return;
        
        // Limpiar informaci칩n anterior
        const existingInfo = mapContainer.querySelector('.zone-info');
        if (existingInfo) existingInfo.remove();
        
        const colorClass = zone.color === 'green' ? 'green' : 'orange';
        const bgClass = `bg-${colorClass}-50`;
        const borderClass = `border-${colorClass}-200`;
        const textClass = `text-${colorClass}-800`;
        const iconClass = `text-${colorClass}-600`;
        
        const zoneInfo = document.createElement('div');
        zoneInfo.className = `zone-info ${bgClass} border ${borderClass} rounded-lg p-3 mt-2`;
        zoneInfo.innerHTML = `
            <div class="flex items-center space-x-2">
                <i class="fas fa-check-circle ${iconClass}"></i>
                <div class="flex-1">
                    <div class="font-medium ${textClass}">${zone.name} - ${zone.distance.toFixed(1)} km</div>
                    <div class="text-xs ${textClass}/70">${zone.description}</div>
                </div>
                <div class="text-right">
                    <div class="font-bold ${textClass}">$${zone.fee}</div>
                    <div class="text-xs ${textClass}/70">${zone.time}</div>
                </div>
            </div>
        `;
        mapContainer.appendChild(zoneInfo);
        const tip = document.getElementById('maps-help-text');
        if (tip) tip.classList.add('hidden');
    }
    
    // Funci칩n fallback para cuando Google Maps no est치 disponible en el hero
    function setupHeroLocationFallback() {
        console.log('游늸 Configurando ubicaci칩n del hero sin Google Maps');
        
        const heroMapElement = document.getElementById('hero-map');
        if (heroMapElement) {
            heroMapElement.innerHTML = `
                <div class="flex items-center justify-center h-full bg-gradient-to-br from-yellow-50 to-orange-50 rounded-lg border-2 border-dashed border-yellow-300">
                    <div class="text-center p-6">
                        <i class="fas fa-map-marker-alt text-yellow-600 text-4xl mb-3"></i>
                        <h3 class="font-bold text-gray-800 mb-2">SR & SRA BURGER</h3>
                        <p class="text-sm text-gray-600 mb-1">Coahuila 36, Col. 10 de Mayo</p>
                        <p class="text-sm text-gray-600 mb-3">Minatitl치n, Veracruz</p>
                        <div class="bg-green-100 text-green-800 text-xs px-3 py-1 rounded-full inline-block">
                            <i class="fas fa-clock mr-1"></i>
                            Entrega disponible 4-7 km
                        </div>
                    </div>
                </div>
            `;
        }
        
        // Configurar bot칩n "Usar mi ubicaci칩n" sin GPS real
        const useLocationBtn = document.getElementById('use-location-btn');
        if (useLocationBtn) {
            useLocationBtn.onclick = function() {
                // Simular que se est치 obteniendo la ubicaci칩n
                useLocationBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Obteniendo ubicaci칩n...';
                useLocationBtn.disabled = true;
                
                setTimeout(() => {
                    useLocationBtn.innerHTML = '<i class="fas fa-exclamation-triangle mr-2"></i>Ubicaci칩n no disponible';
                    useLocationBtn.disabled = true;
                    
                    // Mostrar mensaje alternativo
                    const heroSection = document.getElementById('hero-location');
                    if (heroSection) {
                        const infoDiv = document.createElement('div');
                        infoDiv.className = 'mt-4 bg-blue-50 border border-blue-200 rounded-lg p-3';
                        infoDiv.innerHTML = `
                            <div class="flex items-start space-x-2">
                                <i class="fas fa-info-circle text-blue-600 mt-0.5"></i>
                                <div class="text-sm text-blue-800">
                                    <strong>Tip:</strong> Puedes escribir tu direcci칩n manualmente en el formulario de pedido para calcular el costo de env칤o.
                                </div>
                            </div>
                        `;
                        heroSection.appendChild(infoDiv);
                    }
                }, 2000);
            };
        }
    }
    
    // (Eliminado) showDeliveryZoneInfo duplicado: se usa la versi칩n anterior que recibe un solo objeto.
    
    function showDeliveryZoneWarning(distance) {
        const mapContainer = document.getElementById('map-container');
        if (!mapContainer) return;
        
        // Limpiar informaci칩n anterior
        const existingInfo = mapContainer.querySelector('.zone-info');
        if (existingInfo) existingInfo.remove();
        
        const warning = document.createElement('div');
        warning.className = 'zone-info bg-red-50 border border-red-200 rounded-lg p-3 mt-2';
        warning.innerHTML = `
            <div class="flex items-center space-x-2">
                <i class="fas fa-exclamation-triangle text-red-600"></i>
                <div>
                    <div class="font-medium text-red-800">Lo sentimos estas demasiado lejos</div>
                    <div class="text-sm text-red-700">
                        Tu direcci칩n est치 a ${distance.toFixed(1)} km. Solo entregamos dentro de un radio de ${MAX_DELIVERY_DISTANCE} km desde nuestro restaurante.
                    </div>
                    <div class="text-xs text-red-600 mt-2">
                        <strong>Zonas de entrega:</strong><br>
                         Tarifa: $${COSTO_POR_KM} por KM (se redondea hacia abajo)<br>
                         Cobertura m치xima: ${MAX_DELIVERY_DISTANCE} km
                    </div>
                </div>
            </div>
        `;
        mapContainer.appendChild(warning);
        mapContainer.classList.remove('hidden');
    }
    
    function showAddressError(message) {
        const addressInput = document.getElementById('address-input');
        if (!addressInput) return;
        
        addressInput.classList.add('border-red-500');
        
        const errorDiv = document.createElement('div');
        errorDiv.className = 'text-red-600 text-sm mt-1';
        errorDiv.innerHTML = `<i class="fas fa-exclamation-circle mr-1"></i>${message}`;
        
        addressInput.parentNode.appendChild(errorDiv);
        
        setTimeout(() => {
            addressInput.classList.remove('border-red-500');
            errorDiv.remove();
        }, 5000);
    }
    
    function initializeMiniMap() { return; }

    function getCoordsFromLocation(location) {
        try {
            if (!location) return null;
            const lat = typeof location.lat === 'function' ? location.lat() : location.lat;
            const lng = typeof location.lng === 'function' ? location.lng() : location.lng;
            const latNum = Number(lat);
            const lngNum = Number(lng);
            if (!Number.isFinite(latNum) || !Number.isFinite(lngNum)) return null;
            return { lat: latNum, lng: lngNum };
        } catch (_) {
            return null;
        }
    }
    
    // Fallback if Google Maps fails to load
    setTimeout(() => {
        if (!window.google) {
            console.log('丘멆잺 Google Maps no se carg칩; funcionar치 la validaci칩n con direcci칩n escrita.');
            
            // Asegurar que el campo de direcci칩n funcione sin Google Maps
            const addressInput = document.getElementById('address-input');
            if (addressInput && !autocomplete) {
                console.log('游댢 Configurando autocompletado simulado...');
                setupFreeTextInput(addressInput);
                
                // Mostrar mensaje informativo al usuario
                showGoogleMapsInfo();
            }
        } else {
            console.log('九 Google Maps cargado correctamente');
        }
    }, 3500);
    
    // Funci칩n para mostrar informaci칩n sobre Google Maps
    function showGoogleMapsInfo() {
        const helpText = document.getElementById('maps-help-text') || document.querySelector('.text-xs.text-gray-500');
        if (helpText) {
            helpText.innerHTML = `
                <i class="fas fa-info-circle text-blue-500 mr-1"></i>
                Escribe tu direcci칩n completa y validaremos la distancia desde Coahuila 36. El env칤o se calcula a $${COSTO_POR_KM}/km (redondeo al entero m치s cercano, m치ximo ${MAX_DELIVERY_DISTANCE} km).
            `;
            helpText.classList.remove('text-gray-500');
            helpText.classList.add('text-blue-600');
        }
    }

    // Fallback geocoding with OpenStreetMap Nominatim (no API key required)
    async function fallbackGeocodeAddress(query) {
        // Prefer local proxy to avoid CORS and attach headers; try both 3000 and 3001
        const bases = API_BASES || [''];
        let best = null;
        let lastErr;
        for (const base of bases) {
            try {
                const url = `${base}/api/geocode?q=${encodeURIComponent(query + ', Minatitl치n, Veracruz, M칠xico')}`;
                const resp = await fetch(url);
                if (!resp.ok) { lastErr = new Error(`HTTP ${resp.status}`); continue; }
                const data = await resp.json();
                const arr = data && data.data;
                if (Array.isArray(arr) && arr.length) { best = arr[0]; break; }
            } catch (e) { lastErr = e; continue; }
        }
        if (!best) throw lastErr || new Error('Geocoding error');
        return {
            formatted_address: best.display_name,
            location: { lat: parseFloat(best.lat), lng: parseFloat(best.lon) }
        };
    }
    
    // Inicializaci칩n inmediata del campo de direcci칩n (sin esperar Google Maps)
    const addressInput = document.getElementById('address-input');
    if (addressInput) {
        // Asegurar que el campo est칠 disponible para escritura desde el inicio
        addressInput.removeAttribute('readonly');
        addressInput.removeAttribute('disabled');
        addressInput.style.backgroundColor = 'white';
        addressInput.style.pointerEvents = 'auto';
        addressInput.style.opacity = '1';
        
        // Agregar event listener para monitorear la escritura
        addressInput.addEventListener('input', function(e) {
            console.log('Direcci칩n actual:', e.target.value, 'Longitud:', e.target.value.length);
        });
        
        // Agregar event listener para asegurar que siempre se pueda escribir
        addressInput.addEventListener('keydown', function(e) {
            // Permitir todas las teclas normales de escritura
            if (e.key.length === 1 || ['Backspace', 'Delete', 'ArrowLeft', 'ArrowRight', 'Home', 'End'].includes(e.key)) {
                // No bloquear ninguna tecla de escritura
                return true;
            }
        });
        
        console.log('九 Campo de direcci칩n habilitado para escritura libre desde el inicio');
    }

    // Funci칩n para agregar pedido al sistema de control de env칤os
    function addToOrderControl() {
        try {
            // Obtener datos del formulario
            const customerName = customerNameInput ? customerNameInput.value.trim() : '';
            const customerPhone = customerPhoneInput ? customerPhoneInput.value.trim() : '';
            const deliveryTypeElement = document.querySelector('input[name="delivery-type"]:checked');
            const paymentMethodElement = document.querySelector('input[name="payment"]:checked');
            
            if (!customerName || !customerPhone || !deliveryTypeElement || !paymentMethodElement) {
                console.error('Faltan datos requeridos para agregar al control de env칤os');
                return;
            }
            
            const deliveryTypeValue = deliveryTypeElement.value;
            const paymentMethod = paymentMethodElement.value;
            
            // Obtener direcci칩n
            let address = '';
            if (deliveryTypeValue === 'delivery') {
                const addressInput = document.getElementById('address-input');
                if (addressInput) {
                    address = addressInput.value.trim();
                }
                
                // Usar direcci칩n validada por Google Maps si est치 disponible
                if (window.selectedPlace && window.selectedPlace.formatted_address) {
                    address = window.selectedPlace.formatted_address;
                }
            } else {
                address = 'Recoger en local - SR & SRA BURGER';
            }
            
            // Obtener monto en efectivo si aplica
            let cashAmount = '';
            if (paymentMethod === 'Efectivo') {
                const cashAmountInput = document.getElementById('cash-amount');
                if (cashAmountInput && cashAmountInput.value.trim()) {
                    cashAmount = parseFloat(cashAmountInput.value.trim()).toFixed(2);
                }
            }
            
            // Convertir items del carrito al formato requerido
            const orderItems = cart.map(item => {
                let itemName = item.baseItem.name;
                let customizations = '';
                
                if (item.isCombo) {
                    // Para combos, agregar detalles de las elecciones
                    const choiceDetails = item.choices.map(choice => {
                        let text = choice.burger.name;
                        if (choice.customizations && choice.customizations.length > 0) {
                            text += ` (+ ${choice.customizations.map(c => c.name).join(', ')})`;
                        }
                        if (choice.fries) {
                            text += `, Papas ${choice.fries.type}`;
                        }
                        if (choice.onionRings) {
                            text += `, Aros de Cebolla`;
                        }
                        return text;
                    }).join(' | ');
                    customizations = choiceDetails;
                } else {
                    // Para items individuales
                    const details = [];
                    if (item.customizations && item.customizations.length > 0) {
                        details.push(`+ ${item.customizations.map(c => c.name).join(', ')}`);
                    }
                    if (item.fries) {
                        details.push(`Papas ${item.fries.type}`);
                    }
                    if (!item.fries && item.freeFriesIncluded && item.freeFriesIncluded.name) {
                        details.push(`${item.freeFriesIncluded.name} (GRATIS)`);
                    }
                    if (item.onionRings) {
                        details.push('Aros de Cebolla');
                    }
                    if (item.menuExtras && item.menuExtras.length > 0) {
                        item.menuExtras.forEach(extra => {
                            details.push(`${extra.quantity}x ${extra.name}`);
                        });
                    }
                    customizations = details.join(', ');
                }
                
                const baseId = Number(item.baseItem && item.baseItem.id);
                const unitPrice = Number(item.price || 0);
                return {
                    id: baseId,
                    productId: baseId,
                    name: itemName,
                    quantity: item.quantity,
                    unitPrice: parseFloat(unitPrice.toFixed(2)),
                    price: parseFloat((unitPrice * item.quantity).toFixed(2)),
                    customizations: customizations || ''
                };
            });
            
            // Calcular totales
            const pricing = computeCheckoutPricing(deliveryTypeValue);
            const subtotal = Number(pricing.subtotal || 0);
            const deliveryCost = Number(pricing.deliveryFee || 0);
            const total = Number(pricing.total || 0);
            
            // Crear notas especiales
            let notes = '';
            if (paymentMethod === 'Efectivo' && cashAmount) {
                const change = parseFloat(cashAmount) - total;
                notes += `Pago: $${cashAmount} | Cambio: $${change.toFixed(2)}`;
            }
            if (paymentMethod !== 'Efectivo') {
                notes += `Pago: ${paymentMethod}`;
            }

            if (pricing.rewardApplied && pricing.reward && pricing.reward.label) {
                notes += (notes ? ' | ' : '') + `Recompensa: ${pricing.reward.label}`;
            }

            if (pricing.discountCode) {
                notes += (notes ? ' | ' : '') + `Cup칩n: ${pricing.discountCode}`;
            }

            // Intentar asociar el pedido al usuario autenticado (para puntos)
            let clienteId = null;
            try {
                if (window.firebaseClientManager && typeof window.firebaseClientManager.getCurrentUser === 'function') {
                    const u = window.firebaseClientManager.getCurrentUser();
                    if (u && u.uid) clienteId = u.uid;
                } else if (window.firebaseAuth && window.firebaseAuth.currentUser) {
                    clienteId = window.firebaseAuth.currentUser.uid;
                }
            } catch (_) {
                // Si falla, seguimos sin clienteId (pedido an칩nimo)
            }
            
            // Crear objeto de datos del pedido
            const orderData = {
                customer: {
                    name: customerName,
                    phone: customerPhone,
                    address: address
                },
                items: orderItems,
                // Totales y desglose (flujo secundario sin recompensas)
                subtotal: parseFloat(subtotal.toFixed(2)),
                subtotalAfterDiscount: parseFloat(Number(pricing.subtotalAfterDiscount || subtotal).toFixed(2)),
                deliveryFee: parseFloat(deliveryCost.toFixed(2)),
                total: parseFloat(total.toFixed(2)),
                notes: notes || '',
                deliveryType: deliveryTypeValue,
                paymentMethod: paymentMethod,
                clienteId: clienteId || undefined,
                discountAmount: Number(pricing.discountAmount || 0),
                discountReason: pricing.discountReason || undefined,
                discountCode: pricing.discountCode || undefined,
                discountCodeAmount: pricing.discountCodeAmount || 0,
                rewardDiscountAmount: pricing.rewardDiscountAmount || 0,
                reward: (pricing.rewardApplied && pricing.reward) ? pricing.reward : undefined
            };
            
            console.log('游닇 Enviando pedido a Firebase...', orderData);
            
            // Enviar a Firebase usando el manager global
            if (window.firebaseOrderManager) {
                window.firebaseOrderManager.addOrder(orderData)
                    .then((res) => {
                        const orderId = typeof res === 'object' ? res.id : res;
                        const orderNumber = typeof res === 'object' && res.orderNumber ? res.orderNumber : null;
                        console.log('九 Pedido guardado en Firebase con ID:', orderId, 'No. Orden:', orderNumber);
                        // Mostrar n칰mero de orden en el modal de 칠xito si existe
                        setLastOrderNumber(orderNumber);
                        showNotification('춰Pedido enviado exitosamente!', 'success');
                    })
                    .catch((error) => {
                        console.error('仇 Error al guardar en Firebase:', error);
                        // Fallback: guardar en localStorage si Firebase falla
                        const localNumber = saveToLocalStorageBackup(orderData);
                        setLastOrderNumber(localNumber);
                        showNotification('Pedido guardado localmente (sin conexi칩n)', 'warning');
                    });
            } else {
                console.warn('丘멆잺 Firebase no est치 disponible, guardando en localStorage');
                const localNumber = saveToLocalStorageBackup(orderData);
                setLastOrderNumber(localNumber);
                showNotification('Pedido guardado localmente', 'warning');
            }
            
        } catch (error) {
            console.error('Error al procesar pedido:', error);
            showNotification('Error al procesar el pedido', 'error');
        }
    }

    // Funci칩n de respaldo para localStorage
    // Si se pasa un orderNumber expl칤cito, se usa ese; de lo contrario se genera uno nuevo
    function saveToLocalStorageBackup(orderData, explicitOrderNumber) {
        try {
            const existingOrders = JSON.parse(localStorage.getItem('orders') || '[]');
            // Generar n칰mero de orden local: YYYYMMDD-XYZ
            const now = new Date();
            const yyyy = now.getFullYear();
            const mm = String(now.getMonth() + 1).padStart(2, '0');
            const dd = String(now.getDate()).padStart(2, '0');
            const rand = Math.floor(Math.random() * 900) + 100;
            const orderNumber = explicitOrderNumber || `${yyyy}${mm}${dd}-${rand}`;
            const newOrder = {
                id: Date.now().toString(),
                timestamp: new Date().toISOString(),
                status: 'pending',
                orderNumber,
                customer: orderData.customer,
                items: orderData.items,
                total: orderData.total,
                notes: orderData.notes || '',
                deliveryType: orderData.deliveryType,
                paymentMethod: orderData.paymentMethod,
                estimatedTime: calculateEstimatedTime(orderData.items),
                confirmed: false,
                onWaySent: false,
                arrivedSent: false
            };
            
            existingOrders.unshift(newOrder);
            localStorage.setItem('orders', JSON.stringify(existingOrders));
            console.log('游 Pedido guardado en localStorage como respaldo');
            return orderNumber;
        } catch (error) {
            console.error('Error al guardar en localStorage:', error);
            return null;
        }
    }

    // Guardar y pintar el 칰ltimo n칰mero de orden en el modal
    function setLastOrderNumber(orderNumber) {
        const span = document.getElementById('order-number-display');
        const link = document.getElementById('track-order-link');
        const copyBtn = document.getElementById('copy-order-number');
        if (span && orderNumber) span.textContent = orderNumber;
        if (link && orderNumber) link.href = `tuenvio.html?order=${encodeURIComponent(orderNumber)}`;
        try { updateOrderSuccessWhatsAppLink(orderNumber); } catch (_) {}
        if (copyBtn && orderNumber) {
            copyBtn.onclick = () => {
                navigator.clipboard.writeText(orderNumber).then(() => {
                    showNotification('N칰mero de orden copiado', 'success');
                }).catch(() => {});
            };
        }
    }

    // Funci칩n para mostrar notificaciones
    function showNotification(message, type = 'info') {
        // Crear elemento de notificaci칩n
        const notification = document.createElement('div');
        notification.className = `fixed top-4 right-4 z-50 p-4 rounded-lg shadow-lg max-w-sm transition-all duration-300 transform translate-x-full`;
        
        // Estilos seg칰n tipo
        const styles = {
            success: 'bg-green-500 text-white',
            error: 'bg-red-500 text-white',
            warning: 'bg-yellow-500 text-white',
            info: 'bg-blue-500 text-white'
        };
        
        notification.className += ` ${styles[type] || styles.info}`;
        notification.innerHTML = `
            <div class="flex items-center">
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : type === 'warning' ? 'exclamation-triangle' : 'info-circle'} mr-2"></i>
                <span>${message}</span>
            </div>
        `;
        
        document.body.appendChild(notification);
        
        // Mostrar con animaci칩n
        setTimeout(() => {
            notification.classList.remove('translate-x-full');
        }, 100);
        
        // Ocultar despu칠s de 3 segundos
        setTimeout(() => {
            notification.classList.add('translate-x-full');
            setTimeout(() => {
                if (notification.parentNode) {
                    document.body.removeChild(notification);
                }
            }, 300);
        }, 3000);
    }
    
    // Funci칩n auxiliar para calcular tiempo estimado
    function calculateEstimatedTime(items) {
        // Tiempo base + tiempo por item
        const baseTime = 15;
        const timePerItem = 5;
        return baseTime + (items.length * timePerItem);
    }


// Funci칩n global para controlar las pesta침as m칩viles de promociones
function showMobilePromo(category) {
    console.log('Cambiando a pesta침a:', category);
    
    // Remover clase activa de todas las pesta침as y resetear estilos
    const tabs = document.querySelectorAll('.mobile-promo-tab');
    tabs.forEach(tab => {
        tab.classList.remove('active');
        // Resetear estilos de tab inactiva
        tab.className = 'mobile-promo-tab flex-shrink-0 bg-gray-200 text-gray-700 px-4 py-2 rounded-full text-sm font-bold';
    });
    
    // Ocultar todo el contenido
    const contents = document.querySelectorAll('.mobile-promo-content');
    contents.forEach(content => {
        content.classList.add('hidden');
        content.classList.remove('active');
    });
    
    // Activar la pesta침a seleccionada
    const activeTab = document.querySelector(`[onclick="showMobilePromo('${category}')"]`);
    if (activeTab) {
        activeTab.classList.add('active');
        // Aplicar estilos de tab activa
        activeTab.className = 'mobile-promo-tab active flex-shrink-0 bg-gradient-to-r from-red-500 to-orange-500 text-white px-4 py-2 rounded-full text-sm font-bold';
    }
    
    // Mapear categor칤as a IDs correctos
    const contentIdMap = {
        'daily': 'mobile-daily-promos',
        'combos': 'mobile-combos-promos', 
        'weekend': 'mobile-weekend-promos'
    };
    
    // Mostrar el contenido correspondiente
    const contentId = contentIdMap[category];
    const activeContent = document.getElementById(contentId);
    if (activeContent) {
        activeContent.classList.remove('hidden');
        activeContent.classList.add('active');
        console.log('Mostrando contenido:', contentId);
    } else {
        console.error('No se encontr칩 el contenido:', contentId);
    }
}

// Funci칩n para actualizar promociones seg칰n el d칤a actual
function updateDailyPromotions() {
    const today = new Date();
    const dayOfWeek = today.getDay(); // 0 = Domingo, 1 = Lunes, ..., 6 = S치bado
    
    // Solo promociones de martes a viernes (NO aplican a combos)
    const dailyPromotions = {
        2: { // Martes - HOTDOG MANIA
            day: 'MARTES',
            title: 'HOTDOG MANIA',
            discount: '20% OFF',
            description: 'En todos los hotdogs',
            color: 'from-blue-600 to-blue-800',
            hasPromo: true
        },
        3: { // Mi칠rcoles - BBQ por $100
            day: 'MI칄RCOLES',
            title: 'BBQ BEACON CRUNCH',
            discount: 'Precio 칰nico',
            description: '$100 pesos',
            color: 'from-green-600 to-green-800',
            hasPromo: true
        },
        4: { // Jueves - Papas complemento gratis
            day: 'JUEVES',
            title: 'PAPAS GRATIS',
            discount: 'Papas gratis',
            description: 'Compra hamburguesa o hotdog',
            color: 'from-purple-600 to-purple-800',
            hasPromo: true
        },
        5: { // Viernes - Carne extra y tocino 50% descuento
            day: 'VIERNES',
            title: 'CARNE & TOCINO',
            discount: '50% OFF',
            description: 'Carne extra + tocino',
            color: 'from-red-600 to-red-800',
            hasPromo: true
        }
        // S치bado, domingo y lunes: SIN PROMOCIONES (no se muestran)
    };
    
    const currentPromo = dailyPromotions[dayOfWeek];
    
    // Solo actualizar si hay promoci칩n para el d칤a actual
    if (currentPromo && currentPromo.hasPromo) {
        // Actualizar versi칩n m칩vil
        const mobileCard = document.getElementById('mobile-daily-promo-card');
        const mobileTodayBadge = document.getElementById('mobile-today-badge');
        const mobileDay = document.getElementById('mobile-current-day');
        const mobileTitle = document.getElementById('mobile-current-promo-title');
        const mobileDiscount = document.getElementById('mobile-current-promo-discount');
        const mobileDesc = document.getElementById('mobile-current-promo-desc');
        
        if (mobileCard && mobileDay && mobileTitle && mobileDiscount && mobileDesc) {
            // Mostrar la card de promoci칩n
            mobileCard.style.display = 'block';
            mobileCard.className = `bg-gradient-to-r ${currentPromo.color} rounded-2xl p-4 text-white relative overflow-hidden`;
            mobileDay.textContent = currentPromo.day;
            mobileTitle.textContent = currentPromo.title;
            mobileDiscount.textContent = currentPromo.discount;
            mobileDesc.textContent = currentPromo.description;
            
            // Mostrar badge "HOY"
            if (mobileTodayBadge) {
                mobileTodayBadge.style.display = 'block';
            }
        }
        
        // Actualizar versi칩n desktop
        const desktopCard = document.getElementById('desktop-daily-promo-card');
        const desktopTodayBadge = document.getElementById('desktop-today-badge');
        const desktopDay = document.getElementById('desktop-current-day');
        const desktopTitle = document.getElementById('desktop-current-promo-title');
        const desktopDiscount = document.getElementById('desktop-current-promo-discount');
        const desktopDesc = document.getElementById('desktop-current-promo-desc');
        
        if (desktopCard && desktopDay && desktopTitle && desktopDiscount && desktopDesc) {
            // Mostrar la card de promoci칩n
            desktopCard.style.display = 'block';
            desktopCard.className = `group relative overflow-hidden rounded-2xl bg-gradient-to-br ${currentPromo.color} text-white shadow-xl hover:shadow-2xl transition-all duration-500 transform hover:scale-105`;
            desktopDay.textContent = currentPromo.day;
            desktopTitle.textContent = currentPromo.title;
            desktopDiscount.textContent = currentPromo.discount;
            desktopDesc.textContent = currentPromo.description;
            
            // Mostrar badge "HOY"
            if (desktopTodayBadge) {
                desktopTodayBadge.style.display = 'block';
            }
        }
        
        console.log(`九 Promoci칩n activa para ${currentPromo.day}: ${currentPromo.title}`);
    } else {
        // No hay promoci칩n para hoy - ocultar las cards de promoci칩n diaria
        const mobileCard = document.getElementById('mobile-daily-promo-card');
        const desktopCard = document.getElementById('desktop-daily-promo-card');
        
        if (mobileCard) {
            mobileCard.style.display = 'none';
        }
        if (desktopCard) {
            desktopCard.style.display = 'none';
        }
        
        console.log(`좶잺 Sin promociones para hoy (d칤a ${dayOfWeek})`);
    }
}

// Inicializar promociones del d칤a cuando se carga la p치gina
document.addEventListener('DOMContentLoaded', function() {
    // Esperar un poco para asegurar que todos los elementos est칠n cargados
    setTimeout(() => {
        updateDailyPromotions();
    }, 500);
    
    // Inicializar mejoras de responsividad m칩vil - VERSION SIMPLIFICADA
    initMobileEnhancements();
});

// ============================================
// MEJORAS DE RESPONSIVIDAD M칍VIL - SIMPLIFICADO
// ============================================

function initMobileEnhancements() {
    console.log('游댢 Inicializando mejoras m칩viles simplificadas...');
    
    // Detectar tipo de dispositivo
    const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    const isTouchDevice = ('ontouchstart' in window) || (navigator.maxTouchPoints > 0);
    
    if (isMobile || isTouchDevice) {
        document.body.classList.add('touch-device', 'mobile-device');
        console.log('游님 Dispositivo m칩vil t치ctil detectado');
        
        // Agregar clase CSS para feedback visual
        addTouchFeedbackClass();
        
        // Mejorar scrolling
        document.body.style.webkitOverflowScrolling = 'touch';
        document.body.style.overflowX = 'hidden';
    } else {
        document.body.classList.add('non-touch-device');
        console.log('游둼勇 Dispositivo no t치ctil detectado');
    }
    
    // Manejar orientaci칩n
    handleOrientation();
    window.addEventListener('orientationchange', handleOrientation);
    window.addEventListener('resize', handleOrientation);
    
    console.log('九 Mejoras m칩viles inicializadas correctamente');
}

// Agregar feedback visual simple con CSS
function addTouchFeedbackClass() {
    // Solo agregar clase al body, el CSS har치 el resto
    document.body.classList.add('enable-touch-feedback');
}

// Manejar orientaci칩n del dispositivo
function handleOrientation() {
    const isPortrait = window.innerHeight > window.innerWidth;
    document.body.classList.toggle('portrait-mode', isPortrait);
    document.body.classList.toggle('landscape-mode', !isPortrait);
}
